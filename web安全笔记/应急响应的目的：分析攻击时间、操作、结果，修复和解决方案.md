应急响应的目的：分析攻击时间、操作、结果，修复和解决方案



1. 失效的控制访问
2. 加密机制失效
3. 注入
4. 不安全设计
5. 安全配置失误
6. 自带缺陷的和过时组件
7. 身份识别和身份认证错误
8. 软件和数据完整性故障
9. 安全日志和监控故障
10. ssrf





**weblogic漏洞**：java反序列化、ssrf、xmldecoder反序列化（**CVE-2017**）、任意文件上传（**CVE-2018**）

- 存在后台，就可能存在弱口令漏洞、未授权访问

**sql注入**：

过滤不严谨，把数据当sql带入数据库中执行，

原因：参数可控，拼接sql

- 反馈结果分为：有回显和无回显
- 攻击手法分为：联合、堆叠、报错、盲注
- **防御：代码层防御和网络层防御**，预编译，PDO预处理、正则过滤
- 绕过姿势：大小写、双写、编码、内联
- 危害：获取数据库、操作数据库网页篡改，网页挂马，获取服务器权限、改数据库

**XSS**：跨站脚本攻击

- 原理：JavaScript恶意代码注入，当用户浏览网页时执行，从而实现攻击
- 分类：
  - 反射性：反弹shell
  - dom型：
  - 存储型：
- 绕过方式：大小写、引号、斜杠代替空格、编码、双写、制表符绕过
- 危害：窃取cookies、重定向，钓鱼、挂马，获取操作系统权限
- 防范：对用户输入进行过滤、设置httpOnly使用js无法读取cookie、使用模版引擎

**CSRF：跨站请求伪造**

- 原理：再进行敏感操作没有校验token或者referer值，从而导致利用普通用户完成攻击
- 漏洞类型：GET，POST
- 危害：盗用其他用户账号、获取个人隐私或者机密资料、联合其他漏洞组合拳
- 防范：验证码验证、token验证、验证referer、http头自定义属性验证

**SSRF：服务器端请求伪造**

- 原理：攻击访问服务器B，由于存在防火墙或内网主机无法直接访问，控制服务器A向服务器B发起请求，从而访问服务器B，达到攻击内网目的
- 漏洞常在的位置：分享、转码服务、在线翻译、图片加载下载、图片文章收藏、未公开api及其他
- 绕过：@绕过白名单、绕过限制白名单内网ip，短网址、双冒号、进制转换、特殊域名xip.io、句号
- 危害：内外网端口扫描、攻击内网服务器、dos攻击、攻击内网web、获取数据文件
- 防范：禁止跳转，过滤返回信息、统一错误信息、限制请求端口、禁止除http和https以外的协议

**XXE：XML外部实体注入**

- 原理：xml引用外部实体的时候构造恶意内容，到导致读文件，命令执行
- 构建xxe攻击：DTD外部实体声明、DTD引入外部DTD文档，再声明、DTD外部实体声明引入外部实体声明
- 危害：任意文件读取、系统命令执行、远程代码执行、内网端口探测、dos
- 防范：禁用外部实体引入、过滤铭感关键字

**文件上传**

- 绕过：js禁用绕过、修改后缀、抓包改mime、后缀名大小写、图片马、GIF头文件欺骗、%00（换行）截断，htaccess、user.ini、条件竞争、特殊后缀、后缀双写
- 危害：控制服务器、远程命令执行、木马、提权、修改web页面、内网渗透
- 防范：文件上传目录不可执行、严判文件类型、随机修改文件名和文件路径、内容检测、waf

**WAF**

- 概念：web应用防火墙
- 功能：内置很多安全规则，可防御sql注入、xss、网页篡改等等很多
- 不具备：过滤其他协议流量、不能地址映射、不能防ddos、不防病毒
- 绕过：通配符，大小写变种、内联注释/**/、干扰污染字符、字符编码、cookie绕过、云waf绕过寻找真实网站ip

渗透测试常用攻击

- 信息收集：nmap(信息收集)、fofa、shodan、zoomeye、站长工具、Bugscane(看bug的)、潮汐指纹、子域名挖掘机、whois、Layer子域名收集工具、whatweb（网站识别工具）、wappalyzer、

****

**使用过的安全设备（工具）**

**webshell查杀、**

- D盾

**病毒查杀、**

**安全防护、**

**应急响应、**



**常见中间件漏洞**

- 解析漏洞、目录遍历
- Jboss，反序列化
- 



**中间件漏洞**

- Apache：
  - 可以用多个点分割后缀，从右向左依次碰到到合法后缀才进行解析（可绕黑名单过滤）
  - 目录遍历



ssrf：内网访问，提供功能的网站

csrf：身份伪造



**绕过围绕**

- 大小写、单双引号、正反斜杠、空格、编码、双写、点、通配符、干扰字符、拼凑

**防御围绕**

- 正则、黑名单、白名单、流量过滤、代码层过滤





**保护阶段**：保护现场，尝试恢复

**分析阶段**：入侵过程的分析、指纹库搜索、日志分析、后门追查、漏洞检测、进程检测、计划任务

- 过程分析：攻击是从哪里打进来的，然后再哪里入侵成功
- 查看日志文件是否存在相对于的指纹以便识别攻击的攻击工具
  - fireseek、logfusion都是window日志分析工具
  - 360星图日志分析工具，只不过只能分析iis、apache、nginx的日志文件
  - 还可以使用logontracer平台工具自动分析，将相对于的流量、ip、等等归类汇总
  - 还可以根据是否存在相对于的工具指纹，这有助于后面复现和修复
- 使用杀毒工具扫描是否存在后门文件
- 再使用自动化漏洞检测工具进行扫描
- 使用gscan工具对服务器进行全盘扫描，看是否存在可疑进程，可疑端口，可疑计划任务
- window还需要注意是否存在隐藏用户

**复现阶段**：还远攻击过程、模拟攻击思路、关注应用的漏洞、攻击手法

**修复阶段**：分析原因后，修补相关系统、应用漏洞，清除和整改弱口令，

建议阶段





- 漏洞类型：sql注入、模版注入、XSS、XXE、CSRF、SSRF、弱口令、数据泄露、文件包含、文件上传、权限提升、反序列化，DOM、暴力破解、RCE、越权、逻辑漏洞

- 渗透信息收集：系统版本及类型、中间件信息、ip地址范围、开放的端口、域名子域名、代理

- 入侵后信息收集：日志、进程、网络连接、系统配置、服务、
  - Windows：
    - 系统事件日志：C:\Windows\System32\winevt\Logs
    - 安全日志：C:\Windows\System32\winevt\Secu rity.evtx
  - Linux日志位置：
    - 用户相关日志：/etc
    - 登录及各种服务器日志：/var/log

- 日志分类：用户登录日志、授权日志、系统运行日志、服务器日志

- 分析的关注点：账户、端口、进程、网络、启动项、计划任务、服务、文件、日志 

- 加固措施：过滤、身份验证、防火墙、禁用不要的服、禁用最高权限账号、备份、更新系统、软件包

  

- 文件分析关注点：最近使用文件、系统日志、定时任务、计划任务、用户列表、开机启动项、临时目录、服务器日志

- 真实ip、系统类型、版本、端口开放情况、waf

- cms、cnd、证书、dns记录

- whois信息、姓名、旁站、c段，社工、邮件、子域名、备案

- 中间件版本、弱口令、目录结构、爆后台、、网站bananer、测试文件、备份文件、协议、通用漏洞、源码

- 浏览网站、规模、功能点、特点、端口、弱口令、目录扫描、端口探测、mysql、ftp、ssh、

- xxs、xxe、ssrf、csrf、sql注入、代码执行、越权、任意文件下载、远程命令执行、弱口令、编辑器啊、暴力破解、、漏扫

  




**WIndows事件id**

4624登录成功

4625登录失败

6005事件日志启动

6006事件日志停止

12系统启动

13系统关闭

4720创建用户

4726删除用户





应急前应该做的事：

- 现在的想象是什么，怎么发现的，依据是什么
- 什么时候发现的
- 是否做了物理隔离
- 受害的机器是哪个，受害的服务器有哪些
- 受害服务器对外有哪些服务，
- 这个服务器和其他服务器是否存在同一个网段内
- 操作系统类型、是否有公网映射业务、远程管理方式，网络边界有没有流量接

应急响应时间线：

外网扫描、

- 一般流量特别大，这个一般分析流量就可以，或者看告警信息，或者配合防火墙对ip进行一个封禁、然后可以分析这部分的流量可以进行一个溯源
  - 溯源也就是可以对这个进行whois

漏洞利用、

- 

主机控制、

横向渗透、



找到webshell、确定攻击者ip、回溯攻击者操作、梳理整个流程

**微信情报**

```nginx
奇安信威胁情报中心
微步在线社区
IBM
```

WIndows应急命令

```nginx
# 查看网络连接
netstat -ano

# 操作系统详细配置
systeminfo

# 获取系统进程
wmic process
tasklist

# 技术文件样本
certutil -hashfile

TCPView 看网络连接
Process Explorer 进程工具
logSession 看哪写用户连接过
Autoruns
```

linux应急命令

```nginx
# 查看系统资源占用
top

# 查看进程
ps -aux

# 查看网络连接（找到可疑进程，然后记录pid然后再使用ls命令查看对于的可执行程序）
netstat -antpl
	#在使用ls命令查看对于pid的可执行程序，可以看到他的执行路径

# 开放的端口进程
lsof -i:6666

# 登录信息
lastb # 错误的尝试登录信息
last  # 最近登录信息
lastlog # 所有用户最近登录信息

# 查看计划任务
crontab -l
cat /etc/crontab

# 查看历史命令
history

# 排序查看当前文件下的文件
ls -alt

# 检查rpm包
重点看sm5都不一致的，s是大小、m和mode

# 查看文件详细信息
stat	# 可以看文件夹创建时间和修改时间

# 查看当前目录下指定天数内修改或者新增的类型
find -mtime

# 使用gerp筛选secure日志中成功登录ip和设失败登录ip
# 有助于分析是否存在爆破
成功登录是：accepted
失败登录是：failed password

# 对比
# 输出正在运行程序
ps -ef | awk '{print}' | sort -n | uniq > 1

Gscan 对全盘进行扫描
```

**web攻击事件**

- 重点是备份文件、查杀后门、web日志分析、web中间件缓存处理、重启web中间件、服务器后门检查

**链路劫持**

- 是否能在多个环境中复现异常现象，确定相关资产是否存在（看请求信息）、恶意文件是否存在于服务器上

- 跨地区、跨运营商进行测试、确实受影响的范围、在能复现的环境中判断是dns劫持还是http劫持
- **解决：部署https**

**代理隧道**

- 首先确定存在代理隧道的跳板机，然后看某时间段内集中访问内存资源的机器，在去判断隧道的类型
- **解决：完善内存acl，服务器按白名单策略访问**

**替换系统命令**

- 使用rpm和dpkg命令去检查文件完整性，然后在分析恶意文件的行为，确定影响面

**id.so动态链接库劫持**

- **解决：使用busybox静态链接，在重启被注入恶意模块的进程，必要时重启系统**

**内核态rootkit**

- 解决：使用tyton工具来检测，看etc/modules模块是否有未知模块
- 或者使用**chkrootkit**

**计划任务**

- 判断是否存在周期性的现象、检查常见的计划任务配置文件var/spool/cron/crontabs\etc/cron

**远控木马**

- 主要是关注tcp、udp、icmp的一切网络行为，然后检查注册表、服务、开机目录、计划任务等常见持久化的点



**web攻击**

- 信息泄露
  - 泄露：口令、密匙、证书、会话标识，隐私数据、授权凭证、个人数据、程序文件、配置文件、
    - 日志文件，备份文件，数据库文件
  - 分类
    - 敏感文件
    - 目录遍历
  - 收集方法
    - 搜索引擎
      - 谷歌
    - 社工
      - whois
      - 社工库
    - 网站
      - 端口扫描
      - 域名挖掘
      - 目录遍历
      - cms指纹
      - c段查询
      - 旁站
    - 网络空间绘图
      - fofa
      - shodan

- 弱口令
  - 邮件弱口令
    - IMAP弱口令
    - POP3弱口令
    - SMTP弱口令
  - 数据库弱口令
  - 中间件弱口令
    - tomcat
    - weblogic
    - jobss后台弱口令
  - basic认证弱口令
  - web弱口令
- xss攻击
  - 在web页面中嵌入恶意代码，当用户浏览该网页时恶意js代码触发‘
  - 使用此方法可以盗取用户cookie、
- sql注入
- 文件上传
- 文件包含
- webshell
- 命令执行
- xml注入
- 木马远控
- 挖矿病毒
- 勒索病毒
- 僵尸网络
- 黑市工具



流量分析、日志分析都是为了摸清攻击手法，寻找webshell

然后使用各种工具对各种webshell进行修复

溯源也就是从流量，日志、webshell中找到可疑ip，然后社工反查到个人就算溯源成功

溯源反制就是：如果可疑ip是一个网站，然后对齐信息收集、子域名收集然后攻击它

安全设备：自动会抓取分析流量，自动分析服务器信息或者流量对可疑事情进行告警，告警了就是出事了要应急

威胁情报中心：可以直接查上面流量或者日志分析出的ip或者域名是否为恶意ip/域名



WIndows进程工具：**autoruns**

WIndows查看网络连接工具：**TCPView**

linuxrootkit检查工具：**rkhunter**

Linux服务审查工具：**LineEnum**

攻击上线工具：Cobalt Strike

扫描Cobalt Strike内存特征工具：BeaconEye



**流量特征**

**蚁剑**：**响应体**的返回结果是base64加密、**请求体**都存在以@ini_set(“display:error”)

**冰蝎**：

- 2.0：AES加密+base64编码，使用**动态密匙**加密通信
- 3.0：AES加密+base64编码，使用**固定密匙**加密通信，默认是：**rebeyond**
- 4.0：传输算法自定义，
  - 弱特征：
    - Accept字段：通常是Accept: application/json, text/javascript
    - Content-Type字段：通常是Application/x-www-form-urlencoded

**哥斯拉**

- 采用了和冰蝎 2.0 类似的密钥交换方式
- jsp会出现：xc、pass、Java反射、base64
- 弱特征：
  - User-Agent字段：采用默认的情况，会暴露使用的jdk信息。不过哥斯拉支持自定义HTTP头部
  - Accept字段：Accept:text/html, image/gif, image/jpeg, *; q=.2, /; q=.2

**菜刀**

- payload在请求体中，采用url编码+base64编码，payload部分是明文传输
- payload中有eval或assert、base64_decode这样的字符。
- 特征十分明显





**蜜罐**

- mysql蜜罐反制
  - 会在你的服务器中模拟一个mysql服务，在攻击者扫描数据库弱口令的时候，然后利用他进行登录的时候，会获取攻击者电脑上的微信ID
  - **过程**
    - **主要使用：LOAD DATA INFILE，这个可以将文本中数据快速读取到表中**
    - **这个功能默认关闭**，使用命令`show global variables like 'local_infile';`查看状态





CVE-2019-0193 Apache 的远程代码执行

cve-2018-3004 oracle 权限提升
