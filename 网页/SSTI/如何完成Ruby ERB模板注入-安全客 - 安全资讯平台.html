<!DOCTYPE html>
<!-- saved from url=(0038)https://www.anquanke.com/post/id/86867 -->
<html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="renderer" content="webkit">
<meta name="force-rendering" content="webkit">
<meta name="referrer" content="always">
<meta name="description" content="安全客 - 安全资讯平台">
<link rel="icon" href="https://s3.ssl.qhres2.com/static/02b5158bbb6adeac.ico" type="image/x-icon">
<link rel="shortcut icon" href="https://s3.ssl.qhres2.com/static/02b5158bbb6adeac.ico" type="image/x-icon">
<meta name="keywords" content="安全媒体,安全资讯,安全知识, 安全热点,安全招聘,安全趋势,移动安全,网站安全,终端安全,无线安全,工控安全,物联网安全,WEB安全,系统安全,网络安全,区块链安全,安全活动,信息安全,安全预警,安全会议">

  <title>【技术分享】手把手教你如何完成Ruby ERB模板注入-安全客 - 安全资讯平台</title>
  <meta name="description" content="安全客 - 安全资讯平台">
  <meta name="keywords" content="安全媒体,安全资讯,安全知识, 安全热点,安全招聘,安全趋势,移动安全,网站安全,终端安全,无线安全,工控安全,物联网安全,WEB安全,系统安全,网络安全,区块链安全,安全活动,信息安全,安全预警,安全会议">
  <script>(function(window){
        

function empty() {}

empty();
      })(this);</script>

<link rel="stylesheet" href="./【技术分享】手把手教你如何完成Ruby ERB模板注入-安全客 - 安全资讯平台_files/d4cec9cd8efbfd10.css">
<link rel="stylesheet" href="./【技术分享】手把手教你如何完成Ruby ERB模板注入-安全客 - 安全资讯平台_files/a51843d6b82241be,d94674bd62441768,56ce5cef8079a575,8514be0a921ca6e8,4802c0c382205144,8e4464e423fe6849,13c0bf3b0c2e4882,2b3936345af879da,f568b72da28701d3,da046392ff3eccb9,aa4b116b0af3b8cd,e0bfa.css">
<script>window._dynamic_deps_={}</script>
<style data-id="immersive-translate-input-injected-css">.immersive-translate-input {
  position: absolute;
  top: 0;
  right: 0;
  left: 0;
  bottom: 0;
  z-index: 2147483647;
  display: flex;
  justify-content: center;
  align-items: center;
}

.immersive-translate-input-loading {
  --loading-color: #f78fb6;
  width: 6px;
  height: 6px;
  border-radius: 50%;
  display: block;
  margin: 12px auto;
  position: relative;
  color: white;
  left: -100px;
  box-sizing: border-box;
  animation: immersiveTranslateShadowRolling 1.5s linear infinite;
}

@keyframes immersiveTranslateShadowRolling {
  0% {
    box-shadow: 0px 0 rgba(255, 255, 255, 0), 0px 0 rgba(255, 255, 255, 0), 0px 0 rgba(255, 255, 255, 0), 0px 0 rgba(255, 255, 255, 0);
  }

  12% {
    box-shadow: 100px 0 var(--loading-color), 0px 0 rgba(255, 255, 255, 0), 0px 0 rgba(255, 255, 255, 0), 0px 0 rgba(255, 255, 255, 0);
  }

  25% {
    box-shadow: 110px 0 var(--loading-color), 100px 0 var(--loading-color), 0px 0 rgba(255, 255, 255, 0), 0px 0 rgba(255, 255, 255, 0);
  }

  36% {
    box-shadow: 120px 0 var(--loading-color), 110px 0 var(--loading-color), 100px 0 var(--loading-color), 0px 0 rgba(255, 255, 255, 0);
  }

  50% {
    box-shadow: 130px 0 var(--loading-color), 120px 0 var(--loading-color), 110px 0 var(--loading-color), 100px 0 var(--loading-color);
  }

  62% {
    box-shadow: 200px 0 rgba(255, 255, 255, 0), 130px 0 var(--loading-color), 120px 0 var(--loading-color), 110px 0 var(--loading-color);
  }

  75% {
    box-shadow: 200px 0 rgba(255, 255, 255, 0), 200px 0 rgba(255, 255, 255, 0), 130px 0 var(--loading-color), 120px 0 var(--loading-color);
  }

  87% {
    box-shadow: 200px 0 rgba(255, 255, 255, 0), 200px 0 rgba(255, 255, 255, 0), 200px 0 rgba(255, 255, 255, 0), 130px 0 var(--loading-color);
  }

  100% {
    box-shadow: 200px 0 rgba(255, 255, 255, 0), 200px 0 rgba(255, 255, 255, 0), 200px 0 rgba(255, 255, 255, 0), 200px 0 rgba(255, 255, 255, 0);
  }
}
</style></head>

<body>
  <div id="app" data-v-app=""><div class="_9" style="height: 60px;"><div class="g-w"><a class="logo1" href="https://www.anquanke.com/"></a><div class="_10"><div class="item"><div style="cursor: pointer;"><span>首页</span><ul></ul></div></div><div class="item"><div><span>阅读</span><ul><li class="sub-item"><a href="https://www.anquanke.com/news">安全资讯</a></li><li class="sub-item"><a href="https://www.anquanke.com/knowledge">安全知识</a></li><li class="sub-item"><a href="https://www.anquanke.com/tool">安全工具</a></li></ul></div></div><div class="item"><div style="cursor: pointer;"><span>活动</span><ul></ul></div></div><div class="item"><div style="cursor: pointer;"><span>招聘</span><ul></ul></div></div><div class="item"><div style="cursor: pointer;"><span>安全导航</span><ul></ul></div></div><div class="item"><div style="cursor: pointer;"><span>内容精选</span><ul><li class="sub-item"><a href="https://www.anquanke.com/column/index.html">专栏</a></li><li class="sub-item"><a href="https://www.anquanke.com/subject-list">精选专题</a></li><li class="sub-item"><a href="https://www.anquanke.com/discovery">安全客季刊</a></li><li class="sub-item"><a href="https://www.anquanke.com/week-list">360网络安全周报</a></li></ul></div></div></div><div class="_11"><div class="block"><div class="search"><input class="input" placeholder="输入关键词搜索"><button class="button"></button></div><!----><div class="user-href js-login-body" style="display: none;"><div class="user-href-top"><p class="user-avatar-bottom"><img class="user-href-avatar"><!----></p><div class="user-href-top-main"><p class="user-href-grade"></p><p class="user-href-text"><span>累计积分</span><span>可用积分</span></p><p class="user-href-score"><span></span><span></span></p></div></div><ul><li><a href="https://www.anquanke.com/member.html?memberId=undefined">个人主页</a></li><li><a href="https://www.anquanke.com/setting?p=message">我的消息</a></li><li><a href="https://www.anquanke.com/user/set1.html">个人设置</a></li><li><a href="https://www.anquanke.com/user/score/search.html">积分商城</a></li><li>退出登录</li></ul></div><a href="https://www.anquanke.com/login/index.html" class="nologin"></a></div><span class="write"></span><a class="app" href="https://www.anquanke.com/app"><div class="app-img"><img src="./【技术分享】手把手教你如何完成Ruby ERB模板注入-安全客 - 安全资讯平台_files/t01103704213901dd1e.png"></div></a></div></div></div><div class="index"><div class="index-main"><div class="_55"><h1>【技术分享】手把手教你如何完成Ruby ERB模板注入</h1><div class="read"><p><span class="read-text">阅读量</span><b class="read-num">210722</b></p><p><span class="read-sep">|</span><span class="read-text">评论</span><b class="read-num">4</b></p><p><span class="read-sep">|</span><img class="read-fee" src="./【技术分享】手把手教你如何完成Ruby ERB模板注入-安全客 - 安全资讯平台_files/t01f942715e2a0f1a23.png"></p></div><p class="publish">发布时间 : 2017-09-18 14:34:45</p><div class="_54"><b class="close">x</b><h5>译文声明</h5><p> 本文是翻译文章<!----><span>，文章来源：trustedsec.com</span></p><p>原文地址：<a href="https://www.trustedsec.com/2017/09/rubyerb-template-injection/">https://www.trustedsec.com/2017/09/rubyerb-template-injection/</a></p><p>译文仅供参考，具体内容表达以及含义原文为准。</p></div><div class="content" id="js-article">


<p><span><img title="t019325c55f221fa3e8.jpg" alt="https://p5.ssl.qhimg.com/t019325c55f221fa3e8.jpg" src="./【技术分享】手把手教你如何完成Ruby ERB模板注入-安全客 - 安全资讯平台_files/t019325c55f221fa3e8.jpg"></span></p>
<p><span>译者：</span><a href="http://bobao.360.cn/member/contribute?uid=2819002922" target="_blank">興趣使然的小胃</a></p>
<p><span>预估稿费：200RMB</span></p>
<p><span>投稿方式：发送邮件至linwei#360.cn，或登陆网页版在线投稿</span></p>
<p><span><br></span></p>
<p><span style="font-size: 18px"><strong><span>前言：现在Web应用的模板</span></strong></span></p>
<p><span>现在的Web应用中，许多客户端以及服务器端经常会用到模板。许多模板引擎提供了多种不同的编程语言实现，比如Smarty、Mako、Jinja2、Jade、Velocity、Freemaker以及Twig等模板。作为注入攻击大家族中的一员，模板注入这种攻击形式对不同的目标所造成的影响也有所不同。对于AngularJS而言，模板注入攻击可以达到<span><strong>XSS攻击</strong></span>效果，对于服务器端的注入攻击而言，模板注入攻击可以达到远程代码执行效果。</span></p>
<p><span>作为大名鼎鼎BurpSuite工具的开发商，Portswigger写了一篇</span><a href="http://blog.portswigger.net/2015/08/server-side-template-injection.html" target="_blank"><span>文章</span></a><span>详细介绍了服务器端的模板注入攻击。对攻击者而言，首先需要做的就是识别模板引擎、枚举可访问的类或方法，最终利用这些信息完成预期的操作，比如读取或写入文件、命令执行或其他操作等。攻击者具体能执行哪些操作取决于可访问的类方法或函数的能力范围。</span></p>
<p><span><br></span></p>
<p><span style="font-size: 18px"><strong><span>模板攻击：Ruby/ERB模板注入</span></strong></span></p>
<p><span>在本文中，我们会使用<span><strong>TrustedSec</strong></span>应用安全课程中的实验目标，演练一遍<strong><span>Ruby/ERB模板注入</span></strong>攻击。我们的实验对象是一个简单的应用，该应用可以模拟包含模板编辑功能的一种IT服务台（Helpdesk）报告工具。我们可以通过这个应用来编辑HTML及模板，也可以预览编辑效果，如下图所示：</span></p>
<p style="text-indent: 0em;text-align: center"><img src="https://base_request.html/img/1.png"><img title="t01c7121429feba4232.png" alt="https://p2.ssl.qhimg.com/t01c7121429feba4232.png" src="./【技术分享】手把手教你如何完成Ruby ERB模板注入-安全客 - 安全资讯平台_files/t01c7121429feba4232.png"></p>
<p><span>使用预览（preview）按钮提交表格后，呈现在我们眼前是包含用户信息以及用户创建时间的一个页面：</span></p>
<p style="text-indent: 0em;text-align: center"><img src="https://base_request.html/img/2.png"><img title="t016d21ad6211372d84.png" alt="https://p5.ssl.qhimg.com/t016d21ad6211372d84.png" src="./【技术分享】手把手教你如何完成Ruby ERB模板注入-安全客 - 安全资讯平台_files/t016d21ad6211372d84.png"></p>
<p><span>观察代码中获取username以及tombstone时所使用的语法，根据其中的&lt;%=语法以及其他一些Ruby技术，我们可以猜测这段代码属于Ruby/ERB代码。基于这个判断，我们可以编辑输入数据，测试我们是否可以进行模板注入。大致浏览ERB文档后，我们了解到&lt;%=语法可以用来执行Ruby语句，并会尝试将结果转换为字符串，以附在最终的结果文本中。我们可以使用如下攻击载荷来尝试执行数学运算：</span></p>
<pre><code class="hljs language-undefined">ruby&nbsp;&lt;%=&nbsp;7&nbsp;*&nbsp;7&nbsp;%&gt;</code></pre>
<p><span>运算结果为49，每个用户都会打印一次运算结果，如下所示：</span></p>
<p style="text-indent: 0em;text-align: center"><img data-original="//base_request.html/img/3.png"><img title="t01a3de9db6d000f011.png" alt="https://p5.ssl.qhimg.com/t01a3de9db6d000f011.png" data-original="https://p5.ssl.qhimg.com/t01a3de9db6d000f011.png"></p>
<p><span>可以肯定的是，这段代码存在模板注入漏洞。非常好，接下来我们可以试试看能否执行函数。我们可以先来测试自带的全局函数是否能用到这段代码中。比如，我们可以测试如下这种载荷：</span></p>
<pre><code class="hljs language-bash">ruby&nbsp;&lt;%=&nbsp;File.open(‘/etc/passwd’).<span class="hljs-built_in">read</span>&nbsp;%&gt;</code></pre>
<p style="text-indent: 0em;text-align: center"><img data-original="//base_request.html/img/4.png"><img title="t018551eed0b918398c.png" alt="https://p0.ssl.qhimg.com/t018551eed0b918398c.png" data-original="https://p0.ssl.qhimg.com/t018551eed0b918398c.png"></p>
<p><span>由于不安全操作的原因，系统阻止我们访问<strong><span>File.open</span></strong>函数。Ruby的ERB模板引擎包含一个安全级别（safe level）参数，当安全级别设置为0以上的某个值（比如3）时，我们无法在模板绑定（template binding）中执行包括文件操作在内的某些函数。如果应用使用的安全级别为4，那么它会使用最为严格的隔离机制，只能执行标记为可信状态的那些代码。因此，看样子管理员在这个模板引擎中设置了安全级别。虽然我们的攻击不会像读写硬盘文件那样简单，但这里我们还可以尝试许多攻击面。比如，对于目前可用的这些小工具（gadget），我们还可以做什么操作？如果我们想分析self对象（self-object），我们可以尝试枚举该对象可用的属性及方法。比如，我们可以使用如下载荷：</span></p>
<pre><code class="hljs language-lua">ruby&nbsp;&lt;%=&nbsp;<span class="hljs-built_in">self</span>&nbsp;%&gt;</code></pre>
<p><span>结果如下：</span></p>
<p style="text-indent: 0em;text-align: center"><img data-original="//base_request.html/img/5.png"><img title="t019544a981026ded32.png" alt="https://p0.ssl.qhimg.com/t019544a981026ded32.png" data-original="https://p0.ssl.qhimg.com/t019544a981026ded32.png"></p>
<p><span>结果看起来就是Ruby的风格。现在我们可以试着获取self对象的类名：</span></p>
<pre><code class="hljs language-php">ruby&nbsp;&lt;%=&nbsp;<span class="hljs-built_in">self</span>.<span class="hljs-keyword">class</span>.name&nbsp;%&gt;</code></pre>
<p><span>结果如下：</span></p>
<p style="text-indent: 0em;text-align: center"><img data-original="//base_request.html/img/6.png"><img title="t0162ae80bbca330ed5.png" alt="https://p3.ssl.qhimg.com/t0162ae80bbca330ed5.png" data-original="https://p3.ssl.qhimg.com/t0162ae80bbca330ed5.png"></p>
<p><span>类名为“TemplateInjection”。现在我们已经可以“访问”这个控制接口，我们能用它来干啥？我们可以来枚举TemplateInjection类的可用方法：</span></p>
<pre><code class="hljs language-lua">ruby&nbsp;&lt;%=&nbsp;<span class="hljs-built_in">self</span>.methods&nbsp;%&gt;</code></pre>
<p><span>结果如下：</span></p>
<p style="text-indent: 0em;text-align: center"><img data-original="//base_request.html/img/7.png"><img title="t0166de1994d25f764d.png" alt="https://p0.ssl.qhimg.com/t0166de1994d25f764d.png" data-original="https://p0.ssl.qhimg.com/t0166de1994d25f764d.png"></p>
<p><span>接下来，我们可以观察这些函数，思考哪些数据可以传递给这些函数，以实现未授权访问目的。虽然我们并不清楚该应用具体使用的web框架，但由于我们正往服务器发送HTTP POST请求，因此可以猜到我们很有可能处于handlePOST或者doPOST函数内部。也许我们可以借此访问某些局部变量。</span></p>
<p><span>如果大家不熟悉Ruby，这里我稍微介绍下。Ruby提供了强大的元编程（metaprogramming）以及内省（introspection）功能，读者可以访问</span><a href="http://ruby-metaprogramming.rubylearning.com/" target="_blank"><span>此链接</span></a><span>了解更多细节。作为攻击者，我们可以使用其中某些功能（如前面提到的类的.methods以及.name方法）来探索程序的内部结构。我们可以使用如下载荷获取目标所需的具体参数：</span></p>
<pre><code class="hljs language-ruby">ruby&nbsp;&lt;%=&nbsp;<span class="hljs-keyword">self</span>.method(<span class="hljs-symbol">:handle_POST</span>).parameters&nbsp;%&gt;</code></pre>
<p><span>结果如下：</span></p>
<p style="text-indent: 0em;text-align: center"><img data-original="//base_request.html/img/8.png"><img title="t0116ea2a5826f4e7cf.png" alt="https://p3.ssl.qhimg.com/t0116ea2a5826f4e7cf.png" data-original="https://p3.ssl.qhimg.com/t0116ea2a5826f4e7cf.png"></p>
<p><span>从结果中，我们可知handle_POST需要3个req参数，该参数可能代表的是某个请求（request）对象；rsp参数可能代表的是响应数据的引用；最后的session参数可能是某个id或者某个对象。我们可以继续探索，以确认session对象的具体含义，使用的载荷如下：</span></p>
<pre><code class="hljs language-cpp">ruby&nbsp;&lt;%=&nbsp;session.<span class="hljs-keyword">class</span>.name&nbsp;%&gt;</code></pre>
<p><span>结果如下：</span></p>
<p style="text-indent: 0em;text-align: center"><img data-original="//base_request.html/img/9.png"><img title="t017bb5cb13101b1252.png" alt="https://p5.ssl.qhimg.com/t017bb5cb13101b1252.png" data-original="https://p5.ssl.qhimg.com/t017bb5cb13101b1252.png"></p>
<p><span>上述结果中，我们首先可以观察到的是“WEBrick”，这是Ruby在标准库中实现的原生web服务器。我们当然可以继续探索这个session对象，但除此之外，还有其他一些目标更值得我们探索，比如，我们可以重点关注与当前会话有关的那些数据。简单翻阅WEBrick文档后，我们发现某些变量会传递给Servlet以处理客户端请求。我们可以使用某些内省（introspection）方法，以确认我们是否可以访问这些变量以及其他可用变量。</span></p>
<pre><code class="hljs language-lua">ruby&nbsp;&lt;%=&nbsp;<span class="hljs-built_in">self</span>.instance_variables&nbsp;%&gt;</code></pre>
<p><span>结果如下：</span></p>
<p style="text-indent: 0em;text-align: center"><img data-original="//base_request.html/img/10.png"><img title="t01ae7cfe9eca7d38e8.png" alt="https://p4.ssl.qhimg.com/t01ae7cfe9eca7d38e8.png" data-original="https://p4.ssl.qhimg.com/t01ae7cfe9eca7d38e8.png"></p>
<p><span>当WEBrick被实例化以处理客户端请求时，它会将某个http服务器实例传递给servlet，这很有可能就是@server这个实例变量。接下来我们可以证实这个猜想，同时观察这个对象包含哪些成员变量。我们同样可以通过调用.instance_variables方法来证实这一点：</span></p>
<pre><code class="hljs language-java">ruby&nbsp;&lt;%=<span class="hljs-meta">@server</span>.instance_variables&nbsp;%&gt;</code></pre>
<p><span>结果如下：</span></p>
<p style="text-indent: 0em;text-align: center"><img data-original="//base_request.html/img/11.png"><img title="t01cc2ba03a646de70b.png" alt="https://p4.ssl.qhimg.com/t01cc2ba03a646de70b.png" data-original="https://p4.ssl.qhimg.com/t01cc2ba03a646de70b.png"></p>
<p><span>其中最为有趣的应该就是@ssl_context变量。这个变量可能会包含某些密钥或者其他有用的信息。需要注意的是，接下来我们会稍微改一下语法，使用&lt;%来执行Ruby语句。通过这种语法，我们可以创建自己的局部变量，保存@sll_context的引用，使载荷可读性更好，方便随后在模板中加以引用。</span></p>
<pre><code class="hljs language-java">ruby&nbsp;&lt;%&nbsp;ssl=<span class="hljs-meta">@server</span>.instance_variable_get(:<span class="hljs-meta">@ssl_context</span>)&nbsp;%&gt;&lt;%=&nbsp;ssl.instance_variables&nbsp;%&gt;</code></pre>
<p><span>结果如下：</span></p>
<p style="text-indent: 0em;text-align: center"><img data-original="//base_request.html/img/12.png"><img title="t01b360af7d1a92babe.png" alt="https://p3.ssl.qhimg.com/t01b360af7d1a92babe.png" data-original="https://p3.ssl.qhimg.com/t01b360af7d1a92babe.png"></p>
<p><span>结果中，@key看起来非常有趣，我们可以提取这个值：</span></p>
<pre><code class="hljs language-java">ruby&nbsp;&lt;%&nbsp;ssl&nbsp;=&nbsp;<span class="hljs-meta">@server</span>.instance_variable_get(:<span class="hljs-meta">@ssl_context</span>)&nbsp;%&gt;&lt;%=&nbsp;ssl.instance_variable_get(:<span class="hljs-meta">@key</span>)&nbsp;%&gt;</code></pre>
<p><span>结果如下：</span></p>
<p style="text-indent: 0em;text-align: center"><img data-original="//base_request.html/img/13.png"><img title="t012453cda85d43f4f1.png" alt="https://p5.ssl.qhimg.com/t012453cda85d43f4f1.png" data-original="https://p5.ssl.qhimg.com/t012453cda85d43f4f1.png"></p>
<p><span><br></span></p>
<p><span style="font-size: 18px"><strong><span>总结：风险与检验</span></strong></span></p>
<p><span>在实际生活中，服务器私钥被泄露是非常严重的一件事情。作为应用安全测试员，我们的测试操作到此差不多就该停止了。开发人员可以采用多种方式来限制数据的读取范围，进一步沙箱化模板中运行的代码。我们会根据测试过程中对目标应用的了解来给出相应的建议。作为应用测试人员，我们需要全方位探索哪些模板代码会提交到服务端进行处理。虽然存在一定的安全风险，但是由用户提供模板的场景依然非常常见，特别是在某些应用中更是如此（比如用来生成报表以及发送邮件的那些应用）。希望读完这篇文章后，读者可以掌握一定的技巧来测试现在常用的那些模板引擎。</span></p>

</div><div class="_53"> 本文翻译自trustedsec.com <a href="https://www.trustedsec.com/2017/09/rubyerb-template-injection/" target="_blank">原文链接</a>。如若转载请注明出处。 </div><div class="_206" style="display: none;"> 商务合作，文章发布请联系 anquanke@360.cn </div><div class="_59" style="display: none;"><p> 本文由<b>興趣使然的小胃</b>原创发布 </p><p> 转载，请参考<a href="https://www.anquanke.com/note/repost" target="_blank">转载声明</a>，注明出处： <a href="https://www.anquanke.com/post/id/86867" target="_blank">https://www.anquanke.com/post/id/86867</a></p><p>安全客 - 有思想的安全新媒体</p></div><div class="_62" style="display: none;"><p> 本文转载自: <a href="https://www.trustedsec.com/2017/09/rubyerb-template-injection/">trustedsec.com</a></p><p> 如若转载,请注明出处： <a href="https://www.trustedsec.com/2017/09/rubyerb-template-injection/" target="_blank">https://www.trustedsec.com/2017/09/rubyerb-template-injection/</a></p><p>安全客 - 有思想的安全新媒体</p></div><div class="_63 share1"><div class="main-w"><div class="bg"></div><div class="main"><span>分享到：</span><img class="icon" data-cmd="weixin" alt="微信" src="./【技术分享】手把手教你如何完成Ruby ERB模板注入-安全客 - 安全资讯平台_files/t01e29062a5dcd13c10.png"></div></div><div class="qrcode" title="https://anquanke.com/post/id/86867" style="display: none;"><canvas width="90" height="90" style="display: none;"></canvas><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAFoAAABaCAYAAAA4qEECAAAAAXNSR0IArs4c6QAABN1JREFUeF7tne124jAMROH9H5qeUNgNcqRcSU5ayuzPruOP8Wg0EqG9Xi6X22Xyv9vt/5TX6/Xf7OufLz/0/m/9c7I1bz3y7DKm+zxZZ0FBQDvEIADSMQL6JxhtQ5veViQD6zmykmDX9/ZHJKgiW7PwuOOzlo5ZExNAMpf4HEvmnZkfZuEhoB83SC8nQw4bvS6jSZiTDZJ5bObPHKjqXjrR4e0vci8C2qBG9F5AJxyEGF0oZIiEWRYS5mYLmbeTDgLCGjgBbdgZJTkClpdYybMfxejIl3ZApM7GiwKvqHpb6RDQO8Y9a2e6oZzV37dm9KyiIZrnaLmgoV8hxh4+uDLcm4gmFwH9jcCpTaXoco6Qi1/L6CyLO9pNexQkrInvrrRJZ+ExMHrWxAQcAT0BbQE9gni9dbrbzUuphPxzyYqlIwVL80ju4wL6KGTNvAL6LKCzrxt0+rhR5ifnpXZtay5a/pPzZd1WyXWQjVSSoYA2CAhonxJh499zHcQRZKs5WrZnHQUxTnbOo2TIc0VuMhTQjLneqKGpJEa/vmyZzRUC2vrY1Vuty3+dLh3klbCOjKzPm9VeyxaSiIn1IqylY0hPfbB35CCECWQeehBSNpMLJAmzsicBDW1pBVwSpUNxtk6G0dv5W7Yly5KIeZ25yLOE9RHoZI3oAl7snYDuWToBnXiRZ1YyDX00cRckGVZ0j/RHuuFPEqvHSnLusHFFNJpcQAXcbAkvoLsoBwUEYVJleZLcsgTDjKbl5HNcdrNRAUL8KBlDz0C8fvd8LzJEPjOceUAiF50xAnoDASIL2TFvAXQ22RCnQPWT6CEJd7oesXHZuiJa2y1YyIYFNG+xCuigJzKV0V6btCMjJBrsmOyhstGUPc+yv84aQ1NJQLP+RocIywqtL3RmS9owWQS/1+P53NkJ8zBGZ/0rydxe78CGpjeOHJZcAJWzrLMh+xsYLaBfdTkiyVZ1HMmL+4tRSKEgRvOEiewdCScaQjSEt8ZlnUPY5JmUEyjZBLSxcdlcIaADAO/J6WxGEx89q11I5okKGcqePTtogc7OS1g/nENAs4LFG0UiAxcshIkkUZF5/iyjs41/AhYBPXIfxFoSJ9RxOLagIkXR1I+yBDT3zi9aLkYzjRajDU5d2SJtiEpxhl4JI5mV3LjlziwZIpre1WvyPNZoAhZJQvTgAnripwtRKH8s0CQ8smPC1iEog7Pr0aqNyKE3V2VPh39FWUB/X4uA3mk+bfVNSozOfhecLEK01zZ2yDMk3Cv2jtg18lpc6RMWAmin6yWgOwg/niXs/GigKUBbd1EJa+q39+6+sm+yX+I66Nqn/jo2q3MCeo9CG/9PGCKgN7SVZG+SraPwyz5PQpkmaHI+MhdxI/d8RD7Kyi5I+iHLnAIafi8vCxSVDpJgsoy0c2afX5ON5JZhvaMZTbQ7snqdjiJNNWQNEtWRtB0uHQL60esQo3t/7o/mo1MZHYUy0fuZIU4irTPG5gABXXj3ztPiKEkK6J8GmmbsrX4tkQHqNIitInbQnicrC8R14DZpZcMCGv59XfJbwgi7SaKKioZsEUAYGe2bPE+KGhy9R3/CEm2WbnKvLevJCwV6ljxh6SDMJWMIO4/qdVD5I80gwnriQIamEgGRjBHQ47e7Tv1z1faSPkk6vgA4mCH1Ho/HsAAAAABJRU5ErkJggg==" style="display: block;"></div></div><ul class="_65"><li><a target="_blank" href="https://www.anquanke.com/tag/%E5%AE%89%E5%85%A8%E7%9F%A5%E8%AF%86">安全知识</a></li></ul><div class="_56"><div class="line line1"><div class="_18 item1"><b style="display: none;">+1</b><i class="iconfont icon-rate"></i><span class="rate-text">0赞</span></div><div class="_12 item1"><i class=""></i><span>收藏</span></div></div><div class="line line2"><div class="user"><img class="avatar" src="./【技术分享】手把手教你如何完成Ruby ERB模板注入-安全客 - 安全资讯平台_files/t0104d1b8b4ca36e961.jpg"><span class="name">興趣使然的小胃</span><span class="label label-verify"></span></div><div class="_63 share2"><div class="main-w"><div class="bg"></div><div class="main"><span>分享到：</span><img class="icon" data-cmd="weixin" alt="微信" src="./【技术分享】手把手教你如何完成Ruby ERB模板注入-安全客 - 安全资讯平台_files/t01e29062a5dcd13c10.png"></div></div><div class="qrcode" title="https://anquanke.com/post/id/86867" style="display: none;"><canvas width="90" height="90" style="display: none;"></canvas><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAFoAAABaCAYAAAA4qEECAAAAAXNSR0IArs4c6QAABN1JREFUeF7tne124jAMROH9H5qeUNgNcqRcSU5ayuzPruOP8Wg0EqG9Xi6X22Xyv9vt/5TX6/Xf7OufLz/0/m/9c7I1bz3y7DKm+zxZZ0FBQDvEIADSMQL6JxhtQ5veViQD6zmykmDX9/ZHJKgiW7PwuOOzlo5ZExNAMpf4HEvmnZkfZuEhoB83SC8nQw4bvS6jSZiTDZJ5bObPHKjqXjrR4e0vci8C2qBG9F5AJxyEGF0oZIiEWRYS5mYLmbeTDgLCGjgBbdgZJTkClpdYybMfxejIl3ZApM7GiwKvqHpb6RDQO8Y9a2e6oZzV37dm9KyiIZrnaLmgoV8hxh4+uDLcm4gmFwH9jcCpTaXoco6Qi1/L6CyLO9pNexQkrInvrrRJZ+ExMHrWxAQcAT0BbQE9gni9dbrbzUuphPxzyYqlIwVL80ju4wL6KGTNvAL6LKCzrxt0+rhR5ifnpXZtay5a/pPzZd1WyXWQjVSSoYA2CAhonxJh499zHcQRZKs5WrZnHQUxTnbOo2TIc0VuMhTQjLneqKGpJEa/vmyZzRUC2vrY1Vuty3+dLh3klbCOjKzPm9VeyxaSiIn1IqylY0hPfbB35CCECWQeehBSNpMLJAmzsicBDW1pBVwSpUNxtk6G0dv5W7Yly5KIeZ25yLOE9RHoZI3oAl7snYDuWToBnXiRZ1YyDX00cRckGVZ0j/RHuuFPEqvHSnLusHFFNJpcQAXcbAkvoLsoBwUEYVJleZLcsgTDjKbl5HNcdrNRAUL8KBlDz0C8fvd8LzJEPjOceUAiF50xAnoDASIL2TFvAXQ22RCnQPWT6CEJd7oesXHZuiJa2y1YyIYFNG+xCuigJzKV0V6btCMjJBrsmOyhstGUPc+yv84aQ1NJQLP+RocIywqtL3RmS9owWQS/1+P53NkJ8zBGZ/0rydxe78CGpjeOHJZcAJWzrLMh+xsYLaBfdTkiyVZ1HMmL+4tRSKEgRvOEiewdCScaQjSEt8ZlnUPY5JmUEyjZBLSxcdlcIaADAO/J6WxGEx89q11I5okKGcqePTtogc7OS1g/nENAs4LFG0UiAxcshIkkUZF5/iyjs41/AhYBPXIfxFoSJ9RxOLagIkXR1I+yBDT3zi9aLkYzjRajDU5d2SJtiEpxhl4JI5mV3LjlziwZIpre1WvyPNZoAhZJQvTgAnripwtRKH8s0CQ8smPC1iEog7Pr0aqNyKE3V2VPh39FWUB/X4uA3mk+bfVNSozOfhecLEK01zZ2yDMk3Cv2jtg18lpc6RMWAmin6yWgOwg/niXs/GigKUBbd1EJa+q39+6+sm+yX+I66Nqn/jo2q3MCeo9CG/9PGCKgN7SVZG+SraPwyz5PQpkmaHI+MhdxI/d8RD7Kyi5I+iHLnAIafi8vCxSVDpJgsoy0c2afX5ON5JZhvaMZTbQ7snqdjiJNNWQNEtWRtB0uHQL60esQo3t/7o/mo1MZHYUy0fuZIU4irTPG5gABXXj3ztPiKEkK6J8GmmbsrX4tkQHqNIitInbQnicrC8R14DZpZcMCGv59XfJbwgi7SaKKioZsEUAYGe2bPE+KGhy9R3/CEm2WbnKvLevJCwV6ljxh6SDMJWMIO4/qdVD5I80gwnriQIamEgGRjBHQ47e7Tv1z1faSPkk6vgA4mCH1Ho/HsAAAAABJRU5ErkJggg==" style="display: block;"></div></div></div></div></div><div class="_60"><h2 class="g-title">推荐阅读</h2><ul><li><a href="https://www.anquanke.com/post/id/289260"><img src="./【技术分享】手把手教你如何完成Ruby ERB模板注入-安全客 - 安全资讯平台_files/t01ecfc10734bb0a594.jpg"><h5 class="g-line2">RBAC 和 Keto（Go RBAC 框架）</h5><p>2023-06-16 18:31:25</p></a></li><li><a href="https://www.anquanke.com/post/id/289299"><img src="./【技术分享】手把手教你如何完成Ruby ERB模板注入-安全客 - 安全资讯平台_files/t01631accaaecf8e083.jpg"><h5 class="g-line2">API NEWS | Booking.com爆出API漏洞</h5><p>2023-06-16 17:57:51</p></a></li><li><a href="https://www.anquanke.com/post/id/289298"><img src="./【技术分享】手把手教你如何完成Ruby ERB模板注入-安全客 - 安全资讯平台_files/t010bea9d3bd19acbe5.jpg"><h5 class="g-line2">RBAC 和 Keto（Go RBAC 框架）</h5><p>2023-06-16 17:57:09</p></a></li><li><a href="https://www.anquanke.com/post/id/289234"><img src="./【技术分享】手把手教你如何完成Ruby ERB模板注入-安全客 - 安全资讯平台_files/t01541abcaaa3b796e4.jpg"><h5 class="g-line2">案例分享 | 银行API安全解决方案</h5><p>2023-06-16 17:56:08</p></a></li></ul></div><div class="_7 index-comment"><h2 class="g-title">发表评论</h2><div class="login"><p class="login-text">您还未登录，请先登录。</p><p class="login-bar"><a href="https://www.anquanke.com/login/index.html">登录</a></p></div><h2 class="g-title">评论列表</h2><ul class="body"><li class="body-item"><a href="https://www.anquanke.com/member.html?memberId=0" class="body-item-avatar"><img src="./【技术分享】手把手教你如何完成Ruby ERB模板注入-安全客 - 安全资讯平台_files/t010857340ce46bb672.jpg"></a><div class="item-main"><div class="item-main-top"><a href="https://www.anquanke.com/member.html?memberId=0" class="item-main-name"></a><span class="item-main-time">2019-06-25 18:32</span><div class="_18 rate"><b style="display: none;">+1</b><i class="iconfont icon-rate"></i><span class="rate-text">0赞</span></div><button>回复</button></div><div class="item-main-content">占楼</div><!----><div class="body-item-sub"></div></div></li><li class="body-item"><a href="https://www.anquanke.com/member.html?memberId=143475" class="body-item-avatar"><img src="./【技术分享】手把手教你如何完成Ruby ERB模板注入-安全客 - 安全资讯平台_files/t01677ea2cfaad2e211.png"></a><div class="item-main"><div class="item-main-top"><a href="https://www.anquanke.com/member.html?memberId=143475" class="item-main-name">Corp0ra1</a><span class="item-main-time">2019-06-23 15:33</span><div class="_18 rate"><b style="display: none;">+1</b><i class="iconfont icon-rate"></i><span class="rate-text">0赞</span></div><button>回复</button></div><div class="item-main-content">占楼</div><!----><div class="body-item-sub"></div></div></li><li class="body-item"><a href="https://www.anquanke.com/member.html?memberId=134224" class="body-item-avatar"><img src="./【技术分享】手把手教你如何完成Ruby ERB模板注入-安全客 - 安全资讯平台_files/t015c1acb017196a58e.png"></a><div class="item-main"><div class="item-main-top"><a href="https://www.anquanke.com/member.html?memberId=134224" class="item-main-name">evoA</a><span class="item-main-time">2019-06-23 14:50</span><div class="_18 rate"><b style="display: none;">+1</b><i class="iconfont icon-rate"></i><span class="rate-text">0赞</span></div><button>回复</button></div><div class="item-main-content">占楼</div><!----><div class="body-item-sub"><div class="body-item"><a class="body-item-avatar"><img src="./【技术分享】手把手教你如何完成Ruby ERB模板注入-安全客 - 安全资讯平台_files/t01cdbe1e6364d181c3.png"></a><div class="item-main"><div class="item-main-top"><span class="item-main-name">h4loyyds</span><span class="item-main-time">2019-06-23 18:16</span><div class="_18 rate"><b style="display: none;">+1</b><i class="iconfont icon-rate"></i><span class="rate-text">0赞</span></div></div><div class="item-main-content">占楼</div></div></div></div></div></li></ul><!----></div></div><div class="index-side"><div class="index-side-top"><div class="_66"><img class="banner" src="./【技术分享】手把手教你如何完成Ruby ERB模板注入-安全客 - 安全资讯平台_files/t0109dd3e1a13940163.png"><div class="w"><a class="avatar" href="https://www.anquanke.com/member.html?memberId=122957"><img src="./【技术分享】手把手教你如何完成Ruby ERB模板注入-安全客 - 安全资讯平台_files/t0104d1b8b4ca36e961.jpg"></a><p class="info"><a href="https://www.anquanke.com/member.html?memberId=122957" class="name">興趣使然的小胃</a><a href="https://www.anquanke.com/member.html?memberId=122957" class="user-label user-label-verify"></a></p><p class="hint">肥叶好香锅，孜孜不倦</p><div class="bottom"><ul class="bottom-1"><li>文章</li><li><strong>525</strong></li></ul><ul class="bottom-2"><li>粉丝</li><li><strong>225</strong></li></ul><div class="spacer"></div><!----></div></div></div><div class="_64"><h3 class="title"> TA的文章</h3><ul><li><h5><a href="https://www.anquanke.com/post/id/255690">如何利用Windows预览机制实现持久化</a></h5><p>2021-10-25 14:30:30</p></li><li><h5><a href="https://www.anquanke.com/post/id/254796">.NET 5、Source Generator以及供应链攻击</a></h5><p>2021-10-19 10:30:23</p></li><li><h5><a href="https://www.anquanke.com/post/id/254783">CVE-2021-1810：如何绕过Gatekeeper</a></h5><p>2021-10-15 10:30:05</p></li><li><h5><a href="https://www.anquanke.com/post/id/239569">如何在用户态下绕过LSA保护机制（Part 2）</a></h5><p>2021-05-12 15:30:57</p></li><li><h5><a href="https://www.anquanke.com/post/id/239568">如何在用户态下绕过LSA保护机制（Part 1）</a></h5><p>2021-05-07 14:30:20</p></li></ul></div><div class="_61"><h3 class="title"> 相关文章</h3><ul><li><h5><a href="https://www.anquanke.com/post/id/288808">最新权限提升漏洞 CVE-2023-28252 分析</a></h5><p>2023-06-15 11:36:59</p></li><li><h5><a href="https://www.anquanke.com/post/id/289126">某国外加固环境检测与绕过</a></h5><p>2023-06-12 18:56:08</p></li><li><h5><a href="https://www.anquanke.com/post/id/202705">“震网”三代和二代漏洞技术分析报告</a></h5><p>2020-04-09 14:37:35</p></li><li><h5><a href="https://www.anquanke.com/post/id/202675">4月9日每日安全热点 -7场针对流行病的医疗保健机构的网络攻击</a></h5><p>2020-04-09 10:00:48</p></li><li><h5><a href="https://www.anquanke.com/post/id/198141">远程办公不孤单，自我提升不间断 | 网络安全人员学习入门总结</a></h5><p>2020-02-06 10:52:24</p></li><li><h5><a href="https://www.anquanke.com/post/id/146401">360 | 数字货币钱包APP安全威胁概况</a></h5><p>2018-05-29 09:00:02</p></li><li><h5><a href="https://www.anquanke.com/post/id/146322">以太坊智能合约安全入门了解一下（下）</a></h5><p>2018-05-28 11:37:23</p></li></ul></div><div class="_52"><h3 class="title">热门推荐</h3><ul></ul></div></div><div class="_57"><div class="wrap" style="display: none;"><div class="title">文章目录</div><ul class="list"><li class="item"><a class="g-line1 on" target="_self"></a><ul></ul></li></ul></div></div></div></div><div class="_8"><div class="g-w main"><div class="col1"><p class="col1-logo"><img src="./【技术分享】手把手教你如何完成Ruby ERB模板注入-安全客 - 安全资讯平台_files/t018717b31ed82fff86.png"></p><div class="col1-link"><b class="col1-weixin"></b><a href="https://weibo.com/360adlab" class="col1-sina"></a><a href="https://zhuanlan.zhihu.com/c_118578260" class="col1-zhi"></a></div></div><div class="col2"><div class="title">安全客</div><ul class="col2-list"><li><a href="https://www.anquanke.com/about" rel="noopener noreferrer" target="_blank">关于我们</a></li><li><a href="https://www.anquanke.com/note/contact" target="_blank" rel="noopener noreferrer">联系我们</a></li><li><a href="https://www.anquanke.com/note/protocol" target="_blank" rel="noopener noreferrer">用户协议</a></li></ul></div><div class="col3"><div class="title">商务合作</div><ul class="col3-list"><li><a href="https://www.anquanke.com/note/business" target="_blank" rel="noopener noreferrer">合作内容</a></li><li><a href="https://www.anquanke.com/note/contact" target="_blank" rel="noopener noreferrer">联系方式</a></li><li><a href="https://www.anquanke.com/link" target="_blank" rel="noopener noreferrer">友情链接</a></li></ul></div><div class="col4"><div class="title">内容需知</div><ul><li><a href="https://www.anquanke.com/contribute/tips" target="_blank" rel="noopener noreferrer">投稿须知</a></li><li><a href="https://www.anquanke.com/note/repost" target="_blank" rel="noopener noreferrer">转载须知</a></li><li>官网QQ群8：819797106</li><li>官网QQ群3：830462644(已满)</li><li>官网QQ群2：814450983(已满)</li><li>官网QQ群1：702511263(已满)</li></ul></div><div class="col5"><div class="title">合作单位</div><ul><li><a href="http://www.cert.org.cn/" target="_blank" rel="noopener noreferrer"><img alt="安全客" src="./【技术分享】手把手教你如何完成Ruby ERB模板注入-安全客 - 安全资讯平台_files/t01592a959354157bc0.png" style="max-height: 40px;"></a></li><li style="margin-top: -20px;"><a href="http://www.cnnvd.org.cn/" target="_blank" rel="noopener noreferrer"><img alt="安全客" src="./【技术分享】手把手教你如何完成Ruby ERB模板注入-安全客 - 安全资讯平台_files/t014f76fcea94035e47.png" style="max-height: 50px; margin-top: 10px;"></a></li></ul></div></div><div class="right g-w"><span>Copyright © 北京奇虎科技有限公司 360网络攻防实验室 安全客 All Rights Reserved </span><a href="https://beian.miit.gov.cn/">京ICP备08010314号-66</a><span id="cnzz_stat_icon_1271278035"><a href="https://www.cnzz.com/stat/website.php?web_id=1271278035" target="_blank" title="站长统计"><img border="0" hspace="0" vspace="0" src="./【技术分享】手把手教你如何完成Ruby ERB模板注入-安全客 - 安全资讯平台_files/pic.gif" uhye54wd1=""></a></span></div><div class="layer" style="display: none;"><div class="layer-main"><div class="layer-title">微信二维码</div><b class="layer-close">X</b><img src="./【技术分享】手把手教你如何完成Ruby ERB模板注入-安全客 - 安全资讯平台_files/t0151209205b47f2270.jpg" alt="安全客"></div></div></div></div><script>window.__state__={"artical":{"post":{"id":86867,"title":"【技术分享】手把手教你如何完成Ruby ERB模板注入","category_name":"安全知识","category_slug":"knowledge","desc":"现在的Web应用中，许多客户端以及服务器端经常会用到模板。作为注入攻击大家族中的一员，模板注入这种攻击形式对不同的目标所造成的影响也有所不同。在本文中，我们会使用TrustedSec应用安全课程中的实验目标，演练一遍Ruby/ERB模板注入攻击。","date":"2017-09-18 14:34:45","time_interval":"2017-09-18","status":"publish","comment":4,"cover":"https://p5.ssl.qhimg.com/t019325c55f221fa3e8.jpg","subject":false,"red":false,"type":"translate","url":"https://www.trustedsec.com/2017/09/rubyerb-template-injection/","source":"trustedsec.com","fee":"200","origin_author":"","pv":210722,"like_count":0,"liked":0,"tags":["安全知识"],"is_favorite":false,"favorite_count":4,"content":"<html>\n<head><meta http-equiv=\"Content-Type\" content=\"text/html; charset=utf-8\"></head>\n<body>\n<p><span><img title=\"t019325c55f221fa3e8.jpg\" alt=\"https://p5.ssl.qhimg.com/t019325c55f221fa3e8.jpg\" data-original=\"https://p5.ssl.qhimg.com/t019325c55f221fa3e8.jpg\"></span></p>\n<p><span>译者：</span><a href=\"http://bobao.360.cn/member/contribute?uid=2819002922\" target=\"_blank\">興趣使然的小胃</a></p>\n<p><span>预估稿费：200RMB</span></p>\n<p><span>投稿方式：发送邮件至linwei#360.cn，或登陆网页版在线投稿</span></p>\n<p><span><br></span></p>\n<p><span style=\"font-size: 18px\"><strong><span>前言：现在Web应用的模板</span></strong></span></p>\n<p><span>现在的Web应用中，许多客户端以及服务器端经常会用到模板。许多模板引擎提供了多种不同的编程语言实现，比如Smarty、Mako、Jinja2、Jade、Velocity、Freemaker以及Twig等模板。作为注入攻击大家族中的一员，模板注入这种攻击形式对不同的目标所造成的影响也有所不同。对于AngularJS而言，模板注入攻击可以达到<span><strong>XSS攻击</strong></span>效果，对于服务器端的注入攻击而言，模板注入攻击可以达到远程代码执行效果。</span></p>\n<p><span>作为大名鼎鼎BurpSuite工具的开发商，Portswigger写了一篇</span><a href=\"http://blog.portswigger.net/2015/08/server-side-template-injection.html\" target=\"_blank\"><span>文章</span></a><span>详细介绍了服务器端的模板注入攻击。对攻击者而言，首先需要做的就是识别模板引擎、枚举可访问的类或方法，最终利用这些信息完成预期的操作，比如读取或写入文件、命令执行或其他操作等。攻击者具体能执行哪些操作取决于可访问的类方法或函数的能力范围。</span></p>\n<p><span><br></span></p>\n<p><span style=\"font-size: 18px\"><strong><span>模板攻击：Ruby/ERB模板注入</span></strong></span></p>\n<p><span>在本文中，我们会使用<span><strong>TrustedSec</strong></span>应用安全课程中的实验目标，演练一遍<strong><span>Ruby/ERB模板注入</span></strong>攻击。我们的实验对象是一个简单的应用，该应用可以模拟包含模板编辑功能的一种IT服务台（Helpdesk）报告工具。我们可以通过这个应用来编辑HTML及模板，也可以预览编辑效果，如下图所示：</span></p>\n<p style=\"text-indent: 0em;text-align: center\"><img data-original=\"//base_request.html/img/1.png\"><img title=\"t01c7121429feba4232.png\" alt=\"https://p2.ssl.qhimg.com/t01c7121429feba4232.png\" data-original=\"https://p2.ssl.qhimg.com/t01c7121429feba4232.png\"></p>\n<p><span>使用预览（preview）按钮提交表格后，呈现在我们眼前是包含用户信息以及用户创建时间的一个页面：</span></p>\n<p style=\"text-indent: 0em;text-align: center\"><img data-original=\"//base_request.html/img/2.png\"><img title=\"t016d21ad6211372d84.png\" alt=\"https://p5.ssl.qhimg.com/t016d21ad6211372d84.png\" data-original=\"https://p5.ssl.qhimg.com/t016d21ad6211372d84.png\"></p>\n<p><span>观察代码中获取username以及tombstone时所使用的语法，根据其中的&lt;%=语法以及其他一些Ruby技术，我们可以猜测这段代码属于Ruby/ERB代码。基于这个判断，我们可以编辑输入数据，测试我们是否可以进行模板注入。大致浏览ERB文档后，我们了解到&lt;%=语法可以用来执行Ruby语句，并会尝试将结果转换为字符串，以附在最终的结果文本中。我们可以使用如下攻击载荷来尝试执行数学运算：</span></p>\n<pre><code>ruby &lt;%= 7 * 7 %&gt;</code></pre>\n<p><span>运算结果为49，每个用户都会打印一次运算结果，如下所示：</span></p>\n<p style=\"text-indent: 0em;text-align: center\"><img data-original=\"//base_request.html/img/3.png\"><img title=\"t01a3de9db6d000f011.png\" alt=\"https://p5.ssl.qhimg.com/t01a3de9db6d000f011.png\" data-original=\"https://p5.ssl.qhimg.com/t01a3de9db6d000f011.png\"></p>\n<p><span>可以肯定的是，这段代码存在模板注入漏洞。非常好，接下来我们可以试试看能否执行函数。我们可以先来测试自带的全局函数是否能用到这段代码中。比如，我们可以测试如下这种载荷：</span></p>\n<pre><code>ruby &lt;%= File.open(‘/etc/passwd’).read %&gt;</code></pre>\n<p style=\"text-indent: 0em;text-align: center\"><img data-original=\"//base_request.html/img/4.png\"><img title=\"t018551eed0b918398c.png\" alt=\"https://p0.ssl.qhimg.com/t018551eed0b918398c.png\" data-original=\"https://p0.ssl.qhimg.com/t018551eed0b918398c.png\"></p>\n<p><span>由于不安全操作的原因，系统阻止我们访问<strong><span>File.open</span></strong>函数。Ruby的ERB模板引擎包含一个安全级别（safe level）参数，当安全级别设置为0以上的某个值（比如3）时，我们无法在模板绑定（template binding）中执行包括文件操作在内的某些函数。如果应用使用的安全级别为4，那么它会使用最为严格的隔离机制，只能执行标记为可信状态的那些代码。因此，看样子管理员在这个模板引擎中设置了安全级别。虽然我们的攻击不会像读写硬盘文件那样简单，但这里我们还可以尝试许多攻击面。比如，对于目前可用的这些小工具（gadget），我们还可以做什么操作？如果我们想分析self对象（self-object），我们可以尝试枚举该对象可用的属性及方法。比如，我们可以使用如下载荷：</span></p>\n<pre><code>ruby &lt;%= self %&gt;</code></pre>\n<p><span>结果如下：</span></p>\n<p style=\"text-indent: 0em;text-align: center\"><img data-original=\"//base_request.html/img/5.png\"><img title=\"t019544a981026ded32.png\" alt=\"https://p0.ssl.qhimg.com/t019544a981026ded32.png\" data-original=\"https://p0.ssl.qhimg.com/t019544a981026ded32.png\"></p>\n<p><span>结果看起来就是Ruby的风格。现在我们可以试着获取self对象的类名：</span></p>\n<pre><code>ruby &lt;%= self.class.name %&gt;</code></pre>\n<p><span>结果如下：</span></p>\n<p style=\"text-indent: 0em;text-align: center\"><img data-original=\"//base_request.html/img/6.png\"><img title=\"t0162ae80bbca330ed5.png\" alt=\"https://p3.ssl.qhimg.com/t0162ae80bbca330ed5.png\" data-original=\"https://p3.ssl.qhimg.com/t0162ae80bbca330ed5.png\"></p>\n<p><span>类名为“TemplateInjection”。现在我们已经可以“访问”这个控制接口，我们能用它来干啥？我们可以来枚举TemplateInjection类的可用方法：</span></p>\n<pre><code>ruby &lt;%= self.methods %&gt;</code></pre>\n<p><span>结果如下：</span></p>\n<p style=\"text-indent: 0em;text-align: center\"><img data-original=\"//base_request.html/img/7.png\"><img title=\"t0166de1994d25f764d.png\" alt=\"https://p0.ssl.qhimg.com/t0166de1994d25f764d.png\" data-original=\"https://p0.ssl.qhimg.com/t0166de1994d25f764d.png\"></p>\n<p><span>接下来，我们可以观察这些函数，思考哪些数据可以传递给这些函数，以实现未授权访问目的。虽然我们并不清楚该应用具体使用的web框架，但由于我们正往服务器发送HTTP POST请求，因此可以猜到我们很有可能处于handlePOST或者doPOST函数内部。也许我们可以借此访问某些局部变量。</span></p>\n<p><span>如果大家不熟悉Ruby，这里我稍微介绍下。Ruby提供了强大的元编程（metaprogramming）以及内省（introspection）功能，读者可以访问</span><a href=\"http://ruby-metaprogramming.rubylearning.com/\" target=\"_blank\"><span>此链接</span></a><span>了解更多细节。作为攻击者，我们可以使用其中某些功能（如前面提到的类的.methods以及.name方法）来探索程序的内部结构。我们可以使用如下载荷获取目标所需的具体参数：</span></p>\n<pre><code>ruby &lt;%= self.method(:handle_POST).parameters %&gt;</code></pre>\n<p><span>结果如下：</span></p>\n<p style=\"text-indent: 0em;text-align: center\"><img data-original=\"//base_request.html/img/8.png\"><img title=\"t0116ea2a5826f4e7cf.png\" alt=\"https://p3.ssl.qhimg.com/t0116ea2a5826f4e7cf.png\" data-original=\"https://p3.ssl.qhimg.com/t0116ea2a5826f4e7cf.png\"></p>\n<p><span>从结果中，我们可知handle_POST需要3个req参数，该参数可能代表的是某个请求（request）对象；rsp参数可能代表的是响应数据的引用；最后的session参数可能是某个id或者某个对象。我们可以继续探索，以确认session对象的具体含义，使用的载荷如下：</span></p>\n<pre><code>ruby &lt;%= session.class.name %&gt;</code></pre>\n<p><span>结果如下：</span></p>\n<p style=\"text-indent: 0em;text-align: center\"><img data-original=\"//base_request.html/img/9.png\"><img title=\"t017bb5cb13101b1252.png\" alt=\"https://p5.ssl.qhimg.com/t017bb5cb13101b1252.png\" data-original=\"https://p5.ssl.qhimg.com/t017bb5cb13101b1252.png\"></p>\n<p><span>上述结果中，我们首先可以观察到的是“WEBrick”，这是Ruby在标准库中实现的原生web服务器。我们当然可以继续探索这个session对象，但除此之外，还有其他一些目标更值得我们探索，比如，我们可以重点关注与当前会话有关的那些数据。简单翻阅WEBrick文档后，我们发现某些变量会传递给Servlet以处理客户端请求。我们可以使用某些内省（introspection）方法，以确认我们是否可以访问这些变量以及其他可用变量。</span></p>\n<pre><code>ruby &lt;%= self.instance_variables %&gt;</code></pre>\n<p><span>结果如下：</span></p>\n<p style=\"text-indent: 0em;text-align: center\"><img data-original=\"//base_request.html/img/10.png\"><img title=\"t01ae7cfe9eca7d38e8.png\" alt=\"https://p4.ssl.qhimg.com/t01ae7cfe9eca7d38e8.png\" data-original=\"https://p4.ssl.qhimg.com/t01ae7cfe9eca7d38e8.png\"></p>\n<p><span>当WEBrick被实例化以处理客户端请求时，它会将某个http服务器实例传递给servlet，这很有可能就是@server这个实例变量。接下来我们可以证实这个猜想，同时观察这个对象包含哪些成员变量。我们同样可以通过调用.instance_variables方法来证实这一点：</span></p>\n<pre><code>ruby &lt;%=@server.instance_variables %&gt;</code></pre>\n<p><span>结果如下：</span></p>\n<p style=\"text-indent: 0em;text-align: center\"><img data-original=\"//base_request.html/img/11.png\"><img title=\"t01cc2ba03a646de70b.png\" alt=\"https://p4.ssl.qhimg.com/t01cc2ba03a646de70b.png\" data-original=\"https://p4.ssl.qhimg.com/t01cc2ba03a646de70b.png\"></p>\n<p><span>其中最为有趣的应该就是@ssl_context变量。这个变量可能会包含某些密钥或者其他有用的信息。需要注意的是，接下来我们会稍微改一下语法，使用&lt;%来执行Ruby语句。通过这种语法，我们可以创建自己的局部变量，保存@sll_context的引用，使载荷可读性更好，方便随后在模板中加以引用。</span></p>\n<pre><code>ruby &lt;% ssl=@server.instance_variable_get(:@ssl_context) %&gt;&lt;%= ssl.instance_variables %&gt;</code></pre>\n<p><span>结果如下：</span></p>\n<p style=\"text-indent: 0em;text-align: center\"><img data-original=\"//base_request.html/img/12.png\"><img title=\"t01b360af7d1a92babe.png\" alt=\"https://p3.ssl.qhimg.com/t01b360af7d1a92babe.png\" data-original=\"https://p3.ssl.qhimg.com/t01b360af7d1a92babe.png\"></p>\n<p><span>结果中，@key看起来非常有趣，我们可以提取这个值：</span></p>\n<pre><code>ruby &lt;% ssl = @server.instance_variable_get(:@ssl_context) %&gt;&lt;%= ssl.instance_variable_get(:@key) %&gt;</code></pre>\n<p><span>结果如下：</span></p>\n<p style=\"text-indent: 0em;text-align: center\"><img data-original=\"//base_request.html/img/13.png\"><img title=\"t012453cda85d43f4f1.png\" alt=\"https://p5.ssl.qhimg.com/t012453cda85d43f4f1.png\" data-original=\"https://p5.ssl.qhimg.com/t012453cda85d43f4f1.png\"></p>\n<p><span><br></span></p>\n<p><span style=\"font-size: 18px\"><strong><span>总结：风险与检验</span></strong></span></p>\n<p><span>在实际生活中，服务器私钥被泄露是非常严重的一件事情。作为应用安全测试员，我们的测试操作到此差不多就该停止了。开发人员可以采用多种方式来限制数据的读取范围，进一步沙箱化模板中运行的代码。我们会根据测试过程中对目标应用的了解来给出相应的建议。作为应用测试人员，我们需要全方位探索哪些模板代码会提交到服务端进行处理。虽然存在一定的安全风险，但是由用户提供模板的场景依然非常常见，特别是在某些应用中更是如此（比如用来生成报表以及发送邮件的那些应用）。希望读完这篇文章后，读者可以掌握一定的技巧来测试现在常用的那些模板引擎。</span></p>\n</body>\n</html>","index":[[]],"success":true},"share":{"title":"【技术分享】手把手教你如何完成Ruby ERB模板注入","desc":"现在的Web应用中，许多客户端以及服务器端经常会用到模板。作为注入攻击大家族中的一员，模板注入这种攻击形式对不同的目标所造成的影响也有所不同。在本文中，我们会使用TrustedSec应用安全课程中的实验目标，演练一遍Ruby/ERB模板注入攻击。","imgUrl":"https://p5.ssl.qhimg.com/sdm/160_160_100/t019325c55f221fa3e8.jpg"},"author":{"nickname":"興趣使然的小胃","user_url":"","id":122957,"avatar":"https://p5.ssl.qhmsg.com/dm/200_200_100/t0104d1b8b4ca36e961.jpg","banner":"https://p5.ssl.qhimg.com/t0109dd3e1a13940163.png","location":"上海","user_label":"verify","description":"肥叶好香锅，孜孜不倦","register_date":"2017-11-29 02:38:45","self":false,"follow":false,"post_count":525,"follower_count":225,"follow_count":4,"comment_count":4},"relevant":[{"id":288808,"title":"最新权限提升漏洞 CVE-2023-28252 分析","date":"2023-06-15 11:36:59"},{"id":289126,"title":"某国外加固环境检测与绕过","date":"2023-06-12 18:56:08"},{"id":202705,"title":"“震网”三代和二代漏洞技术分析报告","date":"2020-04-09 14:37:35"},{"id":202675,"title":"4月9日每日安全热点 -7场针对流行病的医疗保健机构的网络攻击","date":"2020-04-09 10:00:48"},{"id":198141,"title":"远程办公不孤单，自我提升不间断 | 网络安全人员学习入门总结","date":"2020-02-06 10:52:24"},{"id":146401,"title":"360 | 数字货币钱包APP安全威胁概况","date":"2018-05-29 09:00:02"},{"id":146322,"title":"以太坊智能合约安全入门了解一下（下）","date":"2018-05-28 11:37:23"}],"authorPostList":[{"post_id":255690,"title":"如何利用Windows预览机制实现持久化","cover":"https://p2.ssl.qhimg.com/sdm/229_160_100/t019c095cac9560e299.jpg","date":"2021-10-25 14:30:30"},{"post_id":254796,"title":".NET 5、Source Generator以及供应链攻击","cover":"https://p1.ssl.qhimg.com/sdm/229_160_100/t01f997037e519ee0e7.jpg","date":"2021-10-19 10:30:23"},{"post_id":254783,"title":"CVE-2021-1810：如何绕过Gatekeeper","cover":"https://p1.ssl.qhimg.com/sdm/229_160_100/t01f26d6d2ae888739e.jpg","date":"2021-10-15 10:30:05"},{"post_id":239569,"title":"如何在用户态下绕过LSA保护机制（Part 2）","cover":"https://p0.ssl.qhimg.com/sdm/229_160_100/t0179689d7747dedf0e.jpg","date":"2021-05-12 15:30:57"},{"post_id":239568,"title":"如何在用户态下绕过LSA保护机制（Part 1）","cover":"https://p0.ssl.qhimg.com/sdm/229_160_100/t0179689d7747dedf0e.jpg","date":"2021-05-07 14:30:20"}],"cookie":{"__guid":"213549842.2010739486156183000.1685757824050.7908","__DC_monitor_count":"1","__DC_sid":"213549842.2304340555566067000.1687534478048.9534","__DC_gid":"213549842.902862346.1685757824050.1687534478050.17","PHPSESSID":"ivu5516uboqikg3d6596lp3ui1"}}};
//published at: 6/23/2023, 3:39:46 PM</script>

<script src="./【技术分享】手把手教你如何完成Ruby ERB模板注入-安全客 - 安全资讯平台_files/a89b1e55fab19834,969b9d2ab6d58ff9.js.下载"></script>
<script src="./【技术分享】手把手教你如何完成Ruby ERB模板注入-安全客 - 安全资讯平台_files/e855bc476c0070c4,d70645fabcfd28e5,b00f894d26352cfe,374cd4f654903275,1fbf0cc911f15a9c.js.下载"></script>
<script src="./【技术分享】手把手教你如何完成Ruby ERB模板注入-安全客 - 安全资讯平台_files/43c736269a19e5f8,d7c4492c306d9e12.js.下载"></script>
<script src="./【技术分享】手把手教你如何完成Ruby ERB模板注入-安全客 - 安全资讯平台_files/c3f64e723fc684b2,d29a864a4b5dd4b6,5c4b8b1bbe75533d,f59329488ebbc180,569b6657398e046f,50a9d6f78d7b9c2b,ffa01aa1dfa9875c,1e0c54ddfbe618cb,cc52ec6e18fb5e0f,7e2ef3c63800d75a,163f062eddf12afb,12d46f.下载"></script><div id="js-toast" data-v-app=""></div><!----><div id="js-lift" data-v-app=""></div><div class="_15"></div>


</body></html>